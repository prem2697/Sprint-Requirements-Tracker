<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sprint Requirements Dashboard</title>
    <!-- Google Fonts - Inter (Modern, Clean, Highly Readable) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ==================== CSS VARIABLES ==================== */
        :root {
            /* Dark Theme Colors (Default) */
            --bg-primary: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --bg-secondary: #1e293b;
            --bg-card: rgba(255,255,255,0.05);
            --bg-card-hover: rgba(255,255,255,0.08);
            --bg-input: rgba(0,0,0,0.3);
            --border-color: rgba(255,255,255,0.1);
            --border-color-strong: rgba(255,255,255,0.2);
            --text-primary: #ffffff;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #6366f1, #8b5cf6);
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --doughnut-bg: #1e293b;
            --table-header-bg: #0f172a;
            --table-row-hover: rgba(255,255,255,0.05);
            --link-color: #60a5fa;
            --shadow-color: rgba(0,0,0,0.3);
        }

        /* Light Theme Colors */
        body.light-theme {
            --bg-primary: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-card-hover: #f8fafc;
            --bg-input: #ffffff;
            --border-color: #cbd5e1;
            --border-color-strong: #94a3b8;
            --text-primary: #0f172a;
            --text-secondary: #1e293b;
            --text-muted: #475569;
            --accent-primary: #4f46e5;
            --accent-secondary: #7c3aed;
            --accent-gradient: linear-gradient(135deg, #4f46e5, #7c3aed);
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --info: #0891b2;
            --doughnut-bg: #ffffff;
            --table-header-bg: #f1f5f9;
            --table-row-hover: rgba(0,0,0,0.04);
            --link-color: #2563eb;
            --shadow-color: rgba(0,0,0,0.15);
        }

        /* Light theme specific overrides */
        body.light-theme .config-panel,
        body.light-theme .filter-panel,
        body.light-theme .dashboard-card,
        body.light-theme .table-section,
        body.light-theme .req-lookup-card {
            background: #ffffff;
            border: 1px solid #cbd5e1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        body.light-theme .config-field input,
        body.light-theme .filter-field select {
            background: #ffffff;
            border: 1px solid #94a3b8;
            color: #0f172a;
        }
        body.light-theme .config-field label,
        body.light-theme .filter-field label {
            color: #334155;
        }
        body.light-theme h1, 
        body.light-theme h2, 
        body.light-theme h3, 
        body.light-theme h4 {
            color: #0f172a;
        }
        body.light-theme th {
            background: #e2e8f0;
            color: #1e293b;
        }
        body.light-theme td {
            color: #1e293b;
            border-bottom-color: #e2e8f0;
        }
        body.light-theme tr:hover {
            background: rgba(99,102,241,0.08);
        }
        body.light-theme .mini-table th {
            background: #e2e8f0;
            color: #1e293b;
        }
        body.light-theme .mini-table td {
            color: #1e293b;
            border-bottom-color: #e2e8f0;
        }
        body.light-theme .wi-link {
            color: #4f46e5;
            font-weight: 500;
        }
        body.light-theme .ratio-bar {
            background: #cbd5e1;
        }
        body.light-theme .loading {
            background: rgba(255,255,255,0.95);
        }
        body.light-theme .loading-text {
            color: #1e293b;
        }
        body.light-theme .btn-secondary {
            background: #ffffff;
            border: 1px solid #94a3b8;
            color: #1e293b;
        }
        body.light-theme .btn-secondary:hover {
            background: #f1f5f9;
        }
        body.light-theme .table-tab {
            background: #e2e8f0;
            color: #1e293b;
        }
        body.light-theme .table-tab:hover {
            background: #cbd5e1;
        }
        body.light-theme .table-tab.active {
            background: #4f46e5;
            color: #ffffff;
        }
        body.light-theme .api-stats {
            color: #475569;
        }
        body.light-theme .header-info span {
            color: #334155;
        }
        body.light-theme .highlight {
            color: #4f46e5;
        }
        body.light-theme .summary-stat {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
        }
        body.light-theme .summary-stat .label {
            color: #475569;
        }
        body.light-theme .dashboard-section {
            color: #1e293b;
        }
        body.light-theme .tab-btn {
            color: #475569;
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        body.light-theme .tab-btn.active {
            background: rgba(79,70,229,0.2);
            color: #4f46e5;
            border-color: #4f46e5;
        }
        body.light-theme .badge {
            font-weight: 600;
        }
        body.light-theme .badge-deliverable {
            background: rgba(5,150,105,0.15);
            color: #047857;
        }
        body.light-theme .badge-non-deliverable {
            background: rgba(217,119,6,0.15);
            color: #b45309;
        }
        body.light-theme p,
        body.light-theme span,
        body.light-theme div {
            color: inherit;
        }
        body.light-theme .content {
            color: #1e293b;
        }
        /* Override inline backgrounds for light theme */
        body.light-theme [style*="background: rgba"],
        body.light-theme [style*="background: linear-gradient"] {
            color: #1e293b !important;
        }
        body.light-theme [style*="background: rgba"] h3,
        body.light-theme [style*="background: rgba"] h4,
        body.light-theme [style*="background: rgba"] p,
        body.light-theme [style*="background: rgba"] span,
        body.light-theme [style*="background: rgba"] td,
        body.light-theme [style*="background: linear-gradient"] h3,
        body.light-theme [style*="background: linear-gradient"] h4,
        body.light-theme [style*="background: linear-gradient"] p,
        body.light-theme [style*="background: linear-gradient"] span,
        body.light-theme [style*="background: linear-gradient"] td {
            color: #1e293b !important;
        }
        /* Stronger card backgrounds for light theme */
        body.light-theme .dashboard-card[style*="background"] {
            background: #ffffff !important;
            border: 1px solid #cbd5e1 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }
        body.light-theme .dashboard-card[style*="background"] h3 {
            color: #1e293b !important;
        }
        /* Dev AI Adoption - Blue theme in light mode */
        body.light-theme .dashboard-card[style*="rgba(59,130,246"] {
            background: linear-gradient(135deg, rgba(59,130,246,0.12), rgba(37,99,235,0.08)) !important;
            border: 1px solid rgba(59,130,246,0.4) !important;
        }
        body.light-theme .dashboard-card[style*="rgba(59,130,246"] h3 {
            color: #2563eb !important;
        }
        /* QA AI Adoption - Green theme in light mode */
        body.light-theme .dashboard-card[style*="rgba(16,185,129"] {
            background: linear-gradient(135deg, rgba(16,185,129,0.12), rgba(5,150,105,0.08)) !important;
            border: 1px solid rgba(16,185,129,0.4) !important;
        }
        body.light-theme .dashboard-card[style*="rgba(16,185,129"] h3 {
            color: #059669 !important;
        }
        /* Overall Discipline AI Adoption - Orange/Amber theme in light mode */
        body.light-theme .dashboard-card[style*="rgba(245,158,11"] {
            background: linear-gradient(135deg, rgba(245,158,11,0.12), rgba(217,119,6,0.08)) !important;
            border: 1px solid rgba(245,158,11,0.4) !important;
        }
        body.light-theme .dashboard-card[style*="rgba(245,158,11"] h3 {
            color: #d97706 !important;
        }
        /* TaskExecutionType AI Adoption - Purple theme in light mode */
        body.light-theme .dashboard-card[style*="rgba(139,92,246"] {
            background: linear-gradient(135deg, rgba(139,92,246,0.12), rgba(168,85,247,0.08)) !important;
            border: 1px solid rgba(139,92,246,0.4) !important;
        }
        body.light-theme .dashboard-card[style*="rgba(139,92,246"] h3 {
            color: #7c3aed !important;
        }
        /* Fix checkbox containers */
        body.light-theme [id*="CheckboxContainer"] {
            background: #f8fafc !important;
            border-color: #cbd5e1 !important;
        }
        body.light-theme [id*="CheckboxContainer"] label {
            color: #1e293b !important;
        }
        /* Fix summary stats in light theme */
        body.light-theme .summary-stat[style*="background"] {
            background: #f1f5f9 !important;
            border: 1px solid #e2e8f0 !important;
        }
        body.light-theme .summary-stat .value {
            filter: brightness(0.8) saturate(1.2);
        }
        /* Fix doughnut chart labels */
        body.light-theme [style*="color: #94a3b8"],
        body.light-theme [style*="color:#94a3b8"] {
            color: #475569 !important;
        }
        body.light-theme [style*="color: #fca5a5"],
        body.light-theme [style*="color:#fca5a5"] {
            color: #dc2626 !important;
        }
        body.light-theme [style*="color: #fcd34d"],
        body.light-theme [style*="color:#fcd34d"] {
            color: #d97706 !important;
        }
        body.light-theme [style*="color: #a5b4fc"],
        body.light-theme [style*="color:#a5b4fc"] {
            color: #4f46e5 !important;
        }
        body.light-theme [style*="color: #c4b5fd"],
        body.light-theme [style*="color:#c4b5fd"] {
            color: #7c3aed !important;
        }
        body.light-theme [style*="color: #67e8f9"],
        body.light-theme [style*="color:#67e8f9"] {
            color: #0891b2 !important;
        }
        /* Fix table headers in cards */
        body.light-theme thead[style*="background: #0f172a"],
        body.light-theme thead[style*="background: #1a1f2e"],
        body.light-theme thead[style*="background: #2d1a1a"],
        body.light-theme thead[style*="background:#0f172a"],
        body.light-theme thead[style*="background:#1a1f2e"] {
            background: #e2e8f0 !important;
        }
        body.light-theme thead th {
            color: #1e293b !important;
        }
        /* Fix detail items */
        body.light-theme .detail-item,
        body.light-theme [style*="background: rgba(0,0,0,0.2)"],
        body.light-theme [style*="background: rgba(0,0,0,0.3)"] {
            background: #f1f5f9 !important;
        }
        body.light-theme .detail-item .detail-label,
        body.light-theme .detail-item .detail-value {
            color: #1e293b !important;
        }

        /* ==================== BASE STYLES ==================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: var(--bg-primary); min-height: 100vh; color: var(--text-primary); padding: 20px; transition: background 0.3s ease, color 0.3s ease; font-size: 14px; line-height: 1.5; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .config-panel { background: var(--bg-card-hover); border-radius: 16px; padding: 24px; margin-bottom: 24px; border: 1px solid var(--border-color); max-width: 500px; margin-left: auto; margin-right: auto; }
        .config-panel h2 { margin-bottom: 16px; font-size: 1.2rem; color: var(--text-primary); }
        .config-field { margin-bottom: 16px; }
        .config-field label { display: block; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 6px; }
        .config-field input { width: 100%; padding: 10px 14px; border: 1px solid var(--border-color-strong); border-radius: 8px; background: var(--bg-input); color: var(--text-primary); font-size: 0.95rem; }
        .config-field input:focus { outline: none; border-color: var(--accent-primary); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease; margin-right: 10px; margin-top: 8px; }
        .btn-primary { background: var(--accent-gradient); color: #fff; }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color-strong); }
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: #fff; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .filter-panel { background: var(--bg-card); border-radius: 16px; padding: 20px; margin-bottom: 24px; border: 1px solid var(--border-color); display: none; max-width: 900px; margin-left: auto; margin-right: auto; }
        .filter-panel.visible { display: block; }
        .filter-panel h3 { margin-bottom: 16px; font-size: 1rem; color: var(--text-secondary); }
        .filter-row { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-end; }
        .filter-field { flex: 1; min-width: 200px; }
        .filter-field label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px; }
        .filter-field select { width: 100%; padding: 10px 14px; border: 1px solid var(--border-color-strong); border-radius: 8px; background: var(--bg-input); color: var(--text-primary); }
        .filter-field select option { background: var(--bg-secondary); }
        .content { display: none; max-width: 1400px; margin: 0 auto; }
        .content.visible { display: block; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .header h1 { font-size: 1.5rem; background: var(--accent-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .header-info { color: var(--text-muted); font-size: 0.9rem; }
        .header-info span { margin-right: 20px; }
        .header-info .highlight { color: var(--accent-primary); font-weight: 600; }
        .summary-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .summary-stat { background: var(--bg-card); border-radius: 12px; padding: 16px; border: 1px solid var(--border-color); text-align: center; }
        .summary-stat .value { font-size: 1.6rem; font-weight: 700; }
        .summary-stat .label { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
        .summary-stat.blue .value { color: #3b82f6; }
        .summary-stat.green .value { color: var(--success); }
        .summary-stat.orange .value { color: var(--warning); }
        .summary-stat.purple .value { color: #a78bfa; }
        .summary-stat.red .value { color: var(--danger); }
        .summary-stat.cyan .value { color: var(--info); }
        .summary-stat.pink .value { color: #ec4899; }
        .summary-stat.gray .value { color: var(--text-muted); }
        .dashboard-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .dashboard-card { background: var(--bg-card); border-radius: 16px; padding: 20px; border: 1px solid var(--border-color); transition: background 0.3s ease; }
        .dashboard-card h3 { font-size: 0.95rem; margin-bottom: 16px; color: var(--text-secondary); }
        .chart-container { position: relative; height: 180px; display: flex; justify-content: center; align-items: center; }
        /* CSS Doughnut Chart - No external library */
        .css-doughnut { width: 100px; height: 100px; border-radius: 50%; position: relative; display: flex; justify-content: center; align-items: center; background: conic-gradient(var(--text-muted) 0deg 360deg); }
        .css-doughnut::before { content: ''; position: absolute; width: 50px; height: 50px; background: var(--doughnut-bg); border-radius: 50%; z-index: 1; }
        .css-doughnut .center-text { position: absolute; z-index: 2; text-align: center; }
        .css-doughnut .center-text .pct { font-size: 1rem; font-weight: 700; color: var(--text-primary); }
        .css-doughnut .center-text .lbl { font-size: 0.5rem; color: var(--text-muted); }
        .chart-legend { display: flex; justify-content: center; gap: 16px; margin-top: 10px; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.7rem; color: var(--text-muted); }
        
        .legend-color { width: 10px; height: 10px; border-radius: 2px; }
        .size-summary { display: flex; justify-content: space-around; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1); }
        .size-item { text-align: center; }
        .size-item .size-value { font-size: 1.3rem; font-weight: 700; }
        .size-item .size-label { font-size: 0.7rem; color: #94a3b8; margin-top: 4px; }
        .size-item.green .size-value { color: #10b981; }
        .size-item.orange .size-value { color: #f59e0b; }
        .size-item.cyan .size-value { color: #06b6d4; }
        .size-item.pink .size-value { color: #ec4899; }
        .size-item.blue .size-value { color: #3b82f6; }
        .size-item.purple .size-value { color: #a855f7; }
        .size-item.gray .size-value { color: #94a3b8; }
        .ratio-bar-container { margin-top: 16px; }
        .ratio-bar-labels { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 8px; color: #94a3b8; flex-wrap: wrap; gap: 8px; }
        .ratio-bar { height: 28px; border-radius: 14px; overflow: hidden; display: flex; background: rgba(0,0,0,0.3); }
        .ratio-bar .segment { display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 600; color: #fff; transition: width 0.5s ease; }
        .ratio-bar .deliverable-seg { background: linear-gradient(90deg, #10b981, #34d399); }
        .ratio-bar .non-deliverable-seg { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .alert-card { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); }
        .alert-card h3 { color: #fca5a5; }
        .warning-card { background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); }
        .warning-card h3 { color: #fcd34d; }
        .mini-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
        .mini-table th, .mini-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; }
        .mini-table th { background: rgba(0,0,0,0.3); color: #94a3b8; font-size: 0.7rem; text-transform: uppercase; }
        .mini-table tr:hover { background: rgba(255,255,255,0.05); }
        .table-section { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 24px; border: 1px solid rgba(255,255,255,0.1); overflow-x: auto; margin-bottom: 24px; }
        .table-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
        .table-header h3 { font-size: 1.1rem; }
        .table-tabs { display: flex; gap: 8px; flex-wrap: wrap; }
        .table-tab { padding: 8px 16px; border-radius: 8px; background: rgba(255,255,255,0.1); border: none; color: #94a3b8; cursor: pointer; font-size: 0.8rem; }
        .table-tab:hover { background: rgba(255,255,255,0.15); }
        .table-tab.active { background: #6366f1; color: #fff; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { background: rgba(0,0,0,0.2); color: #94a3b8; font-weight: 600; font-size: 0.8rem; text-transform: uppercase; }
        tr:hover { background: rgba(255,255,255,0.05); }
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 500; }
        .badge-deliverable { background: rgba(16,185,129,0.2); color: #34d399; }
        .badge-non-deliverable { background: rgba(245,158,11,0.2); color: #fbbf24; }
        .badge-urn-in { background: rgba(6,182,212,0.2); color: #22d3ee; }
        .badge-urn-cf { background: rgba(236,72,153,0.2); color: #f472b6; }
        .wi-link { color: #6366f1; text-decoration: none; }
        .wi-link:hover { text-decoration: underline; }
        .loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; }
        .loading.visible { display: flex; }
        .loading .spinner { width: 50px; height: 50px; border: 4px solid rgba(99,102,241,0.3); border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .error { background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.4); border-radius: 8px; padding: 12px 16px; color: #fca5a5; margin-top: 12px; }
        .req-lookup-card { background: rgba(255,255,255,0.05); border-radius: 12px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); margin-top: 16px; }
        .req-lookup-card h4 { font-size: 1rem; margin-bottom: 16px; color: #e2e8f0; }
        .req-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 16px; }
        .detail-item { background: rgba(0,0,0,0.2); padding: 10px 14px; border-radius: 8px; }
        .detail-item .label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
        .detail-item .value { font-size: 0.9rem; color: #e2e8f0; }
        .tasks-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .tasks-table th, .tasks-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .tasks-table th { background: rgba(0,0,0,0.3); color: #94a3b8; font-size: 0.75rem; }
        .no-tasks { color: #94a3b8; text-align: center; padding: 20px; }
        .api-stats { position: fixed; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); padding: 8px 12px; border-radius: 8px; font-size: 0.7rem; color: #94a3b8; z-index: 100; }

        /* ===== TABLE COLUMN SIZING ===== */
        /* Small card tables - ID narrow, Title expands, third col narrow */
        #blankSizeTable, #blankReleaseNoteTable, #blankParentTable,
        #lastSprintTable, #tagMissingTable2, #blankDisciplineTable,
        #blankDescTable { table-layout: fixed; width: 100%; }

        #blankSizeTable th:first-child, #blankSizeTable td:first-child,
        #blankReleaseNoteTable th:first-child, #blankReleaseNoteTable td:first-child,
        #blankParentTable th:first-child, #blankParentTable td:first-child,
        #lastSprintTable th:first-child, #lastSprintTable td:first-child,
        #tagMissingTable2 th:first-child, #tagMissingTable2 td:first-child,
        #blankDisciplineTable th:first-child, #blankDisciplineTable td:first-child,
        #blankDescTable th:first-child, #blankDescTable td:first-child { width: 48px; }

        #blankReleaseNoteTable th:nth-child(3), #blankReleaseNoteTable td:nth-child(3),
        #lastSprintTable th:nth-child(3), #lastSprintTable td:nth-child(3),
        #blankDescTable th:nth-child(3), #blankDescTable td:nth-child(3) { width: 52px; }

        #blankParentTable th:nth-child(3), #blankParentTable td:nth-child(3) { width: 42px; }

        #tagMissingTable2 th:nth-child(3), #tagMissingTable2 td:nth-child(3),
        #blankDisciplineTable th:nth-child(3), #blankDisciplineTable td:nth-child(3) { width: 72px; overflow: hidden; text-overflow: ellipsis; }

        /* Card table Title column wraps naturally */
        #blankSizeTable td:nth-child(2), #blankReleaseNoteTable td:nth-child(2),
        #blankParentTable td:nth-child(2), #lastSprintTable td:nth-child(2),
        #tagMissingTable2 td:nth-child(2), #blankDisciplineTable td:nth-child(2),
        #blankDescTable td:nth-child(2) { overflow-wrap: anywhere; }

        /* Large tables - non-title columns stay compact */
        #reqListTable, #weekFocusTable, #bugsTable, #sprintGoalReqTable,
        #teamBReqTable, #membersCapacityTable { table-layout: auto; }

        #reqListTable th, #reqListTable td,
        #weekFocusTable th, #weekFocusTable td,
        #bugsTable th, #bugsTable td,
        #sprintGoalReqTable th, #sprintGoalReqTable td,
        #teamBReqTable th, #teamBReqTable td,
        #membersCapacityTable th, #membersCapacityTable td { white-space: nowrap; }

        /* Title columns wrap for readable text */
        #reqListTable td:nth-child(2), #weekFocusTable td:nth-child(2),
        #bugsTable td:nth-child(2), #sprintGoalReqTable td:nth-child(2),
        #teamBReqTable td:nth-child(2), #membersCapacityTable td:nth-child(1),
        #reqListTable th:nth-child(2), #weekFocusTable th:nth-child(2),
        #bugsTable th:nth-child(2), #sprintGoalReqTable th:nth-child(2),
        #teamBReqTable th:nth-child(2) { white-space: normal; overflow-wrap: break-word; }

        /* Mismatch table (Tab 1) - Title gets remaining space */
        #mismatchTable, #dvMismatchTable { table-layout: fixed; }
    </style>
    <script src="allowed_users.txt"></script>
</head>
<body data-theme="dark">
    <!-- Warning for sandboxed/no-script environments -->
    <noscript>
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:#1e293b;z-index:99999;display:flex;align-items:center;justify-content:center;">
            <div style="background:#334155;padding:40px;border-radius:12px;max-text-align:center;color:#e2e8f0;font-family:'Inter',system-ui,sans-serif;">
                <div style="font-size:48px;margin-bottom:20px;">‚ö†Ô∏è</div>
                <h2 style="color:#f87171;margin:0 0 16px 0;">JavaScript Required</h2>
                <p style="margin:0 0 20px 0;color:#94a3b8;line-height:1.6;">
                    This dashboard requires JavaScript to fetch data from TFS and display reports.
                </p>
                <p style="margin:0 0 20px 0;color:#fbbf24;font-weight:600;">
                    Please download this file and open it directly in your browser.
                </p>
                <div style="background:#1e293b;padding:16px;border-radius:8px;margin-top:20px;">
                    <p style="margin:0;color:#94a3b8;font-size:14px;">
                        <strong style="color:#60a5fa;">How to:</strong><br>
                        1. Right-click ‚Üí Save As / Download<br>
                        2. Open the downloaded .html file in Chrome/Edge
                    </p>
                </div>
            </div>
        </div>
    </noscript>

    <!-- API Stats Display -->
    <div class="api-stats" id="apiStats">API Calls: <span id="apiCallCount">0</span></div>

    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div id="loadingText" style="margin-top: 16px; color: #94a3b8;">Loading...</div>
    </div>

    <!-- Config Panel -->
    <div class="config-panel" id="configPanel">
        <h2>üîó Connect to TFS</h2>
        <div class="config-field">
            <label>TFS Server URL</label>
            <input type="text" id="tfsUrl" value="https://tfs.casepoint.in/tfs/Casepoint">
        </div>
        <div class="config-field">
            <label>Personal Access Token</label>
            <input type="password" id="pat" placeholder="Enter your PAT" onblur="autoFetchProjects()">
            <div id="patUserInfo" style="display:none; margin-top:6px; padding:8px 10px; background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3); border-radius:6px; font-size:0.75rem;">
                <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
                    <span style="color:#34d399; font-weight:600;">‚úÖ Authenticated as:</span>
                    <span id="patUserName" style="color:#e2e8f0;"></span>
                    <span id="patUserEmail" style="color:#94a3b8; font-size:0.7rem;"></span>
                    <span id="patUserId" style="color:#64748b; font-size:0.65rem;"></span>
                </div>
            </div>
        </div>
        <div class="config-field">
            <label>Projects <span style="font-size: 0.7rem; color: #94a3b8;">(Select multiple projects)</span></label>
            <div id="projectCheckboxContainer" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px; max-height: 200px; overflow-y: auto;">
                <div style="color: #94a3b8; font-size: 0.85rem;">-- Enter PAT to load projects --</div>
            </div>
            <div id="projectStatus" style="font-size: 0.75rem; margin-top: 6px; color: #94a3b8;"></div>
            <div id="selectedProjects" style="font-size: 0.75rem; margin-top: 6px; color: #60a5fa;"></div>
        </div>
        <button class="btn btn-primary" onclick="connectTFS()">üöÄ Connect</button>
        <div id="errorMsg"></div>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel" id="filterPanel" style="max-width: 1100px;">
        <h3>üìÅ Select Area & Sprint</h3>
        <div class="filter-row" style="align-items: flex-start;">
            <div class="filter-field" style="flex: 1.2; min-width: 280px;">
                <label>Area Path <span style="font-size: 0.7rem; color: #94a3b8;">(Select up to 3 areas)</span> <a href="#" onclick="toggleAllAreas(event)" style="font-size: 0.7rem; color: #34d399; margin-left: 8px;">Select All</a></label>
                <div id="areaCheckboxContainer" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px; max-height: 400px; overflow-y: auto;">
                    <div style="color: #94a3b8; font-size: 0.85rem;">-- Loading areas --</div>
                </div>
                <div style="margin-top: 8px; display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="exactAreaMatch" Checked style="width: 16px; height: 16px; cursor: pointer;">
                    <label for="exactAreaMatch" style="font-size: 0.75rem; color: #fbbf24; cursor: pointer;" title="When checked, only fetch items with exact area path match. Useful to exclude child areas like 'eCase Platform' when selecting 'eCase'.">
                        ‚ö° Exact Area Match <span style="color: #94a3b8;">(excludes child areas)</span>
                    </label>
                </div>
                <div id="selectedAreas" style="font-size: 0.75rem; margin-top: 6px; color: #60a5fa;"></div>
            </div>
            <div class="filter-field" style="flex: 1.5; min-width: 400px;">
                <label>Sprint / Iteration <span style="font-size: 0.7rem; color: #94a3b8;">(Select one or more sprints)</span></label>
                <div id="iterationCheckboxContainer" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; padding: 10px; max-height: 400px; overflow-y: auto;">
                    <div style="color: #94a3b8; font-size: 0.85rem;">-- Loading iterations --</div>
                </div>
                <div id="selectedIterations" style="font-size: 0.75rem; margin-top: 6px; color: #60a5fa;"></div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px; padding-top: 20px;">
                <button class="btn btn-success" onclick="loadData()">üìä Load Data</button>
                <button class="btn btn-secondary" onclick="resetConnection()">üîô Back</button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content" id="content">
        <div class="header">
            <div>
                <h1>üìä Sprint Requirements Dashboard</h1>
                <div class="header-info">
                    <span>Area: <span class="highlight" id="hdrArea">-</span></span>
                    <span>Sprint: <span class="highlight" id="hdrSprint">-</span></span>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-secondary" id="themeToggleBtn" onclick="toggleTheme()" style="padding: 8px 12px; font-size: 0.85rem;" title="Toggle Light/Dark Theme">üåô</button>
                <button class="btn btn-secondary" id="refreshBtn" onclick="refreshData()">üîÑ Refresh</button>
                <button class="btn btn-secondary" onclick="showFilters()">üîß Change Filters</button>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation" style="display: flex; gap: 4px; margin-bottom: 16px; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 8px;">
            <button class="tab-btn active" id="tabBtn1" onclick="switchTab(1)" style="padding: 8px 16px; font-size: 0.8rem; background: rgba(59,130,246,0.3); border: 1px solid rgba(59,130,246,0.5); border-radius: 6px 6px 0 0; color: #93c5fd; cursor: pointer; transition: all 0.2s;">üìã Sprint Planning</button>
            <button class="tab-btn" id="tabBtn2" onclick="switchTab(2)" style="padding: 8px 16px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px 6px 0 0; color: #94a3b8; cursor: pointer; transition: all 0.2s;">üìà Work Progress</button>
            <button class="tab-btn" id="tabBtn3" onclick="switchTab(3)" style="padding: 8px 16px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px 6px 0 0; color: #94a3b8; cursor: pointer; transition: all 0.2s;">ü§ñ AI Usage</button>
        </div>

        <!-- Tab 1: Sprint Planning Check -->
        <div class="tab-content" id="tabContent1">

        <!-- Summary Stats -->
        <div class="summary-row">
            <div class="summary-stat blue"><div class="value" id="statTotalReq">0</div><div class="label">Total Req/CR</div></div>
            <div class="summary-stat green"><div class="value" id="statDeliverable">0</div><div class="label">Deliverable</div></div>
            <div class="summary-stat orange"><div class="value" id="statNonDeliverable">0</div><div class="label">Non-Deliverable</div></div>
            <div class="summary-stat red"><div class="value" id="statBugs">0</div><div class="label">Bugs</div></div>
            <div class="summary-stat cyan"><div class="value" id="statUrnIn">0</div><div class="label">URN-IN</div></div>
            <div class="summary-stat pink"><div class="value" id="statUrnCf">0</div><div class="label">URN-CF</div></div>
            <div class="summary-stat gray"><div class="value" id="statBlankDesc">0</div><div class="label">Blank Desc</div></div>
        </div>

        <!-- Charts Row - Compact Layout -->
        <div class="dashboard-section" style="grid-template-columns: repeat(2, 1fr); gap: 16px;">
            <div class="dashboard-card" style="padding: 14px;">
                <h3 style="font-size: 0.85rem; margin-bottom: 10px;">üìà Deliverable vs Non-Deliverable (Size)</h3>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div class="chart-container" style="height: 100px; width: 100px; flex-shrink: 0;">
                        <div class="css-doughnut" id="sizeChart" style="width: 100px; height: 100px;"></div>
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(59,130,246,0.15); border-radius: 6px;">
                                <span style="font-size: 0.7rem; color: #94a3b8;">üü¢ Deliverable</span>
                                <span style="font-size: 0.9rem; font-weight: 700; color: #3b82f6;" id="chartDelSize">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(168,85,247,0.15); border-radius: 6px;">
                                <span style="font-size: 0.7rem; color: #94a3b8;">üü† Non-Deliverable</span>
                                <span style="font-size: 0.9rem; font-weight: 700; color: #a855f7;" id="chartNonDelSize">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(148,163,184,0.1); border-radius: 6px;">
                                <span style="font-size: 0.7rem; color: #94a3b8;">üìä Total</span>
                                <span style="font-size: 0.9rem; font-weight: 700; color: #94a3b8;" id="chartTotalSize">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ratio-bar-container" style="margin-top: 10px;">
                    <div class="ratio-bar-labels" style="font-size: 0.65rem;">
                        <span>Del: <strong id="lblDelSize">0</strong> (<span id="lblDelPct">0%</span>)</span>
                        <span>Non-Del: <strong id="lblNonDelSize">0</strong> (<span id="lblNonDelPct">0%</span>)</span>
                    </div>
                    <div class="ratio-bar" style="height: 20px; border-radius: 10px;">
                        <div class="segment deliverable-seg" id="barDel" style="width:0%"></div>
                        <div class="segment non-deliverable-seg" id="barNonDel" style="width:0%"></div>
                    </div>
                </div>
            </div>
            <div class="dashboard-card" style="padding: 14px;">
                <h3 style="font-size: 0.85rem; margin-bottom: 10px;">üìä Deliverable vs Non-Deliverable (Task Est) <span style="color: #64748b; font-size: 0.55rem;">Discipline: Development & Test only</span></h3>
                <div style="display: flex; align-items: center; gap: 16px;">
                    <div class="chart-container" style="height: 100px; width: 100px; flex-shrink: 0;">
                        <div class="css-doughnut" id="taskEstChart" style="width: 100px; height: 100px;"></div>
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(6,182,212,0.15); border-radius: 6px;">
                                <span style="font-size: 0.7rem; color: #94a3b8;">üü¢ Deliverable</span>
                                <span style="font-size: 0.9rem; font-weight: 700; color: #06b6d4;" id="chartDelTaskEst">0h</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(236,72,153,0.15); border-radius: 6px;">
                                <span style="font-size: 0.7rem; color: #94a3b8;">üü† Non-Deliverable</span>
                                <span style="font-size: 0.9rem; font-weight: 700; color: #ec4899;" id="chartNonDelTaskEst">0h</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; background: rgba(148,163,184,0.1); border-radius: 6px;">
                                <span style="font-size: 0.7rem; color: #94a3b8;">üìä Total</span>
                                <span style="font-size: 0.9rem; font-weight: 700; color: #94a3b8;" id="chartTotalTaskEst">0h</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ratio-bar-container" style="margin-top: 10px;">
                    <div class="ratio-bar-labels" style="font-size: 0.65rem;">
                        <span>Del: <strong id="lblDelTaskEst">0h</strong> (<span id="lblDelTaskEstPct">0%</span>)</span>
                        <span>Non-Del: <strong id="lblNonDelTaskEst">0h</strong> (<span id="lblNonDelTaskEstPct">0%</span>)</span>
                    </div>
                    <div class="ratio-bar" style="height: 20px; border-radius: 10px;">
                        <div class="segment deliverable-seg" id="barDelTaskEst" style="width:0%"></div>
                        <div class="segment non-deliverable-seg" id="barNonDelTaskEst" style="width:0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overall Planned Sprint Data Estimate Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 24px; background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.1)); border: 1px solid rgba(239,68,68,0.3);">
            <h3 style="color: #fca5a5; font-size: 1.1rem;">üìä Overall Planned Sprint Data Estimate</h3>
            <p style="color: #94a3b8; font-size: 0.8rem; margin-bottom: 16px;">Team capacity vs planned work</p>
            
            <!-- Working Days Calculation - Compact -->
            <div style="background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(99,102,241,0.15)); border: 1px solid rgba(59,130,246,0.3); border-radius: 8px; padding: 10px 14px; margin-bottom: 12px;">
                <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 6px; font-size: 0.85rem; color: #e2e8f0;">
                    <span style="color: #93c5fd; font-weight: 600;">üìÖ</span>
                    <span style="background: rgba(59,130,246,0.3); padding: 4px 10px; border-radius: 6px;">
                        <strong id="sprintCalendarDays">0</strong> Cal Days
                    </span>
                    <span style="color: #64748b;">‚àí</span>
                    <span style="background: rgba(239,68,68,0.3); padding: 4px 10px; border-radius: 6px;">
                        <strong id="teamDaysOff">0</strong> Off
                    </span>
                    <span style="color: #64748b;">=</span>
                    <span style="background: rgba(16,185,129,0.3); padding: 4px 10px; border-radius: 6px;">
                        <strong id="sprintWorkDays" style="color: #34d399;">0</strong> Work Days
                    </span>
                    <span id="teamDaysOffDetails" style="display: none; margin-left: 8px; font-size: 0.75rem; color: #94a3b8;">
                        (Off: <span id="teamDaysOffDatesList" style="color: #fbbf24;"></span>)
                    </span>
                </div>
            </div>
            
            <!-- Team Members Capacity -->
            <div style="background: rgba(0,0,0,0.2); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h4 style="color: #93c5fd; font-size: 0.9rem; margin: 0;">üë• Team Members Capacity (<span id="memberCount">0</span>)</h4>
                    <button class="btn btn-primary" id="loadMembersCapBtn" onclick="toggleMembersCapacity()" style="padding: 4px 12px; font-size: 0.75rem;">üìã Show</button>
                </div>
                <div id="membersCapacityContent" style="display: none;">
                    <div style="max-height: 200px; overflow-y: auto;">
                        <table id="membersCapacityTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead id="membersCapacityTableHead" style="background: #0f172a; position: sticky; top: 0; z-index: 1;"></thead>
                            <tbody id="membersCapacityTableBody"></tbody>
                        </table>
                    </div>
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.75rem; background: rgba(0,0,0,0.3); font-weight: 600;">
                        <tr><td style="padding:8px;">TOTAL</td><td style="padding:8px;">-</td><td style="padding:8px;">-</td><td style="padding:8px;">-</td><td style="padding:8px;text-align:center;" id="totalCapPerDay">0h</td><td style="padding:8px;text-align:center;" id="totalDaysOff">0</td><td style="padding:8px;text-align:center;">-</td><td style="padding:8px;text-align:center;color:#34d399;" id="totalTeamCapacity">0h</td></tr>
                    </table>
                    <div id="noMembersData" style="display:none; text-align:center; color:#94a3b8; padding:12px; font-size: 0.7rem;">No capacity data</div>
                </div>
            </div>
            
            <div class="summary-row" style="margin-bottom: 16px;">
                <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3);">
                    <div class="value" id="teamCapacity" style="color: #60a5fa;">0h</div>
                    <div class="label">Team Capacity</div>
                </div>
                <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3);">
                    <div class="value" id="totalPlannedCapacity" style="color: #fbbf24;">0h</div>
                    <div class="label">Total Planned</div>
                </div>
                <div class="summary-stat" style="background: rgba(148,163,184,0.2); border-color: rgba(148,163,184,0.3);">
                    <div class="value" id="almEngExtraHours" style="color: #94a3b8;">0h</div>
                    <div class="label">ALM/TeamB/etc</div>
                </div>
                <div class="summary-stat" style="background: rgba(236,72,153,0.2); border-color: rgba(236,72,153,0.3);">
                    <div class="value" id="uiUxUdHours" style="color: #f472b6;">0h</div>
                    <div class="label">UI/UX & UD</div>
                </div>
                <div class="summary-stat" style="background: rgba(6,182,212,0.2); border-color: rgba(6,182,212,0.3);">
                    <div class="value" id="availableCapacity" style="color: #22d3ee;">0h</div>
                    <div class="label">Available</div>
                </div>
                <div class="summary-stat" id="overPlanStat" style="background: rgba(168,85,247,0.2); border-color: rgba(168,85,247,0.3);">
                    <div class="value" id="overPlannedCapacity" style="color: #c4b5fd;">0h</div>
                    <div class="label">Planned Capacity</div>
                </div>
                <div class="summary-stat" id="overPlanPctStat" style="background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3);">
                    <div class="value" id="overPlanPct" style="color: #f87171;">0%</div>
                    <div class="label">Over Plan %</div>
                </div>
            </div>
            <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-bottom: 16px; font-size: 0.85rem; color: #94a3b8;">
                <strong>Formulas:</strong><br>
                ‚Ä¢ Available Capacity = Team Capacity (<span id="formulaTeamCap">0</span>h) - ALM/TeamB/etc (<span id="formulaAlmEng">0</span>h) - UI/UX&UD (<span id="formulaUiUxUd">0</span>h) = <span id="formulaAvailable" style="color: #22d3ee;">0</span>h<br>
                ‚Ä¢ Over Planned = Total Planned (<span id="formulaTotalPlanned">0</span>h) - ALM/TeamB/etc (<span id="formulaAlmEng2">0</span>h) - UI/UX&UD (<span id="formulaUiUxUd2">0</span>h) = <span id="formulaOverPlanned" style="color: #f87171;">0</span>h<br>
                ‚Ä¢ Over Plan % = (Over Planned - Available) / Available √ó 100
            </div>
            <div id="overPlanAlert" style="display:none; background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(99,102,241,0.15)); border: 1px solid rgba(139,92,246,0.4); border-radius: 8px; padding: 12px; margin-top: 12px;">
                <p style="color: #c4b5fd; font-size: 0.9rem; margin: 0;">ü§ñ <strong>AI Opportunity:</strong> Extended work by <span id="overPlanAlertPct">0%</span> - Use AI tools (Co-Pilot, Claude) to accelerate!</p>
            </div>
            <div id="underPlanAlert" style="display:none; background: rgba(16,185,129,0.2); border: 1px solid rgba(16,185,129,0.4); border-radius: 8px; padding: 12px; margin-top: 12px;">
                <p style="color: #6ee7b7; font-size: 0.9rem; margin: 0;">‚úÖ <strong>Well Planned:</strong> Sprint capacity is balanced.</p>
            </div>
            
            <!-- Development Only Section -->
            <div style="background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.1)); border: 1px solid rgba(16,185,129,0.4); border-radius: 10px; padding: 12px; margin-top: 12px;">
                <h4 style="color: #6ee7b7; font-size: 0.95rem; margin-bottom: 8px;">üíª Development Only <span style="font-size: 0.7rem; color: #94a3b8; font-weight: normal;">(Discipline = Development)</span></h4>
                <div class="summary-row" style="margin-bottom: 0; flex-wrap: wrap; gap: 6px;">
                    <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); min-width: 80px; flex: 1; padding: 8px;">
                        <div class="value" id="devTeamCapacity" style="color: #60a5fa; font-size: 0.95rem;">0h</div>
                        <div class="label" style="font-size: 0.55rem;">Team Capacity</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); min-width: 80px; flex: 1; padding: 8px;">
                        <div class="value" id="devTotalPlanned" style="color: #fbbf24; font-size: 0.95rem;">0h</div>
                        <div class="label" style="font-size: 0.55rem;">Total Planned</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(6,182,212,0.2); border-color: rgba(6,182,212,0.3); min-width: 80px; flex: 1; padding: 8px;">
                        <div class="value" id="devAvailableCapacity" style="color: #22d3ee; font-size: 0.95rem;">0h</div>
                        <div class="label" style="font-size: 0.55rem;">Available</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(168,85,247,0.2); border-color: rgba(168,85,247,0.3); min-width: 80px; flex: 1; padding: 8px;">
                        <div class="value" id="devPlannedCapacity" style="color: #c4b5fd; font-size: 0.95rem;">0h</div>
                        <div class="label" style="font-size: 0.55rem;">Planned</div>
                    </div>
                    <div class="summary-stat" id="devOverPlanPctStat" style="background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); min-width: 80px; flex: 1; padding: 8px;">
                        <div class="value" id="devOverPlanPct" style="color: #f87171; font-size: 0.95rem;">0%</div>
                        <div class="label" style="font-size: 0.55rem;">Over Plan %</div>
                    </div>
                </div>
                
                <!-- Unclassified Category Blocks (by first word) + Adhoc Support -->
                <div style="margin-top: 10px;">
                    <p style="color: #94a3b8; font-size: 0.65rem; margin-bottom: 6px;">üìä Breakdown by Requirement Category:</p>
                    <div style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.08); border-radius: 6px; padding: 6px 8px; margin-bottom: 8px; font-size: 0.58rem; color: #64748b; line-height: 1.5;">
                        <span style="color: #94a3b8; font-weight: 600;">‚ÑπÔ∏è Considered:</span>
                        <span style="color: #6ee7b7;">Deliverable</span> or <span style="color: #60a5fa;">Non-Deliverable</span> Requirements only with child tasks where <span style="color: #c4b5fd;">Discipline = Development</span>.
                        <br><span style="color: #94a3b8; font-weight: 600;">Grouped by:</span> <span style="color: #fbbf24;">Adhoc Support</span> tag ‚Üí "Adhoc Support", otherwise by <span style="color: #22d3ee;">first word</span> of requirement title.
                        <br><span style="color: #94a3b8; font-weight: 600;">Example:</span> <span style="color: #e2e8f0;">ALM Activities ‚Üí "<span style="color: #22d3ee;">ALM</span>" block | Ticket Handling / Ticket Support ‚Üí "<span style="color: #22d3ee;">Ticket</span>" | Engineering Operations &amp; Support ‚Üí "<span style="color: #22d3ee;">Engineering</span>" | rest ‚Üí Unclassified</span>
                    </div>
                    <div id="devCategoryBlocks" class="summary-row" style="margin-bottom: 0; flex-wrap: wrap; gap: 6px;">
                        <!-- Dynamic blocks will be inserted here -->
                    </div>
                    <div style="margin-top: 6px; font-size: 0.65rem; color: #94a3b8;">
                        <span>Total Unclassified: <strong id="devUnclassifiedTotal" style="color: #6ee7b7;">0h</strong></span>
                    </div>
                </div>
                
                <div style="margin-top: 8px; font-size: 0.7rem; color: #94a3b8;">
                    <span style="margin-right: 12px;">üë• Dev Members: <strong id="devMemberCount" style="color: #60a5fa;">0</strong></span>
                    <span>üìã Dev Tasks: <strong id="devTaskCount" style="color: #6ee7b7;">0</strong></span>
                </div>
                <!-- Hidden formula spans for JS updates -->
                <div style="display:none;">
                    <span id="devFormulaTeamCap">0</span>
                    <span id="devFormulaAlmEng">0</span>
                    <span id="devFormulaAvailable">0</span>
                    <span id="devFormulaTotalPlanned">0</span>
                    <span id="devFormulaAlmEng2">0</span>
                    <span id="devFormulaPlanned">0</span>
                    <span id="devFormulaOverPlanPct">0%</span>
                </div>
            </div>
        </div>

        <!-- Sprint Goal Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.1)); border: 1px solid rgba(16,185,129,0.3); padding: 12px;">
            <h3 style="color: #6ee7b7; font-size: 1rem; margin-bottom: 8px;">üéØ Sprint Goal Requirements</h3>
            <div class="summary-row" style="margin-bottom: 10px; gap: 6px;">
                <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 6px;"><div class="value" id="sprintGoalReqCount" style="color: #34d399; font-size: 1.1rem;">0</div><div class="label" style="font-size: 0.55rem;">Requirements</div></div>
                <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); padding: 6px;"><div class="value" id="sprintGoalTaskCount" style="color: #60a5fa; font-size: 1.1rem;">0</div><div class="label" style="font-size: 0.55rem;">Total Tasks</div></div>
                <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 6px;"><div class="value" id="sprintGoalOriginalEst" style="color: #fbbf24; font-size: 1.1rem;">0h</div><div class="label" style="font-size: 0.55rem;">Original Est</div></div>
                <div class="summary-stat" style="background: rgba(6,182,212,0.2); border-color: rgba(6,182,212,0.3); padding: 6px;"><div class="value" id="sprintGoalRemainingWork" style="color: #22d3ee; font-size: 1.1rem;">0h</div><div class="label" style="font-size: 0.55rem;">Remaining</div></div>
                <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 6px;"><div class="value" id="sprintGoalCompletedWork" style="color: #34d399; font-size: 1.1rem;">0h</div><div class="label" style="font-size: 0.55rem;">Completed</div></div>
            </div>
            <div class="ratio-bar-container" style="margin-bottom: 12px;">
                <div class="ratio-bar-labels" style="font-size: 0.85rem; margin-bottom: 4px;"><span>‚úÖ Completed: <strong id="sprintGoalCompPct" style="color: #34d399;">0%</strong></span><span>‚è≥ Remaining: <strong id="sprintGoalRemPct" style="color: #fbbf24;">0%</strong></span></div>
                <div class="ratio-bar" style="height: 16px; border-radius: 8px;">
                    <div class="segment" id="sprintGoalBarComp" style="width:0%; background: linear-gradient(90deg, #10b981, #34d399);"></div>
                    <div class="segment" id="sprintGoalBarRem" style="width:0%; background: linear-gradient(90deg, #f59e0b, #fbbf24);"></div>
                </div>
            </div>
            <table id="sprintGoalReqTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;"><thead style="background: rgba(0,0,0,0.3);"><tr><th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th><th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">State</th><th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Tasks</th><th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Orig Est</th><th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Remaining</th><th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Completed</th></tr></thead><tbody></tbody></table>
            <div id="noSprintGoalData" style="display:none;text-align:center;color:#94a3b8;padding:12px;font-size:0.75rem;">No Sprint Goal requirements</div>
        </div>

        <!-- Alert Dashboards Grid - 2 Column Layout -->
        <div class="dashboard-section" style="grid-template-columns: 1fr 1fr; gap: 12px;">
            <!-- Over 40h Tasks -->
            <div class="dashboard-card alert-card" style="padding: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="font-size: 0.85rem; margin: 0;">‚ö†Ô∏è Tasks >40h (<span id="overEstTaskCount">0</span>)</h3>
                    <button id="refreshOverEstBtn" onclick="refreshOverEstTasksCard()" style="background: rgba(239,68,68,0.3); border: 1px solid rgba(239,68,68,0.5); color: #fca5a5; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">üîÑ</button>
                </div>
                <div style="max-height: 180px; overflow-y: auto;">
                    <table class="mini-table" id="overEstTasksTable" style="font-size: 0.7rem;">
                        <thead style="position: sticky; top: 0; background: #1e293b; z-index: 1;"><tr><th>ID</th><th>Title</th><th>Est</th><th>Assigned</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="noOverEstTasks" style="text-align:center;color:#94a3b8;padding:8px;font-size:0.7rem;">None</div>
            </div>
            
            <!-- Blank Description -->
            <div class="dashboard-card warning-card" style="padding: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="font-size: 0.85rem; margin: 0;">üìù No Desc (<span id="blankDescCount">0</span>)</h3>
                    <button id="refreshBlankDescBtn" onclick="refreshBlankDescCard()" style="background: rgba(245,158,11,0.3); border: 1px solid rgba(245,158,11,0.5); color: #fcd34d; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">üîÑ</button>
                </div>
                <div style="max-height: 180px; overflow-y: auto;">
                    <table class="mini-table" id="blankDescTable" style="font-size: 0.7rem;">
                        <thead style="position: sticky; top: 0; background: #1e293b; z-index: 1;"><tr><th>ID</th><th>Title</th><th>State</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="noBlankDesc" style="text-align:center;color:#94a3b8;padding:8px;font-size:0.7rem;">OK</div>
            </div>
        </div>
        
        <!-- TEAM B Dashboard -->
        <div class="dashboard-card" style="background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1)); border: 1px solid rgba(99,102,241,0.3); padding: 10px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                <h3 style="color: #a5b4fc; font-size: 0.8rem; margin: 0;">üé´ TEAM B (<span id="teamBReqCount">0</span>)</h3>
                <button id="refreshTeamBBtn" onclick="refreshTeamBCard()" style="background: rgba(99,102,241,0.3); border: 1px solid rgba(99,102,241,0.5); color: #a5b4fc; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">üîÑ</button>
            </div>
            <div class="summary-row" style="margin-bottom: 8px; gap: 6px; justify-content: flex-start;">
                <div class="summary-stat" style="padding: 4px; min-width: 50px; flex: 0 0 auto;"><div class="value" id="teamBTaskCount" style="font-size: 0.9rem; color: #34d399;">0</div><div class="label" style="font-size: 0.45rem;">Tasks</div></div>
                <div class="summary-stat" style="padding: 4px; min-width: 50px; flex: 0 0 auto;"><div class="value" id="teamBTotalSize" style="font-size: 0.9rem; color: #c084fc;">0</div><div class="label" style="font-size: 0.45rem;">Size</div></div>
                <div class="summary-stat" style="padding: 4px; min-width: 50px; flex: 0 0 auto;"><div class="value" id="teamBTotalOrigEst" style="font-size: 0.9rem; color: #fbbf24;">0h</div><div class="label" style="font-size: 0.45rem;">Orig Est</div></div>
                <div class="summary-stat" style="padding: 4px; min-width: 50px; flex: 0 0 auto;"><div class="value" id="teamBTotalRemWork" style="font-size: 0.9rem; color: #22d3ee;">0h</div><div class="label" style="font-size: 0.45rem;">Remaining</div></div>
            </div>
            <div style="max-height: 200px; overflow-y: auto;">
                <table id="teamBReqTable" style="width: 100%; border-collapse: collapse; font-size: 0.65rem;">
                    <thead style="background: #1a1f2e; position: sticky; top: 0; z-index: 1;"><tr><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">State</th><th style="padding:4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Tasks</th><th style="padding:4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Size</th><th style="padding:4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Est</th><th style="padding:4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Rem</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="noTeamBData" style="display:none;text-align:center;color:#94a3b8;padding:6px;font-size:0.6rem;">No TEAM B requirements</div>
        </div>

        <!-- Data Quality Dashboards - 2 Column Layout -->
        <div class="dashboard-section" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <!-- 1. Blank/0 Size Dashboard -->
            <div class="dashboard-card" style="background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.1)); border: 1px solid rgba(239,68,68,0.3); padding: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="color: #fca5a5; font-size: 0.8rem; margin: 0;">üìè Blank/0 Size (<span id="blankSizeCount">0</span>)</h3>
                    <button onclick="refreshBlankSizeCard()" style="background: rgba(239,68,68,0.3); border: 1px solid rgba(239,68,68,0.5); color: #fca5a5; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">üîÑ</button>
                </div>
                <p style="color: #94a3b8; font-size: 0.55rem; margin-bottom: 6px;">Del/Non-Del with blank or zero Size</p>
                <div style="max-height: 180px; overflow-y: auto;">
                    <table id="blankSizeTable" style="width: 100%; border-collapse: collapse; font-size: 0.65rem;">
                        <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;"><tr><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th></tr></thead>
                        <tbody id="blankSizeTableBody"></tbody>
                    </table>
                </div>
                <div id="noBlankSizeData" style="display:none;text-align:center;color:#94a3b8;padding:6px;font-size:0.6rem;">All have Size ‚úì</div>
            </div>

            <!-- 2. Blank Release Note Dashboard -->
            <div class="dashboard-card" style="background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(217,119,6,0.1)); border: 1px solid rgba(245,158,11,0.3); padding: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="color: #fcd34d; font-size: 0.8rem; margin: 0;">üìù Blank Release Note (<span id="blankReleaseNoteCount">0</span>)</h3>
                    <button onclick="refreshBlankReleaseNoteCard()" style="background: rgba(245,158,11,0.3); border: 1px solid rgba(245,158,11,0.5); color: #fcd34d; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">üîÑ</button>
                </div>
                <p style="color: #94a3b8; font-size: 0.55rem; margin-bottom: 6px;">Del/Non-Del with blank Release Notes</p>
                <div style="max-height: 180px; overflow-y: auto; overflow-x: hidden;">
                    <table id="blankReleaseNoteTable" style="width: 100%; border-collapse: collapse; font-size: 0.65rem;">
                        <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;"><tr><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">State</th></tr></thead>
                        <tbody id="blankReleaseNoteTableBody"></tbody>
                    </table>
                </div>
                <div id="noBlankReleaseNoteData" style="display:none;text-align:center;color:#94a3b8;padding:6px;font-size:0.6rem;">All have Release Note ‚úì</div>
            </div>
        </div>
        
        <!-- No Parent Dashboard - 2 Column Layout -->
        <div class="dashboard-section" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <!-- 3. Blank Parent/No Parent Dashboard -->
            <div class="dashboard-card" style="background: linear-gradient(135deg, rgba(168,85,247,0.15), rgba(139,92,246,0.1)); border: 1px solid rgba(168,85,247,0.3); padding: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="color: #c4b5fd; font-size: 0.8rem; margin: 0;">üîó No Parent (<span id="blankParentCount">0</span>)</h3>
                    <button onclick="refreshNoParentCard()" style="background: rgba(168,85,247,0.3); border: 1px solid rgba(168,85,247,0.5); color: #c4b5fd; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">üîÑ</button>
                </div>
                <p style="color: #94a3b8; font-size: 0.55rem; margin-bottom: 6px;">Del/Non-Del without Parent link</p>
                <div style="max-height: 180px; overflow-y: auto;">
                    <table id="blankParentTable" style="width: 100%; border-collapse: collapse; font-size: 0.65rem;">
                        <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;"><tr><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Cat</th></tr></thead>
                        <tbody id="blankParentTableBody"></tbody>
                    </table>
                </div>
                <div id="noBlankParentData" style="display:none;text-align:center;color:#94a3b8;padding:6px;font-size:0.6rem;">All have Parent ‚úì</div>
            </div>
            
            <!-- Last Sprint Open Items Dashboard -->
            <div class="dashboard-card" style="padding: 10px; background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(217,119,6,0.1)); border: 1px solid rgba(245,158,11,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="color: #fcd34d; font-size: 0.8rem; margin: 0;">üìã Last Sprint Open (<span id="lastSprintOpenCount">0</span>)</h3>
                    <button onclick="refreshLastSprintOpenCard()" style="background: rgba(245,158,11,0.3); border: 1px solid rgba(245,158,11,0.5); color: #fcd34d; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">üîÑ</button>
                </div>
                <p style="color: #94a3b8; font-size: 0.55rem; margin-bottom: 6px;">Prev sprint items NOT Closed</p>
                <div id="lastSprintContent" style="margin-top: 6px;">
                    <div style="max-height: 180px; overflow-y: auto;">
                        <table id="lastSprintTable" style="width: 100%; border-collapse: collapse; font-size: 0.65rem;">
                            <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;"><tr><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">State</th></tr></thead>
                            <tbody id="lastSprintTableBody"></tbody>
                        </table>
                    </div>
                    <div id="noLastSprintData" style="display:none; text-align:center; color:#94a3b8; padding:6px; font-size: 0.6rem;">No open items ‚úì</div>
                </div>
            </div>
        </div>

        <!-- Tag Missing & Blank Discipline - 2 Column Layout -->
        <div class="dashboard-section" style="grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
            <!-- Tag Missing Dashboard -->
            <div class="dashboard-card" style="padding: 10px; background: linear-gradient(135deg, rgba(6,182,212,0.15), rgba(8,145,178,0.1)); border: 1px solid rgba(6,182,212,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="color: #67e8f9; font-size: 0.8rem; margin: 0;">üè∑Ô∏è Tag Missing (<span id="tagMissingCount">0</span>)</h3>
                    <button onclick="refreshTagMissingCard()" style="background: rgba(6,182,212,0.3); border: 1px solid rgba(6,182,212,0.5); color: #67e8f9; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">üîÑ</button>
                </div>
                <p style="color: #94a3b8; font-size: 0.55rem; margin-bottom: 4px;">Dev Tasks missing required tags</p>
                <p style="color: #67e8f9; font-size: 0.5rem; margin-bottom: 6px; font-style: italic;">Tags: Product | ALM | Training | Support | Bug/Maintenance</p>
                <div id="tagMissingContent" style="margin-top: 6px;">
                    <div style="max-height: 180px; overflow-y: auto; overflow-x: hidden;">
                        <table id="tagMissingTable2" style="width: 100%; border-collapse: collapse; font-size: 0.65rem;">
                            <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;"><tr><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Assigned</th></tr></thead>
                            <tbody id="tagMissingTableBody2"></tbody>
                        </table>
                    </div>
                    <div id="noTagMissingData2" style="display:none;text-align:center;color:#94a3b8;padding:6px;font-size:0.6rem;">All have tags ‚úì</div>
                </div>
            </div>

            <!-- Blank Discipline Dashboard -->
            <div class="dashboard-card" style="padding: 10px; background: linear-gradient(135deg, rgba(168,85,247,0.15), rgba(139,92,246,0.1)); border: 1px solid rgba(168,85,247,0.3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                    <h3 style="color: #c4b5fd; font-size: 0.8rem; margin: 0;">‚ö†Ô∏è Blank Discipline (<span id="blankDisciplineCount">0</span>)</h3>
                    <button onclick="refreshBlankDisciplineCard()" style="background: rgba(168,85,247,0.3); border: 1px solid rgba(168,85,247,0.5); color: #c4b5fd; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; cursor: pointer;" title="Refresh this card">üîÑ</button>
                </div>
                <p style="color: #94a3b8; font-size: 0.55rem; margin-bottom: 6px;">Dev Tasks with empty Discipline</p>
                <div id="blankDisciplineContent" style="margin-top: 6px;">
                    <div style="max-height: 180px; overflow-y: auto; overflow-x: hidden;">
                        <table id="blankDisciplineTable" style="width: 100%; border-collapse: collapse; font-size: 0.65rem;">
                            <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;"><tr><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th><th style="padding:4px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Assigned</th></tr></thead>
                            <tbody id="blankDisciplineTableBody"></tbody>
                        </table>
                    </div>
                    <div id="noBlankDisciplineData" style="display:none;text-align:center;color:#94a3b8;padding:6px;font-size:0.6rem;">All have Discipline ‚úì</div>
                </div>
            </div>
        </div>


        <!-- Requirements List -->
        <div class="table-section" style="padding: 12px;">
            <div class="table-header" style="margin-bottom: 8px;">
                <h3 style="font-size: 1rem;">üìã Requirements List</h3>
                <button class="btn btn-primary" id="loadReqListBtn" onclick="toggleRequirementsList()" style="padding: 4px 12px; font-size: 0.75rem;">üìã Show</button>
            </div>
            <div id="reqListContent" style="display: none;">
                <div class="table-tabs" style="gap: 4px; margin-bottom: 8px; flex-wrap: wrap;">
                    <button class="table-tab active" onclick="filterTable('all', this)" style="padding: 4px 8px; font-size: 0.7rem;">All</button>
                    <button class="table-tab" onclick="filterTable('deliverable', this)" style="padding: 4px 8px; font-size: 0.7rem;">Deliverable</button>
                    <button class="table-tab" onclick="filterTable('nonDeliverable', this)" style="padding: 4px 8px; font-size: 0.7rem;">Non-Deliverable</button>
                    <button class="table-tab" onclick="filterTable('deliverablesAdhoc', this)" style="padding: 4px 8px; font-size: 0.7rem; background: rgba(168,85,247,0.2); color: #d8b4fe;">Deliverables Adhoc</button>
                    <button class="table-tab" onclick="filterTable('deliverablesOnHold', this)" style="padding: 4px 8px; font-size: 0.7rem; background: rgba(245,158,11,0.2); color: #fcd34d;">Deliverables OnHold</button>
                    <button class="table-tab" onclick="filterTable('adhocSupport', this)" style="padding: 4px 8px; font-size: 0.7rem;">Adhoc Support</button>
                    <button class="table-tab" onclick="filterTable('affectOthers', this)" style="padding: 4px 8px; font-size: 0.7rem;">Affect Others</button>
                    <button class="table-tab" onclick="filterTable('affectedArea', this)" style="padding: 4px 8px; font-size: 0.7rem;">Affected Area</button>
                    <button class="table-tab" onclick="filterTable('urnIn', this)" style="padding: 4px 8px; font-size: 0.7rem;">URN-IN</button>
                    <button class="table-tab" onclick="filterTable('urnCf', this)" style="padding: 4px 8px; font-size: 0.7rem;">URN-CF</button>
                    <button class="table-tab" onclick="filterTable('urnMissing', this)" style="padding: 4px 8px; font-size: 0.7rem;">URN ‚ùå</button>
                    <button class="table-tab" onclick="filterTable('noWeeklyTag', this)" style="padding: 4px 8px; font-size: 0.7rem; background: rgba(239,68,68,0.2); color: #fca5a5;">No Weekly Tag</button>
                </div>
                <table id="reqListTable" style="font-size: 0.75rem; width: 100%; border-collapse: collapse;">
                    <thead id="reqListTableHead" style="background: rgba(0,0,0,0.3);"></thead>
                    <tbody id="reqTable"></tbody>
                </table>
                <div id="noData" style="display:none;text-align:center;color:#94a3b8;padding:20px;font-size:0.75rem;">No requirements</div>
            </div>
        </div>
        </div><!-- End Tab 1 -->

        <!-- Tab 2: Work Item Progress -->
        <div class="tab-content" id="tabContent2" style="display: none;">

        <!-- Weekly Progress Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(99,102,241,0.1)); border: 1px solid rgba(59,130,246,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #93c5fd; font-size: 1rem; margin: 0;">üìÖ Weekly Progress Tracker</h3>
                <button class="btn btn-primary" id="loadWeeklyBtn" onclick="toggleWeeklyProgress()" style="padding: 4px 12px; font-size: 0.75rem;">üìä Show</button>
            </div>
            <div id="weeklyProgressContent" style="display: none;">
                <p style="color: #94a3b8; font-size: 0.75rem; margin-bottom: 12px;">
                    Track sprint delivery by week tags (Week 1, Week 2, Week 3, Week 4) - 
                    <span style="background: rgba(59,130,246,0.3); padding: 2px 6px; border-radius: 4px; color: #93c5fd;">Deliverable</span> items only | Status: Resolved/Closed = Done
                </p>
                
                <!-- Sprint Status Banner -->
                <div id="sprintStatusBanner" style="background: linear-gradient(135deg, rgba(16,185,129,0.3), rgba(5,150,105,0.2)); border: 1px solid rgba(16,185,129,0.5); border-radius: 10px; padding: 12px 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <span id="sprintStatusIcon" style="font-size: 2rem;">üöÄ</span>
                        <div>
                            <div id="sprintStatusText" style="font-size: 1.1rem; font-weight: 700; color: #34d399;">ON TRACK</div>
                            <div id="sprintStatusDesc" style="font-size: 0.7rem; color: #94a3b8;">Sprint delivery is progressing as expected</div>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-size: 0.65rem; color: #94a3b8;">Progress vs Expected</div>
                        <div style="display: flex; align-items: baseline; gap: 4px;">
                            <span id="actualProgress" style="font-size: 1.5rem; font-weight: 700; color: #34d399;">0%</span>
                            <span style="color: #94a3b8; font-size: 0.8rem;">vs</span>
                            <span id="expectedProgress" style="font-size: 1rem; color: #94a3b8;">0%</span>
                        </div>
                        <div style="font-size: 0.65rem; color: #94a3b8;">Variance: <span id="progressVariance" style="color: #34d399;">+0%</span></div>
                    </div>
                </div>
                
                <!-- Weekly Summary Grid -->
                <div class="summary-row" style="margin-bottom: 12px; gap: 8px;">
                    <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); padding: 8px; flex: 1;">
                        <div class="value" style="font-size: 1rem; color: #60a5fa;"><span id="week1Done">0</span>/<span id="week1Total">0</span></div>
                        <div class="label" style="font-size: 0.6rem;">Week 1</div>
                        <div style="font-size: 0.55rem; color: #94a3b8;" id="week1Dates"></div>
                    </div>
                    <div class="summary-stat" style="background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.3); padding: 8px; flex: 1;">
                        <div class="value" style="font-size: 1rem; color: #a78bfa;"><span id="week2Done">0</span>/<span id="week2Total">0</span></div>
                        <div class="label" style="font-size: 0.6rem;">Week 2</div>
                        <div style="font-size: 0.55rem; color: #94a3b8;" id="week2Dates"></div>
                    </div>
                    <div class="summary-stat" style="background: rgba(236,72,153,0.2); border-color: rgba(236,72,153,0.3); padding: 8px; flex: 1;">
                        <div class="value" style="font-size: 1rem; color: #f472b6;"><span id="week3Done">0</span>/<span id="week3Total">0</span></div>
                        <div class="label" style="font-size: 0.6rem;">Week 3</div>
                        <div style="font-size: 0.55rem; color: #94a3b8;" id="week3Dates"></div>
                    </div>
                    <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 8px; flex: 1;">
                        <div class="value" style="font-size: 1rem; color: #fbbf24;"><span id="week4Done">0</span>/<span id="week4Total">0</span></div>
                        <div class="label" style="font-size: 0.6rem;">Week 4</div>
                        <div style="font-size: 0.55rem; color: #94a3b8;" id="week4Dates"></div>
                    </div>
                    <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 8px; flex: 1;">
                        <div class="value" style="font-size: 1rem; color: #34d399;"><span id="weekTotalDone">0</span>/<span id="weekTotalAll">0</span></div>
                        <div class="label" style="font-size: 0.6rem;">Overall</div>
                        <div style="font-size: 0.55rem; color: #34d399;" id="weekOverallPct">0%</div>
                    </div>
                </div>
                
                <!-- Current Week Focus Items -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #fbbf24; font-size: 0.9rem; margin: 0;">üéØ Current Week Focus Items (<span id="focusItemCount">0</span>)</h4>
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <span style="color: #94a3b8; font-size: 0.7rem; margin-right: 4px;">Filter:</span>
                            <button onclick="filterFocusItems('all')" id="focusFilterAll" class="focus-filter-btn active" style="background: rgba(139,92,246,0.4); border: 1px solid rgba(139,92,246,0.6); color: #c4b5fd; padding: 3px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">All</button>
                            <button onclick="filterFocusItems('week1')" id="focusFilterWeek1" class="focus-filter-btn" style="background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.4); color: #93c5fd; padding: 3px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Week 1</button>
                            <button onclick="filterFocusItems('week2')" id="focusFilterWeek2" class="focus-filter-btn" style="background: rgba(16,185,129,0.2); border: 1px solid rgba(16,185,129,0.4); color: #6ee7b7; padding: 3px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Week 2</button>
                            <button onclick="filterFocusItems('week3')" id="focusFilterWeek3" class="focus-filter-btn" style="background: rgba(245,158,11,0.2); border: 1px solid rgba(245,158,11,0.4); color: #fcd34d; padding: 3px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Week 3</button>
                            <button onclick="filterFocusItems('week4')" id="focusFilterWeek4" class="focus-filter-btn" style="background: rgba(236,72,153,0.2); border: 1px solid rgba(236,72,153,0.4); color: #f9a8d4; padding: 3px 10px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Week 4</button>
                        </div>
                    </div>
                    <!-- Progress Summary Bar -->
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="color: #34d399; font-size: 0.75rem;">‚úì Completed:</span>
                            <span id="focusCompletedPct" style="color: #34d399; font-weight: 600; font-size: 0.85rem;">0%</span>
                        </div>
                        <div style="flex: 1; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden;">
                            <div id="focusProgressBar" style="height: 100%; background: linear-gradient(90deg, #10b981, #34d399); width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="color: #f472b6; font-size: 0.75rem;">‚è≥ Remaining:</span>
                            <span id="focusRemainingPct" style="color: #f472b6; font-weight: 600; font-size: 0.85rem;">0%</span>
                        </div>
                    </div>
                    <div style="max-height: 350px; overflow-y: auto;">
                        <table id="weekFocusTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;"><tr>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">State</th>
                                <th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Week</th>
                                <th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Original</th>
                                <th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Remaining</th>
                                <th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Completed</th>
                                <th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Progress</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Assigned</th>
                            </tr></thead>
                            <tbody id="weekFocusTableBody"></tbody>
                        </table>
                    </div>
                    <div id="noFocusItems" style="display:none; text-align:center; color:#94a3b8; padding:10px; font-size: 0.75rem;">No focus items</div>
                </div>
                
                <div id="noWeeklyData" style="display:none; text-align:center; color:#94a3b8; padding:12px; font-size: 0.75rem;">No Deliverable requirements with weekly tags found</div>
            </div>
        </div>

        <!-- Bugs Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.1)); border: 1px solid rgba(239,68,68,0.3); padding: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="color: #fca5a5; font-size: 1rem; margin: 0;">üêõ Bugs (<span id="bugCount">0</span>)</h3>
                <button class="btn btn-primary" id="toggleBugsBtn" onclick="toggleBugsDashboard()" style="padding: 4px 12px; font-size: 0.75rem;">üìã Show</button>
            </div>
            <div id="bugsContent" style="display: none;">
                <!-- Filter Buttons -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 8px;">
                    <div style="display: flex; gap: 4px; align-items: center;">
                        <span style="color: #94a3b8; font-size: 0.7rem; margin-right: 4px;">Filter:</span>
                        <button onclick="filterBugs('all')" id="bugFilterAll" style="background: rgba(239,68,68,0.4); border: 1px solid rgba(239,68,68,0.6); color: #fca5a5; padding: 4px 12px; border-radius: 6px; font-size: 0.72rem; cursor: pointer; font-weight: 600;">All</button>
                        <button onclick="filterBugs('cs')" id="bugFilterCS" style="background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.4); color: #93c5fd; padding: 4px 12px; border-radius: 6px; font-size: 0.72rem; cursor: pointer;">üéß CS</button>
                        <button onclick="filterBugs('production')" id="bugFilterProduction" style="background: rgba(245,158,11,0.2); border: 1px solid rgba(245,158,11,0.4); color: #fcd34d; padding: 4px 12px; border-radius: 6px; font-size: 0.72rem; cursor: pointer;">üöÄ Production</button>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="summary-row" style="margin-bottom: 10px; gap: 8px;">
                    <div class="summary-stat" style="padding: 8px; background: rgba(239,68,68,0.2); border: 1px solid rgba(239,68,68,0.3);">
                        <div class="value" id="bugTotalCount" style="font-size: 1.2rem; color: #f87171;">0</div>
                        <div class="label" style="font-size: 0.6rem; color: #fca5a5;">Total</div>
                    </div>
                    <div class="summary-stat" style="padding: 8px; background: rgba(16,185,129,0.2); border: 1px solid rgba(16,185,129,0.3);">
                        <div class="value" id="bugClosedCount" style="font-size: 1.2rem; color: #34d399;">0</div>
                        <div class="label" style="font-size: 0.6rem; color: #6ee7b7;">Closed</div>
                    </div>
                    <div class="summary-stat" style="padding: 8px; background: rgba(245,158,11,0.2); border: 1px solid rgba(245,158,11,0.3);">
                        <div class="value" id="bugActiveCount" style="font-size: 1.2rem; color: #fbbf24;">0</div>
                        <div class="label" style="font-size: 0.6rem; color: #fcd34d;">Active</div>
                    </div>
                    <div class="summary-stat" style="padding: 8px; background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.3);">
                        <div class="value" id="bugResolvedCount" style="font-size: 1.2rem; color: #60a5fa;">0</div>
                        <div class="label" style="font-size: 0.6rem; color: #93c5fd;">Resolved</div>
                    </div>
                    <div class="summary-stat" style="padding: 8px; background: rgba(59,130,246,0.2); border: 1px solid rgba(59,130,246,0.3);">
                        <div class="value" id="bugCSCount" style="font-size: 1.2rem; color: #60a5fa;">0</div>
                        <div class="label" style="font-size: 0.6rem; color: #93c5fd;">üéß CS</div>
                    </div>
                    <div class="summary-stat" style="padding: 8px; background: rgba(245,158,11,0.2); border: 1px solid rgba(245,158,11,0.3);">
                        <div class="value" id="bugProductionCount" style="font-size: 1.2rem; color: #fbbf24;">0</div>
                        <div class="label" style="font-size: 0.6rem; color: #fcd34d;">üöÄ Prod</div>
                    </div>
                </div>
                
                <!-- Bugs Table -->
                <div style="max-height: 280px; overflow-y: auto;">
                    <table id="bugsTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                        <thead style="background: #0f172a; position: sticky; top: 0; z-index: 1;">
                            <tr>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">ID</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Title</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">State</th>
                                <th style="padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);">Tags</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Severity</th>
                                <th style="padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);">Assigned</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div id="noBugs" style="text-align:center;color:#94a3b8;padding:12px;font-size:0.75rem;">No bugs</div>
            </div>
        </div>

        <!-- Discipline vs Task Execution Type Mismatch Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(220,38,38,0.1)); border: 1px solid rgba(239,68,68,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="color: #fca5a5; font-size: 1rem; margin: 0;">üîÄ Discipline - Manual Task Execution Type</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" id="exportMismatchExcelBtn" onclick="exportMismatchToExcel()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(16,185,129,0.3); border-color: rgba(16,185,129,0.5); display: none;">üì• Excel</button>
                    <button class="btn btn-primary" id="exportMismatchPdfBtn" onclick="exportMismatchToPDF()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); display: none;">üìÑ PDF</button>
                    <button class="btn btn-primary" id="toggleMismatchBtn" onclick="toggleMismatchDashboard()" style="padding: 4px 12px; font-size: 0.75rem;">üìã Show</button>
                </div>
            </div>
            <div id="mismatchContent" style="display: none;">
                <p style="color: #60a5fa; font-size: 0.7rem; margin-bottom: 10px;"><strong>Expected Matrix:</strong> Development ‚Üí AI-Dev* | Test ‚Üí AI-Test* | <span style="color: #94a3b8;">Closed Tasks Only with AI Task Execution Type</span></p>
                <div style="max-height: 280px; overflow-y: auto;">
                    <table id="mismatchTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                        <thead id="mismatchTableHead" style="background: #0f172a; position: sticky; top: 0; z-index: 1;">
                        </thead>
                        <tbody id="mismatchTableBody"></tbody>
                    </table>
                </div>
                <div id="noMismatchData" style="display:none; text-align:center; color:#34d399; padding:12px; font-size: 0.75rem;">‚úì No mismatches found - All tasks have correct discipline-execution type mapping</div>
            </div>
        </div>

        <!-- Discipline Verification Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(37,99,235,0.1)); border: 1px solid rgba(59,130,246,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <h3 style="color: #93c5fd; font-size: 1rem; margin: 0;">üîç Discipline Verification</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" id="exportDisciplineVerifyBtn" onclick="exportDisciplineVerificationToExcel()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(16,185,129,0.3); border-color: rgba(16,185,129,0.5); display: none;">üì• Excel</button>
                    <button class="btn btn-primary" id="exportDisciplineVerifyPdfBtn" onclick="exportDisciplineVerificationToPDF()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); display: none;">üìÑ PDF</button>
                    <button class="btn btn-primary" id="loadDisciplineVerifyBtn" onclick="toggleDisciplineVerification()" style="padding: 4px 12px; font-size: 0.75rem;">üìä Show</button>
                </div>
            </div>
            <div id="disciplineVerifyContent" style="display: none;">
                
                <!-- Query Criteria Display -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <span style="color: #94a3b8;">üìã Source:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Team Members Capacity</span>
                        <span style="color: #64748b;">‚Üí</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Member Discipline</span>
                        <span style="color: #64748b;">vs</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Task Discipline</span>
                        <span style="color: #64748b;">|</span>
                        <span style="color: #94a3b8;">üìå Req:</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 6px; border-radius: 4px; color: #6ee7b7;">Deliverable</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 6px; border-radius: 4px; color: #fcd34d;">Non-Deliverable</span>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="summary-row" style="margin-bottom: 12px; gap: 10px;">
                    <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); padding: 12px;">
                        <div class="value" id="dvMemberCount" style="font-size: 1.2rem; color: #60a5fa;">0</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">Members</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(148,163,184,0.2); border-color: rgba(148,163,184,0.3); padding: 12px;">
                        <div class="value" id="dvTotalTasks" style="font-size: 1.2rem; color: #94a3b8;">0</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">Total Tasks</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 12px;">
                        <div class="value" id="dvMatchedCount" style="font-size: 1.2rem; color: #34d399;">0</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">‚úÖ Matched</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); padding: 12px;">
                        <div class="value" id="dvMismatchedCount" style="font-size: 1.2rem; color: #f87171;">0</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">‚ùå Mismatched</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 12px;">
                        <div class="value" id="dvBlankDisciplineCount" style="font-size: 1.2rem; color: #fbbf24;">0</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">‚ö†Ô∏è Blank Disc.</div>
                    </div>
                </div>
                
                <!-- Mismatched & Blank Discipline Tasks Table -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #f87171; font-size: 0.85rem; margin: 0;">‚ùå Mismatched & ‚ö†Ô∏è Blank Discipline Tasks <span id="dvMismatchTaskCount" style="font-size: 0.75rem; color: #94a3b8;">(0)</span></h4>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table id="dvMismatchTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead id="dvMismatchHead" style="background: rgba(0,0,0,0.3); position: sticky; top: 0; z-index: 1;"></thead>
                            <tbody id="dvMismatchBody"></tbody>
                        </table>
                    </div>
                    <div id="noDVMismatchData" style="display:none;text-align:center;color:#94a3b8;padding:12px;font-size:0.75rem;">‚úÖ No discipline mismatches or blank disciplines found</div>
                </div>
                
            </div>
        </div>

        <!-- Requirement Lookup -->
        <div class="table-section" style="padding: 12px;">
            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                <h3 style="font-size: 1rem; margin: 0;">üîç Requirement Task Lookup</h3>
                <input type="text" id="reqIdInput" placeholder="Enter Requirement ID" style="padding: 6px 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; background: rgba(0,0,0,0.3); color: #fff; width: 150px; height:50px; font-size: 0.8rem;">
                <button class="btn btn-primary" onclick="lookupRequirement()" style="padding: 6px 12px; font-size: 0.75rem;">üîç Lookup</button>
            </div>
            <div id="reqLookupResult"></div>
        </div>

        </div><!-- End Tab 2 -->

        <!-- Tab 3: AI Usage -->
        <div class="tab-content" id="tabContent3" style="display: none;">

        <!-- Dev AI Adoption Data Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(37,99,235,0.1)); border: 1px solid rgba(59,130,246,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #93c5fd; font-size: 1rem; margin: 0;">ü§ñ Dev AI Adoption Data</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" id="exportAIAdoptionBtn" onclick="exportAIAdoptionToExcel()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(16,185,129,0.3); border-color: rgba(16,185,129,0.5); display: none;">üì• Excel</button>
                    <button class="btn btn-primary" id="exportAIAdoptionPdfBtn" onclick="exportAIAdoptionToPDF()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); display: none;">üìÑ PDF</button>
                    <button class="btn btn-primary" id="loadAIAdoptionBtn" onclick="toggleAIAdoptionData()" style="padding: 4px 12px; font-size: 0.75rem;">üìä Show</button>
                </div>
            </div>
            <div id="aiAdoptionContent" style="display: none;">
                
                <!-- Query Criteria Display -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <span style="color: #94a3b8;">üìã Criteria:</span>
                        <span style="background: rgba(139,92,246,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">Discipline = Development</span>
                        <span style="color: #64748b;">‚Üí</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Task</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Resolved/Closed</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 8px; border-radius: 4px; color: #f9a8d4;">Reason ‚â† Rejected</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Orig Est > 0</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(139,92,246,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">TaskExecutionType = AI-Dev* | AI-Test-Auto-*</span>
                        <span style="color: #64748b; margin-left: 8px;">|</span>
                        <span style="color: #94a3b8;">üìå Req/Chr:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Deliverable</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 8px; border-radius: 4px; color: #d8b4fe;">Deliverables Adhoc</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Deliverables OnHold</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Non-Deliverable</span>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="summary-row" style="margin-bottom: 12px; gap: 10px;">
                    <div class="summary-stat" style="background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.3); padding: 12px;">
                        <div class="value" id="aiDevMemberCount" style="font-size: 1.2rem; color: #a78bfa;">0</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">Dev Members</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); padding: 12px;">
                        <div class="value" id="aiTotalTasks" style="font-size: 1.2rem; color: #60a5fa;">0</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">Total Tasks</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 12px;">
                        <div class="value" id="aiTotalOrigEst" style="font-size: 1.2rem; color: #fbbf24;">0h</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">Total Orig Est</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 12px;">
                        <div class="value" id="aiTotalCompleted" style="font-size: 1.2rem; color: #34d399;">0h</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">Total Completed</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(6,182,212,0.2); border-color: rgba(6,182,212,0.3); padding: 12px;">
                        <div class="value" id="aiManualEfficiency" style="font-size: 1.2rem; color: #22d3ee;">0%</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">Manual Eff.</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 12px;">
                        <div class="value" id="aiAIEfficiency" style="font-size: 1.2rem; color: #34d399;">0%</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">AI Eff.</div>
                    </div>
                </div>
                
                <!-- Area Filter Pagination -->
                <div id="aiAreaFilterBar" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 8px 10px; margin-bottom: 8px; display: none;">
                    <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
                        <span style="color: #94a3b8; font-size: 0.7rem; margin-right: 4px;">üìç Area:</span>
                        <div id="aiAreaFilterBtns" style="display: flex; gap: 4px; flex-wrap: wrap;"></div>
                    </div>
                </div>
                
                <!-- Member-wise Summary Table -->
                <div id="memberSummarySection" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #c4b5fd; font-size: 0.85rem; margin: 0;">üë• Member-wise Summary</h4>
                        <button onclick="toggleMemberSummary()" id="toggleMemberSummaryBtn" style="background: rgba(139,92,246,0.3); border: 1px solid rgba(139,92,246,0.5); color: #c4b5fd; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; cursor: pointer;">Hide</button>
                    </div>
                    <div id="memberSummaryContent">
                        <table id="aiAdoptionTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem; table-layout: fixed;">
                            <thead id="aiAdoptionTableHead" style="background: rgba(0,0,0,0.3);"></thead>
                            <tbody id="aiAdoptionTableBody"></tbody>
                            <tfoot id="aiAdoptionTableFoot" style="font-weight: 600; background: rgba(139,92,246,0.15);"></tfoot>
                        </table>
                        <div id="noAIAdoptionData" style="display:none; text-align:center; color:#94a3b8; padding:12px; font-size: 0.75rem;">No AI adoption data found</div>
                    </div>
                </div>
                
                <!-- Area-wise Summary Table -->
                <div id="areaSummarySection" style="background: rgba(6,182,212,0.1); border: 1px solid rgba(6,182,212,0.3); border-radius: 8px; padding: 10px; margin-bottom: 12px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #67e8f9; font-size: 0.85rem; margin: 0;">üè∑Ô∏è Area-wise Summary</h4>
                        <button onclick="toggleAreaSummary()" id="toggleAreaSummaryBtn" style="background: rgba(6,182,212,0.3); border: 1px solid rgba(6,182,212,0.5); color: #67e8f9; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; cursor: pointer;">Hide</button>
                    </div>
                    <div id="areaSummaryContent" style="overflow-x: auto;">
                        <table id="areaSummaryTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead id="areaSummaryHead" style="background: rgba(0,0,0,0.3);"></thead>
                            <tbody id="areaSummaryBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Project-wise Summary Table -->
                <div id="projectSummarySection" style="background: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.3); border-radius: 8px; padding: 10px; margin-bottom: 12px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #a5b4fc; font-size: 0.85rem; margin: 0;">üìÅ Project-wise Summary</h4>
                        <button onclick="toggleProjectSummary()" id="toggleProjectSummaryBtn" style="background: rgba(99,102,241,0.3); border: 1px solid rgba(99,102,241,0.5); color: #a5b4fc; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; cursor: pointer;">Hide</button>
                    </div>
                    <div id="projectSummaryContent" style="overflow-x: auto;">
                        <table id="projectSummaryTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead id="projectSummaryHead" style="background: rgba(0,0,0,0.3);"></thead>
                            <tbody id="projectSummaryBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- QA AI Adoption Data Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.1)); border: 1px solid rgba(16,185,129,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #6ee7b7; font-size: 1rem; margin: 0;">üß™ QA AI Adoption Data</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" id="exportQAAIAdoptionBtn" onclick="exportQAAIAdoptionToExcel()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(16,185,129,0.3); border-color: rgba(16,185,129,0.5); display: none;">üì• Excel</button>
                    <button class="btn btn-primary" id="exportQAAIAdoptionPdfBtn" onclick="exportQAAIAdoptionToPDF()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); display: none;">üìÑ PDF</button>
                    <button class="btn btn-primary" id="loadQAAIAdoptionBtn" onclick="toggleQAAIAdoptionData()" style="padding: 4px 12px; font-size: 0.75rem;">üìä Show</button>
                </div>
            </div>
            <div id="qaAIAdoptionContent" style="display: none;">
                
                <!-- Query Criteria Display -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <span style="color: #94a3b8;">üìã Criteria:</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Discipline = Test</span>
                        <span style="color: #64748b;">‚Üí</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Task</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Resolved/Closed</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 8px; border-radius: 4px; color: #f9a8d4;">Reason ‚â† Rejected</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Orig Est > 0</span>
                        <span style="color: #64748b; margin-left: 8px;">|</span>
                        <span style="color: #94a3b8;">üìå Req/Chr:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Deliverable</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 8px; border-radius: 4px; color: #d8b4fe;">Deliverables Adhoc</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Deliverables OnHold</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Non-Deliverable</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;">
                        <span style="color: #94a3b8;">üéØ AI Type:</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">TaskExecutionType ‚Üí AI-Test*</span>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="summary-row" style="margin-bottom: 12px; gap: 10px;">
                    <div class="summary-stat" style="background: rgba(6,182,212,0.2); border-color: rgba(6,182,212,0.3); padding: 12px;">
                        <div class="value" id="qaDevMemberCount" style="font-size: 1.2rem; color: #22d3ee;">0</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">QA Members</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); padding: 12px;">
                        <div class="value" id="qaTotalTasks" style="font-size: 1.2rem; color: #60a5fa;">0</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">Total Tasks</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 12px;">
                        <div class="value" id="qaTotalOrigEst" style="font-size: 1.2rem; color: #fbbf24;">0h</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">Total Orig Est</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 12px;">
                        <div class="value" id="qaTotalCompleted" style="font-size: 1.2rem; color: #34d399;">0h</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">Total Completed</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 12px;">
                        <div class="value" id="qaManualEfficiency" style="font-size: 1.2rem; color: #fcd34d;">0%</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">Manual Eff.</div>
                    </div>
                    <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 12px;">
                        <div class="value" id="qaAIEfficiency" style="font-size: 1.2rem; color: #34d399;">0%</div>
                        <div class="label" style="font-size: 0.7rem; font-weight: 600;">AI Eff.</div>
                    </div>
                </div>
                
                <!-- Member-wise Summary Table -->
                <div id="qaMemberSummarySection" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #67e8f9; font-size: 0.85rem; margin: 0;">üë• QA Member-wise Summary</h4>
                        <button onclick="toggleQAMemberSummary()" id="toggleQAMemberSummaryBtn" style="background: rgba(6,182,212,0.3); border: 1px solid rgba(6,182,212,0.5); color: #67e8f9; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; cursor: pointer;">Hide</button>
                    </div>
                    <div id="qaMemberSummaryContent">
                        <table id="qaAIAdoptionTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem; table-layout: fixed;">
                            <thead id="qaAIAdoptionTableHead" style="background: rgba(0,0,0,0.3);"></thead>
                            <tbody id="qaAIAdoptionTableBody"></tbody>
                            <tfoot id="qaAIAdoptionTableFoot" style="font-weight: 600; background: rgba(6,182,212,0.15);"></tfoot>
                        </table>
                        <div id="noQAAIAdoptionData" style="display:none; text-align:center; color:#94a3b8; padding:12px; font-size: 0.75rem;">No QA AI adoption data found</div>
                    </div>
                </div>
                
                <!-- QA Area-wise Summary Table -->
                <div id="qaAreaSummarySection" style="background: rgba(168,85,247,0.1); border: 1px solid rgba(168,85,247,0.3); border-radius: 8px; padding: 10px; margin-bottom: 12px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #c4b5fd; font-size: 0.85rem; margin: 0;">üè∑Ô∏è QA Area-wise Summary</h4>
                        <button onclick="toggleQAAreaSummary()" id="toggleQAAreaSummaryBtn" style="background: rgba(168,85,247,0.3); border: 1px solid rgba(168,85,247,0.5); color: #c4b5fd; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; cursor: pointer;">Hide</button>
                    </div>
                    <div id="qaAreaSummaryContent" style="overflow-x: auto;">
                        <table id="qaAreaSummaryTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead id="qaAreaSummaryHead" style="background: rgba(0,0,0,0.3);"></thead>
                            <tbody id="qaAreaSummaryBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- QA Project-wise Summary Table -->
                <div id="qaProjectSummarySection" style="background: rgba(99,102,241,0.1); border: 1px solid rgba(99,102,241,0.3); border-radius: 8px; padding: 10px; margin-bottom: 12px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="color: #a5b4fc; font-size: 0.85rem; margin: 0;">üìÅ QA Project-wise Summary</h4>
                        <button onclick="toggleQAProjectSummary()" id="toggleQAProjectSummaryBtn" style="background: rgba(99,102,241,0.3); border: 1px solid rgba(99,102,241,0.5); color: #a5b4fc; padding: 2px 8px; border-radius: 4px; font-size: 0.65rem; cursor: pointer;">Hide</button>
                    </div>
                    <div id="qaProjectSummaryContent" style="overflow-x: auto;">
                        <table id="qaProjectSummaryTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem;">
                            <thead id="qaProjectSummaryHead" style="background: rgba(0,0,0,0.3);"></thead>
                            <tbody id="qaProjectSummaryBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overall AI Adoption Summary -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(5,150,105,0.1)); border: 1px solid rgba(16,185,129,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #6ee7b7; font-size: 1rem; margin: 0;">üìä Overall AI Adoption Summary</h3>
                <button class="btn btn-primary" id="loadOverallSummaryBtn" onclick="toggleOverallAISummary()" style="padding: 4px 12px; font-size: 0.75rem;">üìä Show</button>
            </div>
            <div id="overallAISummaryContent" style="display: none;">
                
                <!-- Query Criteria -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <span style="color: #94a3b8;">üìã Criteria:</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">All Disciplines</span>
                        <span style="color: #64748b;">‚Üí</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Task</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Resolved/Closed</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 8px; border-radius: 4px; color: #f9a8d4;">Reason ‚â† Rejected</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Orig Est > 0</span>
                        <span style="color: #64748b; margin-left: 8px;">|</span>
                        <span style="color: #94a3b8;">üìå Req/Chr:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Deliverable</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 8px; border-radius: 4px; color: #d8b4fe;">Deliverables Adhoc</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 8px; border-radius: 4px; color: #fcd34d;">Deliverables OnHold</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Non-Deliverable</span>
                    </div>
                </div>
                
                <!-- Row 1: Task Counts & AI Adoption Rate -->
                <div style="margin-bottom: 8px;">
                    <div style="color: #94a3b8; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">üìã Task Overview</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(59,130,246,0.2); border-color: rgba(59,130,246,0.3); padding: 14px;">
                            <div class="value" id="oasOverallTasks" style="font-size: 1.4rem; color: #60a5fa;">0</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">Overall Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.3); padding: 14px;">
                            <div class="value" id="oasAiTasks" style="font-size: 1.4rem; color: #a78bfa;">0</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">AI Adopted Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(245,158,11,0.2); border-color: rgba(245,158,11,0.3); padding: 14px;">
                            <div class="value" id="oasManualTasks" style="font-size: 1.4rem; color: #fbbf24;">0</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">Manual Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.2); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="oasMaiIneffTasks" style="font-size: 1.4rem; color: #fca5a5;">0</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">MAI-Ineff Tasks</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(16,185,129,0.2); border-color: rgba(16,185,129,0.3); padding: 14px;">
                            <div class="value" id="oasAiAdoptionRate" style="font-size: 1.4rem; color: #34d399;">0%</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">AI Adoption Rate</div>
                        </div>
                    </div>
                </div>
                
                <!-- Row 2: AI Hours -->
                <div style="margin-bottom: 8px;">
                    <div style="color: #c4b5fd; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">ü§ñ AI Hours Breakdown</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(139,92,246,0.15); border-color: rgba(139,92,246,0.3); padding: 14px;">
                            <div class="value" id="oasAiOrigEst" style="font-size: 1.3rem; color: #c4b5fd;">0h</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">AI Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(168,85,247,0.15); border-color: rgba(168,85,247,0.3); padding: 14px;">
                            <div class="value" id="oasAiRevisedEst" style="font-size: 1.3rem; color: #d8b4fe;">0h</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">AI Revised Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(59,130,246,0.15); border-color: rgba(59,130,246,0.3); padding: 14px;">
                            <div class="value" id="oasAiTotalOrigEst" style="font-size: 1.3rem; color: #60a5fa;">0h</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">Total AI Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.3); padding: 14px;">
                            <div class="value" id="oasAiCompleted" style="font-size: 1.3rem; color: #34d399;">0h</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">AI Completed</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(6,182,212,0.15); border-color: rgba(6,182,212,0.3); padding: 14px;">
                            <div class="value" id="oasAiEfficiency" style="font-size: 1.3rem; color: #22d3ee;">0%</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">AI Efficiency</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(236,72,153,0.15); border-color: rgba(236,72,153,0.3); padding: 14px;">
                            <div class="value" id="oasAiHoursSaved" style="font-size: 1.3rem; color: #f472b6;">0h</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">Hours Saved</div>
                        </div>
                    </div>
                </div>
                
                <!-- Row 3: MAI-Ineff Hours -->
                <div style="margin-bottom: 8px;">
                    <div style="color: #fca5a5; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">‚ö†Ô∏è Manual-AI-Ineffective Hours Breakdown</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="oasMaiIneffOrigEst" style="font-size: 1.3rem; color: #fca5a5;">0h</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">MAI-Ineff Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="oasMaiIneffCompleted" style="font-size: 1.3rem; color: #fb7185;">0h</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">MAI-Ineff Completed</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="oasMaiIneffEfficiency" style="font-size: 1.3rem; color: #22d3ee;">0%</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">MAI-Ineff Efficiency</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); padding: 14px;">
                            <div class="value" id="oasMaiIneffHoursSaved" style="font-size: 1.3rem; color: #f472b6;">0h</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">Hours Saved</div>
                        </div>
                    </div>
                </div>
                
                <!-- Row 4: Manual Hours -->
                <div>
                    <div style="color: #fcd34d; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; padding-left: 4px;">üîß Manual Hours Breakdown</div>
                    <div class="summary-row" style="gap: 10px;">
                        <div class="summary-stat" style="background: rgba(245,158,11,0.15); border-color: rgba(245,158,11,0.3); padding: 14px;">
                            <div class="value" id="oasManualOrigEst" style="font-size: 1.3rem; color: #fbbf24;">0h</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">Manual Orig Est</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.3); padding: 14px;">
                            <div class="value" id="oasManualCompleted" style="font-size: 1.3rem; color: #34d399;">0h</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">Manual Completed</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(6,182,212,0.15); border-color: rgba(6,182,212,0.3); padding: 14px;">
                            <div class="value" id="oasManualEfficiency" style="font-size: 1.3rem; color: #22d3ee;">0%</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">Manual Efficiency</div>
                        </div>
                        <div class="summary-stat" style="background: rgba(236,72,153,0.15); border-color: rgba(236,72,153,0.3); padding: 14px;">
                            <div class="value" id="oasManualHoursSaved" style="font-size: 1.3rem; color: #f472b6;">0h</div>
                            <div class="label" style="font-size: 0.7rem; font-weight: 600;">Hours Saved</div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>

        <!-- AI-Enabled Disciplines Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(217,119,6,0.1)); border: 1px solid rgba(245,158,11,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #fcd34d; font-size: 1rem; margin: 0;">üìä AI-Enabled Disciplines</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" id="exportOverallAIAdoptionBtn" onclick="exportOverallAIAdoptionToExcel()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(16,185,129,0.3); border-color: rgba(16,185,129,0.5); display: none;">üì• Excel</button>
                    <button class="btn btn-primary" id="exportOverallAIAdoptionPdfBtn" onclick="exportOverallAIAdoptionToPDF()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); display: none;">üìÑ PDF</button>
                    <button class="btn btn-primary" id="loadOverallAIAdoptionBtn" onclick="toggleOverallAIAdoptionData()" style="padding: 4px 12px; font-size: 0.75rem;">üìä Show</button>
                </div>
            </div>
            <div id="overallAIAdoptionContent" style="display: none;">
                
                <!-- Query Criteria Display -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                        <span style="color: #94a3b8;">üìã Parent:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Requirement/Change Request</span>
                        <span style="color: #64748b;">with tag =</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 6px; border-radius: 4px; color: #6ee7b7;">Deliverable</span>
                        <span style="color: #64748b;">|</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 6px; border-radius: 4px; color: #d8b4fe;">Deliverables Adhoc</span>
                        <span style="color: #64748b;">|</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 6px; border-radius: 4px; color: #fcd34d;">Deliverables OnHold</span>
                        <span style="color: #64748b;">|</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 6px; border-radius: 4px; color: #f9a8d4;">Non-Deliverable</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;">
                        <span style="color: #94a3b8;">üìã Task:</span>
                        <span style="background: rgba(139,92,246,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">TaskExecutionType = AI-*</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Resolved/Closed</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 8px; border-radius: 4px; color: #f9a8d4;">Reason ‚â† Rejected</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Orig Est > 0</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;">
                        <span style="color: #94a3b8;">üîç AI Tool:</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">Claude AI</span>
                        <span style="color: #64748b;">vs</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #22d3ee;">GitHub Copilot</span>
                        <span style="color: #64748b;">| Based on "Claude AI" tag</span>
                    </div>
                </div>
                
                <!-- Discipline-wise Summary Table -->
                <div id="overallDisciplineSummarySection" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                    <h4 style="color: #fcd34d; font-size: 0.85rem; margin: 0 0 10px 0;">üìà AI-Enabled Disciplines Summary</h4>
                    <div style="overflow-x: auto;">
                        <table id="overallAIAdoptionTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem; table-layout: fixed;">
                            <thead id="overallAIAdoptionTableHead" style="background: rgba(0,0,0,0.3);"></thead>
                            <tbody id="overallAIAdoptionTableBody"></tbody>
                            <tfoot id="overallAIAdoptionTableFoot" style="font-weight: 600; background: rgba(16,185,129,0.15);"></tfoot>
                        </table>
                        <div id="noOverallAIAdoptionData" style="display:none; text-align:center; color:#94a3b8; padding:12px; font-size: 0.75rem;">No AI-Enabled tasks found.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TaskExecutionType AI Adoption Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(168,85,247,0.1)); border: 1px solid rgba(139,92,246,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #c4b5fd; font-size: 1rem; margin: 0;">‚ö° Task Execution Type AI Adoption</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" id="exportExecTypeAIAdoptionBtn" onclick="exportExecTypeAIAdoptionToExcel()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(16,185,129,0.3); border-color: rgba(16,185,129,0.5); display: none;">üì• Excel</button>
                    <button class="btn btn-primary" id="exportExecTypeAIAdoptionPdfBtn" onclick="exportExecTypeAIAdoptionToPDF()" style="padding: 4px 12px; font-size: 0.75rem; background: rgba(239,68,68,0.3); border-color: rgba(239,68,68,0.5); display: none;">üìÑ PDF</button>
                    <button class="btn btn-primary" id="loadExecTypeAIAdoptionBtn" onclick="toggleExecTypeAIAdoptionData()" style="padding: 4px 12px; font-size: 0.75rem;">üìä Show</button>
                </div>
            </div>
            <div id="execTypeAIAdoptionContent" style="display: none;">
                
                <!-- Query Criteria Display -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                        <span style="color: #94a3b8;">üìã Parent:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Requirement/CR</span>
                        <span style="color: #64748b;">tag =</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 6px; border-radius: 4px; color: #6ee7b7;">Deliverable</span>
                        <span style="color: #64748b;">|</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 6px; border-radius: 4px; color: #d8b4fe;">Deliverables Adhoc</span>
                        <span style="color: #64748b;">|</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 6px; border-radius: 4px; color: #fcd34d;">Deliverables OnHold</span>
                        <span style="color: #64748b;">|</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 6px; border-radius: 4px; color: #f9a8d4;">Non-Deliverable</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;">
                        <span style="color: #94a3b8;">üìã Task:</span>
                        <span style="background: rgba(139,92,246,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">TaskExecutionType = AI-*</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Resolved/Closed</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 8px; border-radius: 4px; color: #f9a8d4;">Reason ‚â† Rejected</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Orig Est > 0</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;">
                        <span style="color: #94a3b8;">üîç AI Tool:</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">Claude AI</span>
                        <span style="color: #64748b;">vs</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #22d3ee;">GitHub Copilot</span>
                        <span style="color: #64748b;">| Based on "Claude AI" tag</span>
                    </div>
                </div>
                
                <!-- TaskExecutionType-wise Summary Table -->
                <div id="execTypeSummarySection" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                    <h4 style="color: #c4b5fd; font-size: 0.85rem; margin: 0 0 10px 0;">üìà TaskExecutionType-wise Summary</h4>
                    <div style="overflow-x: auto;">
                        <table id="execTypeAIAdoptionTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem; table-layout: fixed;">
                            <thead id="execTypeAIAdoptionTableHead" style="background: rgba(0,0,0,0.3);"></thead>
                            <tbody id="execTypeAIAdoptionTableBody"></tbody>
                            <tfoot id="execTypeAIAdoptionTableFoot" style="font-weight: 600; background: rgba(139,92,246,0.15);"></tfoot>
                        </table>
                        <div id="noExecTypeAIAdoptionData" style="display:none; text-align:center; color:#94a3b8; padding:12px; font-size: 0.75rem;">No TaskExecutionType data found.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project-wise AI Adoption Dashboard -->
        <div class="dashboard-card" style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, rgba(6,182,212,0.15), rgba(34,211,238,0.1)); border: 1px solid rgba(6,182,212,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h3 style="color: #22d3ee; font-size: 1rem; margin: 0;">üè¢ Project-wise AI Adoption</h3>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-primary" id="loadProjectAIAdoptionBtn" onclick="toggleProjectAIAdoptionData()" style="padding: 4px 12px; font-size: 0.75rem;">üìä Show</button>
                </div>
            </div>
            <div id="projectAIAdoptionContent" style="display: none;">
                
                <!-- Query Criteria Display -->
                <div style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px; font-size: 0.7rem;">
                    <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
                        <span style="color: #94a3b8;">üìã Parent:</span>
                        <span style="background: rgba(59,130,246,0.3); padding: 2px 8px; border-radius: 4px; color: #93c5fd;">Requirement/CR</span>
                        <span style="color: #64748b;">tag =</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 6px; border-radius: 4px; color: #6ee7b7;">Deliverable</span>
                        <span style="color: #64748b;">|</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 6px; border-radius: 4px; color: #d8b4fe;">Deliverables Adhoc</span>
                        <span style="color: #64748b;">|</span>
                        <span style="background: rgba(245,158,11,0.3); padding: 2px 6px; border-radius: 4px; color: #fcd34d;">Deliverables OnHold</span>
                        <span style="color: #64748b;">|</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 6px; border-radius: 4px; color: #f9a8d4;">Non-Deliverable</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;">
                        <span style="color: #94a3b8;">üìã Task:</span>
                        <span style="background: rgba(139,92,246,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">TaskExecutionType = AI-*</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(16,185,129,0.3); padding: 2px 8px; border-radius: 4px; color: #6ee7b7;">Resolved/Closed</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(236,72,153,0.3); padding: 2px 8px; border-radius: 4px; color: #f9a8d4;">Reason ‚â† Rejected</span>
                        <span style="color: #64748b;">+</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #67e8f9;">Orig Est > 0</span>
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-top: 6px;">
                        <span style="color: #94a3b8;">üîç AI Tool:</span>
                        <span style="background: rgba(168,85,247,0.3); padding: 2px 8px; border-radius: 4px; color: #c4b5fd;">Claude AI</span>
                        <span style="color: #64748b;">vs</span>
                        <span style="background: rgba(6,182,212,0.3); padding: 2px 8px; border-radius: 4px; color: #22d3ee;">GitHub Copilot</span>
                        <span style="color: #64748b;">| Based on "Claude AI" tag</span>
                    </div>
                </div>
                
                <!-- Project-wise Summary Table -->
                <div id="projectSummarySection" style="background: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px; margin-bottom: 12px;">
                    <h4 style="color: #22d3ee; font-size: 0.85rem; margin: 0 0 10px 0;">üìà Project-wise Summary</h4>
                    <div style="overflow-x: auto;">
                        <table id="projectAIAdoptionTable" style="width: 100%; border-collapse: collapse; font-size: 0.75rem; table-layout: fixed;">
                            <thead id="projectAIAdoptionTableHead" style="background: rgba(0,0,0,0.3);"></thead>
                            <tbody id="projectAIAdoptionTableBody"></tbody>
                            <tfoot id="projectAIAdoptionTableFoot" style="font-weight: 600; background: rgba(6,182,212,0.15);"></tfoot>
                        </table>
                        <div id="noProjectAIAdoptionData" style="display:none; text-align:center; color:#94a3b8; padding:12px; font-size: 0.75rem;">No Project-wise AI data found.</div>
                    </div>
                </div>
            </div>
        </div>
        </div><!-- End Tab 3 -->
    </div>

    <script>
        // ============================================
        // OPTIMIZED TFS SPRINT DASHBOARD V4
        // Key Optimizations:
        // 1. REDUCED WIQL queries from 9 to 3 (tag filtering done in JS)
        // 2. Batch API calls (max 200 per request)
        // 3. Build task-parent mapping once
        // 4. Cache and reuse data
        // 5. Parallel API calls with Promise.all
        // 6. No external libraries (CSS charts)
        // 7. Auto-fetch projects on PAT blur
        // 8. DEFERRED: Weekly Progress Dashboard (on button click)
        // 9. DEFERRED: Last Sprint Data (on button click)
        // 10. DEFERRED: Requirements List render (on button click)
        // 11. DEFERRED: Discipline Checks (on button click)
        // 12. DEFERRED: Members Capacity details (on button click)
        // 13. Weekly tag tracking (Week1-4) for delivery status
        // 14. Light/Dark Theme Toggle
        // API CALL REDUCTION: 6 fewer WIQL queries vs V3
        // ============================================

        // ==================== THEME MANAGEMENT ====================
        function toggleTheme() {
            const body = document.body;
            const btn = document.getElementById('themeToggleBtn');
            const isLight = body.classList.toggle('light-theme');
            body.setAttribute('data-theme', isLight ? 'light' : 'dark');
            btn.textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
            btn.title = isLight ? 'Switch to Dark Theme' : 'Switch to Light Theme';
            localStorage.setItem('sprintTrackerTheme', isLight ? 'light' : 'dark');
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('sprintTrackerTheme');
            const btn = document.getElementById('themeToggleBtn');
            
            // Default is DARK theme (no class added, data-theme="dark")
            // Only apply light theme if explicitly saved
            if (savedTheme === 'light') {
                document.body.classList.add('light-theme');
                document.body.setAttribute('data-theme', 'light');
                if (btn) {
                    btn.textContent = '‚òÄÔ∏è';
                    btn.title = 'Switch to Dark Theme';
                }
            } else {
                // Ensure dark theme (remove light-theme class if present)
                document.body.classList.remove('light-theme');
                document.body.setAttribute('data-theme', 'dark');
                if (btn) {
                    btn.textContent = 'üåô';
                    btn.title = 'Switch to Light Theme';
                }
                // Set dark as default in storage if not set
                if (!savedTheme) {
                    localStorage.setItem('sprintTrackerTheme', 'dark');
                }
            }
        }

        // Initialize theme on page load
        document.addEventListener('DOMContentLoaded', initTheme);
        // ==================== END THEME MANAGEMENT ====================

        let tfsUrl = '', project = '', config = { headers: null };
        let areas = [], iterations = [], requirements = [], bugs = [], tasks = [];
        let taskParentMap = {}; // Map: taskId -> parentId (built once)
        let reqTasksMap = {};   // Map: reqId -> [task objects]
        let apiCallCount = 0;

        // AI Adoption sorting state
        let aiAdoptionMemberData = []; // Store member results for sorting
        let aiAdoptionSortField = 'name';
        let aiAdoptionSortDir = 'asc';
        let aiAdoptionAreaFilter = 'All'; // Area filter for Dev AI pagination
        let aiAdoptionGrandTotals = {}; // Store grand totals for footer
        
        // QA AI Adoption sorting state
        let qaAIAdoptionMemberData = []; // Store QA member results for sorting
        let qaAIAdoptionSortField = 'name';
        let qaAIAdoptionSortDir = 'asc';
        let qaAIAdoptionGrandTotals = {}; // Store QA grand totals for footer
        let qaAIAdoptionDataLoaded = false; // Track if QA AI Adoption is loaded
        
        // Discipline Verification dashboard state
        let dvDataLoaded = false;
        let dvAllTaskData = []; // All processed task data
        let dvSortField = 'assignedTo';
        let dvSortDir = 'asc';
        
        // Area-wise Summary sorting state
        let areaSummaryData = []; // Store area data for sorting
        let areaSortField = 'area';
        let areaSortDir = 'asc';

        // Data containers
        let teamBData = { requirements: [], totalOrigEst: 0, totalSize: 0, totalRemWork: 0, totalCompWork: 0, totalTasks: 0 };
        let sprintGoalData = { requirements: [], totalOrigEst: 0, totalRemWork: 0, totalCompWork: 0, totalTasks: 0 };
        let codeReviewData = { tasks: [], totalOrigEst: 0, done: 0, inProgress: 0, todo: 0 };
        let uiUxUdData = { tasks: [], totalOrigEst: 0 };
        let taskEstByCategory = { deliverableEst: 0, nonDeliverableEst: 0 };
        let weeklyData = { week1: [], week2: [], week3: [], week4: [], noWeekTag: [] };
        let capacityData = { 
            teamCapacity: 0, totalPlannedCapacity: 0, almEngExtraHours: 0, uiUxUdHours: 0,
            availableCapacity: 0, overPlannedCapacity: 0, overPlanPct: 0,
            devTeamCapacity: 0, devMemberCount: 0, devTaskCount: 0, devTotalPlanned: 0,
            devCategoryBreakdown: {}, devUnclassifiedTotal: 0, 
            devAvailableCapacity: 0, devPlannedCapacity: 0, devOverPlanPct: 0,
            sprintCalendarDays: 0, teamDaysOff: 0, teamDaysOffDates: [], memberDaysOff: 0, sprintWorkDays: 0, members: [] 
        };
        let currentFilter = 'all', sprintInfo = { name: '', areaName: '', iterationId: '' };
        let reqListSortField = 'id', reqListSortDir = 'asc'; // Sorting for Requirements List
        let storedSprintStartDate = null; // Store for deferred historical fetch
        let weeklyProgressLoaded = false; // Track if Weekly Progress is loaded

        // PAT Preservation - Load saved credentials on page load
        (function loadSavedCredentials() {
            try {
                const savedTfsUrl = localStorage.getItem('sprintTracker_tfsUrl');
                const savedPat = localStorage.getItem('sprintTracker_pat');
                if (savedTfsUrl) document.getElementById('tfsUrl').value = savedTfsUrl;
                if (savedPat) {
                    document.getElementById('pat').value = savedPat;
                    // Auto-fetch projects after a small delay to allow DOM to settle
                    setTimeout(() => autoFetchProjects(), 500);
                }
            } catch (e) { }
        })();

        // PAT Preservation - Save credentials to localStorage
        function saveCredentials() {
            try {
                const tfsUrl = document.getElementById('tfsUrl').value.trim();
                const pat = document.getElementById('pat').value.trim();
                if (tfsUrl) localStorage.setItem('sprintTracker_tfsUrl', tfsUrl);
                if (pat) localStorage.setItem('sprintTracker_pat', pat);
            } catch (e) { }
        }

        // Helper: Track API calls
        async function apiFetch(url, options = {}) {
            apiCallCount++;
            document.getElementById('apiCallCount').textContent = apiCallCount;
            return fetch(url, { ...options, headers: config.headers });
        }

        // Helper: Format hours
        function fmtH(val) { return (val || 0).toFixed(2); }

        // Helper: Check if task is UI/UX or UD
        function isUiUxUdTask(title) {
            const t = (title || '').toLowerCase();
            return t.startsWith('ui/ux') || t.startsWith('ud ') || t.startsWith('ud-') || t === 'ud';
        }

        // Helper: Batch fetch work items by IDs (max 200 per request)
        async function batchFetchWorkItems(ids, fields) {
            if (!ids || ids.length === 0) return [];
            const fieldStr = fields.join(',');
            const batches = [];
            for (let i = 0; i < ids.length; i += 200) {
                batches.push(ids.slice(i, i + 200).join(','));
            }
            // Parallel fetch all batches (reduces time significantly)
            const responses = await Promise.all(batches.map(batch => 
                apiFetch(`${tfsUrl}/_apis/wit/workitems?ids=${batch}&fields=${fieldStr}&api-version=5.0`)
            ));
            const results = [];
            for (const resp of responses) {
                if (resp.ok) {
                    const data = await resp.json();
                    results.push(...(data.value || []));
                }
            }
            return results;
        }

        // Helper: Batch fetch work items with relations (parallel)
        async function batchFetchWithRelations(ids) {
            if (!ids || ids.length === 0) return [];
            const batches = [];
            for (let i = 0; i < ids.length; i += 200) {
                batches.push(ids.slice(i, i + 200).join(','));
            }
            // Parallel fetch all batches
            const responses = await Promise.all(batches.map(batch => 
                apiFetch(`${tfsUrl}/_apis/wit/workitems?ids=${batch}&$expand=relations&api-version=5.0`)
            ));
            const results = [];
            for (const resp of responses) {
                if (resp.ok) {
                    const data = await resp.json();
                    results.push(...(data.value || []));
                }
            }
            return results;
        }

        // Auto fetch projects on PAT blur
        let projectsFetched = false;
        let isAuthorizedUser = false;
        let selectedProjects = [];
        
        async function autoFetchProjects() {
            const tfsUrlVal = document.getElementById('tfsUrl').value.trim().replace(/\/$/, '');
            const pat = document.getElementById('pat').value.trim();
            if (!tfsUrlVal || !pat || projectsFetched) return;
            
            const container = document.getElementById('projectCheckboxContainer');
            const status = document.getElementById('projectStatus');
            
            container.innerHTML = '<div style="color: #94a3b8; font-size: 0.85rem;">‚è≥ Loading projects...</div>';
            status.textContent = 'Fetching projects...';
            status.style.color = '#94a3b8';
            
            try {
                const headers = { 'Authorization': 'Basic ' + btoa(':' + pat), 'Content-Type': 'application/json' };
                
                // Fetch user profile from TFS connectionData API
                const userInfoDiv = document.getElementById('patUserInfo');
                try {
                    const connResp = await fetch(`${tfsUrlVal}/_apis/connectionData`, { headers });
                    if (connResp.ok) {
                        const connData = await connResp.json();
                        const authUser = connData.authenticatedUser || {};
                        const authzUser = connData.authorizedUser || {};
                        const userName = authUser.providerDisplayName || authUser.displayName || authzUser.providerDisplayName || '-';
                        const userId = authUser.id || '-';
                        
                        // Get email from connectionData properties
                        const props = authUser.properties || {};
                        const authzProps = authzUser.properties || {};
                        const userEmail = props.Mail?.$value || props.ConfirmedNotificationAddress?.$value 
                                       || authzProps.Mail?.$value || authzProps.ConfirmedNotificationAddress?.$value
                                       || props.Account?.$value || '';
                        
                        document.getElementById('patUserName').textContent = userName;
                        document.getElementById('patUserEmail').textContent = userEmail ? `(${userEmail})` : '';
                        document.getElementById('patUserId').textContent = `ID: ${userId}`;
                        
                        // Access control - check user against allowed_users.txt (loaded via script tag)
                        const userNameLower = userName.toLowerCase().replace(/\s+/g, ' ').trim();
                        let accessAllowed = false;
                        if (typeof ALLOWED_USERS_LIST !== 'undefined' && Array.isArray(ALLOWED_USERS_LIST)) {
                            const allowedLower = ALLOWED_USERS_LIST.map(u => u.toLowerCase().replace(/\s+/g, ' ').trim());
                            accessAllowed = allowedLower.includes(userNameLower);
                        }
                        
                        if (!accessAllowed) {
                            userInfoDiv.style.display = 'block';
                            userInfoDiv.style.borderColor = 'rgba(239,68,68,0.5)';
                            userInfoDiv.style.background = 'rgba(239,68,68,0.15)';
                            userInfoDiv.querySelector('span').textContent = 'üö´ Access Denied:';
                            userInfoDiv.querySelector('span').style.color = '#f87171';
                            container.innerHTML = '<div style="color: #f87171; font-size: 0.85rem;">‚õî You are not authorized to access this dashboard.</div>';
                            status.textContent = '';
                            return;
                        }
                        
                        isAuthorizedUser = true;
                        userInfoDiv.style.display = 'block';
                    }
                } catch (connErr) { /* silently skip profile fetch */ }
                
                const resp = await fetch(`${tfsUrlVal}/_apis/projects?api-version=5.0`, { headers });
                if (!resp.ok) throw new Error('Failed to fetch projects');
                
                const data = await resp.json();
                const projects = (data.value || []).sort((a, b) => a.name.localeCompare(b.name));
                
                if (projects.length === 0) {
                    container.innerHTML = '<div style="color: #f87171; font-size: 0.85rem;">-- No projects found --</div>';
                    status.textContent = 'No projects found';
                    status.style.color = '#f87171';
                } else {
                    container.innerHTML = projects.map(p => `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" 
                               onmouseover="this.style.background='rgba(255,255,255,0.1)'" 
                               onmouseout="this.style.background='transparent'">
                            <input type="checkbox" class="project-checkbox" value="${p.name}" onchange="updateSelectedProjects()" 
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #e2e8f0; font-size: 0.85rem;">${p.name}</span>
                        </label>
                    `).join('');
                    status.textContent = `‚úÖ Found ${projects.length} projects - Select projects`;
                    status.style.color = '#34d399';
                    projectsFetched = true;
                    saveCredentials(); // PAT Preservation - save after successful fetch
                }
            } catch (err) {
                container.innerHTML = '<div style="color: #f87171; font-size: 0.85rem;">-- Enter valid PAT --</div>';
                status.textContent = '‚ùå ' + err.message;
                status.style.color = '#f87171';
            }
        }
        
        function updateSelectedProjects() {
            const checkboxes = document.querySelectorAll('.project-checkbox:checked');
            selectedProjects = Array.from(checkboxes).map(cb => cb.value);
            
            // Update display
            const display = document.getElementById('selectedProjects');
            if (selectedProjects.length > 0) {
                display.innerHTML = '‚úì Selected: <strong>' + selectedProjects.join('</strong>, <strong>') + '</strong>';
            } else {
                display.innerHTML = '';
            }
        }

        async function connectTFS() {
            tfsUrl = document.getElementById('tfsUrl').value.trim().replace(/\/$/, '');
            const pat = document.getElementById('pat').value.trim();
            
            if (!tfsUrl || !pat) { showError('Please fill in TFS URL and PAT'); return; }
            if (!isAuthorizedUser) { showError('‚õî Access denied. Your account is not authorized to use this dashboard.'); return; }
            if (selectedProjects.length === 0) { showError('Please select at least one project'); return; }
            
            // Use first selected project as primary
            project = selectedProjects[0];
            
            config.headers = { 'Authorization': 'Basic ' + btoa(':' + pat), 'Content-Type': 'application/json' };
            apiCallCount = 0;
            showLoading('Connecting to ' + selectedProjects.join(' & ') + '...');
            
            try {
                // Fetch areas and iterations from all selected projects
                let allAreas = [];
                let allIterations = [];
                
                for (const proj of selectedProjects) {
                    const [areasResp, iterResp] = await Promise.all([
                        apiFetch(`${tfsUrl}/${proj}/_apis/wit/classificationnodes/areas?$depth=10&api-version=5.0`),
                        apiFetch(`${tfsUrl}/${proj}/_apis/wit/classificationnodes/iterations?$depth=10&api-version=5.0`)
                    ]);
                    
                    if (!areasResp.ok) throw new Error('Connection failed for ' + proj);
                    
                    const projAreas = flattenNodes(await areasResp.json(), [], 0, 'area');
                    const projIterations = flattenNodes(await iterResp.json(), [], 0, 'iteration');
                    
                    // Add project identifier to areas
                    projAreas.forEach(a => {
                        a.project = proj;
                        a.displayName = selectedProjects.length > 1 ? `[${proj}] ${a.name}` : a.name;
                    });
                    
                    // Add project identifier to iterations
                    projIterations.forEach(i => {
                        i.project = proj;
                    });
                    
                    allAreas.push(...projAreas);
                    allIterations.push(...projIterations);
                }
                
                // Sort areas and iterations
                areas = allAreas.sort((a, b) => {
                    // Sort by project first, then by path
                    if (a.project !== b.project) return a.project.localeCompare(b.project);
                    return a.path.localeCompare(b.path);
                });
                
                // EXCLUDED AREAS - These teams are not included in the Area Path dropdown:
                // [CasepointARA] CasepointARA, 508 Compliance Team, Core Framework Web,
                // DA Tools Utilities, DataSite Team, DevOps Team, Global QA, Mobile App,
                // Review Utilities, AI, Document Export, ARA core
                const excludedAreas = [
                    'CasepointARA',
                    '508 Compliance Team',
                    'Core Framework Web',
                    'DA Tools Utilities',
                    'DataSite Team',
                    'Mobile App',
                    'Review Utilities',
                    'Document Export',
                    'AI',
                    'ARA core'
                ];
                
                // Filter out excluded areas
                areas = areas.filter(a => {
                    const areaName = a.name.trim();
                    return !excludedAreas.some(excluded => 
                        areaName.toLowerCase() === excluded.toLowerCase()
                    );
                });
                
                iterations = allIterations.sort((a, b) => a.path.localeCompare(b.path));
                
                // Populate area checkboxes with project groups
                const areaContainer = document.getElementById('areaCheckboxContainer');
                let areaHtml = '';
                
                // Helper function to create area checkbox HTML
                // Default selected areas: Conversion And Processing, Custom Data Parsing under CasepointARA
                const defaultSelectedAreas = ['conversion and processing', 'custom data parsing'];
                const isDefaultArea = (a) => {
                    const areaName = a.name.trim().toLowerCase();
                    return defaultSelectedAreas.some(d => areaName === d);
                };
                
                const createAreaCheckbox = (a, isFirst) => {
                    const projLabel = selectedProjects.length > 1 ? `[${a.project}] ` : '';
                    const shouldCheck = isDefaultArea(a);
                    return `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 5px 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" 
                               onmouseover="this.style.background='rgba(255,255,255,0.1)'" 
                               onmouseout="this.style.background='transparent'">
                            <input type="checkbox" class="area-checkbox" value="${a.path}" data-project="${a.project}" 
                                   ${shouldCheck ? 'checked' : ''} onchange="updateSelectedAreas()"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #e2e8f0; font-size: 0.8rem;">${projLabel}${a.name.trim()}</span>
                        </label>`;
                };
                
                if (selectedProjects.length > 1) {
                    // Group by project
                    selectedProjects.forEach((proj, projIdx) => {
                        const projAreas = areas.filter(a => a.project === proj);
                        if (projAreas.length > 0) {
                            areaHtml += `<div style="background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.3); border-radius: 8px; padding: 8px; margin-bottom: 10px;">
                                <div style="color: #a5b4fc; font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid rgba(99,102,241,0.3);">üìÅ ${proj}</div>`;
                            areaHtml += projAreas.map((a, idx) => createAreaCheckbox(a, projIdx === 0 && idx === 0)).join('');
                            areaHtml += '</div>';
                        }
                    });
                } else {
                    // Single project - simple list
                    areaHtml += areas.map((a, idx) => createAreaCheckbox(a, idx === 0)).join('');
                }
                
                if (areaHtml === '') {
                    areaHtml = '<div style="color: #94a3b8; font-size: 0.85rem; text-align: center; padding: 20px;">No areas found</div>';
                }
                
                areaContainer.innerHTML = areaHtml;
                
                // If no default areas were checked, check the first area as fallback
                const checkedBoxes = document.querySelectorAll('.area-checkbox:checked');
                if (checkedBoxes.length === 0) {
                    const firstCheckbox = document.querySelector('.area-checkbox');
                    if (firstCheckbox) firstCheckbox.checked = true;
                }
                
                updateSelectedAreas();
                
                // Filter iterations to show only last 2 quarters (current + previous)
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth() + 1; // 1-12
                
                // Determine current quarter
                let currentQuarter;
                if (currentMonth <= 3) currentQuarter = 1;
                else if (currentMonth <= 6) currentQuarter = 2;
                else if (currentMonth <= 9) currentQuarter = 3;
                else currentQuarter = 4;
                
                // Calculate previous quarter
                let prevQuarter = currentQuarter - 1;
                let prevYear = currentYear;
                if (prevQuarter === 0) {
                    prevQuarter = 4;
                    prevYear = currentYear - 1;
                }
                
                // Create valid quarter strings (e.g., "2026-Q1", "2025-Q4")
                const currentQStr = `${currentYear}-Q${currentQuarter}`;
                const prevQStr = `${prevYear}-Q${prevQuarter}`;
                
                
                // Filter iterations that match current or previous quarter
                // Pattern: PI-YYYY-QX or YYYY-QX in iteration name
                const filteredIterations = iterations.filter(i => {
                    const name = i.name.trim();
                    // Extract year-quarter pattern from name (e.g., "2026-Q1" from "PI-2026-Q1_2")
                    const match = name.match(/(\d{4})-Q([1-4])/i);
                    if (match) {
                        const iterQStr = `${match[1]}-Q${match[2]}`;
                        return iterQStr === currentQStr || iterQStr === prevQStr;
                    }
                    // Also check for iterations without clear quarter pattern - include them
                    return false;
                });
                
                // OPTIMIZATION: Combine iterations with same name from different projects
                const iterationsByName = {};
                filteredIterations.forEach(i => {
                    const name = i.name.trim();
                    if (!iterationsByName[name]) {
                        iterationsByName[name] = {
                            name: name,
                            paths: [],  // Store all paths (one per project)
                            projects: [],
                            attributes: i.attributes  // Use first iteration's attributes for dates
                        };
                    }
                    iterationsByName[name].paths.push({ path: i.path, project: i.project });
                    iterationsByName[name].projects.push(i.project);
                });
                
                // Convert to array for display
                const combinedIterations = Object.values(iterationsByName);
                
                // Find current sprint in combined iterations (reuse 'now' from above)
                const currentIteration = combinedIterations.find(i => i.attributes?.startDate && i.attributes?.finishDate && 
                    now >= new Date(i.attributes.startDate) && now <= new Date(i.attributes.finishDate));
                
                // Group by quarter for display
                const currentQIterations = combinedIterations.filter(i => {
                    const match = i.name.match(/(\d{4})-Q([1-4])/i);
                    return match && `${match[1]}-Q${match[2]}` === currentQStr;
                });
                const prevQIterations = combinedIterations.filter(i => {
                    const match = i.name.match(/(\d{4})-Q([1-4])/i);
                    return match && `${match[1]}-Q${match[2]}` === prevQStr;
                });
                
                // Build iteration checkboxes with quarter grouping
                const container = document.getElementById('iterationCheckboxContainer');
                let iterHtml = '';
                
                // Helper function to create checkbox HTML for combined iteration
                const createIterCheckbox = (i, isCurrent) => {
                    const d1 = i.attributes?.startDate ? new Date(i.attributes.startDate).toLocaleDateString() : '';
                    const d2 = i.attributes?.finishDate ? new Date(i.attributes.finishDate).toLocaleDateString() : '';
                    // Show project count if multiple projects have this iteration
                    const projInfo = i.projects.length > 1 ? `<span style="color: #60a5fa; font-size: 0.65rem; margin-left: 4px;">(${i.projects.length} projects)</span>` : '';
                    const currentBadge = isCurrent ? '<span style="background: rgba(16,185,129,0.4); color: #34d399; padding: 1px 6px; border-radius: 4px; font-size: 0.65rem; margin-left: 6px;">‚≠ê Current</span>' : '';
                    // Store all paths as JSON in data attribute
                    const pathsJson = JSON.stringify(i.paths).replace(/"/g, '&quot;');
                    return `
                        <label style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; cursor: pointer; border-radius: 4px; transition: background 0.2s;" 
                               onmouseover="this.style.background='rgba(255,255,255,0.1)'" 
                               onmouseout="this.style.background='transparent'">
                            <input type="checkbox" class="iteration-checkbox" value="${i.name}" data-paths="${pathsJson}" 
                                   ${isCurrent ? 'checked' : ''} onchange="updateSelectedIterations()"
                                   style="width: 16px; height: 16px; cursor: pointer;">
                            <span style="color: #e2e8f0; font-size: 0.8rem;">${i.name}</span>
                            ${projInfo}
                            <span style="color: #94a3b8; font-size: 0.7rem;">${d1 ? `(${d1} - ${d2})` : ''}</span>
                            ${currentBadge}
                        </label>`;
                };
                
                // Add current quarter group
                if (currentQIterations.length > 0) {
                    iterHtml += `<div style="background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); border-radius: 8px; padding: 8px; margin-bottom: 10px;">
                        <div style="color: #34d399; font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid rgba(16,185,129,0.3);">üìÖ Current Quarter (${currentQStr})</div>`;
                    iterHtml += currentQIterations.map(i => {
                        const isCurrent = currentIteration && i.name === currentIteration.name;
                        return createIterCheckbox(i, isCurrent);
                    }).join('');
                    iterHtml += '</div>';
                }
                
                // Add previous quarter group
                if (prevQIterations.length > 0) {
                    iterHtml += `<div style="background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); border-radius: 8px; padding: 8px;">
                        <div style="color: #fbbf24; font-size: 0.8rem; font-weight: 600; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid rgba(245,158,11,0.3);">üìÖ Previous Quarter (${prevQStr})</div>`;
                    iterHtml += prevQIterations.map(i => createIterCheckbox(i, false)).join('');
                    iterHtml += '</div>';
                }
                
                if (iterHtml === '') {
                    iterHtml = '<div style="color: #94a3b8; font-size: 0.85rem; text-align: center; padding: 20px;">No iterations found for current/previous quarter</div>';
                }
                
                container.innerHTML = iterHtml;
                
                // Update selected iterations display
                updateSelectedIterations();
                
                hideLoading();
                document.getElementById('configPanel').style.display = 'none';
                document.getElementById('filterPanel').classList.add('visible');
            } catch (err) { hideLoading(); showError(err.message); }
        }

        // Selected areas array
        let selectedAreaPaths = [];
        
        function updateSelectedAreas() {
            const MAX_AREAS = 3;
            const allCheckboxes = document.querySelectorAll('.area-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.area-checkbox:checked');
            
            // If over limit, uncheck the one just clicked
            if (checkedCheckboxes.length > MAX_AREAS) {
                const lastChanged = event?.target;
                if (lastChanged && lastChanged.checked) {
                    lastChanged.checked = false;
                }
            }
            
            const checkedNow = document.querySelectorAll('.area-checkbox:checked');
            selectedAreaPaths = Array.from(checkedNow).map(cb => ({
                path: cb.value,
                project: cb.getAttribute('data-project')
            }));
            
            // Disable unchecked checkboxes when at limit
            const atLimit = selectedAreaPaths.length >= MAX_AREAS;
            allCheckboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.disabled = atLimit;
                    cb.parentElement.style.opacity = atLimit ? '0.4' : '1';
                    cb.parentElement.style.cursor = atLimit ? 'not-allowed' : 'pointer';
                } else {
                    cb.disabled = false;
                    cb.parentElement.style.opacity = '1';
                    cb.parentElement.style.cursor = 'pointer';
                }
            });
            
            // Update display
            const display = document.getElementById('selectedAreas');
            if (selectedAreaPaths.length > 0) {
                const names = selectedAreaPaths.map(p => p.path.split('\\').pop()).join(', ');
                const limitNote = atLimit ? ' <span style="color:#fbbf24;font-size:0.7rem;">(max reached)</span>' : '';
                display.innerHTML = `‚úì Selected: <strong>${selectedAreaPaths.length}</strong>/${MAX_AREAS} area(s) - ${names}${limitNote}`;
            } else {
                display.innerHTML = '<span style="color: #f87171;">Please select at least one area</span>';
            }
        }
        
        // Global helper function to check if a task's area path matches the selected areas
        // This properly handles sibling areas that share a common prefix (e.g., "eCase" vs "eCase Platform")
        function isTaskAreaMatchingSelection(taskAreaPath) {
            if (!taskAreaPath || selectedAreaPaths.length === 0) return true;
            const taskAreaLower = taskAreaPath.toLowerCase();
            const useExactAreaMatch = document.getElementById('exactAreaMatch')?.checked || false;
            
            return selectedAreaPaths.some(a => {
                const selectedAreaLower = a.path.toLowerCase();
                // Always check for exact match first
                if (taskAreaLower === selectedAreaLower) return true;
                
                if (useExactAreaMatch) {
                    // Exact match only - already checked above
                    return false;
                } else {
                    // UNDER match: task area must be a child of the selected area
                    // Child areas have the format: selectedArea\ChildName
                    // We must ensure there's a backslash IMMEDIATELY after the selected area to avoid
                    // matching sibling areas like "eCase\eCase" incorrectly matching "eCase\eCase Platform"
                    return taskAreaLower.startsWith(selectedAreaLower + '\\');
                }
            });
        }
        
        // Toggle all area checkboxes (max 3)
        function toggleAllAreas(event) {
            event.preventDefault();
            const MAX_AREAS = 3;
            const checkboxes = document.querySelectorAll('.area-checkbox');
            const checkedCount = document.querySelectorAll('.area-checkbox:checked').length;
            
            if (checkedCount > 0) {
                // If any are checked, uncheck all
                checkboxes.forEach(cb => cb.checked = false);
                event.target.textContent = 'Select All';
            } else {
                // Check first 3 only
                let count = 0;
                checkboxes.forEach(cb => {
                    cb.checked = count < MAX_AREAS;
                    count++;
                });
                event.target.textContent = 'Deselect All';
            }
            
            updateSelectedAreas();
        }

        // Selected iterations array
        let selectedIterationPaths = [];
        
        function updateSelectedIterations() {
            const checkboxes = document.querySelectorAll('.iteration-checkbox:checked');
            selectedIterationPaths = [];
            
            // Parse the combined iteration paths from each checkbox
            checkboxes.forEach(cb => {
                const pathsJson = cb.getAttribute('data-paths');
                if (pathsJson) {
                    try {
                        const paths = JSON.parse(pathsJson.replace(/&quot;/g, '"'));
                        // Add all paths from this combined iteration
                        paths.forEach(p => selectedIterationPaths.push(p));
                    } catch (e) {
                        console.error('Error parsing iteration paths:', e);
                    }
                }
            });
            
            // Update display - show unique iteration names
            const display = document.getElementById('selectedIterations');
            if (checkboxes.length > 0) {
                const names = Array.from(checkboxes).map(cb => cb.value).join(', ');
                const totalPaths = selectedIterationPaths.length;
                const pathInfo = totalPaths > checkboxes.length ? ` (${totalPaths} project paths)` : '';
                display.innerHTML = `‚úì Selected: <strong>${checkboxes.length}</strong> sprint(s)${pathInfo} - ${names}`;
            } else {
                display.innerHTML = '<span style="color: #f87171;">Please select at least one sprint</span>';
            }
        }

        function flattenNodes(node, list = [], level = 0, nodeType = 'area') {
            if (node.name) {
                let p = node.path || node.name;
                // Clean up path - remove leading backslashes and classification node markers
                p = p.replace(/^\\+/, '');  // Remove leading backslashes
                
                if (nodeType === 'area') {
                    // For areas: \Project\Area\SubArea -> Project\SubArea
                    // Root area: \Project\Area -> Project (fixes FOIAXpress issue)
                    p = p.replace(/\\Area\\/gi, '\\');  // Remove \Area\ in middle (case-insensitive)
                    p = p.replace(/\\Area$/gi, '');     // Remove \Area at end (root area)
                } else {
                    // For iterations: \Project\Iteration\Sprint -> Project\Sprint
                    p = p.replace(/\\Iteration\\/gi, '\\');
                    p = p.replace(/\\Iteration$/gi, '');
                }
                
                list.push({ path: p, name: '  '.repeat(level) + node.name, attributes: node.attributes });
            }
            if (node.children) node.children.forEach(c => flattenNodes(c, list, level + 1, nodeType));
            return list;
        }

        async function loadData() {
            // Get selected areas and iterations from checkboxes
            if (selectedAreaPaths.length === 0) { alert('Please select at least one Area Path'); return; }
            if (selectedIterationPaths.length === 0) { alert('Please select at least one Sprint'); return; }
            
            // Use first selected area's project as primary project
            project = selectedAreaPaths[0].project || project;
            
            // Build area filter for WIQL (supports multiple areas)
            // Check if exact match is enabled (excludes child areas)
            const useExactAreaMatch = document.getElementById('exactAreaMatch')?.checked || false;
            const areaOperator = useExactAreaMatch ? '=' : 'UNDER';
            const areaFilterClauses = selectedAreaPaths.map(a => `[System.AreaPath] ${areaOperator} '${a.path}'`);
            const areaFilter = areaFilterClauses.length > 1 
                ? `(${areaFilterClauses.join(' OR ')})` 
                : areaFilterClauses[0];
            
            // Build iteration filter for WIQL (supports multiple iterations)
            const iterFilterClauses = selectedIterationPaths.map(i => `[System.IterationPath] UNDER '${i.path}'`);
            const iterFilter = iterFilterClauses.length > 1 
                ? `(${iterFilterClauses.join(' OR ')})` 
                : iterFilterClauses[0];
            
            // Get names for display
            const areaNames = selectedAreaPaths.map(a => a.path.split('\\').pop()).join(', ');
            const exactMatchIndicator = useExactAreaMatch ? ' (Exact)' : '';
            // Get unique sprint names (since same sprint from multiple projects now appears once)
            const uniqueSprintNames = [...new Set(selectedIterationPaths.map(i => i.path.split('\\').pop()))];
            const sprintNames = uniqueSprintNames.join(', ');
            sprintInfo = { name: sprintNames, areaName: areaNames + exactMatchIndicator };
            
            // Local variables for backwards compatibility with capacity/team code
            const areaPath = selectedAreaPaths[0].path;
            const iterPath = selectedIterationPaths[0].path;
            
            apiCallCount = 0;
            showLoading(`Fetching data for ${selectedAreaPaths.length} area(s) & ${selectedIterationPaths.length} sprint(s)...`);
            document.getElementById('filterPanel').classList.remove('visible');
            
            try {
                // ====== PHASE 1: Fetch ALL work item IDs (SINGLE WIQL query) ======
                showLoading('Phase 1/3: Fetching work item IDs...');
                
                // ONE query for Reqs + Change Requests + Bugs + Tasks (was 3 separate queries)
                const wiqlResp = await apiFetch(`${tfsUrl}/${project}/_apis/wit/wiql?api-version=5.0`, {
                    method: 'POST', body: JSON.stringify({ query: `SELECT [System.Id] FROM WorkItems WHERE [System.WorkItemType] IN ('Requirement', 'Change Request', 'Bug', 'Task') AND ${areaFilter} AND ${iterFilter}` })
                });
                const wiqlData = await wiqlResp.json();
                const allIds = (wiqlData.workItems || []).map(w => w.id);
                
                // ====== PHASE 2: Batch fetch ALL work items with unified field set ======
                showLoading(`Phase 2/3: Fetching ${allIds.length} work items...`);
                
                // Unified field set (superset of req + bug + task fields)
                const allFields = ['System.Id','System.Title','System.State','System.Reason','System.AssignedTo','System.Tags','System.IterationPath','System.AreaPath','System.Description','System.WorkItemType','Microsoft.VSTS.Scheduling.OriginalEstimate','Microsoft.VSTS.Scheduling.RemainingWork','Microsoft.VSTS.Scheduling.CompletedWork','Microsoft.VSTS.Scheduling.Size','Microsoft.VSTS.Common.Discipline','Microsoft.VSTS.Common.Severity','Casepoint.TFS.CustomFields.TaskExecutionType','Casepoint.TFS.CustomFields.ReleaseNotesCategory','Casepoint.TFS.CustomFields.ReleaseNotes','Casepoint.TFS.CustomFields.RevisedEstimate'];
                
                const allItemData = await batchFetchWorkItems(allIds, allFields);
                
                // Separate by WorkItemType client-side (no extra API calls)
                const reqData = allItemData.filter(w => {
                    const wit = w.fields['System.WorkItemType'];
                    return wit === 'Requirement' || wit === 'Change Request';
                });
                const bugData = allItemData.filter(w => w.fields['System.WorkItemType'] === 'Bug');
                const taskData = allItemData.filter(w => w.fields['System.WorkItemType'] === 'Task');
                
                bugs = bugData;
                tasks = taskData;
                const allReqIds = reqData.map(r => r.id);
                
                // Fetch relations ONLY for requirements (needed for parent-child mapping)
                showLoading(`Phase 2/3: Building relationships for ${allReqIds.length} requirements...`);
                const reqsWithRelations = await batchFetchWithRelations(allReqIds);
                
                // ====== PHASE 3: Build tag-based sets & task-parent mapping ======
                showLoading('Phase 3/3: Processing data & fetching capacity...');
                
                // OPTIMIZATION: Derive tag-based ID sets from fetched data (saves 6 WIQL queries)
                const idSets = {
                    allReqs: new Set(reqData.map(r => r.id)),
                    bugs: new Set(bugData.map(b => b.id)),
                    tasks: new Set(taskData.map(t => t.id)),
                    // Derived from tags in JavaScript instead of separate WIQL queries
                    deliverable: new Set(reqData.filter(r => {
                        const tags = (r.fields['System.Tags'] || '').toLowerCase();
                        return tags.includes('deliverable') && !tags.includes('non-deliverable');
                    }).map(r => r.id)),
                    nonDeliverable: new Set(reqData.filter(r => 
                        (r.fields['System.Tags'] || '').toLowerCase().includes('non-deliverable')
                    ).map(r => r.id)),
                    adhocSupport: new Set(reqData.filter(r => 
                        (r.fields['System.Tags'] || '').toLowerCase().includes('adhoc support')
                    ).map(r => r.id)),
                    affectOthers: new Set(reqData.filter(r => 
                        (r.fields['System.Tags'] || '').toLowerCase().includes('affect others')
                    ).map(r => r.id)),
                    affectedArea: new Set(reqData.filter(r => 
                        (r.fields['System.Tags'] || '').toLowerCase().includes('affected area')
                    ).map(r => r.id)),
                    adhocBugs: new Set(bugData.filter(b => 
                        (b.fields['System.Tags'] || '').toLowerCase().includes('adhoc support')
                    ).map(b => b.id))
                };
                
                // Build task-parent mapping from relations
                taskParentMap = {};
                reqTasksMap = {};
                
                reqsWithRelations.forEach(req => {
                    const childTaskIds = (req.relations || [])
                        .filter(r => r.rel === 'System.LinkTypes.Hierarchy-Forward')
                        .map(r => parseInt(r.url.split('/').pop()));
                    
                    reqTasksMap[req.id] = childTaskIds;
                    childTaskIds.forEach(tid => taskParentMap[tid] = req.id);
                });
                
                // Build set of requirements that have a parent (Hierarchy-Reverse)
                const reqsWithParent = new Set();
                reqsWithRelations.forEach(req => {
                    const hasParent = (req.relations || []).some(r => r.rel === 'System.LinkTypes.Hierarchy-Reverse');
                    if (hasParent) reqsWithParent.add(req.id);
                });
                
                // Create task lookup map
                const taskLookup = {};
                tasks.forEach(t => taskLookup[t.id] = t);
                
                // Process requirements using cached data
                requirements = reqData.map(req => {
                    const tags = (req.fields['System.Tags'] || '').toLowerCase();
                    const category = idSets.deliverable.has(req.id) ? 'deliverable' : 
                                    idSets.nonDeliverable.has(req.id) ? 'nonDeliverable' : 'unclassified';
                    const isAdhocSupport = idSets.adhocSupport.has(req.id);
                    const isAffectOthers = idSets.affectOthers.has(req.id);
                    const isAffectedArea = idSets.affectedArea.has(req.id);
                    const isDeliverablesAdhoc = tags.includes('deliverables adhoc');
                    const isDeliverablesOnHold = tags.includes('deliverables onhold');
                    const urnTag = tags.includes('urn-in') ? 'urnIn' : tags.includes('urn-cf') ? 'urnCf' : 'urnMissing';
                    const hasAffectOthers = tags.includes('affect others');
                    const hasAffectedArea = tags.includes('affected area');
                    const desc = req.fields['System.Description'] || '';
                    
                    // Detect weekly tags (Week 1, Week 2, Week 3, Week 4)
                    const weekTag = tags.includes('week 1') ? 'week1' : 
                                   tags.includes('week 2') ? 'week2' : 
                                   tags.includes('week 3') ? 'week3' : 
                                   tags.includes('week 4') ? 'week4' : null;
                    const hasWeeklyTag = weekTag !== null;
                    
                    // Calculate task hours from cached data (only Development & Test discipline tasks)
                    const childIds = reqTasksMap[req.id] || [];
                    const allowedDisc = ['development', 'test'];
                    const childTasks = childIds.map(id => taskLookup[id]).filter(t => {
                        if (!t) return false;
                        const disc = (t.fields['Microsoft.VSTS.Common.Discipline'] || '').toLowerCase().trim();
                        return allowedDisc.includes(disc);
                    });
                    const taskEstimate = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                    const taskCompletedWork = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0), 0);
                    const taskRemainingWork = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.RemainingWork'] || 0), 0);
                    
                    return {
                        ...req, category, isAdhocSupport, isAffectOthers, isAffectedArea, isDeliverablesAdhoc, isDeliverablesOnHold, urnTag, hasAffectOthers, hasAffectedArea,
                        size: req.fields['Microsoft.VSTS.Scheduling.Size'] || 0,
                        hasDescription: desc.trim().length > 0,
                        hasParent: reqsWithParent.has(req.id),
                        taskEstimate, taskCompletedWork, taskRemainingWork, weekTag, hasWeeklyTag
                    };
                });
                
                // Build weekly data - ONLY Deliverable items
                weeklyData = { week1: [], week2: [], week3: [], week4: [], noWeekTag: [] };
                requirements.filter(req => req.category === 'deliverable').forEach(req => {
                    if (req.weekTag === 'week1') weeklyData.week1.push(req);
                    else if (req.weekTag === 'week2') weeklyData.week2.push(req);
                    else if (req.weekTag === 'week3') weeklyData.week3.push(req);
                    else if (req.weekTag === 'week4') weeklyData.week4.push(req);
                    else weeklyData.noWeekTag.push(req);
                });
                
                // Calculate UI/UX & UD tasks
                uiUxUdData = { tasks: [], totalOrigEst: 0 };
                tasks.filter(t => isUiUxUdTask(t.fields['System.Title'])).forEach(t => {
                    uiUxUdData.tasks.push(t);
                    uiUxUdData.totalOrigEst += t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                });
                
                // Calculate task estimates by category
                taskEstByCategory = { deliverableEst: 0, nonDeliverableEst: 0 };
                requirements.forEach(req => {
                    if (req.category === 'deliverable') taskEstByCategory.deliverableEst += req.taskEstimate;
                    else if (req.category === 'nonDeliverable') taskEstByCategory.nonDeliverableEst += req.taskEstimate;
                });
                
                // TEAM B - Requirements with "Ticket Support" or "Ticket Handling"
                teamBData = { requirements: [], totalOrigEst: 0, totalSize: 0, totalRemWork: 0, totalCompWork: 0, totalTasks: 0 };
                requirements.filter(r => {
                    const title = (r.fields['System.Title'] || '').toLowerCase();
                    return title.includes('ticket support') || title.includes('ticket handling');
                }).forEach(req => {
                    const childIds = reqTasksMap[req.id] || [];
                    const childTasks = childIds.map(id => taskLookup[id]).filter(t => t);
                    const origEst = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                    const remWork = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.RemainingWork'] || 0), 0);
                    const compWork = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0), 0);
                    const size = req.fields['Microsoft.VSTS.Scheduling.Size'] || 0;
                    
                    teamBData.requirements.push({ ...req, taskCount: childTasks.length, taskIds: childIds, originalEstimate: origEst, size: size, remainingWork: remWork, completedWork: compWork });
                    teamBData.totalTasks += childTasks.length;
                    teamBData.totalOrigEst += origEst;
                    teamBData.totalSize += size;
                    teamBData.totalRemWork += remWork;
                    teamBData.totalCompWork += compWork;
                });
                
                // Sprint Goal - Requirements with "Sprint Goal" tag
                sprintGoalData = { requirements: [], totalOrigEst: 0, totalRemWork: 0, totalCompWork: 0, totalTasks: 0 };
                requirements.filter(r => (r.fields['System.Tags'] || '').toLowerCase().includes('sprint goal')).forEach(req => {
                    const childIds = reqTasksMap[req.id] || [];
                    const childTasks = childIds.map(id => taskLookup[id]).filter(t => t);
                    const origEst = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                    const remWork = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.RemainingWork'] || 0), 0);
                    const compWork = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0), 0);
                    
                    sprintGoalData.requirements.push({ ...req, taskCount: childTasks.length, originalEstimate: origEst, remainingWork: remWork, completedWork: compWork });
                    sprintGoalData.totalTasks += childTasks.length;
                    sprintGoalData.totalOrigEst += origEst;
                    sprintGoalData.totalRemWork += remWork;
                    sprintGoalData.totalCompWork += compWork;
                });
                
                // Code Review tasks
                codeReviewData = { tasks: [], totalOrigEst: 0, done: 0, inProgress: 0, todo: 0 };
                tasks.filter(t => (t.fields['System.Title'] || '').toLowerCase().startsWith('code review')).forEach(t => {
                    const state = (t.fields['System.State'] || '').toLowerCase();
                    codeReviewData.tasks.push(t);
                    codeReviewData.totalOrigEst += t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                    if (['done', 'closed', 'completed'].includes(state)) codeReviewData.done++;
                    else if (['in progress', 'active'].includes(state)) codeReviewData.inProgress++;
                    else codeReviewData.todo++;
                });
                
                // ALM/TeamB/EngQa-Reserve - Tasks from untagged requirements
                let almEngExtraHours = 0;
                requirements.filter(r => r.category === 'unclassified' && !r.isAdhocSupport).forEach(req => {
                    const childIds = reqTasksMap[req.id] || [];
                    const childTasks = childIds.map(id => taskLookup[id]).filter(t => t);
                    almEngExtraHours += childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                });
                
                // ====== Fetch Team Capacity (PARALLELIZED - 3 bursts) ======
                const selectedIteration = iterations.find(i => i.path === iterPath);
                let sprintCalendarDays = 0, sprintStartDate = null, sprintEndDate = null;
                
                if (selectedIteration?.attributes?.startDate && selectedIteration?.attributes?.finishDate) {
                    sprintStartDate = new Date(selectedIteration.attributes.startDate);
                    sprintEndDate = new Date(selectedIteration.attributes.finishDate);
                    for (let d = new Date(sprintStartDate); d <= sprintEndDate; d.setDate(d.getDate() + 1)) {
                        if (d.getDay() !== 0 && d.getDay() !== 6) sprintCalendarDays++;
                    }
                }
                
                let teamCapacity = 0, teamDaysOffCount = 0, totalMemberDaysOff = 0;
                let sprintWorkDays = sprintCalendarDays;
                let memberCapacities = [];
                let teamDaysOffDates = [];
                
                try {
                    // Step 1: Group areas by project (CPU only)
                    const areasByProject = {};
                    selectedAreaPaths.forEach(area => {
                        if (!areasByProject[area.project]) areasByProject[area.project] = [];
                        areasByProject[area.project].push(area);
                    });
                    
                    // Step 2: Parallel burst 1 - Fetch ALL project teams (1 call per project)
                    const projectNames = Object.keys(areasByProject);
                    const teamsResults = await Promise.all(
                        projectNames.map(p => apiFetch(`${tfsUrl}/_apis/projects/${p}/teams?api-version=5.0`).then(r => r.json()))
                    );
                    const teamsByProject = {};
                    projectNames.forEach((proj, i) => { teamsByProject[proj] = teamsResults[i].value || []; });
                    
                    // Step 3: Match all areas to teams (CPU only, no API calls)
                    const matchedTeams = [];
                    const processedTeams = new Set();
                    
                    for (const projName of projectNames) {
                        const teams = teamsByProject[projName];
                        for (const selectedArea of areasByProject[projName]) {
                            const areaNameLower = selectedArea.path.split('\\').pop().toLowerCase();
                            
                            let teamToUse = teams.find(t => t.name.toLowerCase() === areaNameLower)
                                || teams.find(t => t.name.toLowerCase() === `${areaNameLower} team`)
                                || teams.find(t => t.name.toLowerCase() === `${areaNameLower}-team`);
                            
                            if (!teamToUse) continue;
                            const teamKey = `${projName}/${teamToUse.name}`;
                            if (processedTeams.has(teamKey)) continue;
                            processedTeams.add(teamKey);
                            matchedTeams.push({ projName, teamName: teamToUse.name });
                        }
                    }
                    
                    // Fallback: use default teams if no matches
                    if (matchedTeams.length === 0) {
                        for (const projName of projectNames) {
                            const teams = teamsByProject[projName];
                            const defaultTeam = teams.find(t => t.name === projName || t.name === projName + ' Team') || teams[0];
                            if (defaultTeam) matchedTeams.push({ projName, teamName: defaultTeam.name });
                        }
                    }
                    
                    
                    // Step 4: Parallel burst 2 - Fetch ALL team iterations at once
                    const iterResults = await Promise.all(
                        matchedTeams.map(({ projName, teamName }) =>
                            apiFetch(`${tfsUrl}/${projName}/${encodeURIComponent(teamName)}/_apis/work/teamsettings/iterations?api-version=5.0`)
                                .then(r => r.ok ? r.json() : { value: [] })
                                .then(data => {
                                    const matchingIter = (data.value || []).find(i =>
                                        selectedIterationPaths.some(sel =>
                                            (sel.project === projName && i.path === sel.path) ||
                                            i.name === sel.path.split('\\').pop()
                                        )
                                    );
                                    return { projName, teamName, iterationId: matchingIter?.id || '' };
                                })
                        )
                    );
                    
                    // Step 5: Parallel burst 3 - Fetch ALL capacities + daysoff at once
                    const teamsWithIter = iterResults.filter(t => t.iterationId);
                    
                    const capResults = await Promise.all(
                        teamsWithIter.map(({ projName, teamName, iterationId }) =>
                            Promise.all([
                                apiFetch(`${tfsUrl}/${projName}/${encodeURIComponent(teamName)}/_apis/work/teamsettings/iterations/${iterationId}/teamdaysoff?api-version=5.0`)
                                    .then(r => r.ok ? r.json() : { daysOff: [] }),
                                apiFetch(`${tfsUrl}/${projName}/${encodeURIComponent(teamName)}/_apis/work/teamsettings/iterations/${iterationId}/capacities?api-version=5.0`)
                                    .then(r => r.ok ? r.json() : { value: [] })
                            ]).then(([daysOffData, capData]) => ({ projName, teamName, daysOffData, capData }))
                        )
                    );
                    
                    // Step 6: Process all results (CPU only, no API calls)
                    let firstTeamProcessed = false;
                    capResults.forEach(({ projName, teamName, daysOffData, capData }) => {
                        // Process team days off (only for first team to avoid double counting)
                        if (!firstTeamProcessed) {
                            firstTeamProcessed = true;
                            (daysOffData.daysOff || []).forEach(dayOff => {
                                if (dayOff.start && dayOff.end) {
                                    const offStart = new Date(dayOff.start);
                                    const offEnd = new Date(dayOff.end);
                                    for (let d = new Date(offStart); d <= offEnd; d.setDate(d.getDate() + 1)) {
                                        if (d.getDay() !== 0 && d.getDay() !== 6 && d >= sprintStartDate && d <= sprintEndDate) {
                                            teamDaysOffCount++;
                                            teamDaysOffDates.push(d.toLocaleDateString());
                                        }
                                    }
                                }
                            });
                            sprintWorkDays = Math.max(0, sprintCalendarDays - teamDaysOffCount);
                        }
                        
                        // Process member capacities
                        (capData.value || []).forEach(member => {
                            const memberName = member.teamMember?.displayName || 'Unknown';
                            const memberUniqueName = member.teamMember?.uniqueName || member.teamMember?.id || '';
                            if (memberCapacities.find(m => m.name === memberName && m.team === teamName)) return; // skip duplicates
                            
                            let memberCapacityPerDay = 0, memberDevCapacityPerDay = 0;
                            const disciplineList = [];
                            
                            (member.activities || []).forEach(activity => {
                                const cap = activity.capacityPerDay || 0;
                                memberCapacityPerDay += cap;
                                if (activity.name) {
                                    disciplineList.push(activity.name);
                                    if (activity.name.toLowerCase() === 'development') memberDevCapacityPerDay += cap;
                                }
                            });
                            
                            let memberDaysOff = 0;
                            (member.daysOff || []).forEach(dayOff => {
                                if (dayOff.start && dayOff.end) {
                                    const offStart = new Date(dayOff.start);
                                    const offEnd = new Date(dayOff.end);
                                    for (let d = new Date(offStart); d <= offEnd; d.setDate(d.getDate() + 1)) {
                                        if (d.getDay() !== 0 && d.getDay() !== 6 && d >= sprintStartDate && d <= sprintEndDate) {
                                            memberDaysOff++;
                                        }
                                    }
                                }
                            });
                            
                            totalMemberDaysOff += memberDaysOff;
                            const memberWorkDays = Math.max(0, sprintWorkDays - memberDaysOff);
                            const memberTotalCapacity = memberCapacityPerDay * memberWorkDays;
                            const memberDevTotalCapacity = memberDevCapacityPerDay * memberWorkDays;
                            teamCapacity += memberTotalCapacity;
                            
                            memberCapacities.push({
                                name: memberName, uniqueName: memberUniqueName, discipline: disciplineList.join(', ') || '-',
                                team: teamName, project: projName,
                                capacityPerDay: memberCapacityPerDay, devCapacityPerDay: memberDevCapacityPerDay,
                                daysOff: memberDaysOff, workDays: memberWorkDays,
                                totalCapacity: memberTotalCapacity, devTotalCapacity: memberDevTotalCapacity
                            });
                        });
                    });
                    
                } catch (e) { }
                
                // Calculate capacities
                const totalPlannedCapacity = tasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                const uiUxUdHours = uiUxUdData.totalOrigEst;
                const availableCapacity = Math.max(0, teamCapacity - almEngExtraHours - uiUxUdHours);
                const overPlannedCapacity = totalPlannedCapacity - almEngExtraHours - uiUxUdHours;
                const overPlanPct = availableCapacity > 0 ? ((overPlannedCapacity - availableCapacity) / availableCapacity) * 100 : (overPlannedCapacity > 0 ? 100 : 0);
                
                // Development Only calculations
                const devTeamCapacity = memberCapacities.reduce((sum, m) => sum + (m.devTotalCapacity || 0), 0);
                const devMemberCount = memberCapacities.filter(m => m.devCapacityPerDay > 0).length;
                
                // Filter Development tasks (Discipline = Development)
                const devTasks = tasks.filter(t => t.fields['Microsoft.VSTS.Common.Discipline'] === 'Development');
                
                const devTaskCount = devTasks.length;
                const devTotalPlanned = devTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                
                // Group unclassified requirements by first word of title + separate Adhoc Support
                const devCategoryBreakdown = {};
                let devUnclassifiedTotal = 0;
                
                // Process unclassified requirements (not deliverable, not non-deliverable)
                requirements.filter(r => r.category === 'unclassified').forEach(req => {
                    const childIds = reqTasksMap[req.id] || [];
                    const childTasks = childIds.map(id => taskLookup[id]).filter(t => {
                        return t && t.fields['Microsoft.VSTS.Common.Discipline'] === 'Development';
                    });
                    
                    const taskHours = childTasks.reduce((sum, t) => sum + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                    
                    if (taskHours > 0) {
                        let categoryKey;
                        if (req.isAdhocSupport) {
                            categoryKey = 'Adhoc Support';
                        } else {
                            // Get first word of requirement title
                            const reqTitle = req.fields['System.Title'] || '';
                            categoryKey = reqTitle.split(/[\s\-:]+/)[0] || 'Other';
                        }
                        
                        if (!devCategoryBreakdown[categoryKey]) {
                            devCategoryBreakdown[categoryKey] = { hours: 0, taskCount: 0, reqCount: 0 };
                        }
                        devCategoryBreakdown[categoryKey].hours += taskHours;
                        devCategoryBreakdown[categoryKey].taskCount += childTasks.length;
                        devCategoryBreakdown[categoryKey].reqCount++;
                        devUnclassifiedTotal += taskHours;
                    }
                });
                
                const devAvailableCapacity = Math.max(0, devTeamCapacity - devUnclassifiedTotal);
                const devPlannedCapacity = devTotalPlanned - devUnclassifiedTotal;
                const devOverPlanPct = devAvailableCapacity > 0 ? ((devPlannedCapacity - devAvailableCapacity) / devAvailableCapacity) * 100 : (devPlannedCapacity > 0 ? 100 : 0);
                
                // Store sprint start date for later use
                storedSprintStartDate = sprintStartDate;
                
                // Store capacity data
                capacityData = {
                    teamCapacity: Math.round(teamCapacity * 100) / 100,
                    totalPlannedCapacity: Math.round(totalPlannedCapacity * 100) / 100,
                    almEngExtraHours: Math.round(almEngExtraHours * 100) / 100,
                    uiUxUdHours: Math.round(uiUxUdHours * 100) / 100,
                    availableCapacity: Math.round(availableCapacity * 100) / 100,
                    overPlannedCapacity: Math.round(overPlannedCapacity * 100) / 100,
                    overPlanPct: Math.round(overPlanPct * 100) / 100,
                    devTeamCapacity: Math.round(devTeamCapacity * 100) / 100,
                    devMemberCount, devTaskCount,
                    devTotalPlanned: Math.round(devTotalPlanned * 100) / 100,
                    devCategoryBreakdown,
                    devUnclassifiedTotal: Math.round(devUnclassifiedTotal * 100) / 100,
                    devAvailableCapacity: Math.round(devAvailableCapacity * 100) / 100,
                    devPlannedCapacity: Math.round(devPlannedCapacity * 100) / 100,
                    devOverPlanPct: Math.round(devOverPlanPct * 100) / 100,
                    sprintCalendarDays, teamDaysOff: teamDaysOffCount, teamDaysOffDates,
                    memberDaysOff: totalMemberDaysOff, sprintWorkDays, members: memberCapacities
                };
                
                hideLoading();
                renderContent();
                
            } catch (err) {
                hideLoading();
                document.getElementById('filterPanel').classList.add('visible');
                showError(err.message);
            }
        }

        function renderContent() {
            document.getElementById('content').classList.add('visible');
            document.getElementById('hdrArea').textContent = sprintInfo.areaName;
            document.getElementById('hdrSprint').textContent = sprintInfo.name;

            const delReqs = requirements.filter(r => r.category === 'deliverable');
            const nonDelReqs = requirements.filter(r => r.category === 'nonDeliverable');
            const blankDescReqs = requirements.filter(r => !r.hasDescription);
            const overEstTasks = tasks.filter(t => (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0) > 40);
            
            // Filter for blank/0 Size - Only Deliverable/Non-Deliverable Requirements and Change Requests with Size = 0 or blank
            const blankSizeReqs = requirements.filter(r => {
                // Must be Deliverable or Non-Deliverable
                if (r.category !== 'deliverable' && r.category !== 'nonDeliverable') return false;
                // Must be Requirement or Change Request work item type
                const workItemType = r.fields['System.WorkItemType'] || '';
                if (workItemType !== 'Requirement' && workItemType !== 'Change Request') return false;
                // Size must be 0, blank, null or undefined
                const size = r.fields['Microsoft.VSTS.Scheduling.Size'];
                return size === undefined || size === null || size === '' || size === 0 || Number(size) === 0;
            });

            const stats = {
                total: delReqs.length + nonDelReqs.length, deliverable: delReqs.length, nonDeliverable: nonDelReqs.length,
                delSize: delReqs.reduce((s, r) => s + r.size, 0),
                nonDelSize: nonDelReqs.reduce((s, r) => s + r.size, 0),
                blankSize: blankSizeReqs.length,
                bugs: bugs.length,
                urnIn: requirements.filter(r => r.urnTag === 'urnIn').length,
                urnCf: requirements.filter(r => r.urnTag === 'urnCf').length,
                blankDesc: blankDescReqs.length
            };

            // Summary stats
            document.getElementById('statTotalReq').textContent = stats.total;
            document.getElementById('statDeliverable').textContent = stats.deliverable;
            document.getElementById('statNonDeliverable').textContent = stats.nonDeliverable;
            document.getElementById('statBugs').textContent = stats.bugs;
            document.getElementById('statUrnIn').textContent = stats.urnIn;
            document.getElementById('statUrnCf').textContent = stats.urnCf;
            document.getElementById('statBlankDesc').textContent = stats.blankDesc;
            
            // Render Blank Size table
            renderBlankSizeData(blankSizeReqs);

            // Chart summaries
            document.getElementById('chartDelSize').textContent = stats.delSize.toFixed(2);
            document.getElementById('chartNonDelSize').textContent = stats.nonDelSize.toFixed(2);
            document.getElementById('chartTotalSize').textContent = (stats.delSize + stats.nonDelSize).toFixed(2);
            document.getElementById('chartDelTaskEst').textContent = fmtH(taskEstByCategory.deliverableEst) + 'h';
            document.getElementById('chartNonDelTaskEst').textContent = fmtH(taskEstByCategory.nonDeliverableEst) + 'h';
            document.getElementById('chartTotalTaskEst').textContent = fmtH(taskEstByCategory.deliverableEst + taskEstByCategory.nonDeliverableEst) + 'h';

            // Update CSS doughnut charts
            updateDoughnut('sizeChart', stats.delSize, stats.nonDelSize, '#3b82f6', '#a855f7', 'chartSizePct');
            updateDoughnut('taskEstChart', taskEstByCategory.deliverableEst, taskEstByCategory.nonDeliverableEst, '#06b6d4', '#ec4899', 'chartTaskEstPct');

            // Ratio bars - Deliverable by Size
            const classifiedSize = stats.delSize + stats.nonDelSize || 1;
            const delPct = ((stats.delSize / classifiedSize) * 100).toFixed(2);
            const nonDelPct = ((stats.nonDelSize / classifiedSize) * 100).toFixed(2);
            document.getElementById('lblDelSize').textContent = stats.delSize.toFixed(2);
            document.getElementById('lblNonDelSize').textContent = stats.nonDelSize.toFixed(2);
            document.getElementById('lblDelPct').textContent = delPct + '%';
            document.getElementById('lblNonDelPct').textContent = nonDelPct + '%';
            document.getElementById('barDel').style.width = delPct + '%';
            document.getElementById('barDel').textContent = parseFloat(delPct) > 8 ? delPct + '%' : '';
            document.getElementById('barNonDel').style.width = nonDelPct + '%';
            document.getElementById('barNonDel').textContent = parseFloat(nonDelPct) > 8 ? nonDelPct + '%' : '';

            // Ratio bars - Deliverable by Task Original Estimate
            const totalTaskEst = taskEstByCategory.deliverableEst + taskEstByCategory.nonDeliverableEst || 1;
            const delTaskEstPct = ((taskEstByCategory.deliverableEst / totalTaskEst) * 100).toFixed(2);
            const nonDelTaskEstPct = ((taskEstByCategory.nonDeliverableEst / totalTaskEst) * 100).toFixed(2);
            document.getElementById('lblDelTaskEst').textContent = fmtH(taskEstByCategory.deliverableEst) + 'h';
            document.getElementById('lblNonDelTaskEst').textContent = fmtH(taskEstByCategory.nonDeliverableEst) + 'h';
            document.getElementById('lblDelTaskEstPct').textContent = delTaskEstPct + '%';
            document.getElementById('lblNonDelTaskEstPct').textContent = nonDelTaskEstPct + '%';
            document.getElementById('barDelTaskEst').style.width = delTaskEstPct + '%';
            document.getElementById('barDelTaskEst').textContent = parseFloat(delTaskEstPct) > 8 ? delTaskEstPct + '%' : '';
            document.getElementById('barNonDelTaskEst').style.width = nonDelTaskEstPct + '%';
            document.getElementById('barNonDelTaskEst').textContent = parseFloat(nonDelTaskEstPct) > 8 ? nonDelTaskEstPct + '%' : '';

            // Over estimate tasks
            document.getElementById('overEstTaskCount').textContent = overEstTasks.length;
            const overEstBody = document.querySelector('#overEstTasksTable tbody');
            if (overEstTasks.length > 0) {
                document.getElementById('noOverEstTasks').style.display = 'none';
                overEstBody.innerHTML = overEstTasks.map(t => `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${t.id}" target="_blank" class="wi-link">${t.id}</a></td><td>${t.fields['System.Title'] || ''}</td><td>${t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0}</td><td>${t.fields['System.AssignedTo']?.displayName || '-'}</td></tr>`).join('');
            } else { document.getElementById('noOverEstTasks').style.display = 'block'; overEstBody.innerHTML = ''; }

            // Blank description
            document.getElementById('blankDescCount').textContent = blankDescReqs.length;
            document.getElementById('blankSizeCount').textContent = stats.blankSize;
            const blankDescBody = document.querySelector('#blankDescTable tbody');
            if (blankDescReqs.length > 0) {
                document.getElementById('noBlankDesc').style.display = 'none';
                blankDescBody.innerHTML = blankDescReqs.map(r => `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${r.fields['System.Title'] || ''}</td><td>${r.fields['System.State'] || ''}</td></tr>`).join('');
            } else { document.getElementById('noBlankDesc').style.display = 'block'; blankDescBody.innerHTML = ''; }

            // Bugs - Enhanced with filtering and member-wise count
            window.allBugs = bugs; // Store globally for filtering
            window.currentBugFilter = 'all';
            
            // Calculate tag counts
            const csTagBugs = bugs.filter(b => {
                const tags = (b.fields['System.Tags'] || '').toLowerCase();
                return tags.includes('cs');
            });
            const productionBugs = bugs.filter(b => {
                const tags = (b.fields['System.Tags'] || '').toLowerCase();
                return tags.includes('production_bug') || tags.includes('production bug');
            });
            
            document.getElementById('bugCount').textContent = bugs.length;
            document.getElementById('bugTotalCount').textContent = bugs.length;
            document.getElementById('bugClosedCount').textContent = bugs.filter(b => b.fields['System.State'] === 'Closed').length;
            document.getElementById('bugActiveCount').textContent = bugs.filter(b => ['Active', 'Open', 'New'].includes(b.fields['System.State'])).length;
            document.getElementById('bugResolvedCount').textContent = bugs.filter(b => b.fields['System.State'] === 'Resolved').length;
            document.getElementById('bugCSCount').textContent = csTagBugs.length;
            document.getElementById('bugProductionCount').textContent = productionBugs.length;
            
            // Render bugs table
            renderBugsTable('all');

            // Sprint Goal
            renderDashboard('sprintGoal', sprintGoalData);
            
            // TEAM B - Display Size in the summary
            document.getElementById('teamBReqCount').textContent = teamBData.requirements.length;
            document.getElementById('teamBTaskCount').textContent = teamBData.totalTasks;
            document.getElementById('teamBTotalSize').textContent = teamBData.totalSize;
            document.getElementById('teamBTotalOrigEst').textContent = fmtH(teamBData.totalOrigEst) + 'h';
            document.getElementById('teamBTotalRemWork').textContent = fmtH(teamBData.totalRemWork) + 'h';
            const teamBBody = document.querySelector('#teamBReqTable tbody');
            if (teamBData.requirements.length > 0) {
                document.getElementById('noTeamBData').style.display = 'none';
                teamBBody.innerHTML = teamBData.requirements.map(r => `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${r.fields['System.Title'] || ''}</td><td>${r.fields['System.State'] || ''}</td><td style="text-align:center;">${r.taskCount}</td><td style="text-align:center;color:#c084fc;">${r.size || 0}</td><td style="text-align:center;color:#fbbf24;">${fmtH(r.originalEstimate)}h</td><td style="text-align:center;color:#22d3ee;">${fmtH(r.remainingWork)}h</td></tr>`).join('');
            } else { document.getElementById('noTeamBData').style.display = 'block'; teamBBody.innerHTML = ''; }

            // ========== DATA QUALITY DASHBOARDS ==========
            try {
                // Filter for Deliverable and Non-Deliverable requirements only
                const classifiedReqs = requirements.filter(r => r.category === 'deliverable' || r.category === 'nonDeliverable');
                
                // 1. Blank/0 Size Dashboard - show if Size is blank or 0 (Only Requirement and Change Request)
                const blankSizeReqs = classifiedReqs.filter(r => {
                    // Must be Requirement or Change Request work item type
                    const workItemType = r.fields ? r.fields['System.WorkItemType'] : '';
                    if (workItemType !== 'Requirement' && workItemType !== 'Change Request') return false;
                    // Size must be 0, blank, null or undefined
                    const size = r.fields ? r.fields['Microsoft.VSTS.Scheduling.Size'] : undefined;
                    return size === undefined || size === null || size === '' || size === 0 || Number(size) === 0;
                });
                document.getElementById('blankSizeCount').textContent = blankSizeReqs.length;
                const blankSizeBody = document.getElementById('blankSizeTableBody');
                if (blankSizeReqs.length > 0) {
                    document.getElementById('noBlankSizeData').style.display = 'none';
                    blankSizeBody.innerHTML = blankSizeReqs.map(r => {
                        const title = r.fields ? (r.fields['System.Title'] || '') : '';
                        return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${title}</td></tr>`;
                    }).join('');
                } else { document.getElementById('noBlankSizeData').style.display = 'block'; blankSizeBody.innerHTML = ''; }

                // 2. Blank Release Notes Dashboard
                const blankReleaseNoteReqs = classifiedReqs.filter(r => {
                    const releaseNote = r.fields ? r.fields['Casepoint.TFS.CustomFields.ReleaseNotes'] : undefined;
                    return releaseNote === undefined || releaseNote === null || releaseNote === '' || (typeof releaseNote === 'string' && releaseNote.trim() === '');
                });
                document.getElementById('blankReleaseNoteCount').textContent = blankReleaseNoteReqs.length;
                const blankReleaseNoteBody = document.getElementById('blankReleaseNoteTableBody');
                if (blankReleaseNoteReqs.length > 0) {
                    document.getElementById('noBlankReleaseNoteData').style.display = 'none';
                    blankReleaseNoteBody.innerHTML = blankReleaseNoteReqs.map(r => {
                        const title = r.fields ? (r.fields['System.Title'] || '') : '';
                        const state = r.fields ? (r.fields['System.State'] || '') : '';
                        return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${title}</td><td>${state}</td></tr>`;
                    }).join('');
                } else { document.getElementById('noBlankReleaseNoteData').style.display = 'block'; blankReleaseNoteBody.innerHTML = ''; }

                // 3. No Parent Dashboard
                const noParentReqs = classifiedReqs.filter(r => !r.hasParent);
                document.getElementById('blankParentCount').textContent = noParentReqs.length;
                const blankParentBody = document.getElementById('blankParentTableBody');
                if (noParentReqs.length > 0) {
                    document.getElementById('noBlankParentData').style.display = 'none';
                    blankParentBody.innerHTML = noParentReqs.map(r => {
                        const cat = r.category === 'deliverable' ? 'Del' : 'Non-Del';
                        const title = r.fields ? (r.fields['System.Title'] || '') : '';
                        return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${title}</td><td style="color:#c4b5fd;">${cat}</td></tr>`;
                    }).join('');
                } else { document.getElementById('noBlankParentData').style.display = 'block'; blankParentBody.innerHTML = ''; }
            } catch (err) {
                console.error('Data Quality Dashboard Error:', err);
            }

            // Capacity stats
            renderCapacityStats();
            
            // Reset lazy-loaded sections
            document.getElementById('reqListContent').style.display = 'none';
            document.getElementById('loadReqListBtn').textContent = 'üìã Show';
            reqListLoaded = false;
            document.getElementById('membersCapacityContent').style.display = 'none';
            document.getElementById('loadMembersCapBtn').textContent = 'üìã Show';
            membersCapacityLoaded = false;
            membersCapSortField = 'name';
            membersCapSortDir = 'asc';
            // Reset Weekly Progress
            document.getElementById('weeklyProgressContent').style.display = 'none';
            document.getElementById('loadWeeklyBtn').textContent = 'üìä Show';
            weeklyProgressLoaded = false;
            // Reset AI Adoption Data
            document.getElementById('aiAdoptionContent').style.display = 'none';
            const aiBtn = document.getElementById('loadAIAdoptionBtn');
            aiBtn.textContent = 'üìä Show';
            aiBtn.style.display = 'inline-block';
            aiBtn.style.background = '';
            aiBtn.style.borderColor = '';
            document.getElementById('exportAIAdoptionBtn').style.display = 'none';
            document.getElementById('exportAIAdoptionPdfBtn').style.display = 'none';
            aiAdoptionDataLoaded = false;
            aiAdoptionMemberData = [];
            aiAdoptionSortField = 'name';
            aiAdoptionSortDir = 'asc';
            aiAdoptionAreaFilter = 'All';
            aiAdoptionGrandTotals = {};
            areaSummaryData = [];
            areaSortField = 'area';
            areaSortDir = 'asc';
            // Reset Dev Area-wise & Project-wise Summary sections
            const devAreaSection = document.getElementById('areaSummarySection');
            if (devAreaSection) { devAreaSection.style.display = 'none'; }
            const devAreaBody = document.getElementById('areaSummaryBody');
            if (devAreaBody) devAreaBody.innerHTML = '';
            const devAreaHead = document.getElementById('areaSummaryHead');
            if (devAreaHead) devAreaHead.innerHTML = '';
            const devProjectSection = document.getElementById('projectSummarySection');
            if (devProjectSection) { devProjectSection.style.display = 'none'; }
            const devProjectBody = document.getElementById('projectSummaryBody');
            if (devProjectBody) devProjectBody.innerHTML = '';
            const devProjectHead = document.getElementById('projectSummaryHead');
            if (devProjectHead) devProjectHead.innerHTML = '';
            // Reset QA AI Adoption Data
            const qaContent = document.getElementById('qaAIAdoptionContent');
            const qaBtn = document.getElementById('loadQAAIAdoptionBtn');
            const qaExportBtn = document.getElementById('exportQAAIAdoptionBtn');
            const qaExportPdfBtn = document.getElementById('exportQAAIAdoptionPdfBtn');
            if (qaContent) qaContent.style.display = 'none';
            if (qaBtn) {
                qaBtn.textContent = 'üìä Show';
                qaBtn.style.background = '';
                qaBtn.style.borderColor = '';
            }
            if (qaExportBtn) qaExportBtn.style.display = 'none';
            if (qaExportPdfBtn) qaExportPdfBtn.style.display = 'none';
            qaAIAdoptionDataLoaded = false;
            qaAIAdoptionMemberData = [];
            qaAIAdoptionSortField = 'name';
            qaAIAdoptionSortDir = 'asc';
            qaAIAdoptionGrandTotals = {};
            // Reset QA Area-wise & Project-wise Summary sections
            const qaAreaSection = document.getElementById('qaAreaSummarySection');
            if (qaAreaSection) { qaAreaSection.style.display = 'none'; }
            const qaAreaBody = document.getElementById('qaAreaSummaryBody');
            if (qaAreaBody) qaAreaBody.innerHTML = '';
            const qaAreaHead = document.getElementById('qaAreaSummaryHead');
            if (qaAreaHead) qaAreaHead.innerHTML = '';
            const qaProjectSection = document.getElementById('qaProjectSummarySection');
            if (qaProjectSection) { qaProjectSection.style.display = 'none'; }
            const qaProjectBody = document.getElementById('qaProjectSummaryBody');
            if (qaProjectBody) qaProjectBody.innerHTML = '';
            const qaProjectHead = document.getElementById('qaProjectSummaryHead');
            if (qaProjectHead) qaProjectHead.innerHTML = '';
            // Reset Discipline Mismatch Data
            const mismatchContent = document.getElementById('mismatchContent');
            const toggleMismatchBtn = document.getElementById('toggleMismatchBtn');
            const mismatchTableBody = document.getElementById('mismatchTableBody');
            const noMismatchData = document.getElementById('noMismatchData');
            if (mismatchContent) mismatchContent.style.display = 'none';
            if (toggleMismatchBtn) { toggleMismatchBtn.textContent = 'üìã Show'; toggleMismatchBtn.style.background = ''; toggleMismatchBtn.style.borderColor = ''; }
            if (document.getElementById('exportMismatchExcelBtn')) document.getElementById('exportMismatchExcelBtn').style.display = 'none';
            if (document.getElementById('exportMismatchPdfBtn')) document.getElementById('exportMismatchPdfBtn').style.display = 'none';
            
            if (mismatchTableBody) mismatchTableBody.innerHTML = '';
            if (noMismatchData) noMismatchData.style.display = 'none';
            mismatchDataLoaded = false;
            mismatchAllData = [];
            mismatchSortField = 'id';
            mismatchSortDir = 'asc';
            // Reset Overall AI Adoption Data
            const overallContent = document.getElementById('overallAIAdoptionContent');
            const overallBtn = document.getElementById('loadOverallAIAdoptionBtn');
            const overallExportBtn = document.getElementById('exportOverallAIAdoptionBtn');
            if (overallContent) overallContent.style.display = 'none';
            if (overallBtn) overallBtn.textContent = 'üìä Show';
            if (overallExportBtn) overallExportBtn.style.display = 'none';
            overallAIAdoptionDataLoaded = false;
            overallAIDisciplineData = [];
            overallAIGrandTotal = {};
            overallAISortField = 'discipline';
            overallAISortDir = 'asc';
            // Reset TaskExecutionType AI Adoption Data
            const execTypeContent = document.getElementById('execTypeAIAdoptionContent');
            const execTypeBtn = document.getElementById('loadExecTypeAIAdoptionBtn');
            const execTypeExportBtn = document.getElementById('exportExecTypeAIAdoptionBtn');
            if (execTypeContent) execTypeContent.style.display = 'none';
            if (execTypeBtn) execTypeBtn.textContent = 'üìä Show';
            if (execTypeExportBtn) execTypeExportBtn.style.display = 'none';
            execTypeAIAdoptionDataLoaded = false;
            execTypeData = [];
            execTypeSortField = 'execType';
            execTypeSortDir = 'asc';
            execTypeGrandTotals = {};
            // Reset Project-wise AI Adoption Data
            const projectAIContent = document.getElementById('projectAIAdoptionContent');
            const projectAIBtn = document.getElementById('loadProjectAIAdoptionBtn');
            if (projectAIContent) projectAIContent.style.display = 'none';
            if (projectAIBtn) projectAIBtn.textContent = 'üìä Show';
            projectAIAdoptionDataLoaded = false;
            projectAIData = [];
            projectAISortField = 'project';
            projectAISortDir = 'asc';
            // Reset Overall AI Adoption Summary
            const oasContent = document.getElementById('overallAISummaryContent');
            const oasBtn = document.getElementById('loadOverallSummaryBtn');
            if (oasContent) oasContent.style.display = 'none';
            if (oasBtn) {
                oasBtn.textContent = 'üìä Show';
                oasBtn.style.background = '';
                oasBtn.style.borderColor = '';
            }
            overallAISummaryLoaded = false;
            // Reset Discipline Verification Data
            const dvContent = document.getElementById('disciplineVerifyContent');
            const dvBtn = document.getElementById('loadDisciplineVerifyBtn');
            const dvExportBtn = document.getElementById('exportDisciplineVerifyBtn');
            if (dvContent) dvContent.style.display = 'none';
            if (dvBtn) {
                dvBtn.textContent = 'üìä Show';
                dvBtn.style.background = '';
                dvBtn.style.borderColor = '';
            }
            if (dvExportBtn) dvExportBtn.style.display = 'none';
            const dvExportPdfBtn = document.getElementById('exportDisciplineVerifyPdfBtn');
            if (dvExportPdfBtn) dvExportPdfBtn.style.display = 'none';
            dvDataLoaded = false;
            dvAllTaskData = [];
            dvSortField = 'assignedTo';
            dvSortDir = 'asc';
            // Auto-load Tag Missing data (no button needed)
            renderTagMissingTasks();
            // Auto-load Last Sprint Open Items
            loadLastSprintData();
            // Auto-load Blank Discipline data (no button needed)
            renderBlankDisciplineTasks();
            // Discipline Mismatch data will be loaded on demand in Tab 2
        }

        function updateDoughnut(elementId, value1, value2, color1, color2, pctElementId) {
            const total = value1 + value2;
            const pct1 = total > 0 ? (value1 / total) * 100 : 0;
            const deg1 = (pct1 / 100) * 360;
            const element = document.getElementById(elementId);
            if (element) element.style.background = `conic-gradient(${color1} 0deg ${deg1}deg, ${color2} ${deg1}deg 360deg)`;
            const pctElement = document.getElementById(pctElementId);
            if (pctElement) pctElement.textContent = pct1.toFixed(2) + '%';
        }

        function renderDashboard(prefix, data) {
            document.getElementById(`${prefix}ReqCount`).textContent = data.requirements.length;
            document.getElementById(`${prefix}TaskCount`).textContent = data.totalTasks;
            document.getElementById(`${prefix}OriginalEst`).textContent = fmtH(data.totalOrigEst) + 'h';
            document.getElementById(`${prefix}RemainingWork`).textContent = fmtH(data.totalRemWork) + 'h';
            document.getElementById(`${prefix}CompletedWork`).textContent = fmtH(data.totalCompWork) + 'h';
            updateProgressBar(prefix, data.totalCompWork, data.totalRemWork);
            
            const tbody = document.querySelector(`#${prefix}ReqTable tbody`);
            if (data.requirements.length > 0) {
                document.getElementById(`no${prefix.charAt(0).toUpperCase() + prefix.slice(1)}Data`).style.display = 'none';
                tbody.innerHTML = data.requirements.map(r => `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${r.fields['System.Title'] || ''}</td><td>${r.fields['System.State'] || ''}</td><td>${r.taskCount}</td><td>${fmtH(r.originalEstimate)}</td><td>${fmtH(r.remainingWork)}</td><td>${fmtH(r.completedWork)}</td></tr>`).join('');
            } else {
                document.getElementById(`no${prefix.charAt(0).toUpperCase() + prefix.slice(1)}Data`).style.display = 'block';
                tbody.innerHTML = '';
            }
        }

        function updateProgressBar(prefix, completed, remaining) {
            const total = completed + remaining || 1;
            const compPct = ((completed / total) * 100).toFixed(1);
            const remPct = ((remaining / total) * 100).toFixed(1);
            document.getElementById(`${prefix}CompPct`).textContent = compPct + '%';
            document.getElementById(`${prefix}RemPct`).textContent = remPct + '%';
            document.getElementById(`${prefix}BarComp`).style.width = compPct + '%';
            document.getElementById(`${prefix}BarComp`).textContent = parseFloat(compPct) > 8 ? compPct + '%' : '';
            document.getElementById(`${prefix}BarRem`).style.width = remPct + '%';
            document.getElementById(`${prefix}BarRem`).textContent = parseFloat(remPct) > 8 ? remPct + '%' : '';
        }

        function renderCapacityStats() {
            const c = capacityData;
            document.getElementById('sprintCalendarDays').textContent = c.sprintCalendarDays;
            document.getElementById('teamDaysOff').textContent = c.teamDaysOff;
            document.getElementById('sprintWorkDays').textContent = c.sprintWorkDays;
            
            if (c.teamDaysOffDates.length > 0) {
                document.getElementById('teamDaysOffDetails').style.display = 'inline';
                document.getElementById('teamDaysOffDatesList').textContent = c.teamDaysOffDates.join(', ');
            } else {
                document.getElementById('teamDaysOffDetails').style.display = 'none';
            }
            
            document.getElementById('memberCount').textContent = c.members.length;
            document.getElementById('teamCapacity').textContent = fmtH(c.teamCapacity) + 'h';
            document.getElementById('totalPlannedCapacity').textContent = fmtH(c.totalPlannedCapacity) + 'h';
            document.getElementById('almEngExtraHours').textContent = fmtH(c.almEngExtraHours) + 'h';
            document.getElementById('uiUxUdHours').textContent = fmtH(c.uiUxUdHours) + 'h';
            document.getElementById('availableCapacity').textContent = fmtH(c.availableCapacity) + 'h';
            document.getElementById('overPlannedCapacity').textContent = fmtH(c.overPlannedCapacity) + 'h';
            document.getElementById('overPlanPct').textContent = c.overPlanPct.toFixed(2) + '%';
            
            // Formula display
            document.getElementById('formulaTeamCap').textContent = fmtH(c.teamCapacity);
            document.getElementById('formulaAlmEng').textContent = fmtH(c.almEngExtraHours);
            document.getElementById('formulaUiUxUd').textContent = fmtH(c.uiUxUdHours);
            document.getElementById('formulaAvailable').textContent = fmtH(c.availableCapacity);
            document.getElementById('formulaTotalPlanned').textContent = fmtH(c.totalPlannedCapacity);
            document.getElementById('formulaAlmEng2').textContent = fmtH(c.almEngExtraHours);
            document.getElementById('formulaUiUxUd2').textContent = fmtH(c.uiUxUdHours);
            document.getElementById('formulaOverPlanned').textContent = fmtH(c.overPlannedCapacity);
            
            // Show alerts based on over/under planning
            const isOverPlanned = c.overPlannedCapacity > c.availableCapacity;
            if (isOverPlanned) {
                document.getElementById('overPlanAlert').style.display = 'block';
                document.getElementById('underPlanAlert').style.display = 'none';
                document.getElementById('overPlanAlertPct').textContent = c.overPlanPct.toFixed(2) + '%';
            } else {
                document.getElementById('overPlanAlert').style.display = 'none';
                document.getElementById('underPlanAlert').style.display = 'block';
                document.getElementById('overPlanStat').style.background = 'rgba(16,185,129,0.2)';
                document.getElementById('overPlanPctStat').style.background = 'rgba(16,185,129,0.2)';
                document.getElementById('overPlanPctStat').querySelector('.value').style.color = '#34d399';
            }
            
            // Development Only stats
            document.getElementById('devTeamCapacity').textContent = fmtH(c.devTeamCapacity) + 'h';
            document.getElementById('devTotalPlanned').textContent = fmtH(c.devTotalPlanned) + 'h';
            document.getElementById('devAvailableCapacity').textContent = fmtH(c.devAvailableCapacity) + 'h';
            document.getElementById('devPlannedCapacity').textContent = fmtH(c.devPlannedCapacity) + 'h';
            document.getElementById('devOverPlanPct').textContent = c.devOverPlanPct.toFixed(2) + '%';
            document.getElementById('devMemberCount').textContent = c.devMemberCount;
            document.getElementById('devTaskCount').textContent = c.devTaskCount;
            document.getElementById('devUnclassifiedTotal').textContent = fmtH(c.devUnclassifiedTotal) + 'h';
            
            // Render dynamic category blocks
            const categoryBlocksContainer = document.getElementById('devCategoryBlocks');
            if (categoryBlocksContainer && c.devCategoryBreakdown) {
                const categories = Object.entries(c.devCategoryBreakdown);
                // Sort: Adhoc Support first, then by hours descending
                categories.sort((a, b) => {
                    if (a[0] === 'Adhoc Support') return -1;
                    if (b[0] === 'Adhoc Support') return 1;
                    return b[1].hours - a[1].hours;
                });
                
                const colors = [
                    { bg: 'rgba(245,158,11,0.2)', border: 'rgba(245,158,11,0.3)', text: '#fbbf24' },  // Adhoc Support - orange
                    { bg: 'rgba(99,102,241,0.2)', border: 'rgba(99,102,241,0.3)', text: '#818cf8' },
                    { bg: 'rgba(16,185,129,0.2)', border: 'rgba(16,185,129,0.3)', text: '#34d399' },
                    { bg: 'rgba(239,68,68,0.2)', border: 'rgba(239,68,68,0.3)', text: '#f87171' },
                    { bg: 'rgba(168,85,247,0.2)', border: 'rgba(168,85,247,0.3)', text: '#c4b5fd' },
                    { bg: 'rgba(6,182,212,0.2)', border: 'rgba(6,182,212,0.3)', text: '#22d3ee' },
                    { bg: 'rgba(236,72,153,0.2)', border: 'rgba(236,72,153,0.3)', text: '#f472b6' },
                    { bg: 'rgba(148,163,184,0.2)', border: 'rgba(148,163,184,0.3)', text: '#94a3b8' }
                ];
                
                categoryBlocksContainer.innerHTML = categories.map(([name, data], idx) => {
                    const color = name === 'Adhoc Support' ? colors[0] : colors[(idx % (colors.length - 1)) + 1];
                    const icon = name === 'Adhoc Support' ? 'üé´' : 'üìÅ';
                    return `<div class="summary-stat" style="background: ${color.bg}; border-color: ${color.border}; min-width: 70px; flex: 1; padding: 6px;">
                        <div class="value" style="color: ${color.text}; font-size: 0.85rem;">${fmtH(data.hours)}h</div>
                        <div class="label" style="font-size: 0.5rem;">${icon} ${name}</div>
                        <div style="font-size: 0.45rem; color: #64748b; margin-top: 1px;">${data.taskCount} tasks</div>
                    </div>`;
                }).join('');
            }
            
            // Development Only formulas
            document.getElementById('devFormulaTeamCap').textContent = fmtH(c.devTeamCapacity);
            document.getElementById('devFormulaAlmEng').textContent = fmtH(c.devUnclassifiedTotal);
            document.getElementById('devFormulaAvailable').textContent = fmtH(c.devAvailableCapacity);
            document.getElementById('devFormulaTotalPlanned').textContent = fmtH(c.devTotalPlanned);
            document.getElementById('devFormulaAlmEng2').textContent = fmtH(c.devUnclassifiedTotal);
            document.getElementById('devFormulaPlanned').textContent = fmtH(c.devPlannedCapacity);
            document.getElementById('devFormulaOverPlanPct').textContent = c.devOverPlanPct.toFixed(2) + '%';
            
            const devStat = document.getElementById('devOverPlanPctStat');
            if (c.devOverPlanPct > 0) {
                devStat.style.background = 'rgba(239,68,68,0.2)';
                devStat.querySelector('.value').style.color = '#f87171';
            } else {
                devStat.style.background = 'rgba(16,185,129,0.2)';
                devStat.querySelector('.value').style.color = '#34d399';
            }
        }

        let membersCapacityLoaded = false;
        let membersCapSortField = 'name';
        let membersCapSortDir = 'asc';
        
        // ========== WEEKLY PROGRESS TRACKER ==========
        function toggleWeeklyProgress() {
            const btn = document.getElementById('loadWeeklyBtn');
            const content = document.getElementById('weeklyProgressContent');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'üîº Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                
                if (!weeklyProgressLoaded) {
                    renderWeeklyProgress();
                    weeklyProgressLoaded = true;
                }
            } else {
                content.style.display = 'none';
                btn.textContent = 'üìä Show';
                btn.style.background = '';
                btn.style.borderColor = '';
            }
        }
        
        function renderWeeklyProgress() {
            const doneStates = ['resolved', 'closed', 'done', 'completed'];
            
            // Calculate week stats
            const weekStats = {
                week1: { total: weeklyData.week1.length, done: weeklyData.week1.filter(r => doneStates.includes((r.fields['System.State'] || '').toLowerCase())).length },
                week2: { total: weeklyData.week2.length, done: weeklyData.week2.filter(r => doneStates.includes((r.fields['System.State'] || '').toLowerCase())).length },
                week3: { total: weeklyData.week3.length, done: weeklyData.week3.filter(r => doneStates.includes((r.fields['System.State'] || '').toLowerCase())).length },
                week4: { total: weeklyData.week4.length, done: weeklyData.week4.filter(r => doneStates.includes((r.fields['System.State'] || '').toLowerCase())).length }
            };
            
            
            // Calculate current week of sprint (use first selected iteration)
            const selectedIteration = selectedIterationPaths.length > 0 
                ? iterations.find(i => i.path === selectedIterationPaths[0].path) 
                : null;
            let currentWeek = 0;
            let sprintStart = null, sprintEnd = null;
            if (selectedIteration?.attributes?.startDate) {
                sprintStart = new Date(selectedIteration.attributes.startDate);
                sprintEnd = selectedIteration.attributes.finishDate ? new Date(selectedIteration.attributes.finishDate) : null;
                const today = new Date();
                const daysSinceStart = Math.floor((today - sprintStart) / (1000 * 60 * 60 * 24));
                currentWeek = Math.min(4, Math.max(1, Math.ceil((daysSinceStart + 1) / 7)));
            }
            
            // Update sprint dates display (elements removed from UI but keeping safe check)
            const sprintStartEl = document.getElementById('sprintStartDate');
            const sprintEndEl = document.getElementById('sprintEndDate');
            if (sprintStart && sprintStartEl) {
                sprintStartEl.textContent = sprintStart.toLocaleDateString();
            }
            if (sprintEnd && sprintEndEl) {
                sprintEndEl.textContent = sprintEnd.toLocaleDateString();
            }
            
            // Update week summary cards
            document.getElementById('week1Done').textContent = weekStats.week1.done;
            document.getElementById('week1Total').textContent = weekStats.week1.total;
            document.getElementById('week2Done').textContent = weekStats.week2.done;
            document.getElementById('week2Total').textContent = weekStats.week2.total;
            document.getElementById('week3Done').textContent = weekStats.week3.done;
            document.getElementById('week3Total').textContent = weekStats.week3.total;
            document.getElementById('week4Done').textContent = weekStats.week4.done;
            document.getElementById('week4Total').textContent = weekStats.week4.total;
            
            // Calculate week date ranges
            if (sprintStart) {
                for (let w = 1; w <= 4; w++) {
                    const weekStart = new Date(sprintStart);
                    weekStart.setDate(weekStart.getDate() + (w - 1) * 7);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    const dateEl = document.getElementById(`week${w}Dates`);
                    if (dateEl) {
                        dateEl.textContent = `${weekStart.getDate()}/${weekStart.getMonth()+1} - ${weekEnd.getDate()}/${weekEnd.getMonth()+1}`;
                    }
                }
            }
            
            // Current week indicator (element removed from UI but keeping safe check)
            const currentWeekEl = document.getElementById('currentWeekIndicator');
            if (currentWeekEl) {
                currentWeekEl.textContent = currentWeek > 0 ? `Week ${currentWeek}` : 'N/A';
            }
            
            // Overall status - consider only items from Week 1 through current week
            // Previous weeks: should be 100% done. Current week: proportional to days elapsed.
            const weekKeys = ['week1', 'week2', 'week3', 'week4'];
            let totalAll = 0, totalDone = 0;
            let prevWeeksTotal = 0, currentWeekTotal = 0;
            for (let w = 0; w < Math.min(currentWeek, 4); w++) {
                totalAll += weekStats[weekKeys[w]].total;
                totalDone += weekStats[weekKeys[w]].done;
                if (w < currentWeek - 1) {
                    prevWeeksTotal += weekStats[weekKeys[w]].total;
                } else {
                    currentWeekTotal += weekStats[weekKeys[w]].total;
                }
            }
            const overallPct = totalAll > 0 ? Math.round((totalDone / totalAll) * 100) : 0;
            
            // Calculate how far into current week we are (day 1 of 7 = 14%, day 7 = 100%)
            let dayInCurrentWeek = 1;
            if (sprintStart) {
                const today = new Date();
                const daysSinceStart = Math.floor((today - sprintStart) / (1000 * 60 * 60 * 24));
                dayInCurrentWeek = Math.max(1, Math.min(7, daysSinceStart - (currentWeek - 1) * 7 + 1));
            }
            const currentWeekElapsedPct = Math.round((dayInCurrentWeek / 7) * 100);
            
            // Expected: previous weeks = 100% done, current week = proportional to days elapsed
            // Weighted expected = (prevItems * 100 + currentItems * dayPct) / totalItems
            let expectedPct = 0;
            if (totalAll > 0) {
                expectedPct = Math.round(((prevWeeksTotal * 100) + (currentWeekTotal * currentWeekElapsedPct)) / totalAll);
            }
            const variance = overallPct - expectedPct;
            
            document.getElementById('weekTotalDone').textContent = totalDone;
            document.getElementById('weekTotalAll').textContent = totalAll;
            document.getElementById('weekOverallPct').textContent = overallPct + '%';
            
            // Update progress display
            document.getElementById('actualProgress').textContent = overallPct + '%';
            document.getElementById('expectedProgress').textContent = expectedPct + '%';
            document.getElementById('progressVariance').textContent = (variance >= 0 ? '+' : '') + variance + '%';
            
            // Determine status based on variance
            let statusIcon, statusText, statusDesc, statusColor, bannerStyle, varianceColor;
            
            if (totalAll === 0) {
                // No data
                statusIcon = 'üìä';
                statusText = 'NO DATA';
                statusDesc = 'No deliverables with weekly tags found';
                statusColor = '#94a3b8';
                bannerStyle = 'background: linear-gradient(135deg, rgba(148,163,184,0.2), rgba(100,116,139,0.15)); border: 1px solid rgba(148,163,184,0.4);';
                varianceColor = '#94a3b8';
            } else if (variance >= 10) {
                // Fast - ahead of schedule by 10%+
                statusIcon = 'üöÄ';
                statusText = 'AHEAD OF SCHEDULE';
                statusDesc = 'Sprint delivery is progressing faster than expected!';
                statusColor = '#22d3ee';
                bannerStyle = 'background: linear-gradient(135deg, rgba(6,182,212,0.3), rgba(14,165,233,0.2)); border: 1px solid rgba(6,182,212,0.5); box-shadow: 0 0 20px rgba(6,182,212,0.2);';
                varianceColor = '#22d3ee';
            } else if (variance >= -5) {
                // On Track - within 5% of expected
                statusIcon = '‚úÖ';
                statusText = 'ON TRACK';
                statusDesc = 'Sprint delivery is progressing as expected';
                statusColor = '#34d399';
                bannerStyle = 'background: linear-gradient(135deg, rgba(16,185,129,0.3), rgba(5,150,105,0.2)); border: 1px solid rgba(16,185,129,0.5); box-shadow: 0 0 20px rgba(16,185,129,0.2);';
                varianceColor = '#34d399';
            } else if (variance >= -15) {
                // At Risk - 5-15% behind
                statusIcon = '‚ö†Ô∏è';
                statusText = 'AT RISK';
                statusDesc = 'Sprint delivery is slightly behind schedule - needs attention';
                statusColor = '#fbbf24';
                bannerStyle = 'background: linear-gradient(135deg, rgba(245,158,11,0.3), rgba(217,119,6,0.2)); border: 1px solid rgba(245,158,11,0.5); box-shadow: 0 0 20px rgba(245,158,11,0.2);';
                varianceColor = '#fbbf24';
            } else {
                // Delayed - more than 15% behind
                statusIcon = 'üî¥';
                statusText = 'DELAYED';
                statusDesc = 'Sprint delivery is significantly behind - immediate action required';
                statusColor = '#f87171';
                bannerStyle = 'background: linear-gradient(135deg, rgba(239,68,68,0.3), rgba(220,38,38,0.2)); border: 1px solid rgba(239,68,68,0.5); box-shadow: 0 0 20px rgba(239,68,68,0.2);';
                varianceColor = '#f87171';
            }
            
            // Apply status to banner
            const banner = document.getElementById('sprintStatusBanner');
            banner.style.cssText = bannerStyle + ' border-radius: 10px; padding: 12px 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;';
            document.getElementById('sprintStatusIcon').textContent = statusIcon;
            document.getElementById('sprintStatusText').textContent = statusText;
            document.getElementById('sprintStatusText').style.color = statusColor;
            document.getElementById('sprintStatusDesc').textContent = statusDesc;
            document.getElementById('actualProgress').style.color = statusColor;
            document.getElementById('progressVariance').style.color = varianceColor;
            
            // Focus Items: Current week items + ALL Previous weeks incomplete items
            const weekArrays = [weeklyData.week1, weeklyData.week2, weeklyData.week3, weeklyData.week4];
            let focusItems = [];
            
            // Add ALL week items (not just current week) for filtering
            for (let w = 0; w < 4; w++) {
                const weekItems = weekArrays[w].map(r => {
                    const isOverdue = w < currentWeek - 1 && !doneStates.includes((r.fields['System.State'] || '').toLowerCase());
                    const isCurrent = w === currentWeek - 1;
                    return { ...r, priority: isOverdue ? 'Overdue' : (isCurrent ? 'Current' : 'Scheduled'), weekNum: w + 1 };
                });
                focusItems.push(...weekItems);
            }
            
            // Store globally for filtering
            window.allFocusItems = focusItems;
            window.currentFocusFilter = 'all';
            
            // Calculate totals for progress summary
            const totalOrigEst = focusItems.reduce((sum, r) => sum + (r.taskEstimate || 0), 0);
            const totalCompleted = focusItems.reduce((sum, r) => sum + (r.taskCompletedWork || 0), 0);
            const completedPct = totalOrigEst > 0 ? Math.round((totalCompleted / totalOrigEst) * 100) : 0;
            const remainingPct = 100 - completedPct;
            
            document.getElementById('focusCompletedPct').textContent = completedPct + '%';
            document.getElementById('focusRemainingPct').textContent = remainingPct + '%';
            document.getElementById('focusProgressBar').style.width = completedPct + '%';
            
            // Render with filter
            renderFocusItemsTable('all');
            
            // Show/hide no weekly data message
            if (totalAll === 0) {
                document.getElementById('noWeeklyData').style.display = 'block';
            } else {
                document.getElementById('noWeeklyData').style.display = 'none';
            }
        }
        
        // Week badge colors
        const weekBadgeStyles = {
            1: { bg: 'rgba(59,130,246,0.3)', border: 'rgba(59,130,246,0.6)', color: '#93c5fd' },
            2: { bg: 'rgba(16,185,129,0.3)', border: 'rgba(16,185,129,0.6)', color: '#6ee7b7' },
            3: { bg: 'rgba(245,158,11,0.3)', border: 'rgba(245,158,11,0.6)', color: '#fcd34d' },
            4: { bg: 'rgba(236,72,153,0.3)', border: 'rgba(236,72,153,0.6)', color: '#f9a8d4' }
        };
        
        function renderFocusItemsTable(filter) {
            const allItems = window.allFocusItems || [];
            const doneStates = ['closed', 'resolved', 'done', 'removed'];
            
            // Filter items
            let filteredItems = allItems;
            if (filter !== 'all') {
                const weekNum = parseInt(filter.replace('week', ''));
                filteredItems = allItems.filter(r => r.weekNum === weekNum);
            }
            
            // Update count
            document.getElementById('focusItemCount').textContent = filteredItems.length;
            
            // Update filter button styles
            ['all', 'week1', 'week2', 'week3', 'week4'].forEach(f => {
                const btn = document.getElementById('focusFilter' + f.charAt(0).toUpperCase() + f.slice(1));
                if (btn) {
                    if (f === filter) {
                        btn.style.opacity = '1';
                        btn.style.fontWeight = '600';
                        btn.style.boxShadow = '0 0 8px rgba(139,92,246,0.4)';
                    } else {
                        btn.style.opacity = '0.7';
                        btn.style.fontWeight = '400';
                        btn.style.boxShadow = 'none';
                    }
                }
            });
            
            // Calculate totals for filtered items
            const totalOrigEst = filteredItems.reduce((sum, r) => sum + (r.taskEstimate || 0), 0);
            const totalCompleted = filteredItems.reduce((sum, r) => sum + (r.taskCompletedWork || 0), 0);
            const completedPct = totalOrigEst > 0 ? Math.round((totalCompleted / totalOrigEst) * 100) : 0;
            const remainingPct = 100 - completedPct;
            
            document.getElementById('focusCompletedPct').textContent = completedPct + '%';
            document.getElementById('focusRemainingPct').textContent = remainingPct + '%';
            document.getElementById('focusProgressBar').style.width = completedPct + '%';
            
            // Render rows
            const tdStyle = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);';
            const focusTableBody = document.getElementById('weekFocusTableBody');
            
            if (filteredItems.length === 0) {
                document.getElementById('noFocusItems').style.display = 'block';
                focusTableBody.innerHTML = '';
                return;
            }
            
            document.getElementById('noFocusItems').style.display = 'none';
            
            focusTableBody.innerHTML = filteredItems.map(req => {
                const state = req.fields['System.State'] || '';
                const isDone = doneStates.includes(state.toLowerCase());
                const stateColor = isDone ? '#10b981' : (state.toLowerCase() === 'active' ? '#60a5fa' : '#f59e0b');
                
                // Week badge with attractive styling
                const weekStyle = weekBadgeStyles[req.weekNum] || weekBadgeStyles[1];
                const weekBadge = `<span style="background:${weekStyle.bg};border:1px solid ${weekStyle.border};color:${weekStyle.color};padding:4px 12px;border-radius:6px;font-size:0.72rem;font-weight:600;display:inline-block;box-shadow:0 2px 4px rgba(0,0,0,0.2);">Week ${req.weekNum}</span>`;
                
                // Progress calculation
                const origEst = req.taskEstimate || 0;
                const completed = req.taskCompletedWork || 0;
                const progress = origEst > 0 ? Math.round((completed / origEst) * 100) : 0;
                const progressColor = progress >= 80 ? '#10b981' : (progress >= 50 ? '#fbbf24' : '#f472b6');
                const progressBar = `
                    <div style="display:flex;align-items:center;gap:6px;">
                        <div style="flex:1;height:8px;background:rgba(0,0,0,0.4);border-radius:4px;overflow:hidden;min-">
                            <div style="height:100%;background:linear-gradient(90deg, ${progressColor}, ${progressColor}dd);width:${progress}%;transition:width 0.3s;border-radius:4px;"></div>
                        </div>
                        <span style="color:${progressColor};font-weight:700;font-size:0.8rem;min-">${progress}%</span>
                    </div>`;
                
                // Get assigned member (first name only for space)
                const assignedTo = req.fields['System.AssignedTo']?.displayName || '-';
                const assignedFirstName = assignedTo !== '-' ? assignedTo.split(' ')[0] : '-';
                
                return `<tr style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <td style="${tdStyle}"><a href="${tfsUrl}/${project}/_workitems/edit/${req.id}" target="_blank" class="wi-link">${req.id}</a></td>
                    <td style="${tdStyle}">${req.fields['System.Title'] || ''}</td>
                    <td style="${tdStyle}color:${stateColor};font-weight:500;">${state}</td>
                    <td style="${tdStyle}text-align:center;">${weekBadge}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;font-weight:600;">${fmtH(origEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#f472b6;font-weight:500;">${fmtH(req.taskRemainingWork || 0)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;font-weight:500;">${fmtH(completed)}h</td>
                    <td style="${tdStyle}">${progressBar}</td>
                    <td style="${tdStyle}color:#a5b4fc;font-size:0.72rem;" title="${assignedTo}">${assignedFirstName}</td>
                </tr>`;
            }).join('');
        }
        
        function filterFocusItems(filter) {
            window.currentFocusFilter = filter;
            renderFocusItemsTable(filter);
        }
        
        function toggleMembersCapacity() {
            const btn = document.getElementById('loadMembersCapBtn');
            const content = document.getElementById('membersCapacityContent');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'üîº Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                
                if (!membersCapacityLoaded) {
                    renderMembersCapacityTable();
                    membersCapacityLoaded = true;
                }
            } else {
                content.style.display = 'none';
                btn.textContent = 'üìã Show';
                btn.style.background = '';
                btn.style.borderColor = '';
            }
        }
        
        function renderMembersCapacityTable() {
            const members = capacityData.members || [];
            const thead = document.getElementById('membersCapacityTableHead');
            const tbody = document.getElementById('membersCapacityTableBody');
            
            if (members.length === 0) {
                document.getElementById('noMembersData').style.display = 'block';
                thead.innerHTML = '';
                tbody.innerHTML = '';
                return;
            }
            
            document.getElementById('noMembersData').style.display = 'none';
            
            // Sort members
            const sortedMembers = [...members].sort((a, b) => {
                let aVal, bVal;
                switch (membersCapSortField) {
                    case 'name': aVal = (a.name || '').toLowerCase(); bVal = (b.name || '').toLowerCase(); break;
                    case 'project': aVal = (a.project || '').toLowerCase(); bVal = (b.project || '').toLowerCase(); break;
                    case 'team': aVal = (a.team || '').toLowerCase(); bVal = (b.team || '').toLowerCase(); break;
                    case 'discipline': aVal = (a.discipline || '').toLowerCase(); bVal = (b.discipline || '').toLowerCase(); break;
                    case 'capPerDay': aVal = a.capacityPerDay || 0; bVal = b.capacityPerDay || 0; break;
                    case 'daysOff': aVal = a.daysOff || 0; bVal = b.daysOff || 0; break;
                    case 'workDays': aVal = a.workDays || 0; bVal = b.workDays || 0; break;
                    case 'total': aVal = a.totalCapacity || 0; bVal = b.totalCapacity || 0; break;
                    default: aVal = (a.name || '').toLowerCase(); bVal = (b.name || '').toLowerCase();
                }
                if (aVal < bVal) return membersCapSortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return membersCapSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Build header with sort icons
            const sortIcon = (field) => membersCapSortField === field ? (membersCapSortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : ' ‚áÖ';
            const thStyle = 'padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);cursor:pointer;';
            const thStyleCenter = 'padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);cursor:pointer;';
            
            thead.innerHTML = `<tr>
                <th style="${thStyle}" onclick="sortMembersCapacity('name')">Member${sortIcon('name')}</th>
                <th style="${thStyle}" onclick="sortMembersCapacity('project')">Project${sortIcon('project')}</th>
                <th style="${thStyle}" onclick="sortMembersCapacity('team')">Team${sortIcon('team')}</th>
                <th style="${thStyle}" onclick="sortMembersCapacity('discipline')">Discipline${sortIcon('discipline')}</th>
                <th style="${thStyleCenter}" onclick="sortMembersCapacity('capPerDay')">Cap/Day${sortIcon('capPerDay')}</th>
                <th style="${thStyleCenter}" onclick="sortMembersCapacity('daysOff')">Off${sortIcon('daysOff')}</th>
                <th style="${thStyleCenter}" onclick="sortMembersCapacity('workDays')">Days${sortIcon('workDays')}</th>
                <th style="${thStyleCenter}" onclick="sortMembersCapacity('total')">Total${sortIcon('total')}</th>
            </tr>`;
            
            // Build body
            tbody.innerHTML = sortedMembers.map(m => `<tr>
                <td style="padding:8px;">${m.name}</td>
                <td style="padding:8px;color:#f472b6;font-size:0.7rem;">${m.project || '-'}</td>
                <td style="padding:8px;color:#67e8f9;font-size:0.7rem;">${m.team || '-'}</td>
                <td style="padding:8px;color:#a5b4fc;font-size:0.7rem;">${m.discipline || '-'}</td>
                <td style="padding:8px;text-align:center;">${fmtH(m.capacityPerDay)}h</td>
                <td style="padding:8px;text-align:center;color:${m.daysOff > 0 ? '#fbbf24' : '#94a3b8'};">${m.daysOff}</td>
                <td style="padding:8px;text-align:center;">${m.workDays}</td>
                <td style="padding:8px;text-align:center;color:#34d399;font-weight:600;">${fmtH(m.totalCapacity)}h</td>
            </tr>`).join('');
            
            // Update totals
            document.getElementById('totalCapPerDay').textContent = fmtH(members.reduce((sum, m) => sum + m.capacityPerDay, 0)) + 'h';
            document.getElementById('totalDaysOff').textContent = members.reduce((sum, m) => sum + m.daysOff, 0);
            document.getElementById('totalTeamCapacity').textContent = fmtH(capacityData.teamCapacity) + 'h';
        }
        
        function sortMembersCapacity(field) {
            if (membersCapSortField === field) {
                membersCapSortDir = membersCapSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                membersCapSortField = field;
                // Default to asc for text fields, desc for numeric
                membersCapSortDir = ['capPerDay', 'daysOff', 'workDays', 'total'].includes(field) ? 'desc' : 'asc';
            }
            renderMembersCapacityTable();
        }

        // ========== TAB SWITCHING ==========
        function switchTab(tabNum) {
            // Hide all tab contents
            document.getElementById('tabContent1').style.display = 'none';
            document.getElementById('tabContent2').style.display = 'none';
            document.getElementById('tabContent3').style.display = 'none';
            
            // Reset all tab buttons
            const inactiveStyle = 'padding: 8px 16px; font-size: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px 6px 0 0; color: #94a3b8; cursor: pointer; transition: all 0.2s;';
            const activeStyle = 'padding: 8px 16px; font-size: 0.8rem; background: rgba(59,130,246,0.3); border: 1px solid rgba(59,130,246,0.5); border-radius: 6px 6px 0 0; color: #93c5fd; cursor: pointer; transition: all 0.2s;';
            
            document.getElementById('tabBtn1').style.cssText = inactiveStyle;
            document.getElementById('tabBtn2').style.cssText = inactiveStyle;
            document.getElementById('tabBtn3').style.cssText = inactiveStyle;
            
            // Show selected tab and activate button
            document.getElementById('tabContent' + tabNum).style.display = 'block';
            document.getElementById('tabBtn' + tabNum).style.cssText = activeStyle;
        }

        function toggleBugsDashboard() {
            const btn = document.getElementById('toggleBugsBtn');
            const content = document.getElementById('bugsContent');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'üîº Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
            } else {
                content.style.display = 'none';
                btn.textContent = 'üìã Show';
                btn.style.background = '';
                btn.style.borderColor = '';
            }
        }
        
        function renderBugsTable(filter) {
            const allBugs = window.allBugs || [];
            
            // Filter bugs based on selection
            let filteredBugs = allBugs;
            if (filter === 'cs') {
                filteredBugs = allBugs.filter(b => {
                    const tags = (b.fields['System.Tags'] || '').toLowerCase();
                    return tags.includes('cs');
                });
            } else if (filter === 'production') {
                filteredBugs = allBugs.filter(b => {
                    const tags = (b.fields['System.Tags'] || '').toLowerCase();
                    return tags.includes('production_bug') || tags.includes('production bug');
                });
            }
            
            // Update filter button styles
            ['all', 'cs', 'production'].forEach(f => {
                const btnId = f === 'all' ? 'bugFilterAll' : (f === 'cs' ? 'bugFilterCS' : 'bugFilterProduction');
                const btn = document.getElementById(btnId);
                if (btn) {
                    if (f === filter) {
                        btn.style.opacity = '1';
                        btn.style.fontWeight = '700';
                        btn.style.boxShadow = '0 0 10px rgba(239,68,68,0.4)';
                    } else {
                        btn.style.opacity = '0.7';
                        btn.style.fontWeight = '400';
                        btn.style.boxShadow = 'none';
                    }
                }
            });
            
            // Update summary stats for filtered bugs
            document.getElementById('bugTotalCount').textContent = filteredBugs.length;
            document.getElementById('bugClosedCount').textContent = filteredBugs.filter(b => b.fields['System.State'] === 'Closed').length;
            document.getElementById('bugActiveCount').textContent = filteredBugs.filter(b => ['Active', 'Open', 'New'].includes(b.fields['System.State'])).length;
            document.getElementById('bugResolvedCount').textContent = filteredBugs.filter(b => b.fields['System.State'] === 'Resolved').length;
            
            // Calculate CS and Production counts for filtered
            const csCount = filteredBugs.filter(b => (b.fields['System.Tags'] || '').toLowerCase().includes('cs')).length;
            const prodCount = filteredBugs.filter(b => {
                const tags = (b.fields['System.Tags'] || '').toLowerCase();
                return tags.includes('production_bug') || tags.includes('production bug');
            }).length;
            document.getElementById('bugCSCount').textContent = csCount;
            document.getElementById('bugProductionCount').textContent = prodCount;
            
            // Render table
            const bugsBody = document.querySelector('#bugsTable tbody');
            const tdStyle = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);';
            
            if (filteredBugs.length > 0) {
                document.getElementById('noBugs').style.display = 'none';
                bugsBody.innerHTML = filteredBugs.map(b => {
                    const state = b.fields['System.State'] || '';
                    const stateColor = state === 'Closed' ? '#34d399' : (state === 'Resolved' ? '#60a5fa' : '#fbbf24');
                    const severity = b.fields['Microsoft.VSTS.Common.Severity'] || '-';
                    const severityColor = severity.includes('1') ? '#f87171' : (severity.includes('2') ? '#fbbf24' : '#94a3b8');
                    const assignedTo = b.fields['System.AssignedTo']?.displayName || '-';
                    const assignedFirstName = assignedTo !== '-' ? assignedTo.split(' ')[0] : '-';
                    
                    // Parse tags for badges
                    const tags = (b.fields['System.Tags'] || '').split(';').map(t => t.trim()).filter(t => t);
                    const hasCS = tags.some(t => t.toLowerCase() === 'cs');
                    const hasProd = tags.some(t => t.toLowerCase().includes('production'));
                    
                    let tagBadges = '';
                    if (hasCS) tagBadges += '<span style="background:rgba(59,130,246,0.3);color:#93c5fd;padding:2px 6px;border-radius:4px;font-size:0.65rem;margin-right:4px;">üéß CS</span>';
                    if (hasProd) tagBadges += '<span style="background:rgba(245,158,11,0.3);color:#fcd34d;padding:2px 6px;border-radius:4px;font-size:0.65rem;">üöÄ Prod</span>';
                    if (!hasCS && !hasProd) tagBadges = '<span style="color:#64748b;">-</span>';
                    
                    return `<tr style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                        <td style="${tdStyle}"><a href="${tfsUrl}/${project}/_workitems/edit/${b.id}" target="_blank" class="wi-link">${b.id}</a></td>
                        <td style="${tdStyle}">${b.fields['System.Title'] || ''}</td>
                        <td style="${tdStyle}color:${stateColor};font-weight:500;">${state}</td>
                        <td style="${tdStyle}text-align:center;">${tagBadges}</td>
                        <td style="${tdStyle}color:${severityColor};">${severity}</td>
                        <td style="${tdStyle}color:#a5b4fc;" title="${assignedTo}">${assignedFirstName}</td>
                    </tr>`;
                }).join('');
            } else {
                document.getElementById('noBugs').style.display = 'block';
                bugsBody.innerHTML = '';
            }
        }
        
        function filterBugs(filter) {
            window.currentBugFilter = filter;
            renderBugsTable(filter);
        }

        // ========== DISCIPLINE vs TASK EXECUTION TYPE MISMATCH ==========
        let mismatchDataLoaded = false;
        let mismatchAllData = [];
        let mismatchSortField = 'id';
        let mismatchSortDir = 'asc';
        
        function toggleMismatchDashboard() {
            const btn = document.getElementById('toggleMismatchBtn');
            const content = document.getElementById('mismatchContent');
            const excelBtn = document.getElementById('exportMismatchExcelBtn');
            const pdfBtn = document.getElementById('exportMismatchPdfBtn');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'üîº Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                excelBtn.style.display = 'inline-block';
                pdfBtn.style.display = 'inline-block';
                // Always reload data when showing to ensure fresh data after area change
                renderDisciplineMismatchTasks();
                mismatchDataLoaded = true;
            } else {
                content.style.display = 'none';
                btn.textContent = 'üìã Show';
                btn.style.background = '';
                btn.style.borderColor = '';
                excelBtn.style.display = 'none';
                pdfBtn.style.display = 'none';
            }
        }

        // ==================== OVERALL AI ADOPTION SUMMARY ====================
        let overallAISummaryLoaded = false;
        
        function toggleOverallAISummary() {
            const btn = document.getElementById('loadOverallSummaryBtn');
            const content = document.getElementById('overallAISummaryContent');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                btn.textContent = 'üîº Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                
                if (!overallAISummaryLoaded) {
                    loadOverallAISummary();
                    overallAISummaryLoaded = true;
                }
            } else {
                content.style.display = 'none';
                btn.textContent = 'üìä Show';
                btn.style.background = '';
                btn.style.borderColor = '';
                overallAISummaryLoaded = false;
            }
        }
        
        function loadOverallAISummary() {
            // Valid requirement IDs: Deliverable, Deliverables Adhoc, Deliverables OnHold, Non-Deliverable
            const validReqIds = new Set();
            requirements.forEach(req => {
                const tags = (req.fields['System.Tags'] || '').split(';').map(t => t.trim().toLowerCase());
                if (tags.includes('deliverable') || tags.includes('deliverables adhoc') || 
                    tags.includes('deliverables onhold') || tags.includes('non-deliverable')) {
                    validReqIds.add(req.id);
                }
            });
            
            // Accumulators
            let aiTaskCount = 0, manualTaskCount = 0, maiIneffTaskCount = 0;
            let aiOrigEst = 0, aiRevisedEst = 0, aiTotalOrigEst = 0, aiCompleted = 0;
            let maiIneffOrigEst = 0, maiIneffCompleted = 0;
            let manualOrigEst = 0, manualCompleted = 0;
            
            tasks.forEach(t => {
                if (!t.fields) return;
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return;
                
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return;
                
                const state = t.fields['System.State'] || '';
                const reason = t.fields['System.Reason'] || '';
                if (!['Resolved', 'Closed'].includes(state)) return;
                if (reason === 'Rejected') return;
                
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                const compWork = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                if (origEst <= 0) return;
                
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                const isAiType = execType.startsWith('AI-');
                const isManualType = execType === 'Manual';
                const isManualAiIneff = execType === 'Manual-AI-Ineffective';
                
                if (!isAiType && !isManualType && !isManualAiIneff) return;
                
                if (isAiType) {
                    aiTaskCount++;
                    if (revisedEst <= 0) aiOrigEst += originalEst;
                    aiRevisedEst += revisedEst;
                    aiTotalOrigEst += origEst; // Per-task: revisedEst > 0 ? revisedEst : originalEst
                    aiCompleted += compWork;
                } else if (isManualAiIneff) {
                    maiIneffTaskCount++;
                    maiIneffOrigEst += origEst;
                    maiIneffCompleted += compWork;
                } else {
                    manualTaskCount++;
                    manualOrigEst += origEst;
                    manualCompleted += compWork;
                }
            });
            
            const totalTasks = aiTaskCount + maiIneffTaskCount + manualTaskCount;
            // AI Adoption Rate based on OrigEst hours
            const totalOrigEst = aiOrigEst + maiIneffOrigEst;
            const aiAdoptionRate = maiIneffOrigEst <= 0 ? 100 : (totalOrigEst > 0 ? Math.round((aiOrigEst / totalOrigEst) * 100) : 0);
            
            // Use Total AI Orig Est (per-task: revised if available, else original) for efficiency
            const aiEfficiency = aiTotalOrigEst > 0 ? Math.round(((aiTotalOrigEst - aiCompleted) / aiTotalOrigEst) * 100) : 0;
            const aiHoursSaved = aiTotalOrigEst - aiCompleted;
            
            const manualEfficiency = manualOrigEst > 0 ? Math.round(((manualOrigEst - manualCompleted) / manualOrigEst) * 100) : 0;
            const manualHoursSaved = manualOrigEst - manualCompleted;
            
            // Row 1 - Task Counts
            document.getElementById('oasOverallTasks').textContent = totalTasks;
            document.getElementById('oasAiTasks').textContent = aiTaskCount;
            document.getElementById('oasManualTasks').textContent = manualTaskCount;
            document.getElementById('oasMaiIneffTasks').textContent = maiIneffTaskCount;
            document.getElementById('oasAiAdoptionRate').textContent = aiAdoptionRate + '%';
            
            // Row 2 - AI Hours
            document.getElementById('oasAiOrigEst').textContent = fmtH(aiOrigEst) + 'h';
            document.getElementById('oasAiRevisedEst').textContent = fmtH(aiRevisedEst) + 'h';
            document.getElementById('oasAiTotalOrigEst').textContent = fmtH(aiTotalOrigEst) + 'h';
            document.getElementById('oasAiCompleted').textContent = fmtH(aiCompleted) + 'h';
            const aiEffEl = document.getElementById('oasAiEfficiency');
            aiEffEl.textContent = aiEfficiency + '%';
            aiEffEl.style.color = aiEfficiency >= 0 ? '#22d3ee' : '#f87171';
            const aiSavedEl = document.getElementById('oasAiHoursSaved');
            aiSavedEl.textContent = fmtH(aiHoursSaved) + 'h';
            aiSavedEl.style.color = aiHoursSaved >= 0 ? '#f472b6' : '#f87171';
            
            // Row 3 - Manual Hours
            document.getElementById('oasManualOrigEst').textContent = fmtH(manualOrigEst) + 'h';
            document.getElementById('oasManualCompleted').textContent = fmtH(manualCompleted) + 'h';
            
            // MAI-Ineff Hours
            document.getElementById('oasMaiIneffOrigEst').textContent = fmtH(maiIneffOrigEst) + 'h';
            document.getElementById('oasMaiIneffCompleted').textContent = fmtH(maiIneffCompleted) + 'h';
            const maiIneffEfficiency = maiIneffOrigEst > 0 ? Math.round(((maiIneffOrigEst - maiIneffCompleted) / maiIneffOrigEst) * 100) : 0;
            const maiIneffHoursSaved = maiIneffOrigEst - maiIneffCompleted;
            const maiIneffEffEl = document.getElementById('oasMaiIneffEfficiency');
            maiIneffEffEl.textContent = maiIneffEfficiency + '%';
            maiIneffEffEl.style.color = maiIneffEfficiency >= 0 ? '#22d3ee' : '#f87171';
            const maiIneffSavedEl = document.getElementById('oasMaiIneffHoursSaved');
            maiIneffSavedEl.textContent = fmtH(maiIneffHoursSaved) + 'h';
            maiIneffSavedEl.style.color = maiIneffHoursSaved >= 0 ? '#f472b6' : '#f87171';
            const manEffEl = document.getElementById('oasManualEfficiency');
            manEffEl.textContent = manualEfficiency + '%';
            manEffEl.style.color = manualEfficiency >= 0 ? '#22d3ee' : '#f87171';
            const manSavedEl = document.getElementById('oasManualHoursSaved');
            manSavedEl.textContent = fmtH(manualHoursSaved) + 'h';
            manSavedEl.style.color = manualHoursSaved >= 0 ? '#f472b6' : '#f87171';
        }

        // ========== AI ADOPTION DATA ==========
        let aiAdoptionDataLoaded = false;
        
        function toggleAIAdoptionData() {
            const btn = document.getElementById('loadAIAdoptionBtn');
            const content = document.getElementById('aiAdoptionContent');
            const exportBtn = document.getElementById('exportAIAdoptionBtn');
            const exportPdfBtn = document.getElementById('exportAIAdoptionPdfBtn');
            
            // Toggle between Load and Unload
            if (content.style.display === 'none' || content.style.display === '') {
                // Load/Show content
                content.style.display = 'block';
                btn.textContent = 'üîº Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                exportBtn.style.display = 'inline-block';
                exportPdfBtn.style.display = 'inline-block';
                
                if (!aiAdoptionDataLoaded) {
                    renderAIAdoptionData();
                    aiAdoptionDataLoaded = true;
                }
            } else {
                // Unload/Hide content
                content.style.display = 'none';
                btn.textContent = 'üìä Show';
                btn.style.background = '';
                btn.style.borderColor = '';
                exportBtn.style.display = 'none';
                exportPdfBtn.style.display = 'none';
            }
        }
        
        // Toggle functions for summary tables
        function toggleMemberSummary() {
            const content = document.getElementById('memberSummaryContent');
            const btn = document.getElementById('toggleMemberSummaryBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show';
            }
        }
        
        function toggleAreaSummary() {
            const content = document.getElementById('areaSummaryContent');
            const btn = document.getElementById('toggleAreaSummaryBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show';
            }
        }
        
        function toggleProjectSummary() {
            const content = document.getElementById('projectSummaryContent');
            const btn = document.getElementById('toggleProjectSummaryBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show';
            }
        }
        
        function renderAIAdoptionData() {
            // Get Development members from capacity data
            const devMembers = (capacityData.members || []).filter(m => 
                m.discipline && m.discipline.toLowerCase().includes('development')
            );
            
            // Create set of deliverable and non-deliverable requirement IDs
            const validReqIds = new Set();
            requirements.forEach(req => {
                if (req.category === 'deliverable' || req.category === 'nonDeliverable') {
                    validReqIds.add(req.id);
                }
            });
            
            // Filter tasks based on criteria
            const completedStates = ['resolved', 'closed'];
            
            const validTasks = tasks.filter(t => {
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return false;
                
                const state = (t.fields['System.State'] || '').toLowerCase();
                const reason = (t.fields['System.Reason'] || '').toLowerCase();
                // Use Revised Estimate if available (non-zero), otherwise use Original Estimate
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                
                // Filter by area path to match selected areas (uses global helper)
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return false;
                
                return completedStates.includes(state) && 
                       reason !== 'rejected' && 
                       origEst > 0;
            });
            
            // Build member data map from capacity data
            const memberDataMap = {};
            devMembers.forEach(m => {
                memberDataMap[m.name.toLowerCase().trim()] = {
                    name: m.name,
                    project: m.project || '-',
                    team: m.team || '-',
                    taskCount: 0,
                    claudeAiCount: 0,
                    copilotCount: 0,
                    manualCount: 0,
                    totalOrigEst: 0,
                    totalCompleted: 0,
                    aiOrigEst: 0,
                    aiCompleted: 0,
                    manualOrigEst: 0,
                    manualCompleted: 0,
                    manualAiIneffCount: 0,
                    manualAiIneffOrigEst: 0,
                    manualAiIneffCompleted: 0
                };
            });
            
            // Process tasks and aggregate by member
            // Also add members from task assignments who might not be in capacity data
            validTasks.forEach(t => {
                const assignedTo = t.fields['System.AssignedTo']?.displayName || '';
                const discipline = t.fields['Microsoft.VSTS.Common.Discipline'] || '';
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                // Use Revised Estimate if available (non-zero), otherwise use Original Estimate
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                const completed = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                const tags = (t.fields['System.Tags'] || '').toLowerCase();
                // Check for Claude AI tag with flexible matching (Claude AI, ClaudeAI, Claude-AI, etc.)
                const hasClaudeAiTag = tags.includes('claude ai') || tags.includes('claudeai') || tags.includes('claude-ai') || /claude[\s\-_]*ai/i.test(tags);
                
                // Check if execution type starts with AI-Dev or AI-Test-Auto-
                const isAiType = execType.startsWith('AI-Dev') || execType.startsWith('AI-Test-Auto-');
                const isManualType = execType === 'Manual';
                const isManualAiIneff = execType === 'Manual-AI-Ineffective';
                
                // Only count if execution type is AI-Dev* or AI-Test-Auto-* or Manual or Manual-AI-Ineffective
                if (!isAiType && !isManualType && !isManualAiIneff) return;
                
                // Only count Development discipline tasks
                if (!discipline.toLowerCase().includes('development')) return;
                
                // Match to member - use full name matching (not just first name)
                const assignedToLower = assignedTo.toLowerCase().trim();
                
                // First try to find existing member
                let memberKey = Object.keys(memberDataMap).find(nameLower => {
                    // Full name matching - check if one contains the other
                    return assignedToLower.includes(nameLower) || nameLower.includes(assignedToLower);
                });
                
                // If member not found in capacity data, add them from task assignment
                // This handles cases where member doesn't have capacity set but has tasks
                if (!memberKey && assignedTo) {
                    memberKey = assignedToLower;
                    const taskAreaPath = t.fields['System.AreaPath'] || '';
                    const taskProject = taskAreaPath.split('\\')[0] || '-';
                    const taskTeam = taskAreaPath.split('\\')[1] || '-';
                    memberDataMap[memberKey] = {
                        name: assignedTo,
                        project: taskProject,
                        team: taskTeam,
                        taskCount: 0,
                        claudeAiCount: 0,
                        copilotCount: 0,
                        manualCount: 0,
                        totalOrigEst: 0,
                        totalCompleted: 0,
                        aiOrigEst: 0,
                        aiCompleted: 0,
                        manualOrigEst: 0,
                        manualCompleted: 0,
                        manualAiIneffCount: 0,
                        manualAiIneffOrigEst: 0,
                        manualAiIneffCompleted: 0
                    };
                }
                
                if (memberKey) {
                    const memberData = memberDataMap[memberKey];
                    memberData.taskCount++;
                    
                    // Count Claude AI vs Copilot vs Manual tasks
                    // If "Claude AI" tag found -> Claude AI column, otherwise -> Copilot column
                    if (isAiType && hasClaudeAiTag) {
                        memberData.claudeAiCount++;
                    } else if (isAiType && !hasClaudeAiTag) {
                        memberData.copilotCount++;
                    }
                    
                    if (isManualType) {
                        memberData.manualCount++;
                    }
                    
                    if (isManualAiIneff) {
                        memberData.manualAiIneffCount++;
                    }
                    
                    memberData.totalOrigEst += origEst;
                    memberData.totalCompleted += completed;
                    
                    if (isAiType) {
                        memberData.aiOrigEst += origEst;
                        memberData.aiCompleted += completed;
                    } else if (isManualType) {
                        memberData.manualOrigEst += origEst;
                        memberData.manualCompleted += completed;
                    } else if (isManualAiIneff) {
                        memberData.manualAiIneffOrigEst += origEst;
                        memberData.manualAiIneffCompleted += completed;
                    }
                }
            });
            
            // Convert to array and filter members with tasks
            const memberResults = Object.values(memberDataMap).filter(m => m.taskCount > 0);
            
            // Calculate grand totals
            let grandTotalOrigEst = 0, grandTotalCompleted = 0;
            let grandAiOrigEst = 0, grandAiCompleted = 0;
            let grandManualOrigEst = 0, grandManualCompleted = 0;
            let grandManualAiIneffOrigEst = 0, grandManualAiIneffCompleted = 0;
            
            memberResults.forEach(m => {
                grandTotalOrigEst += m.totalOrigEst;
                grandTotalCompleted += m.totalCompleted;
                grandAiOrigEst += m.aiOrigEst;
                grandAiCompleted += m.aiCompleted;
                grandManualOrigEst += m.manualOrigEst;
                grandManualCompleted += m.manualCompleted;
                grandManualAiIneffOrigEst += m.manualAiIneffOrigEst;
                grandManualAiIneffCompleted += m.manualAiIneffCompleted;
            });
            
            // Calculate efficiencies
            const manualEfficiency = grandManualOrigEst > 0 ? Math.round(((grandManualOrigEst - grandManualCompleted) / grandManualOrigEst) * 100) : 0;
            const aiEfficiency = grandAiOrigEst > 0 ? Math.round(((grandAiOrigEst - grandAiCompleted) / grandAiOrigEst) * 100) : 0;
            
            // Update summary stats
            document.getElementById('aiDevMemberCount').textContent = memberResults.length;
            document.getElementById('aiTotalTasks').textContent = memberResults.reduce((sum, m) => sum + m.taskCount, 0);
            document.getElementById('aiTotalOrigEst').textContent = fmtH(grandTotalOrigEst) + 'h';
            document.getElementById('aiTotalCompleted').textContent = fmtH(grandTotalCompleted) + 'h';
            document.getElementById('aiManualEfficiency').textContent = manualEfficiency + '%';
            document.getElementById('aiAIEfficiency').textContent = aiEfficiency + '%';
            
            // Color efficiency values
            const manualEffEl = document.getElementById('aiManualEfficiency');
            const aiEffEl = document.getElementById('aiAIEfficiency');
            manualEffEl.style.color = manualEfficiency >= 0 ? '#34d399' : '#f87171';
            aiEffEl.style.color = aiEfficiency >= 0 ? '#34d399' : '#f87171';
            
            // Build table
            const thead = document.getElementById('aiAdoptionTableHead');
            const tbody = document.getElementById('aiAdoptionTableBody');
            const tfoot = document.getElementById('aiAdoptionTableFoot');
            
            if (memberResults.length === 0) {
                document.getElementById('noAIAdoptionData').style.display = 'block';
                thead.innerHTML = '';
                tbody.innerHTML = '';
                tfoot.innerHTML = '';
                return;
            }
            
            document.getElementById('noAIAdoptionData').style.display = 'none';
            
            // Store member results globally for sorting
            aiAdoptionMemberData = memberResults.map(m => {
                // Pre-calculate derived values for sorting
                const mTotalOrig = m.aiOrigEst + m.manualAiIneffOrigEst;
                const mAiAdoption = m.manualAiIneffOrigEst <= 0 ? 100 : (mTotalOrig > 0 ? Math.round((m.aiOrigEst / mTotalOrig) * 100) : 0);
                const mManualEff = m.manualOrigEst > 0 ? Math.round(((m.manualOrigEst - m.manualCompleted) / m.manualOrigEst) * 100) : 0;
                const mAiEff = m.aiOrigEst > 0 ? Math.round(((m.aiOrigEst - m.aiCompleted) / m.aiOrigEst) * 100) : 0;
                const mHourSaved = m.aiOrigEst - m.aiCompleted;
                return { ...m, aiAdoption: mAiAdoption, manualEff: mManualEff, aiEff: mAiEff, hourSaved: mHourSaved };
            });
            
            // Store grand totals globally
            aiAdoptionGrandTotals = {
                grandAiOrigEst, grandAiCompleted, grandManualOrigEst, grandManualCompleted,
                grandManualAiIneffOrigEst, grandManualAiIneffCompleted,
                manualEfficiency, aiEfficiency
            };
            
            // Build area filter buttons
            const uniqueAreas = [...new Set(aiAdoptionMemberData.map(m => m.team))].sort();
            const filterBar = document.getElementById('aiAreaFilterBar');
            const filterBtns = document.getElementById('aiAreaFilterBtns');
            if (uniqueAreas.length > 1 && filterBar && filterBtns) {
                filterBar.style.display = 'block';
                const btnStyle = 'padding:3px 10px;border-radius:4px;font-size:0.65rem;cursor:pointer;border:1px solid;transition:all 0.2s;';
                filterBtns.innerHTML = `<button onclick="filterAIAdoptionByArea('All')" style="${btnStyle}background:${aiAdoptionAreaFilter==='All'?'rgba(139,92,246,0.5)':'rgba(255,255,255,0.08)'};border-color:${aiAdoptionAreaFilter==='All'?'rgba(139,92,246,0.7)':'rgba(255,255,255,0.15)'};color:${aiAdoptionAreaFilter==='All'?'#c4b5fd':'#94a3b8'};">All (${aiAdoptionMemberData.length})</button>` +
                    uniqueAreas.map(area => {
                        const count = aiAdoptionMemberData.filter(m => m.team === area).length;
                        const isActive = aiAdoptionAreaFilter === area;
                        return `<button onclick="filterAIAdoptionByArea('${area.replace(/'/g, "\\'")}')" style="${btnStyle}background:${isActive?'rgba(6,182,212,0.5)':'rgba(255,255,255,0.08)'};border-color:${isActive?'rgba(6,182,212,0.7)':'rgba(255,255,255,0.15)'};color:${isActive?'#67e8f9':'#94a3b8'};">${area} (${count})</button>`;
                    }).join('');
            } else if (filterBar) {
                filterBar.style.display = 'none';
            }
            
            // Header row 1: With sortable columns
            const thStyle = 'padding:10px 8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.75rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (field) => aiAdoptionSortField === field ? (aiAdoptionSortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : ' ‚áÖ';
            
            let headerRow1 = `<tr>
                <th rowspan="2" style="${thStyle}text-align:left;width:11%;" onclick="sortAIAdoptionTable('name')">Member${sortIcon('name')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortAIAdoptionTable('project')">Project${sortIcon('project')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortAIAdoptionTable('team')">Area${sortIcon('team')}</th>
                <th rowspan="2" style="${thStyle}width:4%;" onclick="sortAIAdoptionTable('taskCount')">Tasks${sortIcon('taskCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:4%;" onclick="sortAIAdoptionTable('claudeAiCount')">Claude${sortIcon('claudeAiCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:4%;" onclick="sortAIAdoptionTable('copilotCount')">Copilot${sortIcon('copilotCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(239,68,68,0.25);color:#fca5a5;width:4%;" onclick="sortAIAdoptionTable('manualAiIneffCount')">AI-Ineff${sortIcon('manualAiIneffCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:4%;" onclick="sortAIAdoptionTable('manualCount')">Manual${sortIcon('manualCount')}</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(139,92,246,0.25);color:#c4b5fd;width:9%;">AI Total</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(239,68,68,0.25);color:#fca5a5;width:9%;">AI-Ineff Hours</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(245,158,11,0.25);color:#fcd34d;width:9%;">Manual Hours</th>
                <th rowspan="2" style="${thStyle}background:rgba(59,130,246,0.25);color:#60a5fa;width:6%;" onclick="sortAIAdoptionTable('aiAdoption')">AI Adopt${sortIcon('aiAdoption')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:6%;" onclick="sortAIAdoptionTable('manualEff')">Man Eff${sortIcon('manualEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:6%;" onclick="sortAIAdoptionTable('aiEff')">AI Eff${sortIcon('aiEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:6%;" onclick="sortAIAdoptionTable('hourSaved')">Hr Save${sortIcon('hourSaved')}</th>
            </tr>`;
            
            // Header row 2: Orig/Comp subheaders with sorting
            const subThStyle = 'padding:6px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);font-size:0.7rem;cursor:pointer;';
            let headerRow2 = `<tr>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortAIAdoptionTable('aiOrigEst')">Orig${sortIcon('aiOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortAIAdoptionTable('aiCompleted')">Comp${sortIcon('aiCompleted')}</th>
                <th style="${subThStyle}color:#fca5a5;" onclick="sortAIAdoptionTable('manualAiIneffOrigEst')">Orig${sortIcon('manualAiIneffOrigEst')}</th>
                <th style="${subThStyle}color:#fb7185;" onclick="sortAIAdoptionTable('manualAiIneffCompleted')">Comp${sortIcon('manualAiIneffCompleted')}</th>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortAIAdoptionTable('manualOrigEst')">Orig${sortIcon('manualOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortAIAdoptionTable('manualCompleted')">Comp${sortIcon('manualCompleted')}</th>
            </tr>`;
            
            thead.innerHTML = headerRow1 + headerRow2;
            
            // Render table rows
            renderAIAdoptionTableRows();
        }
        
        function filterAIAdoptionByArea(area) {
            aiAdoptionAreaFilter = area;
            // Re-render area buttons and table
            const uniqueAreas = [...new Set(aiAdoptionMemberData.map(m => m.team))].sort();
            const filterBtns = document.getElementById('aiAreaFilterBtns');
            if (filterBtns) {
                const btnStyle = 'padding:3px 10px;border-radius:4px;font-size:0.65rem;cursor:pointer;border:1px solid;transition:all 0.2s;';
                filterBtns.innerHTML = `<button onclick="filterAIAdoptionByArea('All')" style="${btnStyle}background:${aiAdoptionAreaFilter==='All'?'rgba(139,92,246,0.5)':'rgba(255,255,255,0.08)'};border-color:${aiAdoptionAreaFilter==='All'?'rgba(139,92,246,0.7)':'rgba(255,255,255,0.15)'};color:${aiAdoptionAreaFilter==='All'?'#c4b5fd':'#94a3b8'};">All (${aiAdoptionMemberData.length})</button>` +
                    uniqueAreas.map(a => {
                        const count = aiAdoptionMemberData.filter(m => m.team === a).length;
                        const isActive = aiAdoptionAreaFilter === a;
                        return `<button onclick="filterAIAdoptionByArea('${a.replace(/'/g, "\\'")}')" style="${btnStyle}background:${isActive?'rgba(6,182,212,0.5)':'rgba(255,255,255,0.08)'};border-color:${isActive?'rgba(6,182,212,0.7)':'rgba(255,255,255,0.15)'};color:${isActive?'#67e8f9':'#94a3b8'};">${a} (${count})</button>`;
                    }).join('');
            }
            renderAIAdoptionTableRows();
        }
        
        // Separate function to render AI Adoption table rows (for sorting)
        function renderAIAdoptionTableRows() {
            const tbody = document.getElementById('aiAdoptionTableBody');
            const tfoot = document.getElementById('aiAdoptionTableFoot');
            
            // Filter by area then sort
            const filteredData = aiAdoptionAreaFilter === 'All' ? aiAdoptionMemberData : aiAdoptionMemberData.filter(m => m.team === aiAdoptionAreaFilter);
            const sortedData = [...filteredData].sort((a, b) => {
                let aVal = a[aiAdoptionSortField];
                let bVal = b[aiAdoptionSortField];
                
                // Handle string comparison
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                }
                
                // Handle null/undefined
                if (aVal === null || aVal === undefined) aVal = aiAdoptionSortDir === 'asc' ? Infinity : -Infinity;
                if (bVal === null || bVal === undefined) bVal = aiAdoptionSortDir === 'asc' ? Infinity : -Infinity;
                
                if (aVal < bVal) return aiAdoptionSortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return aiAdoptionSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Data rows
            const tdStyle = 'padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:0.8rem;';
            tbody.innerHTML = sortedData.map(m => {
                const mHourSavedColor = m.hourSaved >= 0 ? '#f472b6' : '#f87171';
                const mManualEffColor = m.manualEff >= 0 ? '#34d399' : '#f87171';
                const mAiEffColor = m.aiEff >= 0 ? '#34d399' : '#f87171';
                const mTotalOrig = m.aiOrigEst + m.manualAiIneffOrigEst;
                
                return `<tr style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <td style="${tdStyle}text-align:left;white-space:nowrap;">${m.name}</td>
                    <td style="${tdStyle}text-align:left;color:#a5b4fc;font-size:0.7rem;">${m.project}</td>
                    <td style="${tdStyle}text-align:left;color:#67e8f9;font-size:0.7rem;">${m.team}</td>
                    <td style="${tdStyle}text-align:center;">${m.taskCount}</td>
                    <td style="${tdStyle}text-align:center;color:#c4b5fd;">${m.claudeAiCount > 0 ? m.claudeAiCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#22d3ee;">${m.copilotCount > 0 ? m.copilotCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${m.manualAiIneffCount > 0 ? m.manualAiIneffCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fcd34d;">${m.manualCount > 0 ? m.manualCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${m.aiOrigEst > 0 ? fmtH(m.aiOrigEst) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${m.aiCompleted > 0 ? fmtH(m.aiCompleted) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${m.manualAiIneffOrigEst > 0 ? fmtH(m.manualAiIneffOrigEst) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fb7185;">${m.manualAiIneffCompleted > 0 ? fmtH(m.manualAiIneffCompleted) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${m.manualOrigEst > 0 ? fmtH(m.manualOrigEst) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${m.manualCompleted > 0 ? fmtH(m.manualCompleted) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#60a5fa;font-weight:600;">${m.aiAdoption + '%'}</td>
                    <td style="${tdStyle}text-align:center;color:${mManualEffColor};font-weight:600;">${m.manualOrigEst > 0 ? m.manualEff + '%' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:${mAiEffColor};font-weight:600;">${m.aiOrigEst > 0 ? m.aiEff + '%' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:${mHourSavedColor};font-weight:600;">${m.aiOrigEst > 0 ? fmtH(m.hourSaved) + 'h' : '-'}</td>
                </tr>`;
            }).join('');
            
            // Footer totals row - recalculate from filtered data
            let grandAiOrigEst, grandAiCompleted, grandManualOrigEst, grandManualCompleted, grandManualAiIneffOrigEst, grandManualAiIneffCompleted, manualEfficiency, aiEfficiency;
            if (aiAdoptionAreaFilter === 'All') {
                ({ grandAiOrigEst, grandAiCompleted, grandManualOrigEst, grandManualCompleted, grandManualAiIneffOrigEst, grandManualAiIneffCompleted, manualEfficiency, aiEfficiency } = aiAdoptionGrandTotals);
            } else {
                grandAiOrigEst = filteredData.reduce((s,m) => s + m.aiOrigEst, 0);
                grandAiCompleted = filteredData.reduce((s,m) => s + m.aiCompleted, 0);
                grandManualOrigEst = filteredData.reduce((s,m) => s + m.manualOrigEst, 0);
                grandManualCompleted = filteredData.reduce((s,m) => s + m.manualCompleted, 0);
                grandManualAiIneffOrigEst = filteredData.reduce((s,m) => s + m.manualAiIneffOrigEst, 0);
                grandManualAiIneffCompleted = filteredData.reduce((s,m) => s + m.manualAiIneffCompleted, 0);
                manualEfficiency = grandManualOrigEst > 0 ? Math.round(((grandManualOrigEst - grandManualCompleted) / grandManualOrigEst) * 100) : 0;
                aiEfficiency = grandAiOrigEst > 0 ? Math.round(((grandAiOrigEst - grandAiCompleted) / grandAiOrigEst) * 100) : 0;
            }
            const totalTasks = filteredData.reduce((sum, m) => sum + m.taskCount, 0);
            const totalClaudeAi = filteredData.reduce((sum, m) => sum + m.claudeAiCount, 0);
            const totalCopilot = filteredData.reduce((sum, m) => sum + m.copilotCount, 0);
            const totalManual = filteredData.reduce((sum, m) => sum + m.manualCount, 0);
            const totalManualAiIneff = filteredData.reduce((sum, m) => sum + m.manualAiIneffCount, 0);
            const tfStyle = 'padding:10px 8px;border-top:2px solid rgba(139,92,246,0.4);font-size:0.8rem;';
            const footManualEffColor = manualEfficiency >= 0 ? '#34d399' : '#f87171';
            const footAiEffColor = aiEfficiency >= 0 ? '#34d399' : '#f87171';
            
            // Calculate overall AI Adoption
            const grandTotalOrig = (grandAiOrigEst || 0) + (grandManualAiIneffOrigEst || 0);
            const grandAiAdoption = (grandManualAiIneffOrigEst || 0) <= 0 ? 100 : (grandTotalOrig > 0 ? Math.round(((grandAiOrigEst || 0) / grandTotalOrig) * 100) : 0);
            
            // Calculate total Hour Saved
            const grandHourSaved = grandAiOrigEst - grandAiCompleted;
            const footHourSavedColor = grandHourSaved >= 0 ? '#f472b6' : '#f87171';
            
            // Only Grand Total in main table footer
            tfoot.innerHTML = `<tr>
                <td colspan="3" style="${tfStyle}text-align:right;color:#e2e8f0;font-weight:700;">Grand Total:</td>
                <td style="${tfStyle}text-align:center;color:#e2e8f0;font-weight:700;">${totalTasks}</td>
                <td style="${tfStyle}text-align:center;color:#c4b5fd;font-weight:700;">${totalClaudeAi}</td>
                <td style="${tfStyle}text-align:center;color:#22d3ee;font-weight:700;">${totalCopilot}</td>
                <td style="${tfStyle}text-align:center;color:#fca5a5;font-weight:700;">${totalManualAiIneff}</td>
                <td style="${tfStyle}text-align:center;color:#fcd34d;font-weight:700;">${totalManual}</td>
                <td style="${tfStyle}text-align:center;color:#fbbf24;font-weight:700;">${fmtH(grandAiOrigEst)}h</td>
                <td style="${tfStyle}text-align:center;color:#34d399;font-weight:700;">${fmtH(grandAiCompleted)}h</td>
                <td style="${tfStyle}text-align:center;color:#fca5a5;font-weight:700;">${fmtH(grandManualAiIneffOrigEst)}h</td>
                <td style="${tfStyle}text-align:center;color:#fb7185;font-weight:700;">${fmtH(grandManualAiIneffCompleted)}h</td>
                <td style="${tfStyle}text-align:center;color:#fbbf24;font-weight:700;">${fmtH(grandManualOrigEst)}h</td>
                <td style="${tfStyle}text-align:center;color:#34d399;font-weight:700;">${fmtH(grandManualCompleted)}h</td>
                <td style="${tfStyle}text-align:center;color:#60a5fa;font-weight:700;">${grandAiAdoption}%</td>
                <td style="${tfStyle}text-align:center;color:${footManualEffColor};font-weight:700;">${manualEfficiency}%</td>
                <td style="${tfStyle}text-align:center;color:${footAiEffColor};font-weight:700;">${aiEfficiency}%</td>
                <td style="${tfStyle}text-align:center;color:${footHourSavedColor};font-weight:700;">${fmtH(grandHourSaved)}h</td>
            </tr>`;
            
            // Render Area-wise Summary Table
            renderAreaSummaryTable();
            
            // Render Project-wise Summary Table
            renderProjectSummaryTable();
        }
        
        // Render Area-wise Summary Table
        function renderAreaSummaryTable() {
            const areaSummarySection = document.getElementById('areaSummarySection');
            const areaSummaryHead = document.getElementById('areaSummaryHead');
            const areaSummaryBody = document.getElementById('areaSummaryBody');
            
            if (!aiAdoptionMemberData || aiAdoptionMemberData.length === 0) {
                areaSummarySection.style.display = 'none';
                return;
            }
            
            areaSummarySection.style.display = 'block';
            // Reset inner content visibility and toggle button on re-render
            const areaSummaryContent = document.getElementById('areaSummaryContent');
            const toggleAreaBtn = document.getElementById('toggleAreaSummaryBtn');
            if (areaSummaryContent) areaSummaryContent.style.display = '';
            if (toggleAreaBtn) toggleAreaBtn.textContent = 'Hide';
            
            // Group by area
            const areaTotals = {};
            aiAdoptionMemberData.forEach(m => {
                const area = m.team || '-';
                if (!areaTotals[area]) {
                    areaTotals[area] = {
                        area: area,
                        project: m.project || '-',
                        taskCount: 0,
                        claudeAiCount: 0,
                        copilotCount: 0,
                        manualAiIneffCount: 0,
                        manualCount: 0,
                        aiOrigEst: 0,
                        aiCompleted: 0,
                        manualAiIneffOrigEst: 0,
                        manualAiIneffCompleted: 0,
                        manualOrigEst: 0,
                        manualCompleted: 0
                    };
                }
                areaTotals[area].taskCount += m.taskCount;
                areaTotals[area].claudeAiCount += m.claudeAiCount;
                areaTotals[area].copilotCount += m.copilotCount;
                areaTotals[area].manualAiIneffCount += m.manualAiIneffCount;
                areaTotals[area].manualCount += m.manualCount;
                areaTotals[area].aiOrigEst += m.aiOrigEst;
                areaTotals[area].aiCompleted += m.aiCompleted;
                areaTotals[area].manualAiIneffOrigEst += m.manualAiIneffOrigEst;
                areaTotals[area].manualAiIneffCompleted += m.manualAiIneffCompleted;
                areaTotals[area].manualOrigEst += m.manualOrigEst;
                areaTotals[area].manualCompleted += m.manualCompleted;
            });
            
            // Calculate derived fields for sorting
            areaSummaryData = Object.values(areaTotals).map(a => {
                const totalOrig = a.aiOrigEst + a.manualAiIneffOrigEst;
                return {
                    ...a,
                    aiAdoption: a.manualAiIneffOrigEst <= 0 ? 100 : (totalOrig > 0 ? Math.round((a.aiOrigEst / totalOrig) * 100) : 0),
                    manualEff: a.manualOrigEst > 0 ? Math.round(((a.manualOrigEst - a.manualCompleted) / a.manualOrigEst) * 100) : 0,
                    aiEff: a.aiOrigEst > 0 ? Math.round(((a.aiOrigEst - a.aiCompleted) / a.aiOrigEst) * 100) : 0,
                    hourSaved: a.aiOrigEst - a.aiCompleted
                };
            });
            
            // Sort data
            areaSummaryData.sort((a, b) => {
                let aVal = a[areaSortField];
                let bVal = b[areaSortField];
                
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();
                
                if (aVal === null || aVal === undefined) aVal = areaSortDir === 'asc' ? Infinity : -Infinity;
                if (bVal === null || bVal === undefined) bVal = areaSortDir === 'asc' ? Infinity : -Infinity;
                
                if (aVal < bVal) return areaSortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return areaSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Sort icon helper
            const sortIcon = (field) => areaSortField === field ? (areaSortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : ' ‚áÖ';
            
            // Header with clickable sorting
            const thStyle = 'padding:8px 6px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#67e8f9;font-size:0.7rem;text-transform:uppercase;cursor:pointer;';
            areaSummaryHead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;" onclick="sortAreaSummary('area')">Area${sortIcon('area')}</th>
                <th style="${thStyle}text-align:left;" onclick="sortAreaSummary('project')">Project${sortIcon('project')}</th>
                <th style="${thStyle}" onclick="sortAreaSummary('taskCount')">Tasks${sortIcon('taskCount')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.2);" onclick="sortAreaSummary('claudeAiCount')">Claude${sortIcon('claudeAiCount')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);" onclick="sortAreaSummary('copilotCount')">Copilot${sortIcon('copilotCount')}</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);" onclick="sortAreaSummary('manualAiIneffCount')">AI-Ineff${sortIcon('manualAiIneffCount')}</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);" onclick="sortAreaSummary('manualCount')">Manual${sortIcon('manualCount')}</th>
                <th style="${thStyle}" onclick="sortAreaSummary('aiOrigEst')">AI Orig${sortIcon('aiOrigEst')}</th>
                <th style="${thStyle}" onclick="sortAreaSummary('aiCompleted')">AI Comp${sortIcon('aiCompleted')}</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);" onclick="sortAreaSummary('manualAiIneffOrigEst')">AI-Ineff Orig${sortIcon('manualAiIneffOrigEst')}</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);" onclick="sortAreaSummary('manualAiIneffCompleted')">AI-Ineff Comp${sortIcon('manualAiIneffCompleted')}</th>
                <th style="${thStyle}" onclick="sortAreaSummary('manualOrigEst')">Man Orig${sortIcon('manualOrigEst')}</th>
                <th style="${thStyle}" onclick="sortAreaSummary('manualCompleted')">Man Comp${sortIcon('manualCompleted')}</th>
                <th style="${thStyle}background:rgba(59,130,246,0.2);" onclick="sortAreaSummary('aiAdoption')">AI Adopt${sortIcon('aiAdoption')}</th>
                <th style="${thStyle}" onclick="sortAreaSummary('manualEff')">Man Eff${sortIcon('manualEff')}</th>
                <th style="${thStyle}" onclick="sortAreaSummary('aiEff')">AI Eff${sortIcon('aiEff')}</th>
                <th style="${thStyle}background:rgba(236,72,153,0.2);" onclick="sortAreaSummary('hourSaved')">Hr Save${sortIcon('hourSaved')}</th>
            </tr>`;
            
            // Body rows
            const tdStyle = 'padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:0.75rem;';
            let bodyHtml = '';
            areaSummaryData.forEach(a => {
                const aHourSavedColor = a.hourSaved >= 0 ? '#f472b6' : '#f87171';
                const aManualEffColor = a.manualEff >= 0 ? '#34d399' : '#f87171';
                const aAiEffColor = a.aiEff >= 0 ? '#34d399' : '#f87171';
                
                bodyHtml += `<tr style="transition:background 0.2s;" onmouseover="this.style.background='rgba(6,182,212,0.1)'" onmouseout="this.style.background='transparent'">
                    <td style="${tdStyle}text-align:left;color:#67e8f9;font-weight:600;">üè∑Ô∏è ${a.area}</td>
                    <td style="${tdStyle}text-align:left;color:#94a3b8;font-size:0.65rem;">${a.project}</td>
                    <td style="${tdStyle}text-align:center;color:#e2e8f0;font-weight:600;">${a.taskCount}</td>
                    <td style="${tdStyle}text-align:center;color:#c4b5fd;">${a.claudeAiCount}</td>
                    <td style="${tdStyle}text-align:center;color:#22d3ee;">${a.copilotCount}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${a.manualAiIneffCount}</td>
                    <td style="${tdStyle}text-align:center;color:#fcd34d;">${a.manualCount}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(a.aiOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(a.aiCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${fmtH(a.manualAiIneffOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fb7185;">${fmtH(a.manualAiIneffCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(a.manualOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(a.manualCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#60a5fa;font-weight:600;">${a.aiAdoption}%</td>
                    <td style="${tdStyle}text-align:center;color:${aManualEffColor};">${a.manualEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${aAiEffColor};">${a.aiEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${aHourSavedColor};font-weight:600;">${fmtH(a.hourSaved)}h</td>
                </tr>`;
            });
            areaSummaryBody.innerHTML = bodyHtml;
        }
        
        // Sort Area-wise Summary
        function sortAreaSummary(field) {
            if (areaSortField === field) {
                areaSortDir = areaSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                areaSortField = field;
                areaSortDir = 'asc';
            }
            renderAreaSummaryTable();
        }
        
        // Render Project-wise Summary Table
        function renderProjectSummaryTable() {
            const projectSummarySection = document.getElementById('projectSummarySection');
            const projectSummaryHead = document.getElementById('projectSummaryHead');
            const projectSummaryBody = document.getElementById('projectSummaryBody');
            
            if (!aiAdoptionMemberData || aiAdoptionMemberData.length === 0) {
                projectSummarySection.style.display = 'none';
                return;
            }
            
            projectSummarySection.style.display = 'block';
            // Reset inner content visibility and toggle button on re-render
            const projectSummaryContent = document.getElementById('projectSummaryContent');
            const toggleProjectBtn = document.getElementById('toggleProjectSummaryBtn');
            if (projectSummaryContent) projectSummaryContent.style.display = '';
            if (toggleProjectBtn) toggleProjectBtn.textContent = 'Hide';
            
            // Group by project
            const projectTotals = {};
            aiAdoptionMemberData.forEach(m => {
                const proj = m.project || '-';
                if (!projectTotals[proj]) {
                    projectTotals[proj] = {
                        project: proj,
                        taskCount: 0,
                        claudeAiCount: 0,
                        copilotCount: 0,
                        manualAiIneffCount: 0,
                        manualCount: 0,
                        aiOrigEst: 0,
                        aiCompleted: 0,
                        manualAiIneffOrigEst: 0,
                        manualAiIneffCompleted: 0,
                        manualOrigEst: 0,
                        manualCompleted: 0
                    };
                }
                projectTotals[proj].taskCount += m.taskCount;
                projectTotals[proj].claudeAiCount += m.claudeAiCount;
                projectTotals[proj].copilotCount += m.copilotCount;
                projectTotals[proj].manualAiIneffCount += m.manualAiIneffCount;
                projectTotals[proj].manualCount += m.manualCount;
                projectTotals[proj].aiOrigEst += m.aiOrigEst;
                projectTotals[proj].aiCompleted += m.aiCompleted;
                projectTotals[proj].manualAiIneffOrigEst += m.manualAiIneffOrigEst;
                projectTotals[proj].manualAiIneffCompleted += m.manualAiIneffCompleted;
                projectTotals[proj].manualOrigEst += m.manualOrigEst;
                projectTotals[proj].manualCompleted += m.manualCompleted;
            });
            
            // Header
            const thStyle = 'padding:8px 6px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#a5b4fc;font-size:0.7rem;text-transform:uppercase;';
            projectSummaryHead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;">Project</th>
                <th style="${thStyle}">Tasks</th>
                <th style="${thStyle}background:rgba(168,85,247,0.2);">Claude</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);">Copilot</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Manual</th>
                <th style="${thStyle}">AI Orig</th>
                <th style="${thStyle}">AI Comp</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff Orig</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff Comp</th>
                <th style="${thStyle}">Man Orig</th>
                <th style="${thStyle}">Man Comp</th>
                <th style="${thStyle}background:rgba(59,130,246,0.2);">AI Adopt</th>
                <th style="${thStyle}">Man Eff</th>
                <th style="${thStyle}">AI Eff</th>
                <th style="${thStyle}background:rgba(236,72,153,0.2);">Hr Save</th>
            </tr>`;
            
            // Body rows
            const tdStyle = 'padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:0.75rem;';
            let bodyHtml = '';
            Object.values(projectTotals).forEach(p => {
                const pTotalOrig = p.aiOrigEst + p.manualAiIneffOrigEst;
                const pAiAdoption = p.manualAiIneffOrigEst <= 0 ? 100 : (pTotalOrig > 0 ? Math.round((p.aiOrigEst / pTotalOrig) * 100) : 0);
                const pManualEff = p.manualOrigEst > 0 ? Math.round(((p.manualOrigEst - p.manualCompleted) / p.manualOrigEst) * 100) : 0;
                const pAiEff = p.aiOrigEst > 0 ? Math.round(((p.aiOrigEst - p.aiCompleted) / p.aiOrigEst) * 100) : 0;
                const pHourSaved = p.aiOrigEst - p.aiCompleted;
                const pHourSavedColor = pHourSaved >= 0 ? '#f472b6' : '#f87171';
                const pManualEffColor = pManualEff >= 0 ? '#34d399' : '#f87171';
                const pAiEffColor = pAiEff >= 0 ? '#34d399' : '#f87171';
                
                bodyHtml += `<tr style="transition:background 0.2s;" onmouseover="this.style.background='rgba(99,102,241,0.1)'" onmouseout="this.style.background='transparent'">
                    <td style="${tdStyle}text-align:left;color:#a5b4fc;font-weight:600;">üìÅ ${p.project}</td>
                    <td style="${tdStyle}text-align:center;color:#e2e8f0;font-weight:600;">${p.taskCount}</td>
                    <td style="${tdStyle}text-align:center;color:#c4b5fd;">${p.claudeAiCount}</td>
                    <td style="${tdStyle}text-align:center;color:#22d3ee;">${p.copilotCount}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${p.manualAiIneffCount}</td>
                    <td style="${tdStyle}text-align:center;color:#fcd34d;">${p.manualCount}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(p.aiOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(p.aiCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${fmtH(p.manualAiIneffOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fb7185;">${fmtH(p.manualAiIneffCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(p.manualOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(p.manualCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#60a5fa;font-weight:600;">${pAiAdoption}%</td>
                    <td style="${tdStyle}text-align:center;color:${pManualEffColor};">${pManualEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${pAiEffColor};">${pAiEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${pHourSavedColor};font-weight:600;">${fmtH(pHourSaved)}h</td>
                </tr>`;
            });
            projectSummaryBody.innerHTML = bodyHtml;
        }
        
        // Sort AI Adoption table
        function sortAIAdoptionTable(field) {
            if (aiAdoptionSortField === field) {
                // Toggle direction
                aiAdoptionSortDir = aiAdoptionSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                // New field, default to ascending for name/project/team, descending for numbers
                aiAdoptionSortField = field;
                aiAdoptionSortDir = (field === 'name' || field === 'project' || field === 'team') ? 'asc' : 'desc';
            }
            
            // Update header sort icons
            const thead = document.getElementById('aiAdoptionTableHead');
            const thStyle = 'padding:10px 8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.75rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (f) => aiAdoptionSortField === f ? (aiAdoptionSortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : ' ‚áÖ';
            
            let headerRow1 = `<tr>
                <th rowspan="2" style="${thStyle}text-align:left;width:11%;" onclick="sortAIAdoptionTable('name')">Member${sortIcon('name')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortAIAdoptionTable('project')">Project${sortIcon('project')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortAIAdoptionTable('team')">Area${sortIcon('team')}</th>
                <th rowspan="2" style="${thStyle}width:4%;" onclick="sortAIAdoptionTable('taskCount')">Tasks${sortIcon('taskCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:4%;" onclick="sortAIAdoptionTable('claudeAiCount')">Claude${sortIcon('claudeAiCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:4%;" onclick="sortAIAdoptionTable('copilotCount')">Copilot${sortIcon('copilotCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(239,68,68,0.25);color:#fca5a5;width:4%;" onclick="sortAIAdoptionTable('manualAiIneffCount')">AI-Ineff${sortIcon('manualAiIneffCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:4%;" onclick="sortAIAdoptionTable('manualCount')">Manual${sortIcon('manualCount')}</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(139,92,246,0.25);color:#c4b5fd;width:9%;">AI Total</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(239,68,68,0.25);color:#fca5a5;width:9%;">AI-Ineff Hours</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(245,158,11,0.25);color:#fcd34d;width:9%;">Manual Hours</th>
                <th rowspan="2" style="${thStyle}background:rgba(59,130,246,0.25);color:#60a5fa;width:6%;" onclick="sortAIAdoptionTable('aiAdoption')">AI Adopt${sortIcon('aiAdoption')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:6%;" onclick="sortAIAdoptionTable('manualEff')">Man Eff${sortIcon('manualEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:6%;" onclick="sortAIAdoptionTable('aiEff')">AI Eff${sortIcon('aiEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:6%;" onclick="sortAIAdoptionTable('hourSaved')">Hr Save${sortIcon('hourSaved')}</th>
            </tr>`;
            
            const subThStyle = 'padding:6px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);font-size:0.7rem;cursor:pointer;';
            let headerRow2 = `<tr>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortAIAdoptionTable('aiOrigEst')">Orig${sortIcon('aiOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortAIAdoptionTable('aiCompleted')">Comp${sortIcon('aiCompleted')}</th>
                <th style="${subThStyle}color:#fca5a5;" onclick="sortAIAdoptionTable('manualAiIneffOrigEst')">Orig${sortIcon('manualAiIneffOrigEst')}</th>
                <th style="${subThStyle}color:#fb7185;" onclick="sortAIAdoptionTable('manualAiIneffCompleted')">Comp${sortIcon('manualAiIneffCompleted')}</th>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortAIAdoptionTable('manualOrigEst')">Orig${sortIcon('manualOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortAIAdoptionTable('manualCompleted')">Comp${sortIcon('manualCompleted')}</th>
            </tr>`;
            
            thead.innerHTML = headerRow1 + headerRow2;
            
            // Re-render the rows
            renderAIAdoptionTableRows();
        }

        // ==================== QA AI ADOPTION DATA FUNCTIONS ====================
        
        function toggleQAAIAdoptionData() {
            const btn = document.getElementById('loadQAAIAdoptionBtn');
            const content = document.getElementById('qaAIAdoptionContent');
            const exportBtn = document.getElementById('exportQAAIAdoptionBtn');
            const exportPdfBtn = document.getElementById('exportQAAIAdoptionPdfBtn');
            
            // Toggle between Load and Unload
            if (content.style.display === 'none' || content.style.display === '') {
                // Load/Show content
                content.style.display = 'block';
                btn.textContent = 'üîº Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                exportBtn.style.display = 'inline-block';
                exportPdfBtn.style.display = 'inline-block';
                
                if (!qaAIAdoptionDataLoaded) {
                    renderQAAIAdoptionData();
                    qaAIAdoptionDataLoaded = true;
                }
            } else {
                // Unload/Hide content
                content.style.display = 'none';
                btn.textContent = 'üìä Show';
                btn.style.background = '';
                btn.style.borderColor = '';
                exportBtn.style.display = 'none';
                exportPdfBtn.style.display = 'none';
            }
        }
        
        function toggleQAMemberSummary() {
            const content = document.getElementById('qaMemberSummaryContent');
            const btn = document.getElementById('toggleQAMemberSummaryBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show';
            }
        }
        
        function toggleQAAreaSummary() {
            const content = document.getElementById('qaAreaSummaryContent');
            const btn = document.getElementById('toggleQAAreaSummaryBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show';
            }
        }
        
        function toggleQAProjectSummary() {
            const content = document.getElementById('qaProjectSummaryContent');
            const btn = document.getElementById('toggleQAProjectSummaryBtn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'Hide';
            } else {
                content.style.display = 'none';
                btn.textContent = 'Show';
            }
        }
        
        function renderQAAIAdoptionData() {
            // Execution types to track for QA - AI-Test* types
            const allExecTypes = ['AI-Test-Case Creation', 'AI-Test-Execution', 'AI-Test-Defect Analysis', 'AI-Test-Documentation', 'Manual'];
            const aiExecTypes = ['AI-Test-Case Creation', 'AI-Test-Execution', 'AI-Test-Defect Analysis', 'AI-Test-Documentation'];
            
            // Get Test/QA members from capacity data (Discipline = Test)
            const qaMembers = (capacityData.members || []).filter(m => 
                m.discipline && m.discipline.toLowerCase().includes('test')
            );
            
            // Create set of deliverable and non-deliverable requirement IDs
            const validReqIds = new Set();
            requirements.forEach(req => {
                if (req.category === 'deliverable' || req.category === 'nonDeliverable') {
                    validReqIds.add(req.id);
                }
            });
            
            // Filter tasks based on criteria: Resolved/Closed + Reason != Rejected + OrigEst > 0
            const completedStates = ['resolved', 'closed'];
            
            const validTasks = tasks.filter(t => {
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return false;
                
                const state = (t.fields['System.State'] || '').toLowerCase();
                const reason = (t.fields['System.Reason'] || '').toLowerCase();
                // Use Revised Estimate if available (non-zero), otherwise use Original Estimate
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                
                // Filter by area path to match selected areas (uses global helper)
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return false;
                
                return completedStates.includes(state) && 
                       reason !== 'rejected' && 
                       origEst > 0;
            });
            
            // Build member data map from capacity data
            const memberDataMap = {};
            qaMembers.forEach(m => {
                memberDataMap[m.name.toLowerCase().trim()] = {
                    name: m.name,
                    project: m.project || '-',
                    team: m.team || '-',
                    taskCount: 0,
                    claudeAiCount: 0,
                    copilotCount: 0,
                    manualCount: 0,
                    totalOrigEst: 0,
                    totalCompleted: 0,
                    aiOrigEst: 0,
                    aiCompleted: 0,
                    manualOrigEst: 0,
                    manualCompleted: 0,
                    manualAiIneffCount: 0,
                    manualAiIneffOrigEst: 0,
                    manualAiIneffCompleted: 0
                };
            });
            
            // Process tasks and aggregate by member
            // Also add members from task assignments who might not be in capacity data
            validTasks.forEach(t => {
                const assignedTo = t.fields['System.AssignedTo']?.displayName || '';
                const discipline = t.fields['Microsoft.VSTS.Common.Discipline'] || '';
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                // Use Revised Estimate if available (non-zero), otherwise use Original Estimate
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                const completed = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                const tags = (t.fields['System.Tags'] || '').toLowerCase();
                // Check for Claude AI tag with flexible matching (Claude AI, ClaudeAI, Claude-AI, etc.)
                const hasClaudeAiTag = tags.includes('claude ai') || tags.includes('claudeai') || tags.includes('claude-ai') || /claude[\s\-_]*ai/i.test(tags);
                
                // Check if execution type starts with AI-Test
                const isAiType = execType.startsWith('AI-Test');
                const isManualType = execType === 'Manual';
                const isManualAiIneff = execType === 'Manual-AI-Ineffective';
                
                // Only count if execution type is AI-Test* or Manual or Manual-AI-Ineffective
                if (!isAiType && !isManualType && !isManualAiIneff) return;
                
                // Only count Test discipline tasks
                if (!discipline.toLowerCase().includes('test')) return;
                
                // Match to member - use full name matching
                const assignedToLower = assignedTo.toLowerCase().trim();
                
                // First try to find existing member
                let memberKey = Object.keys(memberDataMap).find(nameLower => {
                    return assignedToLower.includes(nameLower) || nameLower.includes(assignedToLower);
                });
                
                // If member not found in capacity data, add them from task assignment
                if (!memberKey && assignedTo) {
                    memberKey = assignedToLower;
                    const taskAreaPath = t.fields['System.AreaPath'] || '';
                    const taskProject = taskAreaPath.split('\\')[0] || '-';
                    const taskTeam = taskAreaPath.split('\\')[1] || '-';
                    memberDataMap[memberKey] = {
                        name: assignedTo,
                        project: taskProject,
                        team: taskTeam,
                        taskCount: 0,
                        claudeAiCount: 0,
                        copilotCount: 0,
                        manualCount: 0,
                        totalOrigEst: 0,
                        totalCompleted: 0,
                        aiOrigEst: 0,
                        aiCompleted: 0,
                        manualOrigEst: 0,
                        manualCompleted: 0,
                        manualAiIneffCount: 0,
                        manualAiIneffOrigEst: 0,
                        manualAiIneffCompleted: 0
                    };
                }
                
                if (memberKey) {
                    const memberData = memberDataMap[memberKey];
                    memberData.taskCount++;
                    
                    // Count Claude AI vs Copilot vs Manual tasks
                    // If "Claude AI" tag found -> Claude AI column, otherwise -> Copilot column
                    if (isAiType && hasClaudeAiTag) {
                        memberData.claudeAiCount++;
                    } else if (isAiType && !hasClaudeAiTag) {
                        memberData.copilotCount++;
                    }
                    
                    if (isManualType) {
                        memberData.manualCount++;
                    }
                    
                    if (isManualAiIneff) {
                        memberData.manualAiIneffCount++;
                    }
                    
                    memberData.totalOrigEst += origEst;
                    memberData.totalCompleted += completed;
                    
                    if (isAiType) {
                        memberData.aiOrigEst += origEst;
                        memberData.aiCompleted += completed;
                    } else if (isManualType) {
                        memberData.manualOrigEst += origEst;
                        memberData.manualCompleted += completed;
                    } else if (isManualAiIneff) {
                        memberData.manualAiIneffOrigEst += origEst;
                        memberData.manualAiIneffCompleted += completed;
                    }
                }
            });
            
            // Convert to array and filter members with tasks
            const memberResults = Object.values(memberDataMap).filter(m => m.taskCount > 0);
            
            // Calculate grand totals
            let grandTotalOrigEst = 0, grandTotalCompleted = 0;
            let grandAiOrigEst = 0, grandAiCompleted = 0;
            let grandManualOrigEst = 0, grandManualCompleted = 0;
            let grandManualAiIneffOrigEst = 0, grandManualAiIneffCompleted = 0;
            
            memberResults.forEach(m => {
                grandTotalOrigEst += m.totalOrigEst;
                grandTotalCompleted += m.totalCompleted;
                grandAiOrigEst += m.aiOrigEst;
                grandAiCompleted += m.aiCompleted;
                grandManualOrigEst += m.manualOrigEst;
                grandManualCompleted += m.manualCompleted;
                grandManualAiIneffOrigEst += m.manualAiIneffOrigEst;
                grandManualAiIneffCompleted += m.manualAiIneffCompleted;
            });
            
            // Calculate efficiencies
            const manualEfficiency = grandManualOrigEst > 0 ? Math.round(((grandManualOrigEst - grandManualCompleted) / grandManualOrigEst) * 100) : 0;
            const aiEfficiency = grandAiOrigEst > 0 ? Math.round(((grandAiOrigEst - grandAiCompleted) / grandAiOrigEst) * 100) : 0;
            
            // Update summary stats
            document.getElementById('qaDevMemberCount').textContent = memberResults.length;
            document.getElementById('qaTotalTasks').textContent = memberResults.reduce((sum, m) => sum + m.taskCount, 0);
            document.getElementById('qaTotalOrigEst').textContent = fmtH(grandTotalOrigEst) + 'h';
            document.getElementById('qaTotalCompleted').textContent = fmtH(grandTotalCompleted) + 'h';
            document.getElementById('qaManualEfficiency').textContent = manualEfficiency + '%';
            document.getElementById('qaAIEfficiency').textContent = aiEfficiency + '%';
            
            // Color efficiency values
            const manualEffEl = document.getElementById('qaManualEfficiency');
            const aiEffEl = document.getElementById('qaAIEfficiency');
            manualEffEl.style.color = manualEfficiency >= 0 ? '#34d399' : '#f87171';
            aiEffEl.style.color = aiEfficiency >= 0 ? '#34d399' : '#f87171';
            
            // Build table
            const thead = document.getElementById('qaAIAdoptionTableHead');
            const tbody = document.getElementById('qaAIAdoptionTableBody');
            const tfoot = document.getElementById('qaAIAdoptionTableFoot');
            
            if (memberResults.length === 0) {
                document.getElementById('noQAAIAdoptionData').style.display = 'block';
                thead.innerHTML = '';
                tbody.innerHTML = '';
                tfoot.innerHTML = '';
                return;
            }
            
            document.getElementById('noQAAIAdoptionData').style.display = 'none';
            
            // Store member results globally for sorting
            qaAIAdoptionMemberData = memberResults.map(m => {
                const mTotalOrig = m.aiOrigEst + m.manualAiIneffOrigEst;
                const mAiAdoption = m.manualAiIneffOrigEst <= 0 ? 100 : (mTotalOrig > 0 ? Math.round((m.aiOrigEst / mTotalOrig) * 100) : 0);
                const mManualEff = m.manualOrigEst > 0 ? Math.round(((m.manualOrigEst - m.manualCompleted) / m.manualOrigEst) * 100) : 0;
                const mAiEff = m.aiOrigEst > 0 ? Math.round(((m.aiOrigEst - m.aiCompleted) / m.aiOrigEst) * 100) : 0;
                const mHourSaved = m.aiOrigEst - m.aiCompleted;
                return { ...m, aiAdoption: mAiAdoption, manualEff: mManualEff, aiEff: mAiEff, hourSaved: mHourSaved };
            });
            
            // Store grand totals globally
            qaAIAdoptionGrandTotals = {
                grandAiOrigEst, grandAiCompleted, grandManualOrigEst, grandManualCompleted,
                grandManualAiIneffOrigEst, grandManualAiIneffCompleted,
                manualEfficiency, aiEfficiency
            };
            
            // Header row 1: With sortable columns
            const thStyle = 'padding:10px 8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.75rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (field) => qaAIAdoptionSortField === field ? (qaAIAdoptionSortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : ' ‚áÖ';
            
            let headerRow1 = `<tr>
                <th rowspan="2" style="${thStyle}text-align:left;width:11%;" onclick="sortQAAIAdoptionTable('name')">Member${sortIcon('name')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortQAAIAdoptionTable('project')">Project${sortIcon('project')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortQAAIAdoptionTable('team')">Area${sortIcon('team')}</th>
                <th rowspan="2" style="${thStyle}width:4%;" onclick="sortQAAIAdoptionTable('taskCount')">Tasks${sortIcon('taskCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:4%;" onclick="sortQAAIAdoptionTable('claudeAiCount')">Claude${sortIcon('claudeAiCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:4%;" onclick="sortQAAIAdoptionTable('copilotCount')">Copilot${sortIcon('copilotCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(239,68,68,0.25);color:#fca5a5;width:4%;" onclick="sortQAAIAdoptionTable('manualAiIneffCount')">MAI-Ineff${sortIcon('manualAiIneffCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:4%;" onclick="sortQAAIAdoptionTable('manualCount')">Manual${sortIcon('manualCount')}</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(6,182,212,0.25);color:#67e8f9;width:9%;">AI Total</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(239,68,68,0.25);color:#fca5a5;width:9%;">MAI-Ineff Hours</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(245,158,11,0.25);color:#fcd34d;width:9%;">Manual Hours</th>
                <th rowspan="2" style="${thStyle}background:rgba(59,130,246,0.25);color:#60a5fa;width:6%;" onclick="sortQAAIAdoptionTable('aiAdoption')">AI Adopt${sortIcon('aiAdoption')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:6%;" onclick="sortQAAIAdoptionTable('manualEff')">Man Eff${sortIcon('manualEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:6%;" onclick="sortQAAIAdoptionTable('aiEff')">AI Eff${sortIcon('aiEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:6%;" onclick="sortQAAIAdoptionTable('hourSaved')">Hr Save${sortIcon('hourSaved')}</th>
            </tr>`;
            
            // Header row 2: Orig/Comp subheaders with sorting
            const subThStyle = 'padding:6px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);font-size:0.7rem;cursor:pointer;';
            let headerRow2 = `<tr>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortQAAIAdoptionTable('aiOrigEst')">Orig${sortIcon('aiOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortQAAIAdoptionTable('aiCompleted')">Comp${sortIcon('aiCompleted')}</th>
                <th style="${subThStyle}color:#fca5a5;" onclick="sortQAAIAdoptionTable('manualAiIneffOrigEst')">Orig${sortIcon('manualAiIneffOrigEst')}</th>
                <th style="${subThStyle}color:#fb7185;" onclick="sortQAAIAdoptionTable('manualAiIneffCompleted')">Comp${sortIcon('manualAiIneffCompleted')}</th>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortQAAIAdoptionTable('manualOrigEst')">Orig${sortIcon('manualOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortQAAIAdoptionTable('manualCompleted')">Comp${sortIcon('manualCompleted')}</th>
            </tr>`;
            
            thead.innerHTML = headerRow1 + headerRow2;
            
            // Render table rows
            renderQAAIAdoptionTableRows();
        }
        
        function renderQAAIAdoptionTableRows() {
            const tbody = document.getElementById('qaAIAdoptionTableBody');
            const tfoot = document.getElementById('qaAIAdoptionTableFoot');
            
            // Sort the data
            const sortedData = [...qaAIAdoptionMemberData].sort((a, b) => {
                let aVal = a[qaAIAdoptionSortField];
                let bVal = b[qaAIAdoptionSortField];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                }
                
                if (aVal === null || aVal === undefined) aVal = qaAIAdoptionSortDir === 'asc' ? Infinity : -Infinity;
                if (bVal === null || bVal === undefined) bVal = qaAIAdoptionSortDir === 'asc' ? Infinity : -Infinity;
                
                if (aVal < bVal) return qaAIAdoptionSortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return qaAIAdoptionSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Data rows
            const tdStyle = 'padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:0.8rem;';
            tbody.innerHTML = sortedData.map(m => {
                const mHourSavedColor = m.hourSaved >= 0 ? '#f472b6' : '#f87171';
                const mManualEffColor = m.manualEff >= 0 ? '#34d399' : '#f87171';
                const mAiEffColor = m.aiEff >= 0 ? '#34d399' : '#f87171';
                const mTotalOrig = m.aiOrigEst + m.manualAiIneffOrigEst;
                
                return `<tr style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <td style="${tdStyle}text-align:left;white-space:nowrap;">${m.name}</td>
                    <td style="${tdStyle}text-align:left;color:#a5b4fc;font-size:0.7rem;">${m.project}</td>
                    <td style="${tdStyle}text-align:left;color:#67e8f9;font-size:0.7rem;">${m.team}</td>
                    <td style="${tdStyle}text-align:center;">${m.taskCount}</td>
                    <td style="${tdStyle}text-align:center;color:#c4b5fd;">${m.claudeAiCount > 0 ? m.claudeAiCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#22d3ee;">${m.copilotCount > 0 ? m.copilotCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${m.manualAiIneffCount > 0 ? m.manualAiIneffCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fcd34d;">${m.manualCount > 0 ? m.manualCount : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${m.aiOrigEst > 0 ? fmtH(m.aiOrigEst) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${m.aiCompleted > 0 ? fmtH(m.aiCompleted) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${m.manualAiIneffOrigEst > 0 ? fmtH(m.manualAiIneffOrigEst) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fb7185;">${m.manualAiIneffCompleted > 0 ? fmtH(m.manualAiIneffCompleted) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${m.manualOrigEst > 0 ? fmtH(m.manualOrigEst) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${m.manualCompleted > 0 ? fmtH(m.manualCompleted) + 'h' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#60a5fa;font-weight:600;">${m.aiAdoption + '%'}</td>
                    <td style="${tdStyle}text-align:center;color:${mManualEffColor};font-weight:600;">${m.manualOrigEst > 0 ? m.manualEff + '%' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:${mAiEffColor};font-weight:600;">${m.aiOrigEst > 0 ? m.aiEff + '%' : '-'}</td>
                    <td style="${tdStyle}text-align:center;color:${mHourSavedColor};font-weight:600;">${m.aiOrigEst > 0 ? fmtH(m.hourSaved) + 'h' : '-'}</td>
                </tr>`;
            }).join('');
            
            // Footer totals row
            const { grandAiOrigEst, grandAiCompleted, grandManualOrigEst, grandManualCompleted, grandManualAiIneffOrigEst, grandManualAiIneffCompleted, manualEfficiency, aiEfficiency } = qaAIAdoptionGrandTotals;
            const totalTasks = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.taskCount, 0);
            const totalClaudeAi = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.claudeAiCount, 0);
            const totalCopilot = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.copilotCount, 0);
            const totalManual = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.manualCount, 0);
            const totalManualAiIneff = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.manualAiIneffCount, 0);
            const tfStyle = 'padding:10px 8px;border-top:2px solid rgba(6,182,212,0.4);font-size:0.8rem;';
            const footManualEffColor = manualEfficiency >= 0 ? '#34d399' : '#f87171';
            const footAiEffColor = aiEfficiency >= 0 ? '#34d399' : '#f87171';
            
            const grandTotalOrig = (grandAiOrigEst || 0) + (grandManualAiIneffOrigEst || 0);
            const grandAiAdoption = (grandManualAiIneffOrigEst || 0) <= 0 ? 100 : (grandTotalOrig > 0 ? Math.round(((grandAiOrigEst || 0) / grandTotalOrig) * 100) : 0);
            const grandHourSaved = grandAiOrigEst - grandAiCompleted;
            const footHourSavedColor = grandHourSaved >= 0 ? '#f472b6' : '#f87171';
            
            tfoot.innerHTML = `<tr>
                <td colspan="3" style="${tfStyle}text-align:right;color:#e2e8f0;font-weight:700;">Grand Total:</td>
                <td style="${tfStyle}text-align:center;color:#e2e8f0;font-weight:700;">${totalTasks}</td>
                <td style="${tfStyle}text-align:center;color:#c4b5fd;font-weight:700;">${totalClaudeAi}</td>
                <td style="${tfStyle}text-align:center;color:#22d3ee;font-weight:700;">${totalCopilot}</td>
                <td style="${tfStyle}text-align:center;color:#fca5a5;font-weight:700;">${totalManualAiIneff}</td>
                <td style="${tfStyle}text-align:center;color:#fcd34d;font-weight:700;">${totalManual}</td>
                <td style="${tfStyle}text-align:center;color:#fbbf24;font-weight:700;">${fmtH(grandAiOrigEst)}h</td>
                <td style="${tfStyle}text-align:center;color:#34d399;font-weight:700;">${fmtH(grandAiCompleted)}h</td>
                <td style="${tfStyle}text-align:center;color:#fca5a5;font-weight:700;">${fmtH(grandManualAiIneffOrigEst)}h</td>
                <td style="${tfStyle}text-align:center;color:#fb7185;font-weight:700;">${fmtH(grandManualAiIneffCompleted)}h</td>
                <td style="${tfStyle}text-align:center;color:#fbbf24;font-weight:700;">${fmtH(grandManualOrigEst)}h</td>
                <td style="${tfStyle}text-align:center;color:#34d399;font-weight:700;">${fmtH(grandManualCompleted)}h</td>
                <td style="${tfStyle}text-align:center;color:#60a5fa;font-weight:700;">${grandAiAdoption}%</td>
                <td style="${tfStyle}text-align:center;color:${footManualEffColor};font-weight:700;">${manualEfficiency}%</td>
                <td style="${tfStyle}text-align:center;color:${footAiEffColor};font-weight:700;">${aiEfficiency}%</td>
                <td style="${tfStyle}text-align:center;color:${footHourSavedColor};font-weight:700;">${fmtH(grandHourSaved)}h</td>
            </tr>`;
            
            // Render QA Area-wise Summary Table
            renderQAAreaSummaryTable();
            
            // Render QA Project-wise Summary Table
            renderQAProjectSummaryTable();
        }
        
        function renderQAAreaSummaryTable() {
            const qaAreaSummarySection = document.getElementById('qaAreaSummarySection');
            const qaAreaSummaryHead = document.getElementById('qaAreaSummaryHead');
            const qaAreaSummaryBody = document.getElementById('qaAreaSummaryBody');
            
            if (qaAIAdoptionMemberData.length === 0) {
                qaAreaSummarySection.style.display = 'none';
                return;
            }
            
            qaAreaSummarySection.style.display = 'block';
            // Reset inner content visibility and toggle button on re-render
            const qaAreaContent = document.getElementById('qaAreaSummaryContent');
            const toggleQAAreaBtn = document.getElementById('toggleQAAreaSummaryBtn');
            if (qaAreaContent) qaAreaContent.style.display = '';
            if (toggleQAAreaBtn) toggleQAAreaBtn.textContent = 'Hide';
            
            // Group by area (team)
            const areaMap = {};
            qaAIAdoptionMemberData.forEach(m => {
                const area = m.team || 'Unknown';
                if (!areaMap[area]) {
                    areaMap[area] = {
                        area,
                        memberCount: 0,
                        taskCount: 0,
                        claudeAiCount: 0,
                        copilotCount: 0,
                        manualAiIneffCount: 0,
                        manualCount: 0,
                        aiOrigEst: 0,
                        aiCompleted: 0,
                        manualAiIneffOrigEst: 0,
                        manualAiIneffCompleted: 0,
                        manualOrigEst: 0,
                        manualCompleted: 0
                    };
                }
                areaMap[area].memberCount++;
                areaMap[area].taskCount += m.taskCount;
                areaMap[area].claudeAiCount += m.claudeAiCount;
                areaMap[area].copilotCount += m.copilotCount;
                areaMap[area].manualAiIneffCount += m.manualAiIneffCount;
                areaMap[area].manualCount += m.manualCount;
                areaMap[area].aiOrigEst += m.aiOrigEst;
                areaMap[area].aiCompleted += m.aiCompleted;
                areaMap[area].manualAiIneffOrigEst += m.manualAiIneffOrigEst;
                areaMap[area].manualAiIneffCompleted += m.manualAiIneffCompleted;
                areaMap[area].manualOrigEst += m.manualOrigEst;
                areaMap[area].manualCompleted += m.manualCompleted;
            });
            
            const areaData = Object.values(areaMap).map(a => {
                const totalOrig = a.aiOrigEst + a.manualAiIneffOrigEst;
                const aiAdoption = a.manualAiIneffOrigEst <= 0 ? 100 : (totalOrig > 0 ? Math.round((a.aiOrigEst / totalOrig) * 100) : 0);
                const manualEff = a.manualOrigEst > 0 ? Math.round(((a.manualOrigEst - a.manualCompleted) / a.manualOrigEst) * 100) : 0;
                const aiEff = a.aiOrigEst > 0 ? Math.round(((a.aiOrigEst - a.aiCompleted) / a.aiOrigEst) * 100) : 0;
                const hourSaved = a.aiOrigEst - a.aiCompleted;
                return { ...a, aiAdoption, manualEff, aiEff, hourSaved };
            });
            
            // Header
            const thStyle = 'padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.7rem;text-transform:uppercase;';
            qaAreaSummaryHead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;">Area</th>
                <th style="${thStyle}">Members</th>
                <th style="${thStyle}">Tasks</th>
                <th style="${thStyle}background:rgba(168,85,247,0.2);">Claude</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);">Copilot</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Manual</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);">AI Orig</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);">AI Comp</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff Orig</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff Comp</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Man Orig</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Man Comp</th>
                <th style="${thStyle}background:rgba(59,130,246,0.2);">AI Adopt</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Man Eff</th>
                <th style="${thStyle}background:rgba(16,185,129,0.2);">AI Eff</th>
                <th style="${thStyle}background:rgba(236,72,153,0.2);">Hr Save</th>
            </tr>`;
            
            // Body
            const tdStyle = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:0.75rem;';
            qaAreaSummaryBody.innerHTML = areaData.map(a => {
                const hrSavedColor = a.hourSaved >= 0 ? '#f472b6' : '#f87171';
                const manEffColor = a.manualEff >= 0 ? '#34d399' : '#f87171';
                const aiEffColor = a.aiEff >= 0 ? '#34d399' : '#f87171';
                return `<tr>
                    <td style="${tdStyle}text-align:left;color:#67e8f9;font-weight:600;">${a.area}</td>
                    <td style="${tdStyle}text-align:center;">${a.memberCount}</td>
                    <td style="${tdStyle}text-align:center;">${a.taskCount}</td>
                    <td style="${tdStyle}text-align:center;color:#c4b5fd;">${a.claudeAiCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#22d3ee;">${a.copilotCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${a.manualAiIneffCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fcd34d;">${a.manualCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(a.aiOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(a.aiCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${fmtH(a.manualAiIneffOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fb7185;">${fmtH(a.manualAiIneffCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(a.manualOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(a.manualCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#60a5fa;font-weight:600;">${a.aiAdoption}%</td>
                    <td style="${tdStyle}text-align:center;color:${manEffColor};font-weight:600;">${a.manualEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${aiEffColor};font-weight:600;">${a.aiEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${hrSavedColor};font-weight:600;">${fmtH(a.hourSaved)}h</td>
                </tr>`;
            }).join('');
        }
        
        function renderQAProjectSummaryTable() {
            const qaProjectSummarySection = document.getElementById('qaProjectSummarySection');
            const qaProjectSummaryHead = document.getElementById('qaProjectSummaryHead');
            const qaProjectSummaryBody = document.getElementById('qaProjectSummaryBody');
            
            if (qaAIAdoptionMemberData.length === 0) {
                qaProjectSummarySection.style.display = 'none';
                return;
            }
            
            qaProjectSummarySection.style.display = 'block';
            // Reset inner content visibility and toggle button on re-render
            const qaProjectContent = document.getElementById('qaProjectSummaryContent');
            const toggleQAProjectBtn = document.getElementById('toggleQAProjectSummaryBtn');
            if (qaProjectContent) qaProjectContent.style.display = '';
            if (toggleQAProjectBtn) toggleQAProjectBtn.textContent = 'Hide';
            
            // Group by project
            const projectMap = {};
            qaAIAdoptionMemberData.forEach(m => {
                const project = m.project || 'Unknown';
                if (!projectMap[project]) {
                    projectMap[project] = {
                        project,
                        memberCount: 0,
                        taskCount: 0,
                        claudeAiCount: 0,
                        copilotCount: 0,
                        manualAiIneffCount: 0,
                        manualCount: 0,
                        aiOrigEst: 0,
                        aiCompleted: 0,
                        manualAiIneffOrigEst: 0,
                        manualAiIneffCompleted: 0,
                        manualOrigEst: 0,
                        manualCompleted: 0
                    };
                }
                projectMap[project].memberCount++;
                projectMap[project].taskCount += m.taskCount;
                projectMap[project].claudeAiCount += m.claudeAiCount;
                projectMap[project].copilotCount += m.copilotCount;
                projectMap[project].manualAiIneffCount += m.manualAiIneffCount;
                projectMap[project].manualCount += m.manualCount;
                projectMap[project].aiOrigEst += m.aiOrigEst;
                projectMap[project].aiCompleted += m.aiCompleted;
                projectMap[project].manualAiIneffOrigEst += m.manualAiIneffOrigEst;
                projectMap[project].manualAiIneffCompleted += m.manualAiIneffCompleted;
                projectMap[project].manualOrigEst += m.manualOrigEst;
                projectMap[project].manualCompleted += m.manualCompleted;
            });
            
            const projectData = Object.values(projectMap).map(p => {
                const totalOrig = p.aiOrigEst + p.manualAiIneffOrigEst;
                const aiAdoption = p.manualAiIneffOrigEst <= 0 ? 100 : (totalOrig > 0 ? Math.round((p.aiOrigEst / totalOrig) * 100) : 0);
                const manualEff = p.manualOrigEst > 0 ? Math.round(((p.manualOrigEst - p.manualCompleted) / p.manualOrigEst) * 100) : 0;
                const aiEff = p.aiOrigEst > 0 ? Math.round(((p.aiOrigEst - p.aiCompleted) / p.aiOrigEst) * 100) : 0;
                const hourSaved = p.aiOrigEst - p.aiCompleted;
                return { ...p, aiAdoption, manualEff, aiEff, hourSaved };
            });
            
            // Header
            const thStyle = 'padding:8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.7rem;text-transform:uppercase;';
            qaProjectSummaryHead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;">Project</th>
                <th style="${thStyle}">Members</th>
                <th style="${thStyle}">Tasks</th>
                <th style="${thStyle}background:rgba(168,85,247,0.2);">Claude</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);">Copilot</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Manual</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);">AI Orig</th>
                <th style="${thStyle}background:rgba(6,182,212,0.2);">AI Comp</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff Orig</th>
                <th style="${thStyle}background:rgba(239,68,68,0.2);">AI-Ineff Comp</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Man Orig</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Man Comp</th>
                <th style="${thStyle}background:rgba(59,130,246,0.2);">AI Adopt</th>
                <th style="${thStyle}background:rgba(245,158,11,0.2);">Man Eff</th>
                <th style="${thStyle}background:rgba(16,185,129,0.2);">AI Eff</th>
                <th style="${thStyle}background:rgba(236,72,153,0.2);">Hr Save</th>
            </tr>`;
            
            // Body
            const tdStyle = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:0.75rem;';
            qaProjectSummaryBody.innerHTML = projectData.map(p => {
                const hrSavedColor = p.hourSaved >= 0 ? '#f472b6' : '#f87171';
                const manEffColor = p.manualEff >= 0 ? '#34d399' : '#f87171';
                const aiEffColor = p.aiEff >= 0 ? '#34d399' : '#f87171';
                return `<tr>
                    <td style="${tdStyle}text-align:left;color:#a5b4fc;font-weight:600;">${p.project}</td>
                    <td style="${tdStyle}text-align:center;">${p.memberCount}</td>
                    <td style="${tdStyle}text-align:center;">${p.taskCount}</td>
                    <td style="${tdStyle}text-align:center;color:#c4b5fd;">${p.claudeAiCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#22d3ee;">${p.copilotCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${p.manualAiIneffCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fcd34d;">${p.manualCount || '-'}</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(p.aiOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(p.aiCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fca5a5;">${fmtH(p.manualAiIneffOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fb7185;">${fmtH(p.manualAiIneffCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#fbbf24;">${fmtH(p.manualOrigEst)}h</td>
                    <td style="${tdStyle}text-align:center;color:#34d399;">${fmtH(p.manualCompleted)}h</td>
                    <td style="${tdStyle}text-align:center;color:#60a5fa;font-weight:600;">${p.aiAdoption}%</td>
                    <td style="${tdStyle}text-align:center;color:${manEffColor};font-weight:600;">${p.manualEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${aiEffColor};font-weight:600;">${p.aiEff}%</td>
                    <td style="${tdStyle}text-align:center;color:${hrSavedColor};font-weight:600;">${fmtH(p.hourSaved)}h</td>
                </tr>`;
            }).join('');
        }
        
        function sortQAAIAdoptionTable(field) {
            if (qaAIAdoptionSortField === field) {
                qaAIAdoptionSortDir = qaAIAdoptionSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                qaAIAdoptionSortField = field;
                qaAIAdoptionSortDir = (field === 'name' || field === 'project' || field === 'team') ? 'asc' : 'desc';
            }
            
            // Update header sort icons
            const thead = document.getElementById('qaAIAdoptionTableHead');
            const thStyle = 'padding:10px 8px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.75rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (f) => qaAIAdoptionSortField === f ? (qaAIAdoptionSortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : ' ‚áÖ';
            
            let headerRow1 = `<tr>
                <th rowspan="2" style="${thStyle}text-align:left;width:11%;" onclick="sortQAAIAdoptionTable('name')">Member${sortIcon('name')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortQAAIAdoptionTable('project')">Project${sortIcon('project')}</th>
                <th rowspan="2" style="${thStyle}text-align:left;width:7%;" onclick="sortQAAIAdoptionTable('team')">Area${sortIcon('team')}</th>
                <th rowspan="2" style="${thStyle}width:4%;" onclick="sortQAAIAdoptionTable('taskCount')">Tasks${sortIcon('taskCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:4%;" onclick="sortQAAIAdoptionTable('claudeAiCount')">Claude${sortIcon('claudeAiCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:4%;" onclick="sortQAAIAdoptionTable('copilotCount')">Copilot${sortIcon('copilotCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(239,68,68,0.25);color:#fca5a5;width:4%;" onclick="sortQAAIAdoptionTable('manualAiIneffCount')">MAI-Ineff${sortIcon('manualAiIneffCount')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:4%;" onclick="sortQAAIAdoptionTable('manualCount')">Manual${sortIcon('manualCount')}</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(6,182,212,0.25);color:#67e8f9;width:9%;">AI Total</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(239,68,68,0.25);color:#fca5a5;width:9%;">MAI-Ineff Hours</th>
                <th colspan="2" style="${thStyle.replace('cursor:pointer;','')}background:rgba(245,158,11,0.25);color:#fcd34d;width:9%;">Manual Hours</th>
                <th rowspan="2" style="${thStyle}background:rgba(59,130,246,0.25);color:#60a5fa;width:6%;" onclick="sortQAAIAdoptionTable('aiAdoption')">AI Adopt${sortIcon('aiAdoption')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(245,158,11,0.25);color:#fcd34d;width:6%;" onclick="sortQAAIAdoptionTable('manualEff')">Man Eff${sortIcon('manualEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:6%;" onclick="sortQAAIAdoptionTable('aiEff')">AI Eff${sortIcon('aiEff')}</th>
                <th rowspan="2" style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:6%;" onclick="sortQAAIAdoptionTable('hourSaved')">Hr Save${sortIcon('hourSaved')}</th>
            </tr>`;
            
            const subThStyle = 'padding:6px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);font-size:0.7rem;cursor:pointer;';
            let headerRow2 = `<tr>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortQAAIAdoptionTable('aiOrigEst')">Orig${sortIcon('aiOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortQAAIAdoptionTable('aiCompleted')">Comp${sortIcon('aiCompleted')}</th>
                <th style="${subThStyle}color:#fca5a5;" onclick="sortQAAIAdoptionTable('manualAiIneffOrigEst')">Orig${sortIcon('manualAiIneffOrigEst')}</th>
                <th style="${subThStyle}color:#fb7185;" onclick="sortQAAIAdoptionTable('manualAiIneffCompleted')">Comp${sortIcon('manualAiIneffCompleted')}</th>
                <th style="${subThStyle}color:#fbbf24;" onclick="sortQAAIAdoptionTable('manualOrigEst')">Orig${sortIcon('manualOrigEst')}</th>
                <th style="${subThStyle}color:#34d399;" onclick="sortQAAIAdoptionTable('manualCompleted')">Comp${sortIcon('manualCompleted')}</th>
            </tr>`;
            
            thead.innerHTML = headerRow1 + headerRow2;
            
            renderQAAIAdoptionTableRows();
        }
        
        // Export QA AI Adoption Data to Excel
        function exportQAAIAdoptionToExcel() {
            if (qaAIAdoptionMemberData.length === 0) {
                alert('No QA AI Adoption data to export');
                return;
            }
            
            let csv = 'QA AI Adoption Data - Member Summary\n';
            csv += 'Member,Project,Area,Tasks,Claude,Copilot,AI-Ineff,Manual,AI Orig Est,AI Completed,AI-Ineff Orig,AI-Ineff Comp,Manual Orig Est,Manual Completed,AI Adoption %,Manual Eff %,AI Eff %,Hour Saved\n';
            
            qaAIAdoptionMemberData.forEach(m => {
                csv += `"${m.name}","${m.project}","${m.team}",${m.taskCount},${m.claudeAiCount},${m.copilotCount},${m.manualAiIneffCount},${m.manualCount},${m.aiOrigEst},${m.aiCompleted},${m.manualAiIneffOrigEst},${m.manualAiIneffCompleted},${m.manualOrigEst},${m.manualCompleted},${m.aiAdoption},${m.manualEff},${m.aiEff},${m.hourSaved}\n`;
            });
            
            // Add grand totals
            const { grandAiOrigEst, grandAiCompleted, grandManualOrigEst, grandManualCompleted, grandManualAiIneffOrigEst, grandManualAiIneffCompleted, manualEfficiency, aiEfficiency } = qaAIAdoptionGrandTotals;
            const totalTasks = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.taskCount, 0);
            const totalClaudeAi = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.claudeAiCount, 0);
            const totalCopilot = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.copilotCount, 0);
            const totalManual = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.manualCount, 0);
            const totalManualAiIneff = qaAIAdoptionMemberData.reduce((sum, m) => sum + m.manualAiIneffCount, 0);
            const grandTotalOrig = (grandAiOrigEst || 0) + (grandManualAiIneffOrigEst || 0);
            const grandAiAdoption = (grandManualAiIneffOrigEst || 0) <= 0 ? 100 : (grandTotalOrig > 0 ? Math.round(((grandAiOrigEst || 0) / grandTotalOrig) * 100) : 0);
            const grandHourSaved = grandAiOrigEst - grandAiCompleted;
            
            csv += `"Grand Total","","",${totalTasks},${totalClaudeAi},${totalCopilot},${totalManualAiIneff},${totalManual},${grandAiOrigEst},${grandAiCompleted},${grandManualAiIneffOrigEst},${grandManualAiIneffCompleted},${grandManualOrigEst},${grandManualCompleted},${grandAiAdoption},${manualEfficiency},${aiEfficiency},${grandHourSaved}\n`;
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `QA_AI_Adoption_Data_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // Export QA AI Adoption Data to PDF
        function exportQAAIAdoptionToPDF() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            const areaNames = selectedAreaPaths.map(p => p.path.split('\\').pop()).join(', ');
            
            // Get all the summary data
            const qaMemberCount = document.getElementById('qaDevMemberCount').textContent;
            const totalTasks = document.getElementById('qaTotalTasks').textContent;
            const totalOrigEst = document.getElementById('qaTotalOrigEst').textContent;
            const totalCompleted = document.getElementById('qaTotalCompleted').textContent;
            const manualEff = document.getElementById('qaManualEfficiency').textContent;
            const aiEff = document.getElementById('qaAIEfficiency').textContent;
            
            // Clone and get table HTML with inline styles preserved
            const memberTable = document.getElementById('qaAIAdoptionTable');
            const areaTable = document.getElementById('qaAreaSummaryTable');
            const projectTable = document.getElementById('qaProjectSummaryTable');
            
            // Build PDF HTML content with dark theme styling matching UI (cyan theme for QA)
            let pdfContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>QA AI Adoption Report - ${sprintName}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @media print {
            @page { size: landscape; margin: 0; }
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0; padding: 0.5in 0.4in; }
            thead { display: table-header-group; }
            tr { page-break-inside: avoid; }
            table { page-break-inside: auto; }
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            font-size: 9pt; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0; 
            padding: 20px;
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(135deg, rgba(6,182,212,0.2), rgba(8,145,178,0.15));
            border: 1px solid rgba(6,182,212,0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
        }
        h1 { color: #67e8f9; font-size: 16pt; margin-bottom: 8px; }
        .header-info { color: #94a3b8; font-size: 8pt; }
        .header-info strong { color: #e2e8f0; }
        
        .summary-grid { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        .summary-box { 
            background: rgba(6,182,212,0.15);
            border: 1px solid rgba(6,182,212,0.3);
            border-radius: 8px; 
            padding: 12px 16px; 
            min-width: 90px;
            text-align: center;
        }
        .summary-box .value { font-size: 16pt; font-weight: 700; color: #22d3ee; }
        .summary-box .label { font-size: 7pt; color: #94a3b8; text-transform: uppercase; margin-top: 4px; }
        
        .section { 
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .section.area { 
            background: rgba(168,85,247,0.1);
            border: 1px solid rgba(168,85,247,0.3);
        }
        .section.project { 
            background: rgba(99,102,241,0.1);
            border: 1px solid rgba(99,102,241,0.3);
        }
        h2 { 
            color: #67e8f9; 
            font-size: 11pt; 
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        h2.area { color: #c4b5fd; }
        h2.project { color: #a5b4fc; }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 8pt;
            table-layout: fixed;
            word-wrap: break-word;
        }
        th { 
            background: rgba(0,0,0,0.3);
            color: #67e8f9; 
            padding: 8px 5px; 
            text-align: center; 
            font-weight: 600;
            text-transform: uppercase;
            font-size: 7pt;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        th.area { color: #c4b5fd; }
        th.project { color: #a5b4fc; }
        td { 
            padding: 6px 5px; 
            border-bottom: 1px solid rgba(255,255,255,0.08);
            text-align: center;
        }
        td.left { text-align: left; }
        tr:hover { background: rgba(6,182,212,0.1); }
        
        .text-purple { color: #c4b5fd; }
        .text-cyan { color: #22d3ee; }
        .text-yellow { color: #fcd34d; }
        .text-green { color: #34d399; }
        .text-blue { color: #60a5fa; }
        .text-pink { color: #f472b6; }
        .text-white { color: #e2e8f0; }
        .text-muted { color: #94a3b8; }
        .font-bold { font-weight: 600; }
        
        .footer-row { 
            background: rgba(6,182,212,0.15) !important;
            font-weight: 600;
        }
        .footer-row td { border-top: 2px solid rgba(6,182,212,0.3); }
        
        .footer { 
            margin-top: 20px; 
            font-size: 7pt; 
            color: #64748b; 
            text-align: center; 
            border-top: 1px solid rgba(255,255,255,0.1); 
            padding-top: 10px; 
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üß™ QA AI Adoption Report</h1>
        <div class="header-info">
            <strong>Sprint:</strong> ${sprintName} &nbsp;|&nbsp; 
            <strong>Area:</strong> ${areaNames} &nbsp;|&nbsp;
            <strong>Projects:</strong> ${selectedProjects.join(', ')} &nbsp;|&nbsp;
            <strong>Generated:</strong> ${new Date().toLocaleString()}
        </div>
    </div>
    
    <div class="summary-grid">
        <div class="summary-box"><div class="value">${qaMemberCount}</div><div class="label">QA Members</div></div>
        <div class="summary-box"><div class="value">${totalTasks}</div><div class="label">Total Tasks</div></div>
        <div class="summary-box"><div class="value">${totalOrigEst}</div><div class="label">Total Orig Est</div></div>
        <div class="summary-box"><div class="value">${totalCompleted}</div><div class="label">Total Completed</div></div>
        <div class="summary-box"><div class="value">${manualEff}</div><div class="label">Manual Eff.</div></div>
        <div class="summary-box"><div class="value">${aiEff}</div><div class="label">AI Eff.</div></div>
    </div>
    
    <div class="section">
        <h2>üë• QA Member-wise Summary</h2>
        ${buildPdfTable(memberTable, 'member')}
    </div>
    
    <div class="section area">
        <h2 class="area">üè∑Ô∏è QA Area-wise Summary</h2>
        ${buildPdfTable(areaTable, 'area')}
    </div>
    
    <div class="section project">
        <h2 class="project">üìÅ QA Project-wise Summary</h2>
        ${buildPdfTable(projectTable, 'project')}
    </div>
    
    <div class="footer">
        Sprint Requirements Tracker - QA AI Adoption Report | Generated on ${new Date().toLocaleString()}
    </div>
</body>
</html>`;
            
            // Generate and download PDF directly using jsPDF and html2canvas
            generateAndDownloadPDF(pdfContent, `QA_AI_Adoption_Report_${sprintName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.pdf`);
        }
        
        // ==================== OVERALL DISCIPLINE AI ADOPTION FUNCTIONS ====================
        let overallAIAdoptionDataLoaded = false;
        let overallAISortField = 'discipline';
        let overallAISortDir = 'asc';
        let overallAIDisciplineData = [];
        let overallAIGrandTotal = {};
        
        function toggleOverallAIAdoptionData() {
            const btn = document.getElementById('loadOverallAIAdoptionBtn');
            const content = document.getElementById('overallAIAdoptionContent');
            const exportBtn = document.getElementById('exportOverallAIAdoptionBtn');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'üîº Hide';
                loadOverallAIAdoptionData();
                exportBtn.style.display = 'inline-block';
                document.getElementById('exportOverallAIAdoptionPdfBtn').style.display = 'inline-block';
            } else {
                content.style.display = 'none';
                btn.textContent = 'üìä Show';
                exportBtn.style.display = 'none';
                document.getElementById('exportOverallAIAdoptionPdfBtn').style.display = 'none';
            }
        }
        
        function loadOverallAIAdoptionData() {
            // Create set of valid requirement IDs
            // Include: Deliverable, Deliverables Adhoc, Deliverables OnHold, Non-Deliverable (exact tag match)
            const validReqIds = new Set();
            requirements.forEach(req => {
                // Check exact tag values
                const tags = (req.fields['System.Tags'] || '').split(';').map(t => t.trim().toLowerCase());
                const hasDeliverable = tags.includes('deliverable');
                const hasDeliverablesAdhoc = tags.includes('deliverables adhoc');
                const hasDeliverablesOnHold = tags.includes('deliverables onhold');
                const hasNonDeliverable = tags.includes('non-deliverable');
                
                if (hasDeliverable || hasDeliverablesAdhoc || hasDeliverablesOnHold || hasNonDeliverable) {
                    validReqIds.add(req.id);
                }
            });
            
            // Define all known TFS Disciplines - these will always show in the table
            const allDisciplines = [
                'Analysis',
                'Development', 
                'Documentation',
                'Test',
                'User Education',
                'User Experience'
            ];
            
            // Initialize data structure for ALL disciplines with zero values
            const disciplineDataMap = new Map();
            allDisciplines.forEach(disc => {
                disciplineDataMap.set(disc, {
                    discipline: disc,
                    category: 'AI-Enabled',
                    totalTasks: 0,
                    claudeAI: 0,
                    copilot: 0,
                    totalAI: 0,
                    estHours: 0,
                    actualHours: 0,
                    claudeEstHours: 0,
                    claudeActualHours: 0,
                    copilotEstHours: 0,
                    copilotActualHours: 0
                });
            });
            
            // Process all tasks - only AI-* TaskExecutionType
            tasks.forEach(t => {
                if (!t.fields) return;
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return;
                
                // Filter by area path to match selected areas (uses global helper)
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return;
                
                const state = t.fields['System.State'] || '';
                const reason = t.fields['System.Reason'] || '';
                if (!['Resolved', 'Closed'].includes(state)) return;
                if (reason === 'Rejected') return;
                
                // Use Revised Estimate if available (non-zero), otherwise use Original Estimate
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                const compWork = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                if (origEst <= 0) return;
                
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                
                // Only consider AI-* execution types
                if (!execType || !execType.startsWith('AI-')) return;
                
                const discipline = t.fields['Microsoft.VSTS.Common.Discipline'] || 'Unknown';
                
                // Check for "Claude AI" tag - handle various formats (Claude AI, ClaudeAI, Claude-AI, etc.)
                const tags = (t.fields['System.Tags'] || '').toLowerCase();
                // Check for claude ai tag with flexible matching
                const hasClaudeAITag = tags.includes('claude ai') || tags.includes('claudeai') || tags.includes('claude-ai') || /claude[\s\-_]*ai/i.test(tags);
                
                // If discipline not in predefined list, add it (handles 'Unknown' or any new disciplines)
                if (!disciplineDataMap.has(discipline)) {
                    disciplineDataMap.set(discipline, {
                        discipline: discipline,
                        category: 'AI-Enabled',
                        totalTasks: 0,
                        claudeAI: 0,
                        copilot: 0,
                        totalAI: 0,
                        estHours: 0,
                        actualHours: 0,
                        claudeEstHours: 0,
                        claudeActualHours: 0,
                        copilotEstHours: 0,
                        copilotActualHours: 0
                    });
                }
                
                const data = disciplineDataMap.get(discipline);
                data.totalTasks++;
                data.totalAI++;
                data.estHours += origEst;
                data.actualHours += compWork;
                
                // If "Claude AI" tag found -> Claude AI column, otherwise -> GitHub Copilot column
                if (hasClaudeAITag) {
                    data.claudeAI++;
                    data.claudeEstHours += origEst;
                    data.claudeActualHours += compWork;
                } else {
                    data.copilot++;
                    data.copilotEstHours += origEst;
                    data.copilotActualHours += compWork;
                }
            });
            
            // Calculate derived values for ALL disciplines (including those with zero data)
            let dataArray = [];
            disciplineDataMap.forEach((data, disc) => {
                data.aiPercent = data.totalTasks > 0 ? Math.round((data.totalAI / data.totalTasks) * 100) : 0;
                data.hoursSaved = data.estHours - data.actualHours;
                data.efficiency = data.estHours > 0 ? Math.round((data.hoursSaved / data.estHours) * 100) : 0;
                // Claude AI efficiency
                const claudeHoursSaved = data.claudeEstHours - data.claudeActualHours;
                data.claudeEfficiency = data.claudeEstHours > 0 ? Math.round((claudeHoursSaved / data.claudeEstHours) * 100) : 0;
                // Copilot efficiency
                const copilotHoursSaved = data.copilotEstHours - data.copilotActualHours;
                data.copilotEfficiency = data.copilotEstHours > 0 ? Math.round((copilotHoursSaved / data.copilotEstHours) * 100) : 0;
                dataArray.push(data);
            });
            
            // Sort by discipline name
            dataArray.sort((a, b) => a.discipline.localeCompare(b.discipline));
            
            // Calculate subtotal (only from disciplines that have data)
            const disciplinesWithData = dataArray.filter(d => d.totalTasks > 0);
            const subtotal = {
                discipline: 'SUBTOTAL (AI-Enabled)',
                category: '-',
                totalTasks: disciplinesWithData.reduce((sum, d) => sum + d.totalTasks, 0),
                claudeAI: disciplinesWithData.reduce((sum, d) => sum + d.claudeAI, 0),
                copilot: disciplinesWithData.reduce((sum, d) => sum + d.copilot, 0),
                totalAI: disciplinesWithData.reduce((sum, d) => sum + d.totalAI, 0),
                estHours: disciplinesWithData.reduce((sum, d) => sum + d.estHours, 0),
                actualHours: disciplinesWithData.reduce((sum, d) => sum + d.actualHours, 0),
                claudeEstHours: disciplinesWithData.reduce((sum, d) => sum + d.claudeEstHours, 0),
                claudeActualHours: disciplinesWithData.reduce((sum, d) => sum + d.claudeActualHours, 0),
                copilotEstHours: dataArray.reduce((sum, d) => sum + d.copilotEstHours, 0),
                copilotActualHours: dataArray.reduce((sum, d) => sum + d.copilotActualHours, 0)
            };
            subtotal.aiPercent = subtotal.totalTasks > 0 ? Math.round((subtotal.totalAI / subtotal.totalTasks) * 100) : 0;
            subtotal.hoursSaved = subtotal.estHours - subtotal.actualHours;
            subtotal.efficiency = subtotal.estHours > 0 ? Math.round((subtotal.hoursSaved / subtotal.estHours) * 100) : 0;
            // Claude AI efficiency for subtotal
            const subtotalClaudeHoursSaved = subtotal.claudeEstHours - subtotal.claudeActualHours;
            subtotal.claudeEfficiency = subtotal.claudeEstHours > 0 ? Math.round((subtotalClaudeHoursSaved / subtotal.claudeEstHours) * 100) : 0;
            // Copilot efficiency for subtotal
            const subtotalCopilotHoursSaved = subtotal.copilotEstHours - subtotal.copilotActualHours;
            subtotal.copilotEfficiency = subtotal.copilotEstHours > 0 ? Math.round((subtotalCopilotHoursSaved / subtotal.copilotEstHours) * 100) : 0;
            
            // Store globally for sorting
            overallAIDisciplineData = dataArray;
            overallAIGrandTotal = subtotal;
            
            // Render table
            renderOverallAIAdoptionTable(dataArray, subtotal);
        }
        
        function renderOverallAIAdoptionTable(disciplineData, subtotal) {
            const thead = document.getElementById('overallAIAdoptionTableHead');
            const tbody = document.getElementById('overallAIAdoptionTableBody');
            const tfoot = document.getElementById('overallAIAdoptionTableFoot');
            
            if (disciplineData.length === 0) {
                document.getElementById('noOverallAIAdoptionData').style.display = 'block';
                thead.innerHTML = '';
                tbody.innerHTML = '';
                tfoot.innerHTML = '';
                return;
            }
            
            document.getElementById('noOverallAIAdoptionData').style.display = 'none';
            
            // Store data globally for sorting
            overallAIDisciplineData = disciplineData;
            overallAIGrandTotal = subtotal;
            
            // Header with sortable columns
            const thStyle = 'padding:8px 6px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.7rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (field) => overallAISortField === field ? (overallAISortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : ' ‚áÖ';
            
            thead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;width:11%;" onclick="sortOverallAIAdoptionTable('discipline')">Discipline${sortIcon('discipline')}</th>
                <th style="${thStyle}width:7%;">Category</th>
                <th style="${thStyle}width:6%;" onclick="sortOverallAIAdoptionTable('totalTasks')">Tasks${sortIcon('totalTasks')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:6%;" onclick="sortOverallAIAdoptionTable('claudeAI')">Claude${sortIcon('claudeAI')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:6%;" onclick="sortOverallAIAdoptionTable('copilot')">Copilot${sortIcon('copilot')}</th>
                <th style="${thStyle}background:rgba(245,158,11,0.25);color:#fbbf24;width:6%;" onclick="sortOverallAIAdoptionTable('estHours')">Orig Est${sortIcon('estHours')}</th>
                <th style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:7%;" onclick="sortOverallAIAdoptionTable('actualHours')">Completed${sortIcon('actualHours')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:7%;" onclick="sortOverallAIAdoptionTable('claudeEfficiency')">Claude %${sortIcon('claudeEfficiency')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:7%;" onclick="sortOverallAIAdoptionTable('copilotEfficiency')">Copilot %${sortIcon('copilotEfficiency')}</th>
                <th style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:6%;" onclick="sortOverallAIAdoptionTable('efficiency')">Eff %${sortIcon('efficiency')}</th>
                <th style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:7%;" onclick="sortOverallAIAdoptionTable('hoursSaved')">Hr Save${sortIcon('hoursSaved')}</th>
            </tr>`;
            
            // Render table rows
            renderOverallAIAdoptionTableRows();
        }
        
        function renderOverallAIAdoptionTableRows() {
            const tbody = document.getElementById('overallAIAdoptionTableBody');
            const tfoot = document.getElementById('overallAIAdoptionTableFoot');
            
            // Sort the data
            const sortedData = [...overallAIDisciplineData].sort((a, b) => {
                let aVal = a[overallAISortField];
                let bVal = b[overallAISortField];
                
                // Handle string comparison
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = (bVal || '').toLowerCase();
                }
                // Handle numeric strings like "100.0"
                if (!isNaN(parseFloat(aVal)) && !isNaN(parseFloat(bVal))) {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                }
                
                if (aVal < bVal) return overallAISortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return overallAISortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Discipline colors map
            const disciplineColors = {
                'Development': '#93c5fd',
                'Test': '#6ee7b7',
                'QA': '#6ee7b7',
                'Analysis': '#fcd34d',
                'Business Analysis': '#fcd34d',
                'Design': '#c4b5fd',
                'Documentation': '#f9a8d4',
                'User Documentation': '#f9a8d4',
                'Requirements': '#fca5a5',
                'User Education': '#67e8f9',
                'User Experience': '#a5b4fc'
            };
            const defaultColor = '#94a3b8';
            
            // Helper function to display value or '-' if zero/empty
            const displayVal = (val) => (val === 0 || val === '0' || val === null || val === undefined) ? '-' : val;
            const displayHours = (val) => (val === 0 || val === null || val === undefined) ? '-' : fmtH(val) + 'h';
            const displayPercent = (val) => (val === 0 || val === '0' || val === null || val === undefined) ? '-' : val + '%';
            
            // Body rows
            const tdStyle = 'padding:8px 6px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.08);';
            tbody.innerHTML = sortedData.map(d => {
                const hasData = d.totalTasks > 0;
                const effValue = parseFloat(d.efficiency);
                const effColor = !hasData ? '#94a3b8' : (effValue >= 30 ? '#34d399' : (effValue >= 15 ? '#fbbf24' : '#f87171'));
                const hrSaveColor = !hasData ? '#94a3b8' : (d.hoursSaved > 0 ? '#34d399' : '#f87171');
                const disciplineColor = disciplineColors[d.discipline] || defaultColor;
                // Claude efficiency color
                const claudeEffValue = parseFloat(d.claudeEfficiency);
                const claudeEffColor = !hasData || d.claudeAI === 0 ? '#94a3b8' : (claudeEffValue >= 30 ? '#34d399' : (claudeEffValue >= 15 ? '#fbbf24' : '#f87171'));
                // Copilot efficiency color
                const copilotEffValue = parseFloat(d.copilotEfficiency);
                const copilotEffColor = !hasData || d.copilot === 0 ? '#94a3b8' : (copilotEffValue >= 30 ? '#34d399' : (copilotEffValue >= 15 ? '#fbbf24' : '#f87171'));
                
                return `<tr>
                    <td style="${tdStyle}text-align:left;font-weight:600;color:${disciplineColor};">${d.discipline}</td>
                    <td style="${tdStyle}color:#67e8f9;">AI-Enabled</td>
                    <td style="${tdStyle}color:${hasData ? '#e2e8f0' : '#94a3b8'};">${displayVal(d.totalTasks)}</td>
                    <td style="${tdStyle}color:${hasData && d.claudeAI > 0 ? '#c4b5fd' : '#94a3b8'};">${displayVal(d.claudeAI)}</td>
                    <td style="${tdStyle}color:${hasData && d.copilot > 0 ? '#22d3ee' : '#94a3b8'};">${displayVal(d.copilot)}</td>
                    <td style="${tdStyle}color:${hasData ? '#fbbf24' : '#94a3b8'};">${displayHours(d.estHours)}</td>
                    <td style="${tdStyle}color:${hasData ? '#34d399' : '#94a3b8'};">${displayHours(d.actualHours)}</td>
                    <td style="${tdStyle}color:${claudeEffColor};font-weight:600;">${d.claudeAI > 0 ? displayPercent(d.claudeEfficiency) : '-'}</td>
                    <td style="${tdStyle}color:${copilotEffColor};font-weight:600;">${d.copilot > 0 ? displayPercent(d.copilotEfficiency) : '-'}</td>
                    <td style="${tdStyle}color:${effColor};font-weight:600;">${displayPercent(d.efficiency)}</td>
                    <td style="${tdStyle}color:${hrSaveColor};font-weight:600;">${displayHours(d.hoursSaved)}</td>
                </tr>`;
            }).join('');
            
            // Footer (Grand Total)
            const gt = overallAIGrandTotal;
            const gtEffValue = parseFloat(gt.efficiency);
            const gtEffColor = gtEffValue >= 30 ? '#34d399' : (gtEffValue >= 15 ? '#fbbf24' : '#f87171');
            const gtHrSaveColor = gt.hoursSaved > 0 ? '#34d399' : '#f87171';
            // Claude efficiency color for subtotal
            const gtClaudeEffValue = parseFloat(gt.claudeEfficiency);
            const gtClaudeEffColor = gtClaudeEffValue >= 30 ? '#34d399' : (gtClaudeEffValue >= 15 ? '#fbbf24' : '#f87171');
            // Copilot efficiency color for subtotal
            const gtCopilotEffValue = parseFloat(gt.copilotEfficiency);
            const gtCopilotEffColor = gtCopilotEffValue >= 30 ? '#34d399' : (gtCopilotEffValue >= 15 ? '#fbbf24' : '#f87171');
            
            tfoot.innerHTML = `<tr style="background:rgba(16,185,129,0.15);">
                <td style="${tdStyle}text-align:left;font-weight:700;color:#34d399;">Grand Total</td>
                <td style="${tdStyle}font-weight:700;">-</td>
                <td style="${tdStyle}font-weight:700;">${gt.totalTasks}</td>
                <td style="${tdStyle}color:#c4b5fd;font-weight:700;">${gt.claudeAI}</td>
                <td style="${tdStyle}color:#22d3ee;font-weight:700;">${gt.copilot}</td>
                <td style="${tdStyle}color:#fbbf24;font-weight:700;">${fmtH(gt.estHours)}h</td>
                <td style="${tdStyle}color:#34d399;font-weight:700;">${fmtH(gt.actualHours)}h</td>
                <td style="${tdStyle}color:${gtClaudeEffColor};font-weight:700;">${gt.claudeEfficiency}%</td>
                <td style="${tdStyle}color:${gtCopilotEffColor};font-weight:700;">${gt.copilotEfficiency}%</td>
                <td style="${tdStyle}color:${gtEffColor};font-weight:700;">${gt.efficiency}%</td>
                <td style="${tdStyle}color:${gtHrSaveColor};font-weight:700;">${fmtH(gt.hoursSaved)}h</td>
            </tr>`;
        }
        
        function sortOverallAIAdoptionTable(field) {
            if (overallAISortField === field) {
                overallAISortDir = overallAISortDir === 'asc' ? 'desc' : 'asc';
            } else {
                overallAISortField = field;
                overallAISortDir = (field === 'discipline') ? 'asc' : 'desc';
            }
            
            // Update header sort icons
            const thead = document.getElementById('overallAIAdoptionTableHead');
            const thStyle = 'padding:8px 6px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.7rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (f) => overallAISortField === f ? (overallAISortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : ' ‚áÖ';
            
            thead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;width:11%;" onclick="sortOverallAIAdoptionTable('discipline')">Discipline${sortIcon('discipline')}</th>
                <th style="${thStyle}width:7%;">Category</th>
                <th style="${thStyle}width:6%;" onclick="sortOverallAIAdoptionTable('totalTasks')">Tasks${sortIcon('totalTasks')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:6%;" onclick="sortOverallAIAdoptionTable('claudeAI')">Claude${sortIcon('claudeAI')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:6%;" onclick="sortOverallAIAdoptionTable('copilot')">Copilot${sortIcon('copilot')}</th>
                <th style="${thStyle}background:rgba(245,158,11,0.25);color:#fbbf24;width:6%;" onclick="sortOverallAIAdoptionTable('estHours')">Orig Est${sortIcon('estHours')}</th>
                <th style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:7%;" onclick="sortOverallAIAdoptionTable('actualHours')">Completed${sortIcon('actualHours')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:7%;" onclick="sortOverallAIAdoptionTable('claudeEfficiency')">Claude %${sortIcon('claudeEfficiency')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:7%;" onclick="sortOverallAIAdoptionTable('copilotEfficiency')">Copilot %${sortIcon('copilotEfficiency')}</th>
                <th style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:6%;" onclick="sortOverallAIAdoptionTable('efficiency')">Eff %${sortIcon('efficiency')}</th>
                <th style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:7%;" onclick="sortOverallAIAdoptionTable('hoursSaved')">Hr Save${sortIcon('hoursSaved')}</th>
            </tr>`;
            
            // Re-render rows with new sort
            renderOverallAIAdoptionTableRows();
        }
        
        function exportOverallAIAdoptionToExcel() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            
            let csv = 'AI-ENABLED DISCIPLINES\n';
            csv += `Sprint: ${sprintName}\n`;
            csv += `Date: ${today}\n\n`;
            
            csv += 'Discipline,Category,Tasks,Claude,Copilot,Orig Est,Completed,Claude %,Copilot %,Eff %,Hr Saved\n';
            
            overallAIDisciplineData.forEach(d => {
                csv += `"${d.discipline}",AI-Enabled,${d.totalTasks},${d.claudeAI},${d.copilot},${fmtH(d.estHours)}h,${fmtH(d.actualHours)}h,${d.claudeEfficiency}%,${d.copilotEfficiency}%,${d.efficiency}%,${fmtH(d.hoursSaved)}h\n`;
            });
            
            const gt = overallAIGrandTotal;
            csv += `"Grand Total",-,${gt.totalTasks},${gt.claudeAI},${gt.copilot},${fmtH(gt.estHours)}h,${fmtH(gt.actualHours)}h,${gt.claudeEfficiency}%,${gt.copilotEfficiency}%,${gt.efficiency}%,${fmtH(gt.hoursSaved)}h\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AI_Enabled_Disciplines_${sprintName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ==================== TASK EXECUTION TYPE AI ADOPTION FUNCTIONS ====================
        let execTypeAIAdoptionDataLoaded = false;
        let execTypeData = [];
        let execTypeSortField = 'execType';
        let execTypeSortDir = 'asc';
        let execTypeGrandTotals = {};
        
        function toggleExecTypeAIAdoptionData() {
            const btn = document.getElementById('loadExecTypeAIAdoptionBtn');
            const content = document.getElementById('execTypeAIAdoptionContent');
            const exportBtn = document.getElementById('exportExecTypeAIAdoptionBtn');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'üîº Hide';
                loadExecTypeAIAdoptionData();
                exportBtn.style.display = 'inline-block';
                document.getElementById('exportExecTypeAIAdoptionPdfBtn').style.display = 'inline-block';
            } else {
                content.style.display = 'none';
                btn.textContent = 'üìä Show';
                exportBtn.style.display = 'none';
                document.getElementById('exportExecTypeAIAdoptionPdfBtn').style.display = 'none';
            }
        }
        
        function loadExecTypeAIAdoptionData() {
            // Create set of valid requirement IDs
            // Include: Deliverable, Deliverables Adhoc, Deliverables OnHold, Non-Deliverable (exact tag match)
            const validReqIds = new Set();
            requirements.forEach(req => {
                // Check exact tag values
                const tags = (req.fields['System.Tags'] || '').split(';').map(t => t.trim().toLowerCase());
                const hasDeliverable = tags.includes('deliverable');
                const hasDeliverablesAdhoc = tags.includes('deliverables adhoc');
                const hasDeliverablesOnHold = tags.includes('deliverables onhold');
                const hasNonDeliverable = tags.includes('non-deliverable');
                
                if (hasDeliverable || hasDeliverablesAdhoc || hasDeliverablesOnHold || hasNonDeliverable) {
                    validReqIds.add(req.id);
                }
            });
            
            // Define all known AI-* TaskExecutionType values
            const allAIExecTypes = [
                'AI-Dev-Analysis',
                'AI-Dev-Code Review',
                'AI-Dev-Development',
                'AI-Dev-Documentation',
                'AI-Test-Case Creation',
                'AI-Test-Defect Analysis',
                'AI-Test-Documentation',
                'AI-Test-Execution',
                'AI-BA-Analysis',
                'AI-BA-Documentation',
                'AI-UD-Documentation'
            ];
            
            // Initialize execTypeMap with all known AI-* types (with zero values)
            const execTypeMap = new Map();
            allAIExecTypes.forEach(execType => {
                execTypeMap.set(execType, {
                    execType: execType,
                    taskCount: 0,
                    claudeCount: 0,
                    copilotCount: 0,
                    origEst: 0,
                    completed: 0,
                    claudeOrigEst: 0,
                    claudeCompleted: 0,
                    copilotOrigEst: 0,
                    copilotCompleted: 0
                });
            });
            
            tasks.forEach(t => {
                if (!t.fields) return;
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return;
                
                // Filter by area path to match selected areas (uses global helper)
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return;
                
                const state = t.fields['System.State'] || '';
                const reason = t.fields['System.Reason'] || '';
                if (!['Resolved', 'Closed'].includes(state)) return;
                if (reason === 'Rejected') return;
                
                // Use Revised Estimate if available (non-zero), otherwise use Original Estimate
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                const compWork = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                if (origEst <= 0) return;
                
                let execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                
                // Only consider AI-* execution types
                if (!execType || !execType.startsWith('AI-')) return;
                
                // Check for "Claude AI" tag with flexible matching (Claude AI, ClaudeAI, Claude-AI, etc.)
                const tags = (t.fields['System.Tags'] || '').toLowerCase();
                const hasClaudeAITag = tags.includes('claude ai') || tags.includes('claudeai') || tags.includes('claude-ai') || /claude[\s\-_]*ai/i.test(tags);
                
                // If execType not in predefined list, add it
                if (!execTypeMap.has(execType)) {
                    execTypeMap.set(execType, {
                        execType: execType,
                        taskCount: 0,
                        claudeCount: 0,
                        copilotCount: 0,
                        origEst: 0,
                        completed: 0,
                        claudeOrigEst: 0,
                        claudeCompleted: 0,
                        copilotOrigEst: 0,
                        copilotCompleted: 0
                    });
                }
                
                const data = execTypeMap.get(execType);
                data.taskCount++;
                data.origEst += origEst;
                data.completed += compWork;
                
                // If "Claude AI" tag found -> Claude AI column, otherwise -> GitHub Copilot column
                if (hasClaudeAITag) {
                    data.claudeCount++;
                    data.claudeOrigEst += origEst;
                    data.claudeCompleted += compWork;
                } else {
                    data.copilotCount++;
                    data.copilotOrigEst += origEst;
                    data.copilotCompleted += compWork;
                }
            });
            
            // Calculate derived values
            let dataArray = [];
            execTypeMap.forEach((data, key) => {
                data.efficiency = data.origEst > 0 ? Math.round(((data.origEst - data.completed) / data.origEst) * 100) : 0;
                data.hourSaved = data.origEst - data.completed;
                // Claude AI % = (Claude Orig - Claude Completed) / Claude Orig * 100
                data.claudeEff = data.claudeOrigEst > 0 ? Math.round(((data.claudeOrigEst - data.claudeCompleted) / data.claudeOrigEst) * 100) : 0;
                // Copilot % = (Copilot Orig - Copilot Completed) / Copilot Orig * 100
                data.copilotEff = data.copilotOrigEst > 0 ? Math.round(((data.copilotOrigEst - data.copilotCompleted) / data.copilotOrigEst) * 100) : 0;
                // Better Tool - compare Claude % vs Copilot %
                if (data.taskCount > 0) {
                    if (data.claudeEff > data.copilotEff) {
                        data.betterTool = 'Claude AI';
                    } else if (data.copilotEff > data.claudeEff) {
                        data.betterTool = 'GitHub Copilot';
                    } else if (data.claudeEff === data.copilotEff && data.claudeEff > 0) {
                        data.betterTool = 'Tie';
                    } else {
                        data.betterTool = '';
                    }
                } else {
                    data.betterTool = '';
                }
                dataArray.push(data);
            });
            
            // Sort by execType name by default
            dataArray.sort((a, b) => a.execType.localeCompare(b.execType));
            
            // Calculate grand totals
            const grandTotal = {
                execType: 'Grand Total',
                taskCount: dataArray.reduce((sum, d) => sum + d.taskCount, 0),
                claudeCount: dataArray.reduce((sum, d) => sum + d.claudeCount, 0),
                copilotCount: dataArray.reduce((sum, d) => sum + d.copilotCount, 0),
                origEst: dataArray.reduce((sum, d) => sum + d.origEst, 0),
                completed: dataArray.reduce((sum, d) => sum + d.completed, 0),
                claudeOrigEst: dataArray.reduce((sum, d) => sum + d.claudeOrigEst, 0),
                claudeCompleted: dataArray.reduce((sum, d) => sum + d.claudeCompleted, 0),
                copilotOrigEst: dataArray.reduce((sum, d) => sum + d.copilotOrigEst, 0),
                copilotCompleted: dataArray.reduce((sum, d) => sum + d.copilotCompleted, 0)
            };
            grandTotal.efficiency = grandTotal.origEst > 0 ? 
                Math.round(((grandTotal.origEst - grandTotal.completed) / grandTotal.origEst) * 100) : 0;
            grandTotal.hourSaved = grandTotal.origEst - grandTotal.completed;
            grandTotal.claudeEff = grandTotal.claudeOrigEst > 0 ? 
                Math.round(((grandTotal.claudeOrigEst - grandTotal.claudeCompleted) / grandTotal.claudeOrigEst) * 100) : 0;
            grandTotal.copilotEff = grandTotal.copilotOrigEst > 0 ? 
                Math.round(((grandTotal.copilotOrigEst - grandTotal.copilotCompleted) / grandTotal.copilotOrigEst) * 100) : 0;
            // Better Tool for grand total
            if (grandTotal.claudeEff > grandTotal.copilotEff) {
                grandTotal.betterTool = 'Claude AI';
            } else if (grandTotal.copilotEff > grandTotal.claudeEff) {
                grandTotal.betterTool = 'GitHub Copilot';
            } else if (grandTotal.claudeEff === grandTotal.copilotEff && grandTotal.claudeEff > 0) {
                grandTotal.betterTool = 'Tie';
            } else {
                grandTotal.betterTool = '';
            }
            
            // Store globally for sorting
            execTypeData = dataArray;
            execTypeGrandTotals = grandTotal;
            
            // Render table
            renderExecTypeAIAdoptionTable();
        }
        
        function renderExecTypeAIAdoptionTable() {
            const thead = document.getElementById('execTypeAIAdoptionTableHead');
            const tbody = document.getElementById('execTypeAIAdoptionTableBody');
            const tfoot = document.getElementById('execTypeAIAdoptionTableFoot');
            
            // Always show the table since we display all predefined TaskExecutionTypes
            document.getElementById('noExecTypeAIAdoptionData').style.display = 'none';
            
            // Sort data
            const sortedData = [...execTypeData].sort((a, b) => {
                let aVal = a[execTypeSortField];
                let bVal = b[execTypeSortField];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (execTypeSortDir === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            // Header with sortable columns
            const thStyle = 'padding:8px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.7rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (field) => execTypeSortField === field ? (execTypeSortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : ' ‚áÖ';
            
            thead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;width:18%;" onclick="sortExecTypeTable('execType')">Task Execution Type${sortIcon('execType')}</th>
                <th style="${thStyle}width:6%;" onclick="sortExecTypeTable('taskCount')">Tasks${sortIcon('taskCount')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:6%;" onclick="sortExecTypeTable('claudeCount')">Claude${sortIcon('claudeCount')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:6%;" onclick="sortExecTypeTable('copilotCount')">Copilot${sortIcon('copilotCount')}</th>
                <th style="${thStyle}background:rgba(245,158,11,0.25);color:#fbbf24;width:8%;" onclick="sortExecTypeTable('origEst')">Orig Est${sortIcon('origEst')}</th>
                <th style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:8%;" onclick="sortExecTypeTable('completed')">Completed${sortIcon('completed')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:8%;" onclick="sortExecTypeTable('claudeEff')">Claude %${sortIcon('claudeEff')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:8%;" onclick="sortExecTypeTable('copilotEff')">Copilot %${sortIcon('copilotEff')}</th>
                <th style="${thStyle}background:rgba(59,130,246,0.25);color:#60a5fa;width:7%;" onclick="sortExecTypeTable('efficiency')">Eff %${sortIcon('efficiency')}</th>
                <th style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:8%;" onclick="sortExecTypeTable('hourSaved')">Hr Save${sortIcon('hourSaved')}</th>
            </tr>`;
            
            // Execution type color mapping
            const execTypeColors = {
                'AI-Dev-Analysis': '#c4b5fd',
                'AI-Dev-Code Review': '#a5b4fc',
                'AI-Dev-Development': '#93c5fd',
                'AI-Dev-Documentation': '#67e8f9',
                'AI-Test-Case Creation': '#6ee7b7',
                'AI-Test-Defect Analysis': '#34d399',
                'AI-Test-Documentation': '#a3e635',
                'AI-Test-Execution': '#fbbf24',
                'AI-BA-Analysis': '#f472b6',
                'AI-BA-Documentation': '#fb7185',
                'AI-UD-Documentation': '#fca5a5'
            };
            const defaultColor = '#c4b5fd';
            
            // Body rows
            const tdStyle = 'padding:8px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.08);';
            tbody.innerHTML = sortedData.map(d => {
                const hasData = d.taskCount > 0;
                const effColor = d.efficiency >= 20 ? '#34d399' : (d.efficiency >= 10 ? '#fbbf24' : '#f87171');
                const hrSaveColor = d.hourSaved > 0 ? '#34d399' : '#f87171';
                const claudeEffColor = d.claudeEff >= 20 ? '#34d399' : (d.claudeEff >= 10 ? '#fbbf24' : '#f87171');
                const copilotEffColor = d.copilotEff >= 20 ? '#34d399' : (d.copilotEff >= 10 ? '#fbbf24' : '#f87171');
                const execColor = execTypeColors[d.execType] || defaultColor;
                

                
                // Style for rows with no data - grayed out
                const rowOpacity = hasData ? '1' : '0.4';
                const noDataStyle = hasData ? '' : 'font-style:italic;';
                const displayVal = (val, suffix = '') => hasData ? `${val}${suffix}` : '-';
                
                return `<tr style="opacity:${rowOpacity};">
                    <td style="${tdStyle}text-align:left;font-weight:600;color:${execColor};${noDataStyle}">${d.execType}</td>
                    <td style="${tdStyle}${noDataStyle}">${displayVal(d.taskCount)}</td>
                    <td style="${tdStyle}color:#c4b5fd;${noDataStyle}">${displayVal(d.claudeCount)}</td>
                    <td style="${tdStyle}color:#22d3ee;${noDataStyle}">${displayVal(d.copilotCount)}</td>
                    <td style="${tdStyle}color:#fbbf24;${noDataStyle}">${hasData ? fmtH(d.origEst) + 'h' : '-'}</td>
                    <td style="${tdStyle}color:#34d399;${noDataStyle}">${hasData ? fmtH(d.completed) + 'h' : '-'}</td>
                    <td style="${tdStyle}color:${hasData ? claudeEffColor : '#64748b'};font-weight:600;${noDataStyle}">${displayVal(d.claudeEff, '%')}</td>
                    <td style="${tdStyle}color:${hasData ? copilotEffColor : '#64748b'};font-weight:600;${noDataStyle}">${displayVal(d.copilotEff, '%')}</td>
                    <td style="${tdStyle}color:${hasData ? effColor : '#64748b'};font-weight:600;${noDataStyle}">${displayVal(d.efficiency, '%')}</td>
                    <td style="${tdStyle}color:${hasData ? hrSaveColor : '#64748b'};font-weight:600;${noDataStyle}">${hasData ? fmtH(d.hourSaved) + 'h' : '-'}</td>
                </tr>`;
            }).join('');
            
            // Footer (Grand Total) - determine overall better tool
            const gt = execTypeGrandTotals;
            const gtEffColor = gt.efficiency >= 20 ? '#34d399' : (gt.efficiency >= 10 ? '#fbbf24' : '#f87171');
            const gtHrSaveColor = gt.hourSaved > 0 ? '#34d399' : '#f87171';
            const gtClaudeEffColor = gt.claudeEff >= 20 ? '#34d399' : (gt.claudeEff >= 10 ? '#fbbf24' : '#f87171');
            const gtCopilotEffColor = gt.copilotEff >= 20 ? '#34d399' : (gt.copilotEff >= 10 ? '#fbbf24' : '#f87171');
            

            
            tfoot.innerHTML = `<tr style="background:rgba(139,92,246,0.1);">
                <td style="${tdStyle}text-align:left;font-weight:700;color:#c4b5fd;">Grand Total</td>
                <td style="${tdStyle}font-weight:700;">${gt.taskCount}</td>
                <td style="${tdStyle}color:#c4b5fd;font-weight:700;">${gt.claudeCount}</td>
                <td style="${tdStyle}color:#22d3ee;font-weight:700;">${gt.copilotCount}</td>
                <td style="${tdStyle}color:#fbbf24;font-weight:700;">${fmtH(gt.origEst)}h</td>
                <td style="${tdStyle}color:#34d399;font-weight:700;">${fmtH(gt.completed)}h</td>
                <td style="${tdStyle}color:${gtClaudeEffColor};font-weight:700;">${gt.claudeEff}%</td>
                <td style="${tdStyle}color:${gtCopilotEffColor};font-weight:700;">${gt.copilotEff}%</td>
                <td style="${tdStyle}color:${gtEffColor};font-weight:700;">${gt.efficiency}%</td>
                <td style="${tdStyle}color:${gtHrSaveColor};font-weight:700;">${fmtH(gt.hourSaved)}h</td>
            </tr>`;
        }
        
        function sortExecTypeTable(field) {
            if (execTypeSortField === field) {
                execTypeSortDir = execTypeSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                execTypeSortField = field;
                execTypeSortDir = 'asc';
            }
            renderExecTypeAIAdoptionTable();
        }
        
        function exportExecTypeAIAdoptionToExcel() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            
            let csv = 'TaskExecutionType AI Adoption Data (AI-* Only)\n';
            csv += `Sprint: ${sprintName}\n`;
            csv += `Date: ${today}\n\n`;
            
            csv += 'Task Execution Type,Tasks,Claude,Copilot,Orig Est,Completed,Claude %,Copilot %,Eff %,Hr Saved\n';
            
            execTypeData.forEach(d => {
                csv += `"${d.execType}",${d.taskCount},${d.claudeCount},${d.copilotCount},${fmtH(d.origEst)}h,${fmtH(d.completed)}h,${d.claudeEff}%,${d.copilotEff}%,${d.efficiency}%,${fmtH(d.hourSaved)}h\n`;
            });
            
            const gt = execTypeGrandTotals;
            csv += `\nGrand Total,${gt.taskCount},${gt.claudeCount},${gt.copilotCount},${fmtH(gt.origEst)}h,${fmtH(gt.completed)}h,${gt.claudeEff}%,${gt.copilotEff}%,${gt.efficiency}%,${fmtH(gt.hourSaved)}h\n`;
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `TaskExecutionType_AI_Adoption_${sprintName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ==================== PROJECT-WISE AI ADOPTION FUNCTIONS ====================
        let projectAIAdoptionDataLoaded = false;
        let projectAIData = [];
        let projectAISortField = 'project';
        let projectAISortDir = 'asc';
        let projectAIGrandTotals = {};
        
        function toggleProjectAIAdoptionData() {
            const btn = document.getElementById('loadProjectAIAdoptionBtn');
            const content = document.getElementById('projectAIAdoptionContent');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'üîº Hide';
                loadProjectAIAdoptionData();
            } else {
                content.style.display = 'none';
                btn.textContent = 'üìä Show';
            }
        }
        
        function loadProjectAIAdoptionData() {
            // Create set of valid requirement IDs
            // Include: Deliverable, Deliverables Adhoc, Deliverables OnHold, Non-Deliverable (exact tag match)
            const validReqIds = new Set();
            
            requirements.forEach(req => {
                // Check exact tag values
                const tags = (req.fields['System.Tags'] || '').split(';').map(t => t.trim().toLowerCase());
                const hasDeliverable = tags.includes('deliverable');
                const hasDeliverablesAdhoc = tags.includes('deliverables adhoc');
                const hasDeliverablesOnHold = tags.includes('deliverables onhold');
                const hasNonDeliverable = tags.includes('non-deliverable');
                
                if (hasDeliverable || hasDeliverablesAdhoc || hasDeliverablesOnHold || hasNonDeliverable) {
                    validReqIds.add(req.id);
                }
            });
            
            // Initialize project data map
            const projectDataMap = new Map();
            
            tasks.forEach(t => {
                if (!t.fields) return;
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return;
                
                // Filter by area path to match selected areas (uses global helper)
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return;
                
                const state = t.fields['System.State'] || '';
                const reason = t.fields['System.Reason'] || '';
                if (!['Resolved', 'Closed'].includes(state)) return;
                if (reason === 'Rejected') return;
                
                // Use Revised Estimate if available (non-zero), otherwise use Original Estimate
                const revisedEst = t.fields['Casepoint.TFS.CustomFields.RevisedEstimate'] || 0;
                const originalEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const origEst = (revisedEst > 0) ? revisedEst : originalEst;
                const compWork = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                if (origEst <= 0) return;
                
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                
                // Only consider AI-* execution types
                if (!execType || !execType.startsWith('AI-')) return;
                
                // Get project from task's area path - first segment is always the TFS project name
                // Format: "ProjectName\AreaName\SubArea" e.g. "CasepointARA\eCase\SubTeam"
                const areaPath = t.fields['System.AreaPath'] || '';
                const projectName = areaPath.split('\\')[0] || 'Unknown';
                
                // Check for "Claude AI" tag
                const tags = (t.fields['System.Tags'] || '').toLowerCase();
                const hasClaudeAITag = tags.includes('claude ai') || tags.includes('claudeai') || tags.includes('claude-ai') || /claude[\s\-_]*ai/i.test(tags);
                
                if (!projectDataMap.has(projectName)) {
                    projectDataMap.set(projectName, {
                        project: projectName,
                        taskCount: 0,
                        claudeCount: 0,
                        copilotCount: 0,
                        origEst: 0,
                        completed: 0,
                        claudeOrigEst: 0,
                        claudeCompleted: 0,
                        copilotOrigEst: 0,
                        copilotCompleted: 0
                    });
                }
                
                const data = projectDataMap.get(projectName);
                data.taskCount++;
                data.origEst += origEst;
                data.completed += compWork;
                
                if (hasClaudeAITag) {
                    data.claudeCount++;
                    data.claudeOrigEst += origEst;
                    data.claudeCompleted += compWork;
                } else {
                    data.copilotCount++;
                    data.copilotOrigEst += origEst;
                    data.copilotCompleted += compWork;
                }
            });
            
            // Calculate derived values
            let dataArray = [];
            projectDataMap.forEach((data, key) => {
                data.efficiency = data.origEst > 0 ? Math.round(((data.origEst - data.completed) / data.origEst) * 100) : 0;
                data.hourSaved = data.origEst - data.completed;
                data.claudeEff = data.claudeOrigEst > 0 ? Math.round(((data.claudeOrigEst - data.claudeCompleted) / data.claudeOrigEst) * 100) : 0;
                data.copilotEff = data.copilotOrigEst > 0 ? Math.round(((data.copilotOrigEst - data.copilotCompleted) / data.copilotOrigEst) * 100) : 0;
                // Better Tool
                if (data.claudeEff > data.copilotEff) {
                    data.betterTool = 'Claude AI';
                } else if (data.copilotEff > data.claudeEff) {
                    data.betterTool = 'GitHub Copilot';
                } else if (data.claudeEff === data.copilotEff && data.claudeEff > 0) {
                    data.betterTool = 'Tie';
                } else {
                    data.betterTool = '';
                }
                dataArray.push(data);
            });
            
            // Sort by project name by default
            dataArray.sort((a, b) => a.project.localeCompare(b.project));
            
            // Calculate grand totals
            const grandTotal = {
                project: 'Grand Total',
                taskCount: dataArray.reduce((sum, d) => sum + d.taskCount, 0),
                claudeCount: dataArray.reduce((sum, d) => sum + d.claudeCount, 0),
                copilotCount: dataArray.reduce((sum, d) => sum + d.copilotCount, 0),
                origEst: dataArray.reduce((sum, d) => sum + d.origEst, 0),
                completed: dataArray.reduce((sum, d) => sum + d.completed, 0),
                claudeOrigEst: dataArray.reduce((sum, d) => sum + d.claudeOrigEst, 0),
                claudeCompleted: dataArray.reduce((sum, d) => sum + d.claudeCompleted, 0),
                copilotOrigEst: dataArray.reduce((sum, d) => sum + d.copilotOrigEst, 0),
                copilotCompleted: dataArray.reduce((sum, d) => sum + d.copilotCompleted, 0)
            };
            grandTotal.efficiency = grandTotal.origEst > 0 ? 
                Math.round(((grandTotal.origEst - grandTotal.completed) / grandTotal.origEst) * 100) : 0;
            grandTotal.hourSaved = grandTotal.origEst - grandTotal.completed;
            grandTotal.claudeEff = grandTotal.claudeOrigEst > 0 ? 
                Math.round(((grandTotal.claudeOrigEst - grandTotal.claudeCompleted) / grandTotal.claudeOrigEst) * 100) : 0;
            grandTotal.copilotEff = grandTotal.copilotOrigEst > 0 ? 
                Math.round(((grandTotal.copilotOrigEst - grandTotal.copilotCompleted) / grandTotal.copilotOrigEst) * 100) : 0;
            // Better Tool for grand total
            if (grandTotal.claudeEff > grandTotal.copilotEff) {
                grandTotal.betterTool = 'Claude AI';
            } else if (grandTotal.copilotEff > grandTotal.claudeEff) {
                grandTotal.betterTool = 'GitHub Copilot';
            } else if (grandTotal.claudeEff === grandTotal.copilotEff && grandTotal.claudeEff > 0) {
                grandTotal.betterTool = 'Tie';
            } else {
                grandTotal.betterTool = '';
            }
            
            // Store globally for sorting
            projectAIData = dataArray;
            projectAIGrandTotals = grandTotal;
            
            // Render table
            renderProjectAIAdoptionTable();
        }
        
        function renderProjectAIAdoptionTable() {
            const thead = document.getElementById('projectAIAdoptionTableHead');
            const tbody = document.getElementById('projectAIAdoptionTableBody');
            const tfoot = document.getElementById('projectAIAdoptionTableFoot');
            
            if (projectAIData.length === 0) {
                document.getElementById('noProjectAIAdoptionData').style.display = 'block';
                thead.innerHTML = '';
                tbody.innerHTML = '';
                tfoot.innerHTML = '';
                return;
            }
            
            document.getElementById('noProjectAIAdoptionData').style.display = 'none';
            
            // Sort data
            const sortedData = [...projectAIData].sort((a, b) => {
                let aVal = a[projectAISortField];
                let bVal = b[projectAISortField];
                
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                
                if (projectAISortDir === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            // Header with sortable columns
            const thStyle = 'padding:8px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.7rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (field) => projectAISortField === field ? (projectAISortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : ' ‚áÖ';
            
            thead.innerHTML = `<tr>
                <th style="${thStyle}text-align:left;width:18%;" onclick="sortProjectAITable('project')">Project${sortIcon('project')}</th>
                <th style="${thStyle}width:6%;" onclick="sortProjectAITable('taskCount')">Tasks${sortIcon('taskCount')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:6%;" onclick="sortProjectAITable('claudeCount')">Claude${sortIcon('claudeCount')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:6%;" onclick="sortProjectAITable('copilotCount')">Copilot${sortIcon('copilotCount')}</th>
                <th style="${thStyle}background:rgba(245,158,11,0.25);color:#fbbf24;width:8%;" onclick="sortProjectAITable('origEst')">Orig Est${sortIcon('origEst')}</th>
                <th style="${thStyle}background:rgba(16,185,129,0.25);color:#34d399;width:8%;" onclick="sortProjectAITable('completed')">Completed${sortIcon('completed')}</th>
                <th style="${thStyle}background:rgba(168,85,247,0.25);color:#c4b5fd;width:8%;" onclick="sortProjectAITable('claudeEff')">Claude %${sortIcon('claudeEff')}</th>
                <th style="${thStyle}background:rgba(6,182,212,0.25);color:#22d3ee;width:8%;" onclick="sortProjectAITable('copilotEff')">Copilot %${sortIcon('copilotEff')}</th>
                <th style="${thStyle}background:rgba(59,130,246,0.25);color:#60a5fa;width:7%;" onclick="sortProjectAITable('efficiency')">Eff %${sortIcon('efficiency')}</th>
                <th style="${thStyle}background:rgba(236,72,153,0.25);color:#f472b6;width:8%;" onclick="sortProjectAITable('hourSaved')">Hr Save${sortIcon('hourSaved')}</th>
            </tr>`;
            
            // Project colors
            const projectColors = {
                'CasepointARA': '#93c5fd',
                'eCase': '#6ee7b7',
                'Casepoint': '#c4b5fd',
                'Automation': '#fcd34d',
                'Infrastructure': '#f9a8d4'
            };
            const defaultColor = '#22d3ee';
            
            // Body rows
            const tdStyle = 'padding:8px 4px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.08);';
            tbody.innerHTML = sortedData.map(d => {
                const effColor = d.efficiency >= 20 ? '#34d399' : (d.efficiency >= 10 ? '#fbbf24' : '#f87171');
                const hrSaveColor = d.hourSaved > 0 ? '#34d399' : '#f87171';
                const claudeEffColor = d.claudeEff >= 20 ? '#34d399' : (d.claudeEff >= 10 ? '#fbbf24' : '#f87171');
                const copilotEffColor = d.copilotEff >= 20 ? '#34d399' : (d.copilotEff >= 10 ? '#fbbf24' : '#f87171');
                const projectColor = projectColors[d.project] || defaultColor;
                

                
                return `<tr>
                    <td style="${tdStyle}text-align:left;font-weight:600;color:${projectColor};">${d.project}</td>
                    <td style="${tdStyle}">${d.taskCount}</td>
                    <td style="${tdStyle}color:#c4b5fd;">${d.claudeCount}</td>
                    <td style="${tdStyle}color:#22d3ee;">${d.copilotCount}</td>
                    <td style="${tdStyle}color:#fbbf24;">${fmtH(d.origEst)}h</td>
                    <td style="${tdStyle}color:#34d399;">${fmtH(d.completed)}h</td>
                    <td style="${tdStyle}color:${claudeEffColor};font-weight:600;">${d.claudeEff}%</td>
                    <td style="${tdStyle}color:${copilotEffColor};font-weight:600;">${d.copilotEff}%</td>
                    <td style="${tdStyle}color:${effColor};font-weight:600;">${d.efficiency}%</td>
                    <td style="${tdStyle}color:${hrSaveColor};font-weight:600;">${fmtH(d.hourSaved)}h</td>
                </tr>`;
            }).join('');
            
            // Footer (Grand Total)
            const gt = projectAIGrandTotals;
            const gtEffColor = gt.efficiency >= 20 ? '#34d399' : (gt.efficiency >= 10 ? '#fbbf24' : '#f87171');
            const gtHrSaveColor = gt.hourSaved > 0 ? '#34d399' : '#f87171';
            const gtClaudeEffColor = gt.claudeEff >= 20 ? '#34d399' : (gt.claudeEff >= 10 ? '#fbbf24' : '#f87171');
            const gtCopilotEffColor = gt.copilotEff >= 20 ? '#34d399' : (gt.copilotEff >= 10 ? '#fbbf24' : '#f87171');
            

            
            tfoot.innerHTML = `<tr style="background:rgba(6,182,212,0.1);">
                <td style="${tdStyle}text-align:left;font-weight:700;color:#22d3ee;">Grand Total</td>
                <td style="${tdStyle}font-weight:700;">${gt.taskCount}</td>
                <td style="${tdStyle}color:#c4b5fd;font-weight:700;">${gt.claudeCount}</td>
                <td style="${tdStyle}color:#22d3ee;font-weight:700;">${gt.copilotCount}</td>
                <td style="${tdStyle}color:#fbbf24;font-weight:700;">${fmtH(gt.origEst)}h</td>
                <td style="${tdStyle}color:#34d399;font-weight:700;">${fmtH(gt.completed)}h</td>
                <td style="${tdStyle}color:${gtClaudeEffColor};font-weight:700;">${gt.claudeEff}%</td>
                <td style="${tdStyle}color:${gtCopilotEffColor};font-weight:700;">${gt.copilotEff}%</td>
                <td style="${tdStyle}color:${gtEffColor};font-weight:700;">${gt.efficiency}%</td>
                <td style="${tdStyle}color:${gtHrSaveColor};font-weight:700;">${fmtH(gt.hourSaved)}h</td>
            </tr>`;
        }
        
        function sortProjectAITable(field) {
            if (projectAISortField === field) {
                projectAISortDir = projectAISortDir === 'asc' ? 'desc' : 'asc';
            } else {
                projectAISortField = field;
                projectAISortDir = (field === 'project') ? 'asc' : 'desc';
            }
            renderProjectAIAdoptionTable();
        }
        
        
        // ==================== END QA AI ADOPTION DATA FUNCTIONS ====================

        function renderBlankSizeData(blankSizeReqs) {
            const tbody = document.getElementById('blankSizeTableBody');
            const noDataDiv = document.getElementById('noBlankSizeData');
            const tdStyle = 'padding:4px;border-bottom:1px solid rgba(255,255,255,0.08);';
            
            if (blankSizeReqs.length === 0) {
                noDataDiv.style.display = 'block';
                tbody.innerHTML = '';
            } else {
                noDataDiv.style.display = 'none';
                tbody.innerHTML = blankSizeReqs.map(req => {
                    const title = req.fields['System.Title'] || '';
                    return `<tr>
                        <td style="${tdStyle}"><a href="${tfsUrl}/${project}/_workitems/edit/${req.id}" target="_blank" class="wi-link">${req.id}</a></td>
                        <td style="${tdStyle}">${title}</td>
                    </tr>`;
                }).join('');
            }
        }
        
        // ==================== DISCIPLINE VERIFICATION FUNCTIONS ====================
        
        function toggleDisciplineVerification() {
            const btn = document.getElementById('loadDisciplineVerifyBtn');
            const content = document.getElementById('disciplineVerifyContent');
            const exportBtn = document.getElementById('exportDisciplineVerifyBtn');
            const exportPdfBtn = document.getElementById('exportDisciplineVerifyPdfBtn');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                btn.textContent = 'üîº Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                exportBtn.style.display = 'inline-block';
                exportPdfBtn.style.display = 'inline-block';
                
                if (!dvDataLoaded) {
                    loadDisciplineVerificationData();
                    dvDataLoaded = true;
                }
            } else {
                content.style.display = 'none';
                btn.textContent = 'üìä Show';
                btn.style.background = '';
                btn.style.borderColor = '';
                exportBtn.style.display = 'none';
                exportPdfBtn.style.display = 'none';
                dvDataLoaded = false; // Reset so data refreshes on next Load
            }
        }
        
        function loadDisciplineVerificationData() {
            const members = capacityData.members || [];
            if (members.length === 0) return;
            
            // Build member entries as array (allow same name in different teams/areas)
            // Use uniqueName (email/id) as primary key for reliable matching
            const memberEntries = [];
            members.forEach(m => {
                const disciplines = (m.discipline || '').split(',').map(d => d.trim().toLowerCase()).filter(d => d && d !== '-');
                memberEntries.push({
                    nameLower: m.name.toLowerCase().trim(),
                    uniqueName: (m.uniqueName || '').toLowerCase().trim(),
                    name: m.name,
                    project: m.project || '-',
                    team: m.team || '-',
                    disciplines: disciplines,
                    disciplineDisplay: m.discipline || '-'
                });
            });
            
            // Process ALL tasks in the sprint (no requirement category filter)
            dvAllTaskData = [];
            
            tasks.forEach(t => {
                if (!t.fields) return;
                
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return;
                
                const assignedToObj = t.fields['System.AssignedTo'];
                if (!assignedToObj) return;
                const assignedTo = assignedToObj.displayName || '';
                if (!assignedTo) return;
                
                const taskUniqueName = (assignedToObj.uniqueName || assignedToObj.id || '').toLowerCase().trim();
                const assignedToLower = assignedTo.toLowerCase().trim();
                const taskDiscipline = t.fields['Microsoft.VSTS.Common.Discipline'] || '';
                const taskState = t.fields['System.State'] || '';
                
                let memberInfo;
                
                if (taskUniqueName) {
                    // Primary match: by uniqueName (email/id) - most reliable
                    memberInfo = memberEntries.find(m => m.uniqueName && m.uniqueName === taskUniqueName);
                    
                    // If multiple entries with same uniqueName exist (same person, different teams),
                    // disambiguate by area path
                    if (memberInfo) {
                        const sameUserEntries = memberEntries.filter(m => m.uniqueName === taskUniqueName);
                        if (sameUserEntries.length > 1) {
                            const taskAreaLower = taskAreaPath.toLowerCase();
                            const areaMatch = sameUserEntries.find(m =>
                                m.team && taskAreaLower.includes(m.team.toLowerCase())
                            );
                            if (areaMatch) memberInfo = areaMatch;
                        }
                    }
                }
                
                // Fallback: name-based matching (for older TFS data without uniqueName)
                if (!memberInfo) {
                    const nameMatches = memberEntries.filter(m =>
                        assignedToLower === m.nameLower ||
                        assignedToLower.includes(m.nameLower) || m.nameLower.includes(assignedToLower)
                    );
                    if (nameMatches.length === 0) return;
                    
                    if (nameMatches.length === 1) {
                        memberInfo = nameMatches[0];
                    } else {
                        const taskAreaLower = taskAreaPath.toLowerCase();
                        memberInfo = nameMatches.find(m =>
                            m.team && taskAreaLower.includes(m.team.toLowerCase())
                        ) || nameMatches[0];
                    }
                }
                
                // Determine match status - exact discipline comparison
                let matchStatus;
                if (!taskDiscipline || taskDiscipline.trim() === '') {
                    matchStatus = 'blank';
                } else if (memberInfo.disciplines.length === 0) {
                    matchStatus = 'blank';
                } else {
                    const taskDiscLower = taskDiscipline.toLowerCase().trim();
                    const isMatch = memberInfo.disciplines.some(md => md === taskDiscLower);
                    matchStatus = isMatch ? 'matched' : 'mismatched';
                }
                
                dvAllTaskData.push({
                    id: t.id,
                    title: t.fields['System.Title'] || '',
                    assignedTo: assignedTo,
                    memberDiscipline: memberInfo.disciplineDisplay,
                    taskDiscipline: taskDiscipline || '-',
                    matchStatus: matchStatus,
                    state: taskState,
                    area: memberInfo.team || '-',
                    project: (taskAreaPath.split('\\')[0]) || memberInfo.project
                });
            });
            
            // Update summary stats
            const uniqueMembers = new Set(dvAllTaskData.map(t => t.assignedTo)).size;
            const totalTasks = dvAllTaskData.length;
            const matchedCount = dvAllTaskData.filter(t => t.matchStatus === 'matched').length;
            const mismatchedCount = dvAllTaskData.filter(t => t.matchStatus === 'mismatched').length;
            const blankCount = dvAllTaskData.filter(t => t.matchStatus === 'blank').length;
            
            document.getElementById('dvMemberCount').textContent = uniqueMembers;
            document.getElementById('dvTotalTasks').textContent = totalTasks;
            document.getElementById('dvMatchedCount').textContent = matchedCount;
            document.getElementById('dvMismatchedCount').textContent = mismatchedCount;
            document.getElementById('dvBlankDisciplineCount').textContent = blankCount;
            
            renderDVMismatchTable();
        }
        
        function renderDVMismatchTable() {
            const thead = document.getElementById('dvMismatchHead');
            const tbody = document.getElementById('dvMismatchBody');
            const noDataEl = document.getElementById('noDVMismatchData');
            const countEl = document.getElementById('dvMismatchTaskCount');
            
            // Filter mismatched AND blank discipline tasks
            const flaggedTasks = dvAllTaskData.filter(t => t.matchStatus === 'mismatched' || t.matchStatus === 'blank');
            countEl.textContent = `(${flaggedTasks.length})`;
            
            if (flaggedTasks.length === 0) {
                thead.innerHTML = '';
                tbody.innerHTML = '';
                noDataEl.style.display = 'block';
                return;
            }
            noDataEl.style.display = 'none';
            
            // Sort
            const sorted = [...flaggedTasks].sort((a, b) => {
                let aVal = a[dvSortField];
                let bVal = b[dvSortField];
                if (typeof aVal === 'string') { aVal = aVal.toLowerCase(); bVal = (bVal || '').toLowerCase(); }
                if (aVal < bVal) return dvSortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return dvSortDir === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Header
            const thStyle = 'padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.15);color:#94a3b8;font-size:0.7rem;text-transform:uppercase;cursor:pointer;';
            const sortIcon = (f) => dvSortField === f ? (dvSortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : ' ‚áÖ';
            
            thead.innerHTML = `<tr>
                <th style="${thStyle}text-align:center;width:8%;" onclick="sortDVTable('matchStatus')">Status${sortIcon('matchStatus')}</th>
                <th style="${thStyle}text-align:left;width:5%;" onclick="sortDVTable('id')">ID${sortIcon('id')}</th>
                <th style="${thStyle}text-align:left;" onclick="sortDVTable('title')">Title${sortIcon('title')}</th>
                <th style="${thStyle}text-align:left;width:12%;" onclick="sortDVTable('assignedTo')">Assigned${sortIcon('assignedTo')}</th>
                <th style="${thStyle}text-align:center;width:10%;" onclick="sortDVTable('area')">Area${sortIcon('area')}</th>
                <th style="${thStyle}text-align:center;width:11%;" onclick="sortDVTable('memberDiscipline')">Mem Disc.${sortIcon('memberDiscipline')}</th>
                <th style="${thStyle}text-align:center;width:11%;" onclick="sortDVTable('taskDiscipline')">Task Disc.${sortIcon('taskDiscipline')}</th>
                <th style="${thStyle}text-align:center;width:7%;" onclick="sortDVTable('state')">State${sortIcon('state')}</th>
            </tr>`;
            
            // Body
            const tdStyle = 'padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.08);font-size:0.78rem;';
            tbody.innerHTML = sorted.map(t => {
                const stateColor = t.state === 'Closed' ? '#34d399' : (t.state === 'Resolved' ? '#60a5fa' : (t.state === 'Active' ? '#fbbf24' : '#94a3b8'));
                const statusIcon = t.matchStatus === 'mismatched' ? '‚ùå' : '‚ö†Ô∏è';
                const statusColor = t.matchStatus === 'mismatched' ? '#f87171' : '#fbbf24';
                const statusLabel = t.matchStatus === 'mismatched' ? 'Mismatch' : 'Blank';
                const taskDiscDisplay = t.taskDiscipline === '-' ? '<span style="color:#fbbf24;font-style:italic;">‚Äî blank ‚Äî</span>' : `<span style="color:#f87171;font-weight:600;">${t.taskDiscipline}</span>`;
                return `<tr style="transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                    <td style="${tdStyle}text-align:center;color:${statusColor};font-size:0.7rem;font-weight:600;">${statusIcon} ${statusLabel}</td>
                    <td style="${tdStyle}"><a href="${tfsUrl}/${t.project}/_workitems/edit/${t.id}" target="_blank" class="wi-link">${t.id}</a></td>
                    <td style="${tdStyle}">${t.title}</td>
                    <td style="${tdStyle}">${t.assignedTo}</td>
                    <td style="${tdStyle}text-align:center;color:#67e8f9;font-size:0.7rem;">${t.area}</td>
                    <td style="${tdStyle}text-align:center;color:#c4b5fd;">${t.memberDiscipline}</td>
                    <td style="${tdStyle}text-align:center;">${taskDiscDisplay}</td>
                    <td style="${tdStyle}text-align:center;color:${stateColor};">${t.state}</td>
                </tr>`;
            }).join('');
        }
        
        function sortDVTable(field) {
            if (dvSortField === field) {
                dvSortDir = dvSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                dvSortField = field;
                dvSortDir = (field === 'assignedTo' || field === 'title' || field === 'memberDiscipline' || field === 'taskDiscipline' || field === 'state' || field === 'area') ? 'asc' : 'desc';
            }
            renderDVMismatchTable();
        }
        
        function exportDisciplineVerificationToExcel() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            
            let csv = 'Discipline Verification Report\n';
            csv += `Sprint: ${sprintName}\n`;
            csv += `Date: ${today}\n\n`;
            
            csv += 'MISMATCHED & BLANK DISCIPLINE TASKS\n';
            csv += 'Status,ID,Title,Assigned To,Area,Member Discipline,Task Discipline,State\n';
            
            dvAllTaskData.filter(t => t.matchStatus === 'mismatched' || t.matchStatus === 'blank').forEach(t => {
                const status = t.matchStatus === 'mismatched' ? 'Mismatch' : 'Blank';
                csv += `${status},${t.id},"${t.title.replace(/"/g, '""')}","${t.assignedTo}","${t.area}","${t.memberDiscipline}","${t.taskDiscipline}","${t.state}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Discipline_Mismatch_${sprintName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function renderBlankDisciplineTasks() {
            // Find tasks with blank/empty Discipline field - all members, filtered by area
            const blankDisciplineTasks = tasks.filter(t => {
                if (!t.fields) return false;
                
                // Filter by area path to match selected areas
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return false;
                
                const discipline = t.fields['Microsoft.VSTS.Common.Discipline'];
                return discipline === undefined || discipline === null || discipline === '' || (typeof discipline === 'string' && discipline.trim() === '');
            });

            // Update count
            document.getElementById('blankDisciplineCount').textContent = blankDisciplineTasks.length;

            // Render table - simplified 3 columns
            const tbody = document.getElementById('blankDisciplineTableBody');
            const tdStyle = 'padding:6px;border-bottom:1px solid rgba(255,255,255,0.08);';
            if (tbody) {
                if (blankDisciplineTasks.length === 0) {
                    document.getElementById('noBlankDisciplineData').style.display = 'block';
                    tbody.innerHTML = '';
                } else {
                    document.getElementById('noBlankDisciplineData').style.display = 'none';
                    tbody.innerHTML = blankDisciplineTasks.map(t => {
                        const title = t.fields['System.Title'] || '';
                        const assignedTo = t.fields['System.AssignedTo']?.displayName || '-';
                        return `<tr>
                            <td style="${tdStyle}"><a href="${tfsUrl}/${project}/_workitems/edit/${t.id}" target="_blank" class="wi-link">${t.id}</a></td>
                            <td style="${tdStyle}">${title}</td>
                            <td style="${tdStyle}">${assignedTo.split(' ')[0]}</td>
                        </tr>`;
                    }).join('');
                }
            }
        }

        function renderDisciplineMismatchTasks() {
            // Get Development members for filtering
            const devMembers = (capacityData.members || []).filter(m => 
                m.discipline && m.discipline.toLowerCase().includes('development')
            );
            const devMemberNames = devMembers.map(m => m.name.toLowerCase().trim());
            
            // Matrix: Discipline -> Expected Task Execution Type prefix
            const disciplineMatrix = {
                'Development': 'AI-Dev',
                'Test': 'AI-Test'
            };

            // Create set of deliverable and non-deliverable requirement IDs
            const validReqIds = new Set();
            requirements.forEach(req => {
                if (req.category === 'deliverable' || req.category === 'nonDeliverable') {
                    validReqIds.add(req.id);
                }
            });

            // Find CLOSED tasks with mismatched Discipline and Task Execution Type
            const mismatchedTasks = tasks.filter(t => {
                if (!t.fields) return false;
                
                // Filter by area path to match selected areas
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return false;
                
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return false;

                const assignedTo = (t.fields['System.AssignedTo']?.displayName || '').toLowerCase().trim();
                const isDevMember = devMemberNames.some(name => 
                    assignedTo.includes(name) || name.includes(assignedTo)
                );
                if (!isDevMember) return false;

                const state = t.fields['System.State'] || '';
                if (state !== 'Closed') return false;

                const discipline = t.fields['Microsoft.VSTS.Common.Discipline'];
                if (discipline !== 'Development') return false;

                const taskExecutionType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                if (!discipline || !disciplineMatrix[discipline]) return false;

                const expectedPrefix = disciplineMatrix[discipline];
                return !taskExecutionType.startsWith(expectedPrefix);
            });

            // Update count
            

            // Store globally for sorting
            mismatchAllData = mismatchedTasks;
            renderMismatchTableRows();
        }
        
        function renderMismatchTableRows() {
            const thead = document.getElementById('mismatchTableHead');
            const tbody = document.getElementById('mismatchTableBody');
            const tdStyle = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);';
            
            // Sortable header
            const thStyle = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.15);cursor:pointer;';
            const sortIcon = (field) => mismatchSortField === field ? (mismatchSortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : ' ‚áÖ';
            
            if (thead) {
                thead.innerHTML = `<tr>
                    <th style="${thStyle}text-align:left;width:5%;" onclick="sortMismatchTable('id')">ID${sortIcon('id')}</th>
                    <th style="${thStyle}text-align:left;" onclick="sortMismatchTable('title')">Title${sortIcon('title')}</th>
                    <th style="${thStyle}text-align:left;width:8%;" onclick="sortMismatchTable('state')">State${sortIcon('state')}</th>
                    <th style="${thStyle}text-align:left;width:14%;" onclick="sortMismatchTable('assigned')">Assigned${sortIcon('assigned')}</th>
                    <th style="${thStyle}text-align:center;width:10%;" onclick="sortMismatchTable('discipline')">Discipline${sortIcon('discipline')}</th>
                    <th style="${thStyle}text-align:center;width:15%;" onclick="sortMismatchTable('execType')">Task Exec Type${sortIcon('execType')}</th>
                </tr>`;
            }

            if (tbody) {
                if (mismatchAllData.length === 0) {
                    document.getElementById('noMismatchData').style.display = 'block';
                    tbody.innerHTML = '';
                } else {
                    document.getElementById('noMismatchData').style.display = 'none';
                    
                    const sorted = [...mismatchAllData].sort((a, b) => {
                        let aVal, bVal;
                        switch(mismatchSortField) {
                            case 'id': aVal = a.id; bVal = b.id; break;
                            case 'title': aVal = (a.fields['System.Title'] || '').toLowerCase(); bVal = (b.fields['System.Title'] || '').toLowerCase(); break;
                            case 'state': aVal = (a.fields['System.State'] || '').toLowerCase(); bVal = (b.fields['System.State'] || '').toLowerCase(); break;
                            case 'assigned': aVal = (a.fields['System.AssignedTo']?.displayName || '').toLowerCase(); bVal = (b.fields['System.AssignedTo']?.displayName || '').toLowerCase(); break;
                            case 'areaPath': aVal = (a.fields['System.AreaPath'] || '').toLowerCase(); bVal = (b.fields['System.AreaPath'] || '').toLowerCase(); break;
                            case 'discipline': aVal = (a.fields['Microsoft.VSTS.Common.Discipline'] || '').toLowerCase(); bVal = (b.fields['Microsoft.VSTS.Common.Discipline'] || '').toLowerCase(); break;
                            case 'execType': aVal = (a.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '').toLowerCase(); bVal = (b.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '').toLowerCase(); break;
                            default: aVal = a.id; bVal = b.id;
                        }
                        if (aVal < bVal) return mismatchSortDir === 'asc' ? -1 : 1;
                        if (aVal > bVal) return mismatchSortDir === 'asc' ? 1 : -1;
                        return 0;
                    });
                    
                    tbody.innerHTML = sorted.map(t => {
                        const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '-';
                        return `<tr>
                            <td style="${tdStyle}"><a href="${tfsUrl}/${project}/_workitems/edit/${t.id}" target="_blank" class="wi-link">${t.id}</a></td>
                            <td style="${tdStyle}">${t.fields['System.Title'] || ''}</td>
                            <td style="${tdStyle}">${t.fields['System.State'] || ''}</td>
                            <td style="${tdStyle}">${t.fields['System.AssignedTo']?.displayName || '-'}</td>
                            <td style="${tdStyle}text-align:center;">${t.fields['Microsoft.VSTS.Common.Discipline'] || '-'}</td>
                            <td style="${tdStyle}text-align:center;">${execType}</td>
                        </tr>`;
                    }).join('');
                }
            }
        }
        
        function sortMismatchTable(field) {
            if (mismatchSortField === field) {
                mismatchSortDir = mismatchSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                mismatchSortField = field;
                mismatchSortDir = 'asc';
            }
            renderMismatchTableRows();
        }

        function renderTagMissingTasks() {
            // Get Development members for filtering
            const devMembers = (capacityData.members || []).filter(m => 
                m.discipline && m.discipline.toLowerCase().includes('development')
            );
            const devMemberNames = devMembers.map(m => m.name.toLowerCase().trim());
            
            // AI Execution Types for calculating AI Efforts
            const aiExecTypes = ['AI-Dev-Analysis', 'AI-Dev-Code Review', 'AI-Dev-Development', 'AI-Dev-Documentation'];
            
            // Required tags - task must have at least one of these (exact match)
            const requiredTags = ['product', 'alm', 'training', 'support', 'bug/maintenance'];

            // Find tasks that don't have any of the required tags - only for Development members
            const tagMissingTasks = tasks.filter(t => {
                if (!t.fields) return false;
                
                // Check if assigned to Development member - use full name matching
                const assignedTo = (t.fields['System.AssignedTo']?.displayName || '').toLowerCase().trim();
                const isDevMember = devMemberNames.some(name => 
                    assignedTo.includes(name) || name.includes(assignedTo)
                );
                if (!isDevMember) return false;
                
                const tagsString = t.fields['System.Tags'] || '';
                // Split tags by semicolon and trim each tag for exact matching
                const tagList = tagsString.split(';').map(tag => tag.trim().toLowerCase());
                // Check if task has at least one of the required tags (exact match)
                const hasRequiredTag = requiredTags.some(reqTag => tagList.includes(reqTag));
                return !hasRequiredTag;
            });

            // Update count
            document.getElementById('tagMissingCount').textContent = tagMissingTasks.length;

            // Render table - using new table IDs for separate dashboard
            const tbody = document.getElementById('tagMissingTableBody2');
            const tdStyle = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.08);';
            if (tbody) {
                if (tagMissingTasks.length === 0) {
                    document.getElementById('noTagMissingData2').style.display = 'block';
                    tbody.innerHTML = '';
                } else {
                    document.getElementById('noTagMissingData2').style.display = 'none';
                    tbody.innerHTML = tagMissingTasks.map(t => {
                        return `<tr>
                            <td style="${tdStyle}"><a href="${tfsUrl}/${project}/_workitems/edit/${t.id}" target="_blank" class="wi-link">${t.id}</a></td>
                            <td style="${tdStyle}">${t.fields['System.Title'] || ''}</td>
                            <td style="${tdStyle}">${t.fields['System.AssignedTo']?.displayName || '-'}</td>
                        </tr>`;
                    }).join('');
                }
            }
        }

        let reqListLoaded = false;
        function toggleRequirementsList() {
            const btn = document.getElementById('loadReqListBtn');
            const content = document.getElementById('reqListContent');
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'üîº Hide';
                btn.style.background = 'rgba(239,68,68,0.3)';
                btn.style.borderColor = 'rgba(239,68,68,0.5)';
                
                if (!reqListLoaded) {
                    renderTable();
                    reqListLoaded = true;
                }
            } else {
                content.style.display = 'none';
                btn.textContent = 'üìã Show';
                btn.style.background = '';
                btn.style.borderColor = '';
            }
        }

        let lastSprintOpenItems = [];
        async function loadLastSprintData() {
            // Auto-load last sprint open items
            await loadLastSprintOpenItems();
        }

        async function loadLastSprintOpenItems() {
            // Clear existing data first
            const tbody = document.getElementById('lastSprintTableBody');
            const noDataDiv = document.getElementById('noLastSprintData');
            tbody.innerHTML = '';
            noDataDiv.style.display = 'none';
            
            // Get current areas and iteration path from selected checkboxes
            if (selectedAreaPaths.length === 0) {
                noDataDiv.style.display = 'block';
                noDataDiv.textContent = 'No area selected';
                document.getElementById('lastSprintOpenCount').textContent = '0';
                return;
            }
            
            if (selectedIterationPaths.length === 0) {
                noDataDiv.style.display = 'block';
                noDataDiv.textContent = 'No sprint selected';
                document.getElementById('lastSprintOpenCount').textContent = '0';
                return;
            }
            const currentIterPath = selectedIterationPaths[0].path;
            
            // Build area filter for multi-select
            // Check if exact match is enabled (excludes child areas)
            const useExactAreaMatch = document.getElementById('exactAreaMatch')?.checked || false;
            const areaOperator = useExactAreaMatch ? '=' : 'UNDER';
            const areaFilterClauses = selectedAreaPaths.map(a => `[System.AreaPath] ${areaOperator} '${a.path}'`);
            const areaFilter = areaFilterClauses.length > 1 
                ? `(${areaFilterClauses.join(' OR ')})` 
                : areaFilterClauses[0];
            
            // Find the previous iteration
            const currentIterIdx = iterations.findIndex(i => i.path === currentIterPath);
            if (currentIterIdx <= 0) {
                noDataDiv.style.display = 'block';
                noDataDiv.textContent = 'No previous sprint found';
                document.getElementById('lastSprintOpenCount').textContent = '0';
                return;
            }
            
            const prevIter = iterations[currentIterIdx - 1];
            const prevIterPath = prevIter.path;
            
            try {
                // Query for NOT Closed Requirements/CRs from previous sprint
                const query = `SELECT [System.Id] FROM WorkItems WHERE [System.WorkItemType] IN ('Requirement', 'Change Request') AND ${areaFilter} AND [System.IterationPath] UNDER '${prevIterPath}' AND [System.State] <> 'Closed'`;
                
                const resp = await apiFetch(`${tfsUrl}/${project}/_apis/wit/wiql?api-version=5.0`, {
                    method: 'POST', body: JSON.stringify({ query })
                });
                const data = await resp.json();
                const ids = (data.workItems || []).map(w => w.id);
                
                document.getElementById('lastSprintOpenCount').textContent = ids.length;
                
                if (ids.length === 0) {
                    noDataDiv.textContent = 'No open items ‚úì';
                    noDataDiv.style.display = 'block';
                    lastSprintOpenItems = [];
                    return;
                }
                
                // Fetch work item details
                const batchSize = 200;
                const items = [];
                for (let i = 0; i < ids.length; i += batchSize) {
                    const batchIds = ids.slice(i, i + batchSize).join(',');
                    const itemsResp = await apiFetch(`${tfsUrl}/${project}/_apis/wit/workitems?ids=${batchIds}&fields=System.Id,System.Title,System.State,System.AssignedTo,Microsoft.VSTS.Scheduling.RemainingWork&api-version=5.0`);
                    const itemsData = await itemsResp.json();
                    items.push(...(itemsData.value || []));
                }
                
                lastSprintOpenItems = items;
                
                // Render the table
                tbody.innerHTML = items.map(item => {
                    const f = item.fields;
                    return `<tr>
                        <td><a href="${tfsUrl}/${project}/_workitems/edit/${item.id}" target="_blank" class="wi-link">${item.id}</a></td>
                        <td>${f['System.Title'] || ''}</td>
                        <td>${f['System.State'] || ''}</td>
                    </tr>`;
                }).join('');
                
                noDataDiv.style.display = items.length === 0 ? 'block' : 'none';
            } catch (err) {
                console.error('Error loading last sprint data:', err);
                document.getElementById('noLastSprintData').style.display = 'block';
                document.getElementById('noLastSprintData').textContent = 'Error loading data';
            }
        }

        function renderTable() {
            let filtered = requirements;
            if (currentFilter === 'deliverable') filtered = requirements.filter(r => r.category === 'deliverable');
            else if (currentFilter === 'nonDeliverable') filtered = requirements.filter(r => r.category === 'nonDeliverable');
            else if (currentFilter === 'deliverablesAdhoc') filtered = requirements.filter(r => r.isDeliverablesAdhoc);
            else if (currentFilter === 'deliverablesOnHold') filtered = requirements.filter(r => r.isDeliverablesOnHold);
            else if (currentFilter === 'adhocSupport') filtered = requirements.filter(r => r.isAdhocSupport);
            else if (currentFilter === 'affectOthers') filtered = requirements.filter(r => r.isAffectOthers);
            else if (currentFilter === 'affectedArea') filtered = requirements.filter(r => r.isAffectedArea);
            else if (currentFilter === 'urnIn') filtered = requirements.filter(r => r.urnTag === 'urnIn');
            else if (currentFilter === 'urnCf') filtered = requirements.filter(r => r.urnTag === 'urnCf');
            else if (currentFilter === 'urnMissing') filtered = requirements.filter(r => r.urnTag === 'urnMissing');
            else if (currentFilter === 'noWeeklyTag') filtered = requirements.filter(r => r.category === 'deliverable' && !r.hasWeeklyTag);

            // Sort the filtered data
            const sortedData = [...filtered].sort((a, b) => {
                let aVal, bVal;
                switch (reqListSortField) {
                    case 'id': aVal = a.id; bVal = b.id; break;
                    case 'title': aVal = (a.fields['System.Title'] || '').toLowerCase(); bVal = (b.fields['System.Title'] || '').toLowerCase(); break;
                    case 'state': aVal = (a.fields['System.State'] || '').toLowerCase(); bVal = (b.fields['System.State'] || '').toLowerCase(); break;
                    case 'size': aVal = a.size || 0; bVal = b.size || 0; break;
                    case 'assigned': aVal = (a.fields['System.AssignedTo']?.displayName || '').toLowerCase(); bVal = (b.fields['System.AssignedTo']?.displayName || '').toLowerCase(); break;
                    case 'category': aVal = a.category || ''; bVal = b.category || ''; break;
                    case 'urn': aVal = a.urnTag || ''; bVal = b.urnTag || ''; break;
                    default: aVal = a.id; bVal = b.id;
                }
                if (aVal < bVal) return reqListSortDir === 'asc' ? -1 : 1;
                if (aVal > bVal) return reqListSortDir === 'asc' ? 1 : -1;
                return 0;
            });

            // Render header with sort icons
            const thStyle = 'padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.15);cursor:pointer;';
            const sortIcon = (field) => reqListSortField === field ? (reqListSortDir === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : '';
            document.getElementById('reqListTableHead').innerHTML = `<tr>
                <th style="${thStyle}" onclick="sortReqList('id')">ID${sortIcon('id')}</th>
                <th style="${thStyle}" onclick="sortReqList('title')">Title${sortIcon('title')}</th>
                <th style="${thStyle}" onclick="sortReqList('state')">State${sortIcon('state')}</th>
                <th style="${thStyle}" onclick="sortReqList('size')">Size${sortIcon('size')}</th>
                <th style="${thStyle}" onclick="sortReqList('assigned')">Assigned${sortIcon('assigned')}</th>
                <th style="${thStyle}" onclick="sortReqList('category')">Cat${sortIcon('category')}</th>
                <th style="${thStyle}" onclick="sortReqList('urn')">URN${sortIcon('urn')}</th>
            </tr>`;

            const tbody = document.getElementById('reqTable');
            document.getElementById('noData').style.display = sortedData.length === 0 ? 'block' : 'none';
            tbody.innerHTML = sortedData.map(req => {
                const f = req.fields;
                const catLabel = req.category === 'deliverable' ? 'Deliverable' : req.category === 'nonDeliverable' ? 'Non-Deliverable' : '-';
                const catClass = req.category === 'deliverable' ? 'deliverable' : req.category === 'nonDeliverable' ? 'non-deliverable' : '';
                const urnLabel = req.urnTag === 'urnIn' ? 'URN-IN' : req.urnTag === 'urnCf' ? 'URN-CF' : '-';
                const urnClass = req.urnTag === 'urnIn' ? 'urn-in' : req.urnTag === 'urnCf' ? 'urn-cf' : '';
                return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${req.id}" target="_blank" class="wi-link">${req.id}</a></td><td>${f['System.Title'] || ''}</td><td>${f['System.State'] || ''}</td><td style="text-align:center;">${req.size}</td><td  title="${f['System.AssignedTo']?.displayName || '-'}">${f['System.AssignedTo']?.displayName || '-'}</td><td>${catClass ? `<span class="badge badge-${catClass}">${catLabel}</span>` : '-'}</td><td>${urnClass ? `<span class="badge badge-${urnClass}">${urnLabel}</span>` : '-'}</td></tr>`;
            }).join('');
        }

        function sortReqList(field) {
            if (reqListSortField === field) {
                reqListSortDir = reqListSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                reqListSortField = field;
                reqListSortDir = 'asc';
            }
            renderTable();
        }

        function filterTable(cat, btn) {
            currentFilter = cat;
            document.querySelectorAll('.table-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            renderTable();
        }

        // Export AI Adoption Data to Excel
        function exportAIAdoptionToExcel() {
            // Get Development members from capacity data
            const devMembers = (capacityData.members || []).filter(m => 
                m.discipline && m.discipline.toLowerCase().includes('development')
            );
            
            // Create set of deliverable and non-deliverable requirement IDs
            const validReqIds = new Set();
            requirements.forEach(req => {
                if (req.category === 'deliverable' || req.category === 'nonDeliverable') {
                    validReqIds.add(req.id);
                }
            });
            
            // Filter tasks based on criteria
            const completedStates = ['resolved', 'closed'];
            
            const validTasks = tasks.filter(t => {
                const parentReqId = taskParentMap[t.id];
                if (!parentReqId || !validReqIds.has(parentReqId)) return false;
                
                const state = (t.fields['System.State'] || '').toLowerCase();
                const reason = (t.fields['System.Reason'] || '').toLowerCase();
                const origEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                
                // Filter by area path to match selected areas (uses global helper)
                const taskAreaPath = t.fields['System.AreaPath'] || '';
                if (!isTaskAreaMatchingSelection(taskAreaPath)) return false;
                
                return completedStates.includes(state) && 
                       reason !== 'rejected' && 
                       origEst > 0;
            });
            
            // Build member data map
            const memberDataMap = {};
            devMembers.forEach(m => {
                memberDataMap[m.name] = {
                    name: m.name,
                    project: m.project || '-',
                    team: m.team || '-',
                    taskCount: 0,
                    claudeAiCount: 0,
                    copilotCount: 0,
                    manualCount: 0,
                    aiOrigEst: 0,
                    aiCompleted: 0,
                    manualOrigEst: 0,
                    manualCompleted: 0,
                    manualAiIneffCount: 0,
                    manualAiIneffOrigEst: 0,
                    manualAiIneffCompleted: 0
                };
            });
            
            // Process tasks and aggregate by member
            validTasks.forEach(t => {
                const assignedTo = t.fields['System.AssignedTo']?.displayName || '';
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                const origEst = t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0;
                const completed = t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0;
                const tags = (t.fields['System.Tags'] || '').toLowerCase();
                // Check for Claude AI tag with flexible matching (Claude AI, ClaudeAI, Claude-AI, etc.)
                const hasClaudeAiTag = tags.includes('claude ai') || tags.includes('claudeai') || tags.includes('claude-ai') || /claude[\s\-_]*ai/i.test(tags);
                
                // Check if execution type starts with AI-Dev or AI-Test-Auto- or is Manual
                const isAiType = execType.startsWith('AI-Dev') || execType.startsWith('AI-Test-Auto-');
                const isManualType = execType === 'Manual';
                
                if (!isAiType && !isManualType) return;
                
                // Match to member - use full name matching (not just first name)
                const assignedToLower = assignedTo.toLowerCase().trim();
                const memberKey = Object.keys(memberDataMap).find(name => {
                    const nameLower = name.toLowerCase().trim();
                    // Full name matching - check if one contains the other
                    return assignedToLower.includes(nameLower) || nameLower.includes(assignedToLower);
                });
                
                if (memberKey) {
                    const memberData = memberDataMap[memberKey];
                    memberData.taskCount++;
                    
                    // Count by execution type
                    if (isAiType) {
                        // AI execution type - check for Claude AI tag
                        if (hasClaudeAiTag) {
                            memberData.claudeAiCount++;
                        } else {
                            memberData.copilotCount++;
                        }
                        memberData.aiOrigEst += origEst;
                        memberData.aiCompleted += completed;
                    } else if (isManualType) {
                        // Manual execution type
                        memberData.manualCount++;
                        memberData.manualOrigEst += origEst;
                        memberData.manualCompleted += completed;
                    }
                }
            });
            
            // Convert to array and filter members with tasks
            const memberResults = Object.values(memberDataMap).filter(m => m.taskCount > 0);
            
            // Calculate grand totals
            let grandAiOrigEst = 0, grandAiCompleted = 0;
            let grandManualOrigEst = 0, grandManualCompleted = 0;
            let grandManualAiIneffOrigEst = 0, grandManualAiIneffCompleted = 0;
            
            memberResults.forEach(m => {
                grandAiOrigEst += m.aiOrigEst;
                grandAiCompleted += m.aiCompleted;
                grandManualOrigEst += m.manualOrigEst;
                grandManualCompleted += m.manualCompleted;
                grandManualAiIneffOrigEst += m.manualAiIneffOrigEst;
                grandManualAiIneffCompleted += m.manualAiIneffCompleted;
            });
            
            const totalTasks = memberResults.reduce((sum, m) => sum + m.taskCount, 0);
            const totalClaudeAi = memberResults.reduce((sum, m) => sum + m.claudeAiCount, 0);
            const totalCopilot = memberResults.reduce((sum, m) => sum + m.copilotCount, 0);
            const totalManual = memberResults.reduce((sum, m) => sum + m.manualCount, 0);
            const totalManualAiIneff = memberResults.reduce((sum, m) => sum + m.manualAiIneffCount, 0);
            
            const manualEfficiency = grandManualOrigEst > 0 ? Math.round(((grandManualOrigEst - grandManualCompleted) / grandManualOrigEst) * 100) : 0;
            const aiEfficiency = grandAiOrigEst > 0 ? Math.round(((grandAiOrigEst - grandAiCompleted) / grandAiOrigEst) * 100) : 0;
            const grandTotalOrig = (grandAiOrigEst || 0) + (grandManualAiIneffOrigEst || 0);
            const grandAiAdoption = (grandManualAiIneffOrigEst || 0) <= 0 ? 100 : (grandTotalOrig > 0 ? Math.round(((grandAiOrigEst || 0) / grandTotalOrig) * 100) : 0);
            const grandHourSaved = grandAiOrigEst - grandAiCompleted;
            
            // Build CSV-style data for Excel
            const sprintName = document.getElementById('iterationPath')?.textContent || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            
            // Build HTML table for Excel - Standard format
            let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
<head>
<meta charset="UTF-8">
<!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>AI Adoption Report</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->
<style>
    table { border-collapse: collapse; font-family: Calibri, Arial, sans-serif; font-size: 11pt; }
    th { background-color: #4472C4; color: white; font-weight: bold; padding: 8px 12px; border: 1px solid #2F5496; text-align: center; }
    td { padding: 6px 12px; border: 1px solid #B4C6E7; }
    tr:nth-child(even) td { background-color: #D6DCE5; }
    tr:nth-child(odd) td { background-color: #FFFFFF; }
    .left { text-align: left; }
    .center { text-align: center; }
    .number { text-align: right; }
    .footer td { background-color: #4472C4 !important; color: white; font-weight: bold; }
</style>
</head>
<body>
<table>
    <tr>
        <th>Member</th>
        <th>Project</th>
        <th>Area</th>
        <th>Tasks</th>
        <th>Claude AI</th>
        <th>Copilot</th>
        <th>AI-Ineff</th>
        <th>Manual</th>
        <th>AI Orig (h)</th>
        <th>AI Comp (h)</th>
        <th>AI-Ineff Orig (h)</th>
        <th>AI-Ineff Comp (h)</th>
        <th>Manual Orig (h)</th>
        <th>Manual Comp (h)</th>
        <th>AI Adoption %</th>
        <th>Manual Eff %</th>
        <th>AI Eff %</th>
        <th>Hour Saved (h)</th>
    </tr>`;
            
            // Data rows
            memberResults.forEach(m => {
                const mManualEff = m.manualOrigEst > 0 ? Math.round(((m.manualOrigEst - m.manualCompleted) / m.manualOrigEst) * 100) : 0;
                const mAiEff = m.aiOrigEst > 0 ? Math.round(((m.aiOrigEst - m.aiCompleted) / m.aiOrigEst) * 100) : 0;
                const mTotalOrig = m.aiOrigEst + m.manualAiIneffOrigEst;
                const mAiAdoption = m.manualAiIneffOrigEst <= 0 ? 100 : (mTotalOrig > 0 ? Math.round((m.aiOrigEst / mTotalOrig) * 100) : 0);
                const mHourSaved = m.aiOrigEst - m.aiCompleted;
                
                html += `
    <tr>
        <td class="left">${m.name}</td>
        <td class="left">${m.project}</td>
        <td class="left">${m.team}</td>
        <td class="center">${m.taskCount}</td>
        <td class="center">${m.claudeAiCount}</td>
        <td class="center">${m.copilotCount}</td>
        <td class="center">${m.manualAiIneffCount}</td>
        <td class="center">${m.manualCount}</td>
        <td class="number">${m.aiOrigEst.toFixed(2)}</td>
        <td class="number">${m.aiCompleted.toFixed(2)}</td>
        <td class="number">${m.manualAiIneffOrigEst.toFixed(2)}</td>
        <td class="number">${m.manualAiIneffCompleted.toFixed(2)}</td>
        <td class="number">${m.manualOrigEst.toFixed(2)}</td>
        <td class="number">${m.manualCompleted.toFixed(2)}</td>
        <td class="center">${mAiAdoption}%</td>
        <td class="center">${mManualEff}%</td>
        <td class="center">${mAiEff}%</td>
        <td class="number">${mHourSaved.toFixed(2)}</td>
    </tr>`;
            });
            
            // Grand Total row for member data table
            html += `
    <tr class="footer">
        <td class="left">GRAND TOTAL</td>
        <td></td>
        <td></td>
        <td class="center">${totalTasks}</td>
        <td class="center">${totalClaudeAi}</td>
        <td class="center">${totalCopilot}</td>
        <td class="center">${totalManualAiIneff}</td>
        <td class="center">${totalManual}</td>
        <td class="number">${grandAiOrigEst.toFixed(2)}</td>
        <td class="number">${grandAiCompleted.toFixed(2)}</td>
        <td class="number">${grandManualAiIneffOrigEst.toFixed(2)}</td>
        <td class="number">${grandManualAiIneffCompleted.toFixed(2)}</td>
        <td class="number">${grandManualOrigEst.toFixed(2)}</td>
        <td class="number">${grandManualCompleted.toFixed(2)}</td>
        <td class="center">${grandAiAdoption}%</td>
        <td class="center">${manualEfficiency}%</td>
        <td class="center">${aiEfficiency}%</td>
        <td class="number">${grandHourSaved.toFixed(2)}</td>
    </tr>
</table>

<br/><br/>

<!-- Area-wise Summary Section -->
<table>
    <tr>
        <th colspan="17" style="background-color: #17A2B8; text-align: left;">üè∑Ô∏è AREA-WISE SUMMARY</th>
    </tr>
    <tr>
        <th>Area</th>
        <th>Project</th>
        <th>Tasks</th>
        <th>Claude AI</th>
        <th>Copilot</th>
        <th>AI-Ineff</th>
        <th>Manual</th>
        <th>AI Orig (h)</th>
        <th>AI Comp (h)</th>
        <th>AI-Ineff Orig (h)</th>
        <th>AI-Ineff Comp (h)</th>
        <th>Manual Orig (h)</th>
        <th>Manual Comp (h)</th>
        <th>AI Adoption %</th>
        <th>Manual Eff %</th>
        <th>AI Eff %</th>
        <th>Hour Saved (h)</th>
    </tr>`;
            
            // Group by area for subtotals
            const areaTotals = {};
            memberResults.forEach(m => {
                const area = m.team || '-';
                if (!areaTotals[area]) {
                    areaTotals[area] = {
                        area: area,
                        project: m.project || '-',
                        taskCount: 0,
                        claudeAiCount: 0,
                        copilotCount: 0,
                        manualAiIneffCount: 0,
                        manualCount: 0,
                        aiOrigEst: 0,
                        aiCompleted: 0,
                        manualAiIneffOrigEst: 0,
                        manualAiIneffCompleted: 0,
                        manualOrigEst: 0,
                        manualCompleted: 0
                    };
                }
                areaTotals[area].taskCount += m.taskCount;
                areaTotals[area].claudeAiCount += m.claudeAiCount;
                areaTotals[area].copilotCount += m.copilotCount;
                areaTotals[area].manualAiIneffCount += m.manualAiIneffCount;
                areaTotals[area].manualCount += m.manualCount;
                areaTotals[area].aiOrigEst += m.aiOrigEst;
                areaTotals[area].aiCompleted += m.aiCompleted;
                areaTotals[area].manualAiIneffOrigEst += m.manualAiIneffOrigEst;
                areaTotals[area].manualAiIneffCompleted += m.manualAiIneffCompleted;
                areaTotals[area].manualOrigEst += m.manualOrigEst;
                areaTotals[area].manualCompleted += m.manualCompleted;
            });
            
            // Add area subtotal rows
            Object.values(areaTotals).forEach(a => {
                const aTotalOrig = a.aiOrigEst + a.manualAiIneffOrigEst;
                const aAiAdoption = a.manualAiIneffOrigEst <= 0 ? 100 : (aTotalOrig > 0 ? Math.round((a.aiOrigEst / aTotalOrig) * 100) : 0);
                const aManualEff = a.manualOrigEst > 0 ? Math.round(((a.manualOrigEst - a.manualCompleted) / a.manualOrigEst) * 100) : 0;
                const aAiEff = a.aiOrigEst > 0 ? Math.round(((a.aiOrigEst - a.aiCompleted) / a.aiOrigEst) * 100) : 0;
                const aHourSaved = a.aiOrigEst - a.aiCompleted;
                
                html += `
    <tr style="background-color: #D6EAF8;">
        <td class="left" style="font-weight: bold; background-color: #D6EAF8;">üè∑Ô∏è ${a.area}</td>
        <td class="left" style="background-color: #D6EAF8; font-size: 9pt;">${a.project}</td>
        <td class="center" style="font-weight: bold; background-color: #D6EAF8;">${a.taskCount}</td>
        <td class="center" style="background-color: #D6EAF8;">${a.claudeAiCount}</td>
        <td class="center" style="background-color: #D6EAF8;">${a.copilotCount}</td>
        <td class="center" style="background-color: #D6EAF8;">${a.manualAiIneffCount}</td>
        <td class="center" style="background-color: #D6EAF8;">${a.manualCount}</td>
        <td class="number" style="background-color: #D6EAF8;">${a.aiOrigEst.toFixed(2)}</td>
        <td class="number" style="background-color: #D6EAF8;">${a.aiCompleted.toFixed(2)}</td>
        <td class="number" style="background-color: #D6EAF8;">${a.manualAiIneffOrigEst.toFixed(2)}</td>
        <td class="number" style="background-color: #D6EAF8;">${a.manualAiIneffCompleted.toFixed(2)}</td>
        <td class="number" style="background-color: #D6EAF8;">${a.manualOrigEst.toFixed(2)}</td>
        <td class="number" style="background-color: #D6EAF8;">${a.manualCompleted.toFixed(2)}</td>
        <td class="center" style="font-weight: bold; background-color: #D6EAF8;">${aAiAdoption}%</td>
        <td class="center" style="background-color: #D6EAF8;">${aManualEff}%</td>
        <td class="center" style="background-color: #D6EAF8;">${aAiEff}%</td>
        <td class="number" style="font-weight: bold; background-color: #D6EAF8;">${aHourSaved.toFixed(2)}</td>
    </tr>`;
            });
            
            html += `
</table>

<br/><br/>

<!-- Project-wise Summary Section -->
<table>
    <tr>
        <th colspan="16" style="background-color: #6F42C1; text-align: left;">üìÅ PROJECT-WISE SUMMARY</th>
    </tr>
    <tr>
        <th>Project</th>
        <th>Tasks</th>
        <th>Claude AI</th>
        <th>Copilot</th>
        <th>AI-Ineff</th>
        <th>Manual</th>
        <th>AI Orig (h)</th>
        <th>AI Comp (h)</th>
        <th>AI-Ineff Orig (h)</th>
        <th>AI-Ineff Comp (h)</th>
        <th>Manual Orig (h)</th>
        <th>Manual Comp (h)</th>
        <th>AI Adoption %</th>
        <th>Manual Eff %</th>
        <th>AI Eff %</th>
        <th>Hour Saved (h)</th>
    </tr>`;
            
            // Group by project for subtotals
            const projectTotals = {};
            memberResults.forEach(m => {
                const proj = m.project || '-';
                if (!projectTotals[proj]) {
                    projectTotals[proj] = {
                        project: proj,
                        taskCount: 0,
                        claudeAiCount: 0,
                        copilotCount: 0,
                        manualAiIneffCount: 0,
                        manualCount: 0,
                        aiOrigEst: 0,
                        aiCompleted: 0,
                        manualAiIneffOrigEst: 0,
                        manualAiIneffCompleted: 0,
                        manualOrigEst: 0,
                        manualCompleted: 0
                    };
                }
                projectTotals[proj].taskCount += m.taskCount;
                projectTotals[proj].claudeAiCount += m.claudeAiCount;
                projectTotals[proj].copilotCount += m.copilotCount;
                projectTotals[proj].manualAiIneffCount += m.manualAiIneffCount;
                projectTotals[proj].manualCount += m.manualCount;
                projectTotals[proj].aiOrigEst += m.aiOrigEst;
                projectTotals[proj].aiCompleted += m.aiCompleted;
                projectTotals[proj].manualAiIneffOrigEst += m.manualAiIneffOrigEst;
                projectTotals[proj].manualAiIneffCompleted += m.manualAiIneffCompleted;
                projectTotals[proj].manualOrigEst += m.manualOrigEst;
                projectTotals[proj].manualCompleted += m.manualCompleted;
            });
            
            // Add project subtotal rows
            Object.values(projectTotals).forEach(p => {
                const pTotalOrig = p.aiOrigEst + p.manualAiIneffOrigEst;
                const pAiAdoption = p.manualAiIneffOrigEst <= 0 ? 100 : (pTotalOrig > 0 ? Math.round((p.aiOrigEst / pTotalOrig) * 100) : 0);
                const pManualEff = p.manualOrigEst > 0 ? Math.round(((p.manualOrigEst - p.manualCompleted) / p.manualOrigEst) * 100) : 0;
                const pAiEff = p.aiOrigEst > 0 ? Math.round(((p.aiOrigEst - p.aiCompleted) / p.aiOrigEst) * 100) : 0;
                const pHourSaved = p.aiOrigEst - p.aiCompleted;
                
                html += `
    <tr style="background-color: #E2EFDA;">
        <td class="left" style="font-weight: bold; background-color: #E2EFDA;">üìÅ ${p.project}</td>
        <td class="center" style="font-weight: bold; background-color: #E2EFDA;">${p.taskCount}</td>
        <td class="center" style="background-color: #E2EFDA;">${p.claudeAiCount}</td>
        <td class="center" style="background-color: #E2EFDA;">${p.copilotCount}</td>
        <td class="center" style="background-color: #E2EFDA;">${p.manualAiIneffCount}</td>
        <td class="center" style="background-color: #E2EFDA;">${p.manualCount}</td>
        <td class="number" style="background-color: #E2EFDA;">${p.aiOrigEst.toFixed(2)}</td>
        <td class="number" style="background-color: #E2EFDA;">${p.aiCompleted.toFixed(2)}</td>
        <td class="number" style="background-color: #E2EFDA;">${p.manualAiIneffOrigEst.toFixed(2)}</td>
        <td class="number" style="background-color: #E2EFDA;">${p.manualAiIneffCompleted.toFixed(2)}</td>
        <td class="number" style="background-color: #E2EFDA;">${p.manualOrigEst.toFixed(2)}</td>
        <td class="number" style="background-color: #E2EFDA;">${p.manualCompleted.toFixed(2)}</td>
        <td class="center" style="font-weight: bold; background-color: #E2EFDA;">${pAiAdoption}%</td>
        <td class="center" style="background-color: #E2EFDA;">${pManualEff}%</td>
        <td class="center" style="background-color: #E2EFDA;">${pAiEff}%</td>
        <td class="number" style="font-weight: bold; background-color: #E2EFDA;">${pHourSaved.toFixed(2)}</td>
    </tr>`;
            });
            
            html += `
</table>
</body>
</html>`;
            
            // Create download
            const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `AI_Adoption_Report_${sprintName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.xls`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Export AI Adoption Data to PDF
        function exportAIAdoptionToPDF() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            const areaNames = selectedAreaPaths.map(p => p.path.split('\\').pop()).join(', ');
            
            // Get all the summary data
            const devMemberCount = document.getElementById('aiDevMemberCount').textContent;
            const totalTasks = document.getElementById('aiTotalTasks').textContent;
            const totalOrigEst = document.getElementById('aiTotalOrigEst').textContent;
            const totalCompleted = document.getElementById('aiTotalCompleted').textContent;
            const manualEff = document.getElementById('aiManualEfficiency').textContent;
            const aiEff = document.getElementById('aiAIEfficiency').textContent;
            
            // Clone and get table HTML with inline styles preserved
            const memberTable = document.getElementById('aiAdoptionTable');
            const areaTable = document.getElementById('areaSummaryTable');
            const projectTable = document.getElementById('projectSummaryTable');
            
            // Build PDF HTML content with dark theme styling matching UI
            let pdfContent = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI Adoption Report - ${sprintName}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        @media print {
            @page { size: landscape; margin: 0; }
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0; padding: 0.5in 0.4in; }
            thead { display: table-header-group; }
            tr { page-break-inside: avoid; }
            table { page-break-inside: auto; }
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            font-size: 9pt; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0; 
            padding: 20px;
            min-height: 100vh;
        }
        .header { 
            background: linear-gradient(135deg, rgba(139,92,246,0.2), rgba(168,85,247,0.15));
            border: 1px solid rgba(139,92,246,0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 20px;
        }
        h1 { color: #c4b5fd; font-size: 16pt; margin-bottom: 8px; }
        .header-info { color: #94a3b8; font-size: 8pt; }
        .header-info strong { color: #e2e8f0; }
        
        .summary-grid { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        .summary-box { 
            background: rgba(139,92,246,0.15);
            border: 1px solid rgba(139,92,246,0.3);
            border-radius: 8px; 
            padding: 12px 16px; 
            min-width: 90px;
            text-align: center;
        }
        .summary-box .value { font-size: 16pt; font-weight: 700; color: #a78bfa; }
        .summary-box .label { font-size: 7pt; color: #94a3b8; text-transform: uppercase; margin-top: 4px; }
        
        .section { 
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 16px;
        }
        .section.area { 
            background: rgba(6,182,212,0.1);
            border: 1px solid rgba(6,182,212,0.3);
        }
        .section.project { 
            background: rgba(99,102,241,0.1);
            border: 1px solid rgba(99,102,241,0.3);
        }
        h2 { 
            color: #c4b5fd; 
            font-size: 11pt; 
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        h2.area { color: #67e8f9; }
        h2.project { color: #a5b4fc; }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 8pt;
            table-layout: fixed;
            word-wrap: break-word;
        }
        th { 
            background: rgba(0,0,0,0.3);
            color: #c4b5fd; 
            padding: 8px 5px; 
            text-align: center; 
            font-weight: 600;
            text-transform: uppercase;
            font-size: 7pt;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        th.area { color: #67e8f9; }
        th.project { color: #a5b4fc; }
        td { 
            padding: 6px 5px; 
            border-bottom: 1px solid rgba(255,255,255,0.08);
            text-align: center;
        }
        td.left { text-align: left; }
        tr:hover { background: rgba(139,92,246,0.1); }
        
        .text-purple { color: #c4b5fd; }
        .text-cyan { color: #22d3ee; }
        .text-yellow { color: #fcd34d; }
        .text-green { color: #34d399; }
        .text-blue { color: #60a5fa; }
        .text-pink { color: #f472b6; }
        .text-white { color: #e2e8f0; }
        .text-muted { color: #94a3b8; }
        .font-bold { font-weight: 600; }
        
        .footer-row { 
            background: rgba(139,92,246,0.15) !important;
            font-weight: 600;
        }
        .footer-row td { border-top: 2px solid rgba(139,92,246,0.3); }
        
        .footer { 
            margin-top: 20px; 
            font-size: 7pt; 
            color: #64748b; 
            text-align: center; 
            border-top: 1px solid rgba(255,255,255,0.1); 
            padding-top: 10px; 
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ü§ñ AI Adoption Report</h1>
        <div class="header-info">
            <strong>Sprint:</strong> ${sprintName} &nbsp;|&nbsp; 
            <strong>Area:</strong> ${areaNames} &nbsp;|&nbsp;
            <strong>Projects:</strong> ${selectedProjects.join(', ')} &nbsp;|&nbsp;
            <strong>Generated:</strong> ${new Date().toLocaleString()}
        </div>
    </div>
    
    <div class="summary-grid">
        <div class="summary-box"><div class="value">${devMemberCount}</div><div class="label">Dev Members</div></div>
        <div class="summary-box"><div class="value">${totalTasks}</div><div class="label">Total Tasks</div></div>
        <div class="summary-box"><div class="value">${totalOrigEst}</div><div class="label">Total Orig Est</div></div>
        <div class="summary-box"><div class="value">${totalCompleted}</div><div class="label">Total Completed</div></div>
        <div class="summary-box"><div class="value">${manualEff}</div><div class="label">Manual Eff.</div></div>
        <div class="summary-box"><div class="value">${aiEff}</div><div class="label">AI Eff.</div></div>
    </div>
    
    <div class="section">
        <h2>üë• Member-wise Summary</h2>
        ${buildPdfTable(memberTable, 'member')}
    </div>
    
    <div class="section area">
        <h2 class="area">üè∑Ô∏è Area-wise Summary</h2>
        ${buildPdfTable(areaTable, 'area')}
    </div>
    
    <div class="section project">
        <h2 class="project">üìÅ Project-wise Summary</h2>
        ${buildPdfTable(projectTable, 'project')}
    </div>
    
    <div class="footer">
        Sprint Requirements Tracker - AI Adoption Report | Generated on ${new Date().toLocaleString()}
    </div>
</body>
</html>`;
            
            // Generate and download PDF directly using jsPDF and html2canvas
            generateAndDownloadPDF(pdfContent, `AI_Adoption_Report_${sprintName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.pdf`);
        }
        
        // Helper function to generate and download PDF directly
        async function generateAndDownloadPDF(htmlContent, filename) {
            // Create a hidden iframe to render the content
            const iframe = document.createElement('iframe');
            iframe.style.position = 'fixed';
            iframe.style.left = '-9999px';
            iframe.style.width = '1400px';
            iframe.style.height = '900px';
            document.body.appendChild(iframe);
            
            iframe.contentDocument.open();
            iframe.contentDocument.write(htmlContent);
            iframe.contentDocument.close();
            
            // Wait for content to load
            await new Promise(resolve => setTimeout(resolve, 500));
            
            try {
                const { jsPDF } = window.jspdf;
                const element = iframe.contentDocument.body;
                
                // Capture the content as canvas
                const canvas = await html2canvas(element, {
                    scale: 1.5,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#0f172a',
                    width: element.scrollWidth,
                    height: element.scrollHeight,
                    windowWidth: element.scrollWidth,
                    windowHeight: element.scrollHeight
                });
                
                // Create PDF in landscape A4
                const pdf = new jsPDF('l', 'mm', 'a4');
                const pageWidth = 297; // A4 landscape width in mm
                const pageHeight = 210; // A4 landscape height in mm
                const margin = 5;
                
                const imgWidth = pageWidth - (margin * 2);
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                const imgData = canvas.toDataURL('image/png');
                
                // Add first page
                pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, imgHeight);
                
                // Handle multi-page if content is too long
                let heightLeft = imgHeight - (pageHeight - margin * 2);
                let position = -(pageHeight - margin * 2) + margin;
                
                while (heightLeft > 0) {
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                    heightLeft -= (pageHeight - margin * 2);
                    position -= (pageHeight - margin * 2);
                }
                
                // Download PDF directly
                pdf.save(filename);
                
            } catch (error) {
                console.error('PDF generation error:', error);
                alert('Error generating PDF. Please try again.');
            } finally {
                // Clean up iframe
                document.body.removeChild(iframe);
            }
        }
        
        // Helper function to build PDF table with proper styling
        function buildPdfTable(table, type) {
            if (!table || !table.innerHTML.trim()) {
                return '<p style="color:#94a3b8;text-align:center;padding:12px;">No data available</p>';
            }
            
            const thClass = type === 'area' ? 'area' : type === 'project' ? 'project' : '';
            
            // Clone and process the table
            const clone = table.cloneNode(true);
            
            // Remove sort icons from headers
            clone.querySelectorAll('th').forEach(th => {
                th.textContent = th.textContent.replace(/[‚ñ≤‚ñº‚áÖ]/g, '').trim();
                if (thClass) th.classList.add(thClass);
            });
            
            // Process cells to add appropriate classes based on content/color
            clone.querySelectorAll('td').forEach(td => {
                const style = td.getAttribute('style') || '';
                if (style.includes('#c4b5fd') || style.includes('a78bfa')) td.classList.add('text-purple');
                else if (style.includes('#22d3ee') || style.includes('67e8f9')) td.classList.add('text-cyan');
                else if (style.includes('#fcd34d') || style.includes('fbbf24')) td.classList.add('text-yellow');
                else if (style.includes('#34d399')) td.classList.add('text-green');
                else if (style.includes('#60a5fa')) td.classList.add('text-blue');
                else if (style.includes('#f472b6')) td.classList.add('text-pink');
                else if (style.includes('#e2e8f0')) td.classList.add('text-white');
                else if (style.includes('#94a3b8')) td.classList.add('text-muted');
                
                if (style.includes('font-weight')) td.classList.add('font-bold');
                if (style.includes('text-align:left') || style.includes('text-align: left')) td.classList.add('left');
                
                // Remove inline styles
                td.removeAttribute('style');
            });
            
            // Process footer rows
            clone.querySelectorAll('tfoot tr').forEach(tr => {
                tr.classList.add('footer-row');
            });
            
            // Remove all remaining inline styles from rows
            clone.querySelectorAll('tr').forEach(tr => {
                tr.removeAttribute('style');
                tr.removeAttribute('onmouseover');
                tr.removeAttribute('onmouseout');
            });
            
            clone.querySelectorAll('th').forEach(th => {
                th.removeAttribute('style');
                th.removeAttribute('onclick');
            });
            
            return clone.outerHTML;
        }

        async function lookupRequirement() {
            const reqId = document.getElementById('reqIdInput').value.trim();
            const resultDiv = document.getElementById('reqLookupResult');
            if (!reqId) { resultDiv.innerHTML = '<div class="error">Please enter a Requirement ID</div>'; return; }
            
            resultDiv.innerHTML = '<div style="color:#94a3b8;">üîÑ Loading...</div>';
            try {
                const resp = await apiFetch(`${tfsUrl}/_apis/wit/workitems/${reqId}?$expand=relations&api-version=5.0`);
                if (!resp.ok) throw new Error(`Requirement ${reqId} not found`);
                const data = await resp.json();
                
                const f = data.fields, tags = (f['System.Tags'] || '').toLowerCase();
                let cat = tags.includes('non-deliverable') ? 'Non-Deliverable' : tags.includes('deliverable') ? 'Deliverable' : 'Unclassified';
                let catCls = cat === 'Deliverable' ? 'deliverable' : cat === 'Non-Deliverable' ? 'non-deliverable' : '';
                
                const taskIds = (data.relations || []).filter(r => r.rel === 'System.LinkTypes.Hierarchy-Forward').map(r => r.url.split('/').pop());
                let tasks = [];
                if (taskIds.length > 0) {
                    tasks = await batchFetchWorkItems(taskIds, ['System.Id','System.Title','System.State','System.AssignedTo','System.WorkItemType','System.Tags','Microsoft.VSTS.Scheduling.OriginalEstimate','Microsoft.VSTS.Scheduling.RemainingWork','Microsoft.VSTS.Scheduling.CompletedWork','Microsoft.VSTS.Common.Discipline','Casepoint.TFS.CustomFields.TaskExecutionType']);
                    tasks = tasks.filter(t => t.fields['System.WorkItemType'] === 'Task');
                }
                
                const totOrig = tasks.reduce((s, t) => s + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                const totRem = tasks.reduce((s, t) => s + (t.fields['Microsoft.VSTS.Scheduling.RemainingWork'] || 0), 0);
                const totComp = tasks.reduce((s, t) => s + (t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0), 0);
                
                resultDiv.innerHTML = `<div class="req-lookup-card"><h4><a href="${tfsUrl}/${project}/_workitems/edit/${reqId}" target="_blank" class="wi-link">#${reqId}</a>: ${f['System.Title'] || ''}</h4><div class="req-details"><div class="detail-item"><div class="label">Type</div><div class="value">${f['System.WorkItemType'] || '-'}</div></div><div class="detail-item"><div class="label">State</div><div class="value">${f['System.State'] || '-'}</div></div><div class="detail-item"><div class="label">Category</div><div class="value">${catCls ? `<span class="badge badge-${catCls}">${cat}</span>` : cat}</div></div><div class="detail-item"><div class="label">Size</div><div class="value">${f['Microsoft.VSTS.Scheduling.Size'] || 0}</div></div></div><h4 style="margin-top:16px;">üìã Tasks (${tasks.length})</h4>${tasks.length > 0 ? `<div style="background:rgba(0,0,0,0.2);padding:12px;border-radius:8px;margin-bottom:12px;"><div style="display:flex;gap:24px;flex-wrap:wrap;font-size:0.85rem;"><span>üìä Original: <strong>${fmtH(totOrig)}h</strong></span><span>‚è≥ Remaining: <strong>${fmtH(totRem)}h</strong></span><span>‚úÖ Completed: <strong>${fmtH(totComp)}h</strong></span></div></div><div style="overflow-x:auto;"><table class="tasks-table"><thead><tr><th>ID</th><th>Title</th><th>State</th><th>Assigned</th><th>Discipline</th><th>Task Exec Type</th><th>Orig</th><th>Revised</th><th>Comp</th><th>Tags</th></tr></thead><tbody>${tasks.map(t => {
                    const discipline = t.fields['Microsoft.VSTS.Common.Discipline'] || '-';
                    const taskExecType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '-';
                    const taskTags = t.fields['System.Tags'] || '-';
                    const revisedEst = t.fields['Microsoft.VSTS.Scheduling.RemainingWork'] || 0;
                    return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${t.id}" target="_blank" class="wi-link">${t.id}</a></td><td>${t.fields['System.Title'] || ''}</td><td>${t.fields['System.State'] || ''}</td><td>${t.fields['System.AssignedTo']?.displayName || '-'}</td><td style="color:#a78bfa;">${discipline}</td><td style="color:#22d3ee;">${taskExecType}</td><td>${fmtH(t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0)}h</td><td style="color:#fbbf24;">${fmtH(revisedEst)}h</td><td>${fmtH(t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0)}h</td><td style="font-size:0.65rem;max-" title="${taskTags}">${taskTags}</td></tr>`;
                }).join('')}</tbody></table></div>` : '<div class="no-tasks">No tasks found</div>'}</div>`;
            } catch (err) { resultDiv.innerHTML = `<div class="error">‚ùå ${err.message}</div>`; }
        }

        // ==================== ON-DEMAND CARD REFRESH FUNCTIONS ====================
        // Individual card refresh functions for dynamic updates without full-page reload

        async function refreshBlankSizeCard() {
            const btn = event?.target;
            if (btn) { btn.textContent = '‚è≥'; btn.disabled = true; }
            try {
                // Fetch fresh requirement data
                const reqIds = requirements.map(r => r.id);
                if (reqIds.length > 0) {
                    const freshReqs = await batchFetchWorkItems(reqIds, ['System.Id', 'System.Title', 'Microsoft.VSTS.Scheduling.Size', 'System.WorkItemType']);
                    freshReqs.forEach(fr => {
                        const existingReq = requirements.find(r => r.id === fr.id);
                        if (existingReq) {
                            existingReq.fields['Microsoft.VSTS.Scheduling.Size'] = fr.fields['Microsoft.VSTS.Scheduling.Size'];
                            existingReq.fields['System.WorkItemType'] = fr.fields['System.WorkItemType'];
                        }
                    });
                }
                // Filter: Deliverable/Non-Deliverable + Requirement/Change Request + Size 0 or blank
                const blankSizeReqs = requirements.filter(r => {
                    // Must be Deliverable or Non-Deliverable
                    if (r.category !== 'deliverable' && r.category !== 'nonDeliverable') return false;
                    // Must be Requirement or Change Request work item type
                    const workItemType = r.fields ? r.fields['System.WorkItemType'] : '';
                    if (workItemType !== 'Requirement' && workItemType !== 'Change Request') return false;
                    // Size must be 0, blank, null or undefined
                    const size = r.fields ? r.fields['Microsoft.VSTS.Scheduling.Size'] : undefined;
                    return size === undefined || size === null || size === '' || size === 0 || Number(size) === 0;
                });
                document.getElementById('blankSizeCount').textContent = blankSizeReqs.length;
                renderBlankSizeData(blankSizeReqs);
            } catch (err) { console.error('Error refreshing Blank Size:', err); }
            finally { if (btn) { btn.textContent = 'üîÑ'; btn.disabled = false; } }
        }

        async function refreshBlankReleaseNoteCard() {
            const btn = event?.target;
            if (btn) { btn.textContent = '‚è≥'; btn.disabled = true; }
            try {
                // Fetch fresh requirement data
                const reqIds = requirements.map(r => r.id);
                if (reqIds.length > 0) {
                    const freshReqs = await batchFetchWorkItems(reqIds, ['System.Id', 'System.Title', 'System.State', 'Casepoint.TFS.CustomFields.ReleaseNotes']);
                    freshReqs.forEach(fr => {
                        const existingReq = requirements.find(r => r.id === fr.id);
                        if (existingReq) {
                            existingReq.fields['Casepoint.TFS.CustomFields.ReleaseNotes'] = fr.fields['Casepoint.TFS.CustomFields.ReleaseNotes'];
                            existingReq.fields['System.State'] = fr.fields['System.State'];
                        }
                    });
                }
                const classifiedReqs = requirements.filter(r => r.category === 'deliverable' || r.category === 'nonDeliverable');
                const blankReleaseNoteReqs = classifiedReqs.filter(r => {
                    const releaseNote = r.fields ? r.fields['Casepoint.TFS.CustomFields.ReleaseNotes'] : undefined;
                    return releaseNote === undefined || releaseNote === null || releaseNote === '' || (typeof releaseNote === 'string' && releaseNote.trim() === '');
                });
                document.getElementById('blankReleaseNoteCount').textContent = blankReleaseNoteReqs.length;
                const blankReleaseNoteBody = document.getElementById('blankReleaseNoteTableBody');
                if (blankReleaseNoteReqs.length > 0) {
                    document.getElementById('noBlankReleaseNoteData').style.display = 'none';
                    blankReleaseNoteBody.innerHTML = blankReleaseNoteReqs.map(r => {
                        const title = r.fields ? (r.fields['System.Title'] || '') : '';
                        const state = r.fields ? (r.fields['System.State'] || '') : '';
                        return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${title}</td><td>${state}</td></tr>`;
                    }).join('');
                } else { document.getElementById('noBlankReleaseNoteData').style.display = 'block'; blankReleaseNoteBody.innerHTML = ''; }
            } catch (err) { console.error('Error refreshing Blank Release Note:', err); }
            finally { if (btn) { btn.textContent = 'üîÑ'; btn.disabled = false; } }
        }

        async function refreshNoParentCard() {
            const btn = event?.target;
            if (btn) { btn.textContent = '‚è≥'; btn.disabled = true; }
            try {
                // Fetch fresh parent relations
                const reqIds = requirements.map(r => r.id);
                if (reqIds.length > 0) {
                    const freshReqs = await batchFetchWithRelations(reqIds);
                    freshReqs.forEach(fr => {
                        const existingReq = requirements.find(r => r.id === fr.id);
                        if (existingReq) {
                            existingReq.hasParent = fr.relations?.some(rel => rel.rel === 'System.LinkTypes.Hierarchy-Reverse') || false;
                        }
                    });
                }
                const classifiedReqs = requirements.filter(r => r.category === 'deliverable' || r.category === 'nonDeliverable');
                const noParentReqs = classifiedReqs.filter(r => !r.hasParent);
                document.getElementById('blankParentCount').textContent = noParentReqs.length;
                const blankParentBody = document.getElementById('blankParentTableBody');
                if (noParentReqs.length > 0) {
                    document.getElementById('noBlankParentData').style.display = 'none';
                    blankParentBody.innerHTML = noParentReqs.map(r => {
                        const title = r.fields ? (r.fields['System.Title'] || '') : '';
                        const catLabel = r.category === 'deliverable' ? 'Del' : 'Non-Del';
                        return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${title}</td><td>${catLabel}</td></tr>`;
                    }).join('');
                } else { document.getElementById('noBlankParentData').style.display = 'block'; blankParentBody.innerHTML = ''; }
            } catch (err) { console.error('Error refreshing No Parent:', err); }
            finally { if (btn) { btn.textContent = 'üîÑ'; btn.disabled = false; } }
        }

        async function refreshLastSprintOpenCard() {
            if (!storedSprintStartDate) return;
            const btn = event?.target;
            if (btn) { btn.textContent = '‚è≥'; btn.disabled = true; }
            try {
                await loadLastSprintOpenItems();
            } catch (err) { console.error('Error refreshing Last Sprint Open:', err); }
            finally { if (btn) { btn.textContent = 'üîÑ'; btn.disabled = false; } }
        }

        async function refreshTagMissingCard() {
            const btn = event?.target;
            if (btn) { btn.textContent = '‚è≥'; btn.disabled = true; }
            try {
                // Fetch fresh task data
                const taskIds = tasks.map(t => t.id);
                if (taskIds.length > 0) {
                    const freshTasks = await batchFetchWorkItems(taskIds, ['System.Id', 'System.Title', 'System.AssignedTo', 'System.Tags', 'Microsoft.VSTS.Common.Discipline']);
                    freshTasks.forEach(ft => {
                        const existingTask = tasks.find(t => t.id === ft.id);
                        if (existingTask) {
                            existingTask.fields['System.Tags'] = ft.fields['System.Tags'];
                            existingTask.fields['System.AssignedTo'] = ft.fields['System.AssignedTo'];
                            existingTask.fields['Microsoft.VSTS.Common.Discipline'] = ft.fields['Microsoft.VSTS.Common.Discipline'];
                        }
                    });
                }
                renderTagMissingTasks();
            } catch (err) { console.error('Error refreshing Tag Missing:', err); }
            finally { if (btn) { btn.textContent = 'üîÑ'; btn.disabled = false; } }
        }

        async function refreshBlankDisciplineCard() {
            const btn = event?.target;
            if (btn) { btn.textContent = '‚è≥'; btn.disabled = true; }
            try {
                // Fetch fresh task data
                const taskIds = tasks.map(t => t.id);
                if (taskIds.length > 0) {
                    const freshTasks = await batchFetchWorkItems(taskIds, ['System.Id', 'System.Title', 'System.AssignedTo', 'Microsoft.VSTS.Common.Discipline']);
                    freshTasks.forEach(ft => {
                        const existingTask = tasks.find(t => t.id === ft.id);
                        if (existingTask) {
                            existingTask.fields['Microsoft.VSTS.Common.Discipline'] = ft.fields['Microsoft.VSTS.Common.Discipline'];
                            existingTask.fields['System.AssignedTo'] = ft.fields['System.AssignedTo'];
                        }
                    });
                }
                renderBlankDisciplineTasks();
            } catch (err) { console.error('Error refreshing Blank Discipline:', err); }
            finally { if (btn) { btn.textContent = 'üîÑ'; btn.disabled = false; } }
        }

        async function refreshOverEstTasksCard() {
            const btn = document.getElementById('refreshOverEstBtn');
            btn.textContent = '‚è≥';
            btn.disabled = true;
            try {
                // Fetch fresh task data from TFS
                const taskIds = tasks.map(t => t.id);
                if (taskIds.length > 0) {
                    const freshTasks = await batchFetchWorkItems(taskIds, ['System.Id', 'System.Title', 'Microsoft.VSTS.Scheduling.OriginalEstimate', 'System.AssignedTo']);
                    // Update local tasks cache with fresh data
                    freshTasks.forEach(ft => {
                        const existingTask = tasks.find(t => t.id === ft.id);
                        if (existingTask) {
                            existingTask.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] = ft.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'];
                            existingTask.fields['System.Title'] = ft.fields['System.Title'];
                            existingTask.fields['System.AssignedTo'] = ft.fields['System.AssignedTo'];
                        }
                    });
                }
                // Re-render with fresh data
                const overEstTasks = tasks.filter(t => (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0) > 40);
                document.getElementById('overEstTaskCount').textContent = overEstTasks.length;
                const overEstTable = document.getElementById('overEstTasksTable').querySelector('tbody');
                if (overEstTasks.length > 0) {
                    document.getElementById('noOverEstTasks').style.display = 'none';
                    overEstTable.innerHTML = overEstTasks.map(t => `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${t.id}" target="_blank" class="wi-link">${t.id}</a></td><td>${t.fields['System.Title'] || ''}</td><td>${t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0}</td><td>${t.fields['System.AssignedTo']?.displayName || '-'}</td></tr>`).join('');
                } else {
                    document.getElementById('noOverEstTasks').style.display = 'block';
                    overEstTable.innerHTML = '';
                }
            } catch (err) {
                console.error('Error refreshing Over Est Tasks:', err);
            } finally {
                btn.textContent = 'üîÑ';
                btn.disabled = false;
            }
        }

        async function refreshBlankDescCard() {
            const btn = document.getElementById('refreshBlankDescBtn');
            btn.textContent = '‚è≥';
            btn.disabled = true;
            try {
                // Fetch fresh requirement data from TFS
                const reqIds = requirements.map(r => r.id);
                if (reqIds.length > 0) {
                    const freshReqs = await batchFetchWorkItems(reqIds, ['System.Id', 'System.Title', 'System.Description', 'System.State']);
                    // Update local requirements cache with fresh data
                    freshReqs.forEach(fr => {
                        const existingReq = requirements.find(r => r.id === fr.id);
                        if (existingReq) {
                            existingReq.fields['System.Description'] = fr.fields['System.Description'];
                            existingReq.fields['System.Title'] = fr.fields['System.Title'];
                            existingReq.fields['System.State'] = fr.fields['System.State'];
                        }
                    });
                }
                // Re-render with fresh data
                const blankDescReqs = requirements.filter(r => {
                    const desc = r.fields['System.Description'] || '';
                    return !desc || desc.trim() === '';
                });
                document.getElementById('blankDescCount').textContent = blankDescReqs.length;
                const blankDescTable = document.getElementById('blankDescTable').querySelector('tbody');
                if (blankDescReqs.length > 0) {
                    document.getElementById('noBlankDesc').style.display = 'none';
                    blankDescTable.innerHTML = blankDescReqs.map(r => {
                        const title = r.fields['System.Title'] || '';
                        const state = r.fields['System.State'] || '';
                        return `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${title}</td><td>${state}</td></tr>`;
                    }).join('');
                } else {
                    document.getElementById('noBlankDesc').style.display = 'block';
                    blankDescTable.innerHTML = '';
                }
            } catch (err) {
                console.error('Error refreshing Blank Desc:', err);
            } finally {
                btn.textContent = 'üîÑ';
                btn.disabled = false;
            }
        }

        async function refreshTeamBCard() {
            const btn = document.getElementById('refreshTeamBBtn');
            if (btn) { btn.textContent = '‚è≥'; btn.disabled = true; }
            try {
                // Fetch fresh requirement and task data from TFS
                const reqIds = requirements.map(r => r.id);
                const taskIds = tasks.map(t => t.id);
                
                if (reqIds.length > 0) {
                    const freshReqs = await batchFetchWorkItems(reqIds, ['System.Id', 'System.Title', 'System.State', 'Microsoft.VSTS.Scheduling.Size']);
                    freshReqs.forEach(fr => {
                        const existingReq = requirements.find(r => r.id === fr.id);
                        if (existingReq) {
                            existingReq.fields['System.Title'] = fr.fields['System.Title'];
                            existingReq.fields['System.State'] = fr.fields['System.State'];
                            existingReq.fields['Microsoft.VSTS.Scheduling.Size'] = fr.fields['Microsoft.VSTS.Scheduling.Size'];
                        }
                    });
                }
                
                if (taskIds.length > 0) {
                    const freshTasks = await batchFetchWorkItems(taskIds, ['System.Id', 'Microsoft.VSTS.Scheduling.OriginalEstimate', 'Microsoft.VSTS.Scheduling.RemainingWork', 'Microsoft.VSTS.Scheduling.CompletedWork']);
                    freshTasks.forEach(ft => {
                        const existingTask = tasks.find(t => t.id === ft.id);
                        if (existingTask) {
                            existingTask.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] = ft.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'];
                            existingTask.fields['Microsoft.VSTS.Scheduling.RemainingWork'] = ft.fields['Microsoft.VSTS.Scheduling.RemainingWork'];
                            existingTask.fields['Microsoft.VSTS.Scheduling.CompletedWork'] = ft.fields['Microsoft.VSTS.Scheduling.CompletedWork'];
                        }
                    });
                }
                
                // Re-calculate TEAM B data - filter by TITLE containing "ticket support" or "ticket handling"
                teamBData = { requirements: [], totalOrigEst: 0, totalSize: 0, totalRemWork: 0, totalCompWork: 0, totalTasks: 0 };
                requirements.filter(r => {
                    const title = (r.fields['System.Title'] || '').toLowerCase();
                    return title.includes('ticket support') || title.includes('ticket handling');
                }).forEach(req => {
                    const reqTasks = tasks.filter(t => taskParentMap[t.id] === req.id);
                    const origEst = reqTasks.reduce((s, t) => s + (t.fields['Microsoft.VSTS.Scheduling.OriginalEstimate'] || 0), 0);
                    const remWork = reqTasks.reduce((s, t) => s + (t.fields['Microsoft.VSTS.Scheduling.RemainingWork'] || 0), 0);
                    const compWork = reqTasks.reduce((s, t) => s + (t.fields['Microsoft.VSTS.Scheduling.CompletedWork'] || 0), 0);
                    const size = req.fields['Microsoft.VSTS.Scheduling.Size'] || 0;
                    // Use same field names as initial: originalEstimate, remainingWork, completedWork
                    teamBData.requirements.push({ ...req, taskCount: reqTasks.length, originalEstimate: origEst, size: size, remainingWork: remWork, completedWork: compWork });
                    teamBData.totalOrigEst += origEst;
                    teamBData.totalSize += size;
                    teamBData.totalRemWork += remWork;
                    teamBData.totalCompWork += compWork;
                    teamBData.totalTasks += reqTasks.length;
                });
                
                // Update UI
                document.getElementById('teamBReqCount').textContent = teamBData.requirements.length;
                document.getElementById('teamBTaskCount').textContent = teamBData.totalTasks;
                document.getElementById('teamBTotalSize').textContent = teamBData.totalSize;
                document.getElementById('teamBTotalOrigEst').textContent = fmtH(teamBData.totalOrigEst) + 'h';
                document.getElementById('teamBTotalRemWork').textContent = fmtH(teamBData.totalRemWork) + 'h';
                const teamBTable = document.getElementById('teamBReqTable').querySelector('tbody');
                if (teamBData.requirements.length > 0) {
                    document.getElementById('noTeamBData').style.display = 'none';
                    teamBTable.innerHTML = teamBData.requirements.map(r => `<tr><td><a href="${tfsUrl}/${project}/_workitems/edit/${r.id}" target="_blank" class="wi-link">${r.id}</a></td><td>${r.fields['System.Title'] || ''}</td><td>${r.fields['System.State'] || ''}</td><td>${r.taskCount}</td><td style="color:#c084fc;">${r.size || 0}</td><td style="color:#fbbf24;">${fmtH(r.originalEstimate)}h</td><td style="color:#22d3ee;">${fmtH(r.remainingWork)}h</td></tr>`).join('');
                } else {
                    document.getElementById('noTeamBData').style.display = 'block';
                    teamBTable.innerHTML = '';
                }
            } catch (err) {
                console.error('Error refreshing TEAM B:', err);
            } finally {
                if (btn) { btn.textContent = 'üîÑ'; btn.disabled = false; }
            }
        }

        // ==================== END ON-DEMAND CARD REFRESH ====================

        async function refreshData() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.textContent = 'üîÑ Refreshing...';
            try { await loadData(); } finally { btn.disabled = false; btn.textContent = 'üîÑ Refresh'; }
        }

        function showFilters() { document.getElementById('content').classList.remove('visible'); document.getElementById('filterPanel').classList.add('visible'); }
        function resetConnection() { 
            document.getElementById('filterPanel').classList.remove('visible'); 
            document.getElementById('content').classList.remove('visible'); 
            document.getElementById('configPanel').style.display = 'block';
            document.getElementById('projectCheckboxContainer').innerHTML = '<div style="color: #94a3b8; font-size: 0.85rem;">-- Enter PAT to load projects --</div>';
            document.getElementById('projectStatus').textContent = '';
            document.getElementById('selectedProjects').innerHTML = '';
            document.getElementById('areaCheckboxContainer').innerHTML = '<div style="color: #94a3b8; font-size: 0.85rem;">-- Loading areas --</div>';
            document.getElementById('selectedAreas').innerHTML = '';
            document.getElementById('iterationCheckboxContainer').innerHTML = '<div style="color: #94a3b8; font-size: 0.85rem;">-- Loading iterations --</div>';
            document.getElementById('selectedIterations').innerHTML = '';
            selectedProjects = [];
            selectedAreaPaths = [];
            selectedIterationPaths = [];
            projectsFetched = false;
        }
        function showLoading(t) { document.getElementById('loadingText').textContent = t; document.getElementById('loading').classList.add('visible'); }
        function hideLoading() { document.getElementById('loading').classList.remove('visible'); }
        function showError(m) { document.getElementById('errorMsg').innerHTML = `<div class="error">‚ùå ${m}</div>`; }
    
        function exportMismatchToExcel() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            
            let csv = 'Discipline - Manual Task Execution Type Mismatch\n';
            csv += `Sprint: ${sprintName}\n`;
            csv += `Date: ${today}\n\n`;
            csv += 'ID,Title,State,Assigned To,Area Path,Discipline,Task Execution Type\n';
            
            mismatchAllData.forEach(t => {
                const title = (t.fields['System.Title'] || '').replace(/"/g, '""');
                const state = t.fields['System.State'] || '';
                const assigned = t.fields['System.AssignedTo']?.displayName || '';
                const areaPath = t.fields['System.AreaPath'] || '';
                const discipline = t.fields['Microsoft.VSTS.Common.Discipline'] || '';
                const execType = t.fields['Casepoint.TFS.CustomFields.TaskExecutionType'] || '';
                csv += `${t.id},"${title}",${state},"${assigned}","${areaPath}","${discipline}","${execType}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Mismatch_Tasks_${sprintName.replace(/[^a-zA-Z0-9]/g, '_')}_${today}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportMismatchToPDF() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            const areaNames = selectedAreaPaths.map(p => p.path.split('\\').pop()).join(', ');
            const table = document.getElementById('mismatchTable');
            if (!table || !table.querySelector('tbody').innerHTML) { alert('No data loaded. Please show the dashboard first.'); return; }
            
            const pdfContent = `
<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<title>Discipline Mismatch - ${sprintName}</title>
<style>
    @media print { @page { size: landscape; margin: 0; } body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0; padding: 0.5in 0.4in; } thead { display: table-header-group; } tr { page-break-inside: avoid; } table { page-break-inside: auto; } }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; }
    .header { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid rgba(239,68,68,0.4); }
    .header h1 { font-size: 1.1rem; color: #fca5a5; margin-bottom: 4px; }
    .header .meta { font-size: 0.7rem; color: #94a3b8; }
    .header .criteria { font-size: 0.7rem; color: #60a5fa; margin-top: 4px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.65rem; table-layout: fixed; word-wrap: break-word; }
    th { background: rgba(30,41,59,0.9); color: #fca5a5; padding: 6px 5px; text-align: left; border-bottom: 2px solid rgba(239,68,68,0.3); font-size: 0.65rem; text-transform: uppercase; }
    td { padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    tr:nth-child(even) { background: rgba(255,255,255,0.03); }
</style></head><body>
<div class="header">
    <h1>üîÄ Discipline - Manual Task Execution Type Mismatch (${mismatchAllData.length})</h1>
    <div class="meta">Sprint: ${sprintName} | Area: ${areaNames} | Generated: ${today}</div>
    <div class="criteria">Expected: Development ‚Üí AI-Dev* | Test ‚Üí AI-Test* | Closed Tasks Only with AI Task Execution Type</div>
</div>
${table.outerHTML}
</body></html>`;
            
            const w = window.open('', '_blank', 'width=1200,height=800');
            w.document.write(pdfContent);
            w.document.close();
            setTimeout(() => { w.print(); }, 500);
        }

        function exportDisciplineVerificationToPDF() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            const areaNames = selectedAreaPaths.map(p => p.path.split('\\').pop()).join(', ');
            const table = document.getElementById('dvMismatchTable');
            if (!table) { alert('No data loaded. Please show the dashboard first.'); return; }
            
            const stats = {
                members: document.getElementById('dvMemberCount').textContent,
                total: document.getElementById('dvTotalTasks').textContent,
                matched: document.getElementById('dvMatchedCount').textContent,
                mismatched: document.getElementById('dvMismatchedCount').textContent,
                blank: document.getElementById('dvBlankDisciplineCount').textContent
            };
            
            const pdfContent = `
<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<title>Discipline Verification - ${sprintName}</title>
<style>
    @media print { @page { size: landscape; margin: 0; } body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0; padding: 0.5in 0.4in; } thead { display: table-header-group; } tr { page-break-inside: avoid; } table { page-break-inside: auto; } }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; }
    .header { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid rgba(59,130,246,0.4); }
    .header h1 { font-size: 1.1rem; color: #93c5fd; margin-bottom: 4px; }
    .header .meta { font-size: 0.7rem; color: #94a3b8; }
    .stats { display: flex; justify-content: center; gap: 20px; margin: 12px 0; font-size: 0.75rem; }
    .stat { text-align: center; padding: 8px 16px; border-radius: 6px; }
    .stat .val { font-size: 1.1rem; font-weight: 700; }
    .stat .lbl { font-size: 0.65rem; color: #94a3b8; }
    table { width: 100%; border-collapse: collapse; font-size: 0.65rem; table-layout: fixed; word-wrap: break-word; }
    th { background: rgba(30,41,59,0.9); color: #93c5fd; padding: 6px 5px; text-align: left; border-bottom: 2px solid rgba(59,130,246,0.3); font-size: 0.65rem; text-transform: uppercase; }
    td { padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    tr:nth-child(even) { background: rgba(255,255,255,0.03); }
</style></head><body>
<div class="header">
    <h1>üîç Discipline Verification Report</h1>
    <div class="meta">Sprint: ${sprintName} | Area: ${areaNames} | Generated: ${today}</div>
</div>
<div class="stats">
    <div class="stat" style="background:rgba(59,130,246,0.2);"><div class="val" style="color:#60a5fa;">${stats.members}</div><div class="lbl">Members</div></div>
    <div class="stat" style="background:rgba(148,163,184,0.2);"><div class="val" style="color:#94a3b8;">${stats.total}</div><div class="lbl">Total Tasks</div></div>
    <div class="stat" style="background:rgba(16,185,129,0.2);"><div class="val" style="color:#34d399;">${stats.matched}</div><div class="lbl">‚úÖ Matched</div></div>
    <div class="stat" style="background:rgba(239,68,68,0.2);"><div class="val" style="color:#f87171;">${stats.mismatched}</div><div class="lbl">‚ùå Mismatched</div></div>
    <div class="stat" style="background:rgba(245,158,11,0.2);"><div class="val" style="color:#fbbf24;">${stats.blank}</div><div class="lbl">‚ö†Ô∏è Blank</div></div>
</div>
<h3 style="color:#f87171;font-size:0.85rem;margin:10px 0;">‚ùå Mismatched & ‚ö†Ô∏è Blank Discipline Tasks (${stats.mismatched} mismatched, ${stats.blank} blank)</h3>
${table.outerHTML}
</body></html>`;
            
            const w = window.open('', '_blank', 'width=1200,height=800');
            w.document.write(pdfContent);
            w.document.close();
            setTimeout(() => { w.print(); }, 500);
        }

        function exportOverallAIAdoptionToPDF() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            const areaNames = selectedAreaPaths.map(p => p.path.split('\\').pop()).join(', ');
            const table = document.getElementById('overallAIAdoptionTable');
            if (!table) { alert('No data loaded. Please show the dashboard first.'); return; }
            
            const pdfContent = `
<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<title>üìä AI-Enabled Disciplines - ${sprintName}</title>
<style>
    @media print { @page { size: landscape; margin: 0; } body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0; padding: 0.5in 0.4in; } thead { display: table-header-group; } tr { page-break-inside: avoid; } table { page-break-inside: auto; } }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; }
    .header { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid rgba(59,130,246,0.4); }
    .header h1 { font-size: 1.1rem; color: #93c5fd; margin-bottom: 4px; }
    .header .meta { font-size: 0.7rem; color: #94a3b8; }
    table { width: 100%; border-collapse: collapse; font-size: 0.65rem; table-layout: fixed; word-wrap: break-word; }
    th { background: rgba(30,41,59,0.9); color: #93c5fd; padding: 6px 5px; text-align: center; border-bottom: 2px solid rgba(59,130,246,0.3); font-size: 0.65rem; text-transform: uppercase; }
    td { padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    tr:nth-child(even) { background: rgba(255,255,255,0.03); }
    tfoot td { font-weight: 700; background: rgba(59,130,246,0.15); border-top: 2px solid rgba(59,130,246,0.3); }
</style></head><body>
<div class="header">
    <h1>üìä AI-Enabled Disciplines</h1>
    <div class="meta">Sprint: ${sprintName} | Area: ${areaNames} | Generated: ${today}</div>
</div>
${table.outerHTML}
</body></html>`;
            
            const w = window.open('', '_blank', 'width=1200,height=800');
            w.document.write(pdfContent);
            w.document.close();
            setTimeout(() => { w.print(); }, 500);
        }

        function exportExecTypeAIAdoptionToPDF() {
            const sprintName = sprintInfo.name || 'Sprint';
            const today = new Date().toISOString().split('T')[0];
            const areaNames = selectedAreaPaths.map(p => p.path.split('\\').pop()).join(', ');
            const table = document.getElementById('execTypeAIAdoptionTable');
            if (!table) { alert('No data loaded. Please show the dashboard first.'); return; }
            
            const pdfContent = `
<!DOCTYPE html>
<html><head><meta charset="UTF-8">
<title>‚ö° Task Execution Type AI Adoption - ${sprintName}</title>
<style>
    @media print { @page { size: landscape; margin: 0; } body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; margin: 0; padding: 0.5in 0.4in; } thead { display: table-header-group; } tr { page-break-inside: avoid; } table { page-break-inside: auto; } }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #0f172a; color: #e2e8f0; padding: 20px; }
    .header { text-align: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid rgba(59,130,246,0.4); }
    .header h1 { font-size: 1.1rem; color: #93c5fd; margin-bottom: 4px; }
    .header .meta { font-size: 0.7rem; color: #94a3b8; }
    table { width: 100%; border-collapse: collapse; font-size: 0.65rem; table-layout: fixed; word-wrap: break-word; }
    th { background: rgba(30,41,59,0.9); color: #93c5fd; padding: 6px 5px; text-align: center; border-bottom: 2px solid rgba(59,130,246,0.3); font-size: 0.65rem; text-transform: uppercase; }
    td { padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    tr:nth-child(even) { background: rgba(255,255,255,0.03); }
    tfoot td { font-weight: 700; background: rgba(59,130,246,0.15); border-top: 2px solid rgba(59,130,246,0.3); }
</style></head><body>
<div class="header">
    <h1>‚ö° Task Execution Type AI Adoption</h1>
    <div class="meta">Sprint: ${sprintName} | Area: ${areaNames} | Generated: ${today}</div>
</div>
${table.outerHTML}
</body></html>`;
            
            const w = window.open('', '_blank', 'width=1200,height=800');
            w.document.write(pdfContent);
            w.document.close();
            setTimeout(() => { w.print(); }, 500);
        }


    </script>
</body>
</html>
